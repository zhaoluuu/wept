"use strict";const e=require('../core.wxvpkg/f245202fb5469e3e632befcfb85b60a8.js'),t="darwin"===process.platform;function i(e){const t=document.getElementById("checkbox_auto-update__icon");t&&(e?(t.classList.remove("uiv2-checkbox-icon"),t.classList.add("uiv2-checkbox-icon-o")):(t.classList.remove("uiv2-checkbox-icon-o"),t.classList.add("uiv2-checkbox-icon")))}new class{constructor(){this.webview=null,this.isDoc=!1,this.theme="white",this.href="",this.proxyCssUrl="",this.proxyJsUrl="",this.onShowTimer=null,this.customFrame=null,this.href=global.shareData.updateConfig.whatsnewURL||"",this.isDoc=this.href.endsWith(".html")&&this.href.includes("miniprogram/dev/devtools"),this.theme=global.shareData.updateConfig.theme,this.initTheme(),this.initWebview(),this.initWindowFrame(),this.initActionButton(),this.initThemeListener()}initTheme(){var e,t;"white"===this.theme?(document.body.classList.remove("dark"),null===(e=this.webview)||void 0===e||e.executeScript({code:'\n          var htmlNode = document.querySelector("html")\n          htmlNode.classList.remove("dark");\n          htmlNode.classList.add("white");\n        '})):(document.body.classList.add("dark"),null===(t=this.webview)||void 0===t||t.executeScript({code:'\n        var htmlNode = document.querySelector("html")\n        htmlNode.classList.remove("white");\n        htmlNode.classList.add("dark");\n      '}))}get window(){return global.windowMap.get("WHATSNEW")}initActionButton(){const e=document.getElementById("checkbox_auto-update__label");let t=!!global.shareData.updateConfig.autoUpdate;i(t),null==e||e.addEventListener("click",()=>{t=!t,i(t),global.shareData.updateConfig&&(global.shareData.updateConfig.autoUpdate=t)});const s=document.getElementById("btn_confirm");null==s||s.addEventListener("click",()=>{global.shareData.updateConfig&&(global.shareData.updateConfig.confirmInstall=!0),this.window.close()});const o=document.getElementById("btn_ignore");o&&o.addEventListener("click",()=>{global.shareData.updateConfig&&(global.shareData.updateConfig.ignore=!0),this.window.close()});const n=document.getElementById("btn_wait");n&&n.addEventListener("click",()=>{global.shareData.updateConfig&&(global.shareData.updateConfig.wait=!0),this.window.close()})}initWebview(){const e=document.getElementById("webview-container");this.webview=document.createElement("webview");const t=()=>{this.webview.removeEventListener("loadcommit",t);const e=`${this.webview.getUserAgent()} wechatdevtools/${global.appVersion||"?"}`;this.webview.setUserAgentOverride(e),this.webview.src=this.href,this.webview.addEventListener("loadcommit",i)},i=()=>{this.webview.removeEventListener("loadcommit",i)};this.webview.addEventListener("loadcommit",t),this.webview.classList.add("webview"),this.webview.src="about:blank",this.webview.addEventListener("newwindow",e=>{const t=e.targetUrl.match(/https?:\/\/developers.weixin.qq.com\/t\/(.*)/);(null==t?void 0:t[1])?fetch("http://127.0.0.1:32123/tutorial/"+encodeURIComponent(t[1]),{headers:{Authorization:global.minicodeServerToken},method:"POST",mode:"cors"}):window.open(e.targetUrl)}),this.webview.addEventListener("dialog",e=>{const t=e.messageType||"",i=e.messageText;"alert"!==t||"DEVTOOLS_INIT_THEME_READY"===i&&(clearTimeout(this.onShowTimer),this.webview.style.opacity=1)}),this.initWebviewRequestProxy(),null==e||e.appendChild(this.webview)}initWebviewRequestProxy(){this.webview.request.onBeforeRequest.addListener(t=>!this.proxyCssUrl&&t.url.endsWith(".css")?(console.log(t.url,t),this.proxyCssUrl=`${e.ar.getHost(!0)}/whatsnew?targetUrl=${decodeURIComponent(t.url)}&theme=${this.theme}&isDoc=${+this.isDoc}`,{redirectUrl:this.proxyCssUrl}):!this.proxyJsUrl&&t.url.endsWith(".js")?(this.proxyJsUrl=`${e.ar.getHost(!0)}/whatsnew?targetUrl=${decodeURIComponent(t.url)}&theme=${this.theme}&isDoc=${+this.isDoc}`,{redirectUrl:this.proxyJsUrl}):void 0,{urls:["<all_urls>"]},["blocking"])}initThemeListener(){global.shareData.updateConfig.changeTheme=e=>{e!==this.theme&&(this.theme=e,this.initTheme())}}initWindowFrame(){if(this.customFrame)return;const e=document;this.customFrame=e.createElement("header");const i=e.createElement("div");i.setAttribute("class",t?"title-bar-ext is-mac":"title-bar-ext is-win");const s=e.createElement("a"),o=e.createElement("i");s.appendChild(o);const n=e.createElement("a"),a=e.createElement("i");n.appendChild(a);const r=document.createElement("span");t?(i.appendChild(s),i.appendChild(n)):(i.appendChild(n),i.appendChild(s)),this.customFrame.setAttribute("id","custom-frame"),s.setAttribute("class",t?"title-bar-close --no-drag --cursor-pointer":"custom-frame-close --no-drag --cursor-pointer"),o.setAttribute("class",t?"ui-icon-circle":"uiv2-icon-close"),n.setAttribute("class",t?"title-bar-minimize --no-drag --cursor-pointer":"--no-drag --cursor-pointer"),a.setAttribute("class",t?"ui-icon-circle":"uiv2-icon-minimize"),r.setAttribute("class","custom-frame-title"),this.customFrame.setAttribute("class","whatsnew"),r.innerHTML=global.shareData.updateConfig.title||"",s.addEventListener("click",()=>{const e=global.windowMap.get("WHATSNEW");e&&e.close()},!1),n.addEventListener("click",()=>{const e=global.windowMap.get("WHATSNEW");e&&e.minimize()},!1),t||(s.style.width="12px",s.style.height="12px",s.style.marginRight="5px"),this.customFrame.appendChild(i),this.customFrame.appendChild(r),e.body.insertBefore(this.customFrame,e.body.firstChild),t||document.body.classList.add("windows")}};