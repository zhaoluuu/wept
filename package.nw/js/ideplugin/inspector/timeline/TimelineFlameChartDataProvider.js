import*as Bindings from"../bindings/bindings.js";import*as Common from"../common/common.js";import*as Host from"../host/host.js";import*as PerfUI from"../perf_ui/perf_ui.js";import*as SDK from"../sdk/sdk.js";import*as TimelineModel from"../timeline_model/timeline_model.js";import*as UI from"../ui/ui.js";import{PerformanceModel}from"./PerformanceModel.js";import{FlameChartStyle,Selection,TimelineFlameChartMarker}from"./TimelineFlameChartView.js";import{TimelineSelection}from"./TimelinePanel.js";import{TimelineCategory,TimelineUIUtils}from"./TimelineUIUtils.js";export class TimelineFlameChartDataProvider extends Common.ObjectWrapper.ObjectWrapper{constructor(){super(),this.reset(),this._font="11px "+Host.Platform.fontFamily(),this._timelineData=null,this._currentLevel=0,this._performanceModel=null,this._model=null,this._minimumBoundary=0,this._maximumBoundary=0,this._timeSpan=0,this._consoleColorGenerator=new Common.Color.Generator({min:30,max:55},{min:70,max:100,count:6},50,.7),this._extensionColorGenerator=new Common.Color.Generator({min:210,max:300},{min:70,max:100,count:6},70,.7),this._headerLevel1=this._buildGroupStyle({shareHeaderLine:!1}),this._headerLevel2=this._buildGroupStyle({padding:2,nestingLevel:1,collapsible:!1}),this._staticHeader=this._buildGroupStyle({collapsible:!1}),this._framesHeader=this._buildGroupStyle({useFirstLineForOverview:!0}),this._collapsibleTimingsHeader=this._buildGroupStyle({shareHeaderLine:!0,useFirstLineForOverview:!0,collapsible:!0}),this._timingsHeader=this._buildGroupStyle({shareHeaderLine:!0,useFirstLineForOverview:!0,collapsible:!1}),this._screenshotsHeader=this._buildGroupStyle({useFirstLineForOverview:!0,nestingLevel:1,collapsible:!1,itemsHeight:150}),this._interactionsHeaderLevel1=this._buildGroupStyle({useFirstLineForOverview:!0}),this._interactionsHeaderLevel2=this._buildGroupStyle({padding:2,nestingLevel:1}),this._experienceHeader=this._buildGroupStyle({collapsible:!1}),this._flowEventIndexById=new Map}_buildGroupStyle(e){const t={padding:4,height:17,collapsible:!0,color:self.UI.themeSupport.patchColorText("#222",UI.UIUtils.ThemeSupport.ColorUsage.Foreground),backgroundColor:self.UI.themeSupport.patchColorText("white",UI.UIUtils.ThemeSupport.ColorUsage.Background),font:this._font,nestingLevel:0,shareHeaderLine:!0};return Object.assign(t,e)}setModel(e){this.reset(),this._performanceModel=e,this._model=e&&e.timelineModel()}groupTrack(e){return e._track||null}navStartTimes(){return this._model?this._model.navStartTimes():new Map}entryTitle(e){const t=EntryType,n=this._entryType(e);if(n===t.Event){const t=this._entryData[e];return t.phase===SDK.TracingModel.Phase.AsyncStepInto||t.phase===SDK.TracingModel.Phase.AsyncStepPast?t.name+":"+t.args.step:t._blackboxRoot?Common.UIString.UIString("Blackboxed"):this._performanceModel.timelineModel().isMarkerEvent(t)?TimelineUIUtils.markerShortTitle(t):TimelineUIUtils.eventTitle(t)}if(n===t.ExtensionEvent){return this._entryData[e].name}if(n===t.Screenshot)return"";let i=this._entryIndexToTitle[e];return i||(i=Common.UIString.UIString("Unexpected entryIndex %d",e),console.error(i)),i}textColor(e){const t=this._entryData[e];return t&&t._blackboxRoot?"#888":FlameChartStyle.textColor}entryFont(e){return this._font}reset(){this._currentLevel=0,this._timelineData=null,this._entryData=[],this._entryParent=[],this._entryTypeByLevel=[],this._entryIndexToTitle=[],this._markers=[],this._asyncColorByCategory=new Map,this._asyncColorByInteractionPhase=new Map,this._extensionInfo=[],this._screenshotImageCache=new Map}maxStackDepth(){return this._currentLevel}timelineData(){return this._timelineData?this._timelineData:(this._timelineData=new PerfUI.FlameChart.TimelineData([],[],[],[]),this._model?(this._flowEventIndexById.clear(),this._minimumBoundary=this._model.minimumRecordTime(),this._timeSpan=this._model.isEmpty()?1e3:this._model.maximumRecordTime()-this._minimumBoundary,this._currentLevel=0,this._model.isGenericTrace()?this._processGenericTrace():this._processInspectorTrace(),this._timelineData):this._timelineData)}_processGenericTrace(){const e=this._buildGroupStyle({shareHeaderLine:!1}),t=this._buildGroupStyle({padding:2,nestingLevel:1,shareHeaderLine:!1}),n=EntryType.Event,i=new Platform.Multimap;for(const e of this._model.tracks())null!==e.thread?i.set(e.thread.process(),e):console.error("Failed to process track");for(const r of i.keysArray()){if(i.size>1){const t=`${r.name()} ${r.id()}`;this._appendHeader(t,e,!1)}for(const e of i.get(r)){const i=this._appendSyncEvents(e,e.events,e.name,t,n,!0);this._timelineData.selectedGroup&&e.name!==TimelineModel.TimelineModel.TimelineModelImpl.BrowserMainThreadName||(this._timelineData.selectedGroup=i)}}}_processInspectorTrace(){this._appendFrames(),this._appendInteractionRecords();const e=EntryType.Event,t=e=>{switch(e.type){case TimelineModel.TimelineModel.TrackType.Input:return 0;case TimelineModel.TimelineModel.TrackType.Animation:return 1;case TimelineModel.TimelineModel.TrackType.Timings:return 2;case TimelineModel.TimelineModel.TrackType.Console:return 3;case TimelineModel.TimelineModel.TrackType.Experience:return 4;case TimelineModel.TimelineModel.TrackType.MainThread:return e.forMainFrame?5:6;case TimelineModel.TimelineModel.TrackType.Worker:return 7;case TimelineModel.TimelineModel.TrackType.Raster:return 8;case TimelineModel.TimelineModel.TrackType.GPU:return 9;case TimelineModel.TimelineModel.TrackType.Other:return 10}},n=this._model.tracks().slice();n.sort((e,n)=>t(e)-t(n));let i=0;for(const t of n)switch(t.type){case TimelineModel.TimelineModel.TrackType.Input:this._appendAsyncEventsGroup(t,ls`Input`,t.asyncEvents,this._interactionsHeaderLevel2,e,!1);break;case TimelineModel.TimelineModel.TrackType.Animation:this._appendAsyncEventsGroup(t,ls`Animation`,t.asyncEvents,this._interactionsHeaderLevel2,e,!1);break;case TimelineModel.TimelineModel.TrackType.Timings:{const n=t.asyncEvents.length>0?this._collapsibleTimingsHeader:this._timingsHeader;this._appendHeader(ls`Timings`,n,!0)._track=t,this._appendPageMetrics(),this._appendAsyncEventsGroup(t,null,t.asyncEvents,n,e,!0);break}case TimelineModel.TimelineModel.TrackType.Console:this._appendAsyncEventsGroup(t,ls`Console`,t.asyncEvents,this._headerLevel1,e,!0);break;case TimelineModel.TimelineModel.TrackType.MainThread:if(t.forMainFrame){const n=this._appendSyncEvents(t,t.events,t.url?ls`Main \u2014 ${t.url}`:ls`Main`,this._headerLevel1,e,!0);n&&(this._timelineData.selectedGroup=n)}else this._appendSyncEvents(t,t.events,t.url?ls`Frame \u2014 ${t.url}`:ls`Subframe`,this._headerLevel1,e,!0);break;case TimelineModel.TimelineModel.TrackType.Worker:this._appendSyncEvents(t,t.events,t.name,this._headerLevel1,e,!0);break;case TimelineModel.TimelineModel.TrackType.Raster:i||this._appendHeader(ls`Raster`,this._headerLevel1,!1),++i,this._appendSyncEvents(t,t.events,ls`Rasterizer Thread ${i}`,this._headerLevel2,e,!0);break;case TimelineModel.TimelineModel.TrackType.GPU:this._appendSyncEvents(t,t.events,ls`GPU`,this._headerLevel1,e,!0);break;case TimelineModel.TimelineModel.TrackType.Other:this._appendSyncEvents(t,t.events,t.name||ls`Thread`,this._headerLevel1,e,!0),this._appendAsyncEventsGroup(t,t.name,t.asyncEvents,this._headerLevel1,e,!0);break;case TimelineModel.TimelineModel.TrackType.Experience:this._appendSyncEvents(t,t.events,ls`Experience`,this._experienceHeader,e,!0)}this._timelineData.selectedGroup&&(this._timelineData.selectedGroup.expanded=!0);for(let e=0;e<this._extensionInfo.length;e++)this._innerAppendExtensionEvents(e);this._markers.sort((e,t)=>e.startTime()-t.startTime()),this._timelineData.markers=this._markers,this._flowEventIndexById.clear()}minimumBoundary(){return this._minimumBoundary}totalTime(){return this._timeSpan}search(e,t,n){const i=[],r=EntryType;this.timelineData();for(let s=0;s<this._entryData.length;++s){if(this._entryType(s)!==r.Event)continue;const a=this._entryData[s];a.startTime>t||((a.endTime||a.startTime)<e||n.accept(a)&&i.push(s))}return i.sort((e,t)=>SDK.TracingModel.Event.compareStartTime(this._entryData[e],this._entryData[t])),i}_appendSyncEvents(e,t,n,i,r,s){if(!t.length)return null;const a=r===EntryType.ExtensionEvent,l=[],o=Root.Runtime.experiments.isEnabled("timelineFlowEvents"),m=!a&&Root.Runtime.experiments.isEnabled("blackboxJSFramesOnTimeline");let h=0,c=null;e&&e.type===TimelineModel.TimelineModel.TrackType.MainThread&&(c=this._appendHeader(n,i,s),c._track=e);for(let r=0;r<t.length;++r){const d=t[r];if(this._performanceModel){const t=this._performanceModel.timelineModel().isInteractiveTimeEvent(d),n=this._performanceModel.timelineModel().isLayoutShiftEvent(d),i=t||n;if(e&&e.type===TimelineModel.TimelineModel.TrackType.MainThread&&i)continue}if(this._performanceModel&&this._performanceModel.timelineModel().isLayoutShiftEvent(d))for(const e of this._performanceModel.frames()){void 0===d.endTime&&d.setEndTime(d.startTime);const t=d.startTime>=e.startTime,n=d.endTime&&d.endTime<=e.endTime;t&&n&&(d.startTime=e.startTime,d.setEndTime(e.endTime))}if(!a&&this._performanceModel.timelineModel().isMarkerEvent(d)&&this._markers.push(new TimelineFlameChartMarker(d.startTime,d.startTime-this._model.minimumRecordTime(),TimelineUIUtils.markerStyleForEvent(d))),!SDK.TracingModel.TracingModel.isFlowPhase(d.phase)){if(!d.endTime&&d.phase!==SDK.TracingModel.Phase.Instant)continue;if(SDK.TracingModel.TracingModel.isAsyncPhase(d.phase))continue;if(!a&&!this._performanceModel.isVisible(d))continue}for(;l.length&&l.peekLast().endTime<=d.startTime;)l.pop();if(d._blackboxRoot=!1,m&&this._isBlackboxedEvent(d)){const e=l.peekLast();if(e&&e._blackboxRoot)continue;d._blackboxRoot=!0}c||(c=this._appendHeader(n,i,s),s&&(c._track=e));const p=this._currentLevel+l.length;o&&this._appendFlowEvent(d,p);const T=this._appendEvent(d,p);l.length&&(this._entryParent[T]=l.peekLast()),!a&&this._performanceModel.timelineModel().isMarkerEvent(d)&&(this._timelineData.entryTotalTimes[this._entryData.length]=void 0),h=Math.max(h,l.length+1),d.endTime&&l.push(d)}return this._entryTypeByLevel.length=this._currentLevel+h,this._entryTypeByLevel.fill(r,this._currentLevel),this._currentLevel+=h,c}_isBlackboxedEvent(e){if(e.name!==TimelineModel.TimelineModel.RecordType.JSFrame)return!1;const t=e.args.data.url;return t&&this._isBlackboxedURL(t)}_isBlackboxedURL(e){return Bindings.BlackboxManager.BlackboxManager.instance().isBlackboxedURL(e)}_appendAsyncEventsGroup(e,t,n,i,r,s){if(!n.length)return null;const a=[];let l=null;for(let r=0;r<n.length;++r){const o=n[r];if(!this._performanceModel.isVisible(o))continue;!l&&t&&(l=this._appendHeader(t,i,s),s&&(l._track=e));const m=o.startTime;let h;for(h=0;h<a.length&&a[h]>m;++h);this._appendAsyncEvent(o,this._currentLevel+h),a[h]=o.endTime}return this._entryTypeByLevel.length=this._currentLevel+a.length,this._entryTypeByLevel.fill(r,this._currentLevel),this._currentLevel+=a.length,l}_appendInteractionRecords(){const e=this._performanceModel.interactionRecords();if(e.length){this._appendHeader(ls`Interactions`,this._interactionsHeaderLevel1,!1);for(const t of e){const e=this._entryData.length;this._entryData.push(t.data),this._entryIndexToTitle[e]=t.data,this._timelineData.entryLevels[e]=this._currentLevel,this._timelineData.entryTotalTimes[e]=t.end-t.begin,this._timelineData.entryStartTimes[e]=t.begin}this._entryTypeByLevel[this._currentLevel++]=EntryType.InteractionRecord}}_appendPageMetrics(){this._entryTypeByLevel[this._currentLevel]=EntryType.Event;const e=[],t=[],n=this._performanceModel.timelineModel();for(const i of this._model.tracks())for(const r of i.events)n.isMarkerEvent(r)&&(n.isLCPCandidateEvent(r)||n.isLCPInvalidateEvent(r)?t.push(r):e.push(r));if(t.length>0){const i=new Map;for(const e of t){const t=e.args.data.navigationId,n=i.get(t);(!n||n.args.data.candidateIndex<e.args.data.candidateIndex)&&i.set(t,e)}const r=Array.from(i.values()).filter(e=>n.isLCPCandidateEvent(e));e.push(...r)}e.sort(SDK.TracingModel.Event.compareStartTime);const i=this._timelineData.entryTotalTimes;for(const t of e)this._appendEvent(t,this._currentLevel),i[i.length-1]=Number.NaN;++this._currentLevel}_appendFrames(){const e=this._performanceModel.filmStripModel().frames(),t=!!e.length;this._framesHeader.collapsible=t,this._appendHeader(Common.UIString.UIString("Frames"),this._framesHeader,!1),this._frameGroup=this._timelineData.groups.peekLast();const n=TimelineUIUtils.markerStyleForFrame();this._entryTypeByLevel[this._currentLevel]=EntryType.Frame;for(const e of this._performanceModel.frames())this._markers.push(new TimelineFlameChartMarker(e.startTime,e.startTime-this._model.minimumRecordTime(),n)),this._appendFrame(e);if(++this._currentLevel,!t)return;let i;this._appendHeader("",this._screenshotsHeader,!1),this._entryTypeByLevel[this._currentLevel]=EntryType.Screenshot;for(const t of e)this._entryData.push(t),this._timelineData.entryLevels.push(this._currentLevel),this._timelineData.entryStartTimes.push(t.timestamp),i&&this._timelineData.entryTotalTimes.push(t.timestamp-i),i=t.timestamp;e.length&&this._timelineData.entryTotalTimes.push(this._model.maximumRecordTime()-i),++this._currentLevel}_entryType(e){return this._entryTypeByLevel[this._timelineData.entryLevels[e]]}prepareHighlightedEntryInfo(e){let t,n,i="";const r=this._entryType(e);if(r===EntryType.Event){const r=this._entryData[e],s=r.duration,a=r.selfTime,l=1e-6;if("number"==typeof s&&(i=Math.abs(s-a)>l&&a>l?Common.UIString.UIString("%s (self %s)",Number.millisToString(s,!0),Number.millisToString(a,!0)):Number.millisToString(s,!0)),t=this._performanceModel.timelineModel().isMarkerEvent(r)?TimelineUIUtils.eventTitle(r):this.entryTitle(e),n=TimelineUIUtils.eventWarning(r),this._model&&this._model.isLayoutShiftEvent(r)){i=ls`Occurrences: ${1}`}if(this._model&&this._model.isParseHTMLEvent(r)){const e=r.args.beginData.startLine,n=r.args.endData&&r.args.endData.endLine;t+=` - ${Bindings.ResourceUtils.displayNameForURL(r.args.beginData.url)} [${-1!==n||n===e?`${e}...${n}`:e}]`}}else{if(r!==EntryType.Frame)return null;{const r=this._entryData[e];i=Common.UIString.UIString("%s ~ %.0f fps",Number.preciseMillisToString(r.duration,1),1e3/r.duration),t=r.idle?Common.UIString.UIString("Idle Frame"):Common.UIString.UIString("Frame"),r.hasWarnings()&&(n=createElement("span"),n.textContent=Common.UIString.UIString("Long frame"))}}const s=createElement("div"),a=UI.Utils.createShadowRootWithCoreStyles(s,"timeline/timelineFlamechartPopover.css").createChild("div","timeline-flamechart-popover");return a.createChild("span","timeline-info-time").textContent=i,a.createChild("span","timeline-info-title").textContent=t,n&&(n.classList.add("timeline-info-warning"),a.appendChild(n)),s}entryColor(e){function t(e,t,n){let i=e.get(t);if(i)return i;return i=Common.Color.Color.parse(n(t)).setAlpha(.7).asString(Common.Color.Format.RGBA)||"",e.set(t,i),i}const n=EntryType,i=this._entryType(e);if(i===n.Event){const n=this._entryData[e];if(this._model.isGenericTrace())return this._genericTraceEventColor(n);if(this._performanceModel.timelineModel().isMarkerEvent(n))return TimelineUIUtils.markerStyleForEvent(n).color;if(!SDK.TracingModel.TracingModel.isAsyncPhase(n.phase))return this._colorForEvent(n);if(n.hasCategory(TimelineModel.TimelineModel.TimelineModelImpl.Category.Console)||n.hasCategory(TimelineModel.TimelineModel.TimelineModelImpl.Category.UserTiming))return this._consoleColorGenerator.colorForID(n.name);if(n.hasCategory(TimelineModel.TimelineModel.TimelineModelImpl.Category.LatencyInfo)){const e=TimelineModel.TimelineIRModel.TimelineIRModel.phaseForEvent(n)||TimelineModel.TimelineIRModel.Phases.Uncategorized;return t(this._asyncColorByInteractionPhase,e,TimelineUIUtils.interactionPhaseColor)}const i=TimelineUIUtils.eventStyle(n).category;return t(this._asyncColorByCategory,i,()=>i.color)}if(i===n.Frame)return"white";if(i===n.InteractionRecord)return"transparent";if(i===n.ExtensionEvent){const t=this._entryData[e];return this._extensionColorGenerator.colorForID(t.name)}return""}_genericTraceEventColor(e){const t=e.categoriesString||e.name;return t?`hsl(${String.hashCode(t)%300+30}, 40%, 70%)`:"#ccc"}_drawFrame(e,t,n,i,r,s,a){const l=this._entryData[e];i+=1,s-=2,t.fillStyle=l.idle?"white":l.hasWarnings()?"#fad1d1":"#d7f0d1",t.fillRect(i,r,s,a);const o=Number.preciseMillisToString(l.duration,1),m=t.measureText(o).width;m<=s&&(t.fillStyle=this.textColor(e),t.fillText(o,i+(s-m)/2,r+a-4))}async _drawScreenshot(e,t,n,i,r,s){const a=this._entryData[e];if(!this._screenshotImageCache.has(a)){this._screenshotImageCache.set(a,null);const e=await a.imageDataPromise(),t=await UI.UIUtils.loadImageFromData(e);return this._screenshotImageCache.set(a,t),void this.dispatchEventToListeners(Events.DataChanged)}const l=this._screenshotImageCache.get(a);if(!l)return;const o=n+1,m=i+1,h=s-2,c=h/l.naturalHeight,d=Math.floor(l.naturalWidth*c);t.save(),t.beginPath(),t.rect(n,i,r,s),t.clip(),t.drawImage(l,o,m,d,h),t.strokeStyle="#ccc",t.strokeRect(o-.5,m-.5,Math.min(r-1,d+1),h),t.restore()}decorateEntry(e,t,n,i,r,s,a,l,o){const m=this._entryData[e],h=this._entryType(e),c=EntryType;if(h===c.Frame)return this._drawFrame(e,t,n,i,r,s,a),!0;if(h===c.Screenshot)return this._drawScreenshot(e,t,i,r,s,a),!0;if(h===c.InteractionRecord){const e=TimelineUIUtils.interactionPhaseColor(m);return t.fillStyle=e,t.fillRect(i,r,s-1,2),t.fillRect(i,r-3,2,3),t.fillRect(i+s-3,r-3,2,3),!1}if(h===c.Event){const e=m;if(e.hasCategory(TimelineModel.TimelineModel.TimelineModelImpl.Category.LatencyInfo)){const n=TimelineModel.TimelineModel.TimelineData.forEvent(e).timeWaitingForMainThread;if(n){t.fillStyle="hsla(0, 70%, 60%, 1)";const e=Math.floor(l-i+n*o);t.fillRect(i,r+a-3,e,2)}}TimelineModel.TimelineModel.TimelineData.forEvent(e).warning&&(d=i,p=s-1.5,t.save(),t.beginPath(),t.rect(d,r,p,a),t.clip(),t.beginPath(),t.fillStyle="red",t.moveTo(d+p-8,r),t.lineTo(d+p,r),t.lineTo(d+p,r+8),t.fill(),t.restore())}var d,p;return!1}forceDecoration(e){const t=EntryType,n=this._entryType(e);if(n===t.Frame)return!0;if(n===t.Screenshot)return!0;if(n===t.Event){const t=this._entryData[e];return!!TimelineModel.TimelineModel.TimelineData.forEvent(t).warning}return!1}appendExtensionEvents(e){this._extensionInfo.push(e),this._timelineData&&this._innerAppendExtensionEvents(this._extensionInfo.length-1)}_innerAppendExtensionEvents(e){const t=this._extensionInfo[e],n=EntryType.ExtensionEvent,i=[].concat(...t.model.sortedProcesses().map(e=>e.sortedThreads()));if(!i.length)return;const r=!(1!==i.length||i[0].events().length&&i[0].asyncEvents().length);r||this._appendHeader(t.title,this._headerLevel1,!1);const s=r?this._headerLevel2:this._headerLevel1;let a=0;for(const e of i){const i=r?t.title:e.name()||ls`Thread ${++a}`;this._appendAsyncEventsGroup(null,i,e.asyncEvents(),s,n,!1),this._appendSyncEvents(null,e.events(),i,s,n,!1)}}_appendHeader(e,t,n){const i={startLevel:this._currentLevel,name:e,style:t,selectable:n};return this._timelineData.groups.push(i),i}_appendEvent(e,t){const n=this._entryData.length;return this._entryData.push(e),this._timelineData.entryLevels[n]=t,this._timelineData.entryTotalTimes[n]=e.duration||InstantEventVisibleDurationMs,this._timelineData.entryStartTimes[n]=e.startTime,e[indexSymbol]=n,n}_appendAsyncEvent(e,t){if(SDK.TracingModel.TracingModel.isNestableAsyncPhase(e.phase))return void this._appendEvent(e,t);const n=e.steps,i=n.length>1&&n[1].phase===SDK.TracingModel.Phase.AsyncStepPast?1:0;for(let e=0;e<n.length-1;++e){const r=this._entryData.length;this._entryData.push(n[e+i]);const s=n[e].startTime;this._timelineData.entryLevels[r]=t,this._timelineData.entryTotalTimes[r]=n[e+1].startTime-s,this._timelineData.entryStartTimes[r]=s}}_appendFlowEvent(e,t){const n=this._timelineData;function i(e){const i=n.flowStartTimes.length;return n.flowStartTimes.push(e.startTime),n.flowStartLevels.push(t),i}function r(e,i){n.flowEndTimes[i]=e.startTime,n.flowEndLevels[i]=t}const s=e.id;if(s)switch(e.phase){case SDK.TracingModel.Phase.FlowBegin:this._flowEventIndexById.set(s,i(e));break;case SDK.TracingModel.Phase.FlowStep:r(e,this._flowEventIndexById.get(s)),this._flowEventIndexById.set(s,i(e));break;case SDK.TracingModel.Phase.FlowEnd:r(e,this._flowEventIndexById.get(s)),this._flowEventIndexById.delete(s)}}_appendFrame(e){const t=this._entryData.length;this._entryData.push(e),this._entryIndexToTitle[t]=Number.millisToString(e.duration,!0),this._timelineData.entryLevels[t]=this._currentLevel,this._timelineData.entryTotalTimes[t]=e.duration,this._timelineData.entryStartTimes[t]=e.startTime}createSelection(e){const t=this._entryType(e);let n=null;return t===EntryType.Event?n=TimelineSelection.fromTraceEvent(this._entryData[e]):t===EntryType.Frame&&(n=TimelineSelection.fromFrame(this._entryData[e])),n&&(this._lastSelection=new Selection(n,e)),n}formatValue(e,t){return Number.preciseMillisToString(e,t)}canJumpToEntry(e){return!1}entryIndexForSelection(e){if(!e||e.type()===TimelineSelection.Type.Range)return-1;if(this._lastSelection&&this._lastSelection.timelineSelection.object()===e.object())return this._lastSelection.entryIndex;const t=this._entryData.indexOf(e.object());return-1!==t&&(this._lastSelection=new Selection(e,t)),t}buildFlowForInitiator(e){if(this._lastInitiatorEntry===e)return!1;this._lastInitiatorEntry=e;let t=this.eventByIndex(e);const n=this._timelineData;for(n.flowStartTimes=[],n.flowStartLevels=[],n.flowEndTimes=[],n.flowEndLevels=[];t;){let e;for(;t&&(e=TimelineModel.TimelineModel.TimelineData.forEvent(t).initiator(),!e);t=this._eventParent(t));if(!e)break;const i=t[indexSymbol],r=e[indexSymbol];n.flowStartTimes.push(e.endTime||e.startTime),n.flowStartLevels.push(n.entryLevels[r]),n.flowEndTimes.push(t.startTime),n.flowEndLevels.push(n.entryLevels[i]),t=e}return!0}_eventParent(e){return this._entryParent[e[indexSymbol]]||null}eventByIndex(e){return e>=0&&this._entryType(e)===EntryType.Event?this._entryData[e]:null}setEventColorMapping(e){this._colorForEvent=e}}export const InstantEventVisibleDurationMs=.001;export const indexSymbol=Symbol("index");export const Events={DataChanged:Symbol("DataChanged")};export const EntryType={Frame:Symbol("Frame"),Event:Symbol("Event"),InteractionRecord:Symbol("InteractionRecord"),ExtensionEvent:Symbol("ExtensionEvent"),Screenshot:Symbol("Screenshot")};