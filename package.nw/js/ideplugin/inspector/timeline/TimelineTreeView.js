import*as Common from"../common/common.js";import*as Components from"../components/components.js";import*as DataGrid from"../data_grid/data_grid.js";import*as Platform from"../platform/platform.js";import*as SDK from"../sdk/sdk.js";import*as TimelineModel from"../timeline_model/timeline_model.js";import*as UI from"../ui/ui.js";import{PerformanceModel}from"./PerformanceModel.js";import{TimelineRegExp}from"./TimelineFilters.js";import{TimelineSelection}from"./TimelinePanel.js";import{TimelineUIUtils}from"./TimelineUIUtils.js";export class TimelineTreeView extends UI.Widget.VBox{constructor(){super(),this._model=null,this._track=null,this._tree=null,this.element.classList.add("timeline-tree-view")}static eventNameForSorting(e){if(e.name===TimelineModel.TimelineModel.RecordType.JSFrame){const t=e.args.data;return t.functionName+"@"+(t.scriptId||t.url||"")}return e.name+":@"+TimelineModel.TimelineProfileTree.eventURL(e)}setSearchableView(e){this._searchableView=e}setModel(e,t){this._model=e,this._track=t,this.refreshTree()}getToolbarInputAccessiblePlaceHolder(){return""}model(){return this._model}init(){this._linkifier=new Components.Linkifier.Linkifier,this._taskFilter=new TimelineModel.TimelineModelFilter.ExclusiveNameFilter([TimelineModel.TimelineModel.RecordType.Task]),this._textFilter=new TimelineRegExp,this._currentThreadSetting=Common.Settings.Settings.instance().createSetting("timelineTreeCurrentThread",0),this._currentThreadSetting.addChangeListener(this.refreshTree,this);const e=[];this.populateColumns(e),this._splitWidget=new UI.SplitWidget.SplitWidget(!0,!0,"timelineTreeViewDetailsSplitWidget");const t=new UI.Widget.VBox,i=new UI.Toolbar.Toolbar("",t.element);this.populateToolbar(i),this._dataGrid=new DataGrid.SortableDataGrid.SortableDataGrid({displayName:ls`Performance`,columns:e}),this._dataGrid.addEventListener(DataGrid.DataGrid.Events.SortingChanged,this._sortingChanged,this),this._dataGrid.element.addEventListener("mousemove",this._onMouseMove.bind(this),!0),this._dataGrid.setResizeMethod(DataGrid.DataGrid.ResizeMethod.Last),this._dataGrid.setRowContextMenuCallback(this._onContextMenu.bind(this)),this._dataGrid.asWidget().show(t.element),this._dataGrid.addEventListener(DataGrid.DataGrid.Events.SelectedNode,this._updateDetailsForSelection,this),this._detailsView=new UI.Widget.VBox,this._detailsView.element.classList.add("timeline-details-view","timeline-details-view-body"),this._splitWidget.setMainWidget(t),this._splitWidget.setSidebarWidget(this._detailsView),this._splitWidget.hideSidebar(),this._splitWidget.show(this.element),this._splitWidget.addEventListener(UI.SplitWidget.Events.ShowModeChanged,this._onShowModeChanged,this),this._lastSelectedNode}lastSelectedNode(){return this._lastSelectedNode}updateContents(e){this.setRange(e.startTime(),e.endTime())}setRange(e,t){this._startTime=e,this._endTime=t,this.refreshTree()}filters(){return[this._taskFilter,this._textFilter,...this._model.filters()]}filtersWithoutTextFilter(){return[this._taskFilter,...this._model.filters()]}textFilter(){return this._textFilter}_exposePercentages(){return!1}populateToolbar(e){this._textFilterUI=new UI.Toolbar.ToolbarInput(Common.UIString.UIString("Filter"),this.getToolbarInputAccessiblePlaceHolder()),this._textFilterUI.addEventListener(UI.Toolbar.ToolbarInput.Event.TextChanged,(function(){const e=this._textFilterUI.value();this._textFilter.setRegExp(e?createPlainTextSearchRegex(e,"i"):null),this.refreshTree()}),this),e.appendToolbarItem(this._textFilterUI)}_modelEvents(){return this._track?this._track.syncEvents():[]}_onHover(e){}_appendContextMenuItems(e,t){}_linkifyLocation(e){const t=this._model.timelineModel().targetByEvent(e);if(!t)return null;const i=TimelineModel.TimelineProfileTree.eventStackFrame(e);return i?this._linkifier.maybeLinkifyConsoleCallFrame(t,i):null}selectProfileNode(e,t){const i=[];for(let t=e;t;t=t.parent)i.push(t);for(let e=i.length-1;e>0;--e){const t=this.dataGridNodeForTreeNode(i[e]);t&&t.dataGrid&&t.expand()}const r=this.dataGridNodeForTreeNode(e);r.dataGrid&&(r.reveal(),r.select(t))}refreshTree(){if(this._linkifier.reset(),this._dataGrid.rootNode().removeChildren(),!this._model)return void this._updateDetailsForSelection();this._root=this._buildTree();const e=this._root.children();let t=0,i=0;const r=this._root.totalTime-this._root.selfTime;for(const r of e.values())t=Math.max(t,r.selfTime),i=Math.max(i,r.totalTime);for(const n of e.values()){const e=new TreeGridNode(n,r,t,i,this);this._dataGrid.insertChild(e)}this._sortingChanged(),this._updateDetailsForSelection(),this._searchableView&&this._searchableView.refreshSearch();const n=this._dataGrid.rootNode();n.children.length>0&&n.children[0].select(!0)}_buildTree(){throw new Error("Not Implemented")}buildTopDownTree(e,t){return new TimelineModel.TimelineProfileTree.TopDownRootNode(this._modelEvents(),this.filters(),this._startTime,this._endTime,e,t)}populateColumns(e){e.push({id:"self",title:Common.UIString.UIString("Self Time"),width:"120px",fixedWidth:!0,sortable:!0}),e.push({id:"total",title:Common.UIString.UIString("Total Time"),width:"120px",fixedWidth:!0,sortable:!0}),e.push({id:"activity",title:Common.UIString.UIString("Activity"),disclosure:!0,sortable:!0})}_sortingChanged(){const e=this._dataGrid.sortColumnId();if(!e)return;let t;switch(e){case"startTime":t=function(e,t){const i=t;return e._profileNode.event.startTime-i._profileNode.event.startTime};break;case"self":t=i.bind(null,"selfTime");break;case"total":t=i.bind(null,"totalTime");break;case"activity":t=function(e,t){const i=e,r=t,n=TimelineTreeView.eventNameForSorting(i._profileNode.event),o=TimelineTreeView.eventNameForSorting(r._profileNode.event);return n.localeCompare(o)};break;default:return void console.assert(!1,"Unknown sort field: "+e)}function i(e,t,i){const r=i;return t._profileNode[e]-r._profileNode[e]}this._dataGrid.sortNodes(t,!this._dataGrid.isSortOrderAscending())}_onShowModeChanged(){this._splitWidget.showMode()!==UI.SplitWidget.ShowMode.OnlyMain&&(this._lastSelectedNode=void 0,this._updateDetailsForSelection())}_updateDetailsForSelection(){const e=this._dataGrid.selectedNode?this._dataGrid.selectedNode._profileNode:null;if(e===this._lastSelectedNode)return;if(this._lastSelectedNode=e,this._splitWidget.showMode()===UI.SplitWidget.ShowMode.OnlyMain)return;if(this._detailsView.detachChildWidgets(),this._detailsView.element.removeChildren(),e&&this._showDetailsForNode(e))return;this._detailsView.element.createChild("div","full-widget-dimmed-banner").createTextChild(Common.UIString.UIString("Select item for details."))}_showDetailsForNode(e){return!1}_onMouseMove(e){const t=e.target&&e.target instanceof Node?this._dataGrid.dataGridNodeFromNode(e.target):null,i=t&&t._profileNode;i!==this._lastHoveredProfileNode&&(this._lastHoveredProfileNode=i,this._onHover(i))}_onContextMenu(e,t){t._linkElement&&!e.containsTarget(t._linkElement)&&e.appendApplicableItems(t._linkElement);const i=t._profileNode;i&&this._appendContextMenuItems(e,i)}dataGridNodeForTreeNode(e){return e[TreeGridNode._gridNodeSymbol]||null}searchCanceled(){this._searchResults=[],this._currentResult=0}performSearch(e,t,i){if(this._searchResults=[],this._currentResult=0,!this._root)return;const r=e.toSearchRegex();this._searchResults=this._root.searchTree(e=>TimelineUIUtils.testContentMatching(e,r)),this._searchableView.updateSearchMatchesCount(this._searchResults.length)}jumpToNextSearchResult(){this._searchResults.length&&(this.selectProfileNode(this._searchResults[this._currentResult],!1),this._currentResult=Platform.NumberUtilities.mod(this._currentResult+1,this._searchResults.length))}jumpToPreviousSearchResult(){this._searchResults.length&&(this.selectProfileNode(this._searchResults[this._currentResult],!1),this._currentResult=Platform.NumberUtilities.mod(this._currentResult-1,this._searchResults.length))}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!0}}export class GridNode extends DataGrid.SortableDataGrid.SortableDataGridNode{constructor(e,t,i,r,n){super(null,!1),this._populated=!1,this._profileNode=e,this._treeView=n,this._grandTotalTime=t,this._maxSelfTime=i,this._maxTotalTime=r,this._linkElement=null}createCell(e){return"activity"===e?this._createNameCell(e):this._createValueCell(e)||super.createCell(e)}_createNameCell(e){const t=this.createTD(e),i=t.createChild("div","name-container"),r=i.createChild("div","activity-icon-container"),n=r.createChild("div","activity-icon"),o=i.createChild("div","activity-name"),s=this._profileNode.event;if(this._profileNode.isGroupNode()){const e=this._treeView._displayInfoForGroupNode(this._profileNode);o.textContent=e.name,n.style.backgroundColor=e.color,e.icon&&r.insertBefore(e.icon,n)}else if(s){const e=s.args.data,t=e&&e.deoptReason;t&&(i.createChild("div","activity-warning").title=Common.UIString.UIString("Not optimized: %s",t)),o.textContent=TimelineUIUtils.eventTitle(s),this._linkElement=this._treeView._linkifyLocation(s),this._linkElement&&i.createChild("div","activity-link").appendChild(this._linkElement);const r=TimelineUIUtils.eventStyle(s).category;UI.ARIAUtils.setAccessibleName(n,r.title),n.style.backgroundColor=r.color}return t}_createValueCell(e){if("self"!==e&&"total"!==e&&"startTime"!==e)return null;let t,i,r=!1;switch(e){case"startTime":t=this._profileNode.event.startTime-this._treeView._model.timelineModel().minimumRecordTime();break;case"self":t=this._profileNode.selfTime,i=this._maxSelfTime,r=!0;break;case"total":t=this._profileNode.totalTime,i=this._maxTotalTime,r=!0;break;default:return null}const n=this.createTD(e);n.className="numeric-column";const o=n.createChild("div");return o.createChild("span").textContent=Common.UIString.UIString("%.1f ms",t),r&&this._treeView._exposePercentages()&&(o.createChild("span","percent-column").textContent=Common.UIString.UIString("%.1f %%",t/this._grandTotalTime*100)),i&&(o.classList.add("background-percent-bar"),n.createChild("div","background-bar-container").createChild("div","background-bar").style.width=(100*t/i).toFixed(1)+"%"),n}}export class TreeGridNode extends GridNode{constructor(e,t,i,r,n){super(e,t,i,r,n),this.setHasChildren(this._profileNode.hasChildren()),e[TreeGridNode._gridNodeSymbol]=this}populate(){if(!this._populated&&(this._populated=!0,this._profileNode.children))for(const e of this._profileNode.children().values()){const t=new TreeGridNode(e,this._grandTotalTime,this._maxSelfTime,this._maxTotalTime,this._treeView);this.insertChildOrdered(t)}}}TreeGridNode._gridNodeSymbol=Symbol("treeGridNode");export class AggregatedTimelineTreeView extends TimelineTreeView{constructor(){super(),this._groupBySetting=Common.Settings.Settings.instance().createSetting("timelineTreeGroupBy",AggregatedTimelineTreeView.GroupBy.None),this._groupBySetting.addChangeListener(this.refreshTree.bind(this)),this.init(),this._stackView=new TimelineStackView(this),this._stackView.addEventListener(TimelineStackView.Events.SelectionChanged,this._onStackViewSelectionChanged,this),this._productByURLCache=new Map,this._colorByURLCache=new Map}setModel(e,t){super.setModel(e,t)}updateContents(e){this._updateExtensionResolver(),super.updateContents(e);const t=this._dataGrid.rootNode();t.children.length&&t.children[0].select(!0)}_updateExtensionResolver(){this._executionContextNamesByOrigin=new Map;for(const e of SDK.SDKModel.TargetManager.instance().models(SDK.RuntimeModel.RuntimeModel))for(const t of e.executionContexts())this._executionContextNamesByOrigin.set(t.origin,t.name)}_beautifyDomainName(e){return AggregatedTimelineTreeView._isExtensionInternalURL(e)?e=Common.UIString.UIString("[Chrome extensions overhead]"):AggregatedTimelineTreeView._isV8NativeURL(e)?e=Common.UIString.UIString("[V8 Runtime]"):e.startsWith("chrome-extension")&&(e=this._executionContextNamesByOrigin.get(e)||e),e}_displayInfoForGroupNode(e){const t=TimelineUIUtils.categories(),i=e.id?TimelineUIUtils.eventColor(e.event):t.other.color,r=Common.UIString.UIString("[unattributed]"),n="symbol"==typeof e.id?void 0:e.id;switch(this._groupBySetting.get()){case AggregatedTimelineTreeView.GroupBy.Category:{const e=n?t[n]||t.other:r;return{name:e.title,color:e.color}}case AggregatedTimelineTreeView.GroupBy.Domain:case AggregatedTimelineTreeView.GroupBy.Subdomain:return{name:(n?this._beautifyDomainName(n):void 0)||r,color:i};case AggregatedTimelineTreeView.GroupBy.EventName:return{name:e.event.name===TimelineModel.TimelineModel.RecordType.JSFrame?Common.UIString.UIString("JavaScript"):TimelineUIUtils.eventTitle(e.event),color:e.event.name===TimelineModel.TimelineModel.RecordType.JSFrame?TimelineUIUtils.eventStyle(e.event).category.color:i};case AggregatedTimelineTreeView.GroupBy.URL:break;case AggregatedTimelineTreeView.GroupBy.Frame:{const e=n?this._model.timelineModel().pageFrameById(n):void 0;return{name:e?TimelineUIUtils.displayNameForFrame(e,80):Common.UIString.UIString("Page"),color:i}}default:console.assert(!1,"Unexpected grouping type")}return{name:n||r,color:i}}populateToolbar(e){super.populateToolbar(e);const t=AggregatedTimelineTreeView.GroupBy,i=[{label:Common.UIString.UIString("No Grouping"),value:t.None},{label:Common.UIString.UIString("Group by Activity"),value:t.EventName},{label:Common.UIString.UIString("Group by Category"),value:t.Category},{label:Common.UIString.UIString("Group by Domain"),value:t.Domain},{label:Common.UIString.UIString("Group by Frame"),value:t.Frame},{label:Common.UIString.UIString("Group by Subdomain"),value:t.Subdomain},{label:Common.UIString.UIString("Group by URL"),value:t.URL}];e.appendToolbarItem(new UI.Toolbar.ToolbarSettingComboBox(i,this._groupBySetting,ls`Group by`)),e.appendSpacer(),e.appendToolbarItem(this._splitWidget.createShowHideSidebarButton(Common.UIString.UIString("heaviest stack")))}_buildHeaviestStack(e){console.assert(!!e.parent,"Attempt to build stack for tree root");let t=[];for(let i=e;i&&i.parent;i=i.parent)t.push(i);t=t.reverse();for(let i=e;i&&i.children()&&i.children().size;){const e=Array.from(i.children().values());i=e.reduce((e,t)=>e.totalTime>t.totalTime?e:t),t.push(i)}return t}_exposePercentages(){return!0}_onStackViewSelectionChanged(){const e=this._stackView.selectedTreeNode();e&&this.selectProfileNode(e,!0)}_showDetailsForNode(e){const t=this._buildHeaviestStack(e);return this._stackView.setStack(t,e),this._stackView.show(this._detailsView.element),!0}_groupingFunction(e){const t=AggregatedTimelineTreeView.GroupBy;switch(e){case t.None:return null;case t.EventName:return e=>TimelineUIUtils.eventStyle(e).title;case t.Category:return e=>TimelineUIUtils.eventStyle(e).category.name;case t.Subdomain:return this._domainByEvent.bind(this,!1);case t.Domain:return this._domainByEvent.bind(this,!0);case t.URL:return e=>TimelineModel.TimelineProfileTree.eventURL(e)||"";case t.Frame:return e=>TimelineModel.TimelineModel.TimelineData.forEvent(e).frameId;default:return console.assert(!1,"Unexpected aggregation setting: "+e),null}}_domainByEvent(e,t){const i=TimelineModel.TimelineProfileTree.eventURL(t);if(!i)return"";if(AggregatedTimelineTreeView._isExtensionInternalURL(i))return AggregatedTimelineTreeView._extensionInternalPrefix;if(AggregatedTimelineTreeView._isV8NativeURL(i))return AggregatedTimelineTreeView._v8NativePrefix;const r=Common.ParsedURL.ParsedURL.fromString(i);if(!r)return"";if("chrome-extension"===r.scheme)return r.scheme+"://"+r.host;if(!e)return r.host;if(/^[.0-9]+$/.test(r.host))return r.host;const n=/([^.]*\.)?[^.]*$/.exec(r.host);return n&&n[0]||""}_appendContextMenuItems(e,t){if(this._groupBySetting.get()!==AggregatedTimelineTreeView.GroupBy.Frame)return;if(!t.isGroupNode())return;const i=this._model.timelineModel().pageFrameById(t.id);i&&i.ownerNode&&e.appendApplicableItems(i.ownerNode)}static _isExtensionInternalURL(e){return e.startsWith(AggregatedTimelineTreeView._extensionInternalPrefix)}static _isV8NativeURL(e){return e.startsWith(AggregatedTimelineTreeView._v8NativePrefix)}}AggregatedTimelineTreeView._extensionInternalPrefix="extensions::",AggregatedTimelineTreeView._v8NativePrefix="native ",AggregatedTimelineTreeView.GroupBy={None:"None",EventName:"EventName",Category:"Category",Domain:"Domain",Subdomain:"Subdomain",URL:"URL",Frame:"Frame"};export class CallTreeTimelineTreeView extends AggregatedTimelineTreeView{constructor(){super(),this._dataGrid.markColumnAsSortedBy("total",DataGrid.DataGrid.Order.Descending)}getToolbarInputAccessiblePlaceHolder(){return ls`Filter call tree`}_buildTree(){const e=this._groupBySetting.get();return this.buildTopDownTree(!1,this._groupingFunction(e))}}export class BottomUpTimelineTreeView extends AggregatedTimelineTreeView{constructor(){super(),this._dataGrid.markColumnAsSortedBy("self",DataGrid.DataGrid.Order.Descending)}getToolbarInputAccessiblePlaceHolder(){return ls`Filter bottom-up`}_buildTree(){return new TimelineModel.TimelineProfileTree.BottomUpRootNode(this._modelEvents(),this.textFilter(),this.filtersWithoutTextFilter(),this._startTime,this._endTime,this._groupingFunction(this._groupBySetting.get()))}}export class TimelineStackView extends UI.Widget.VBox{constructor(e){super();this.element.createChild("div","timeline-stack-view-header").textContent=Common.UIString.UIString("Heaviest stack"),this._treeView=e;const t=[{id:"total",title:Common.UIString.UIString("Total Time"),fixedWidth:!0,width:"110px"},{id:"activity",title:Common.UIString.UIString("Activity")}];this._dataGrid=new DataGrid.ViewportDataGrid.ViewportDataGrid({displayName:ls`Timeline Stack`,columns:t}),this._dataGrid.setResizeMethod(DataGrid.DataGrid.ResizeMethod.Last),this._dataGrid.addEventListener(DataGrid.DataGrid.Events.SelectedNode,this._onSelectionChanged,this),this._dataGrid.asWidget().show(this.element)}setStack(e,t){const i=this._dataGrid.rootNode();i.removeChildren();let r=null;const n=Math.max.apply(Math,e.map(e=>e.totalTime));for(const o of e){const e=new GridNode(o,n,n,n,this._treeView);i.appendChild(e),o===t&&(r=e)}r.revealAndSelect()}selectedTreeNode(){const e=this._dataGrid.selectedNode;return e&&e._profileNode}_onSelectionChanged(){this.dispatchEventToListeners(TimelineStackView.Events.SelectionChanged)}}TimelineStackView.Events={SelectionChanged:Symbol("SelectionChanged")};