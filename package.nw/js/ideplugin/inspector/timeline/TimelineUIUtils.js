import*as Bindings from"../bindings/bindings.js";import*as Common from"../common/common.js";import*as Components from"../components/components.js";import*as PerfUI from"../perf_ui/perf_ui.js";import*as Platform from"../platform/platform.js";import*as SDK from"../sdk/sdk.js";import*as TimelineModel from"../timeline_model/timeline_model.js";import*as UI from"../ui/ui.js";import{CLSRect}from"./CLSLinkifier.js";import{TimelinePanel,TimelineSelection}from"./TimelinePanel.js";export class TimelineUIUtils{static _initEventStyles(){if(TimelineUIUtils._eventStylesMap)return TimelineUIUtils._eventStylesMap;const e=TimelineModel.TimelineModel.RecordType,t=TimelineUIUtils.categories(),i=t.rendering,n=t.scripting,l=t.loading,a=t.experience,s=t.painting,o=t.other,r=t.idle,c={};return c[e.Task]=new TimelineRecordStyle(ls`Task`,o),c[e.Program]=new TimelineRecordStyle(ls`Other`,o),c[e.Animation]=new TimelineRecordStyle(ls`Animation`,i),c[e.EventDispatch]=new TimelineRecordStyle(ls`Event`,n),c[e.RequestMainThreadFrame]=new TimelineRecordStyle(ls`Request Main Thread Frame`,i,!0),c[e.BeginFrame]=new TimelineRecordStyle(ls`Frame Start`,i,!0),c[e.BeginMainThreadFrame]=new TimelineRecordStyle(ls`Frame Start (main thread)`,i,!0),c[e.DrawFrame]=new TimelineRecordStyle(ls`Draw Frame`,i,!0),c[e.HitTest]=new TimelineRecordStyle(ls`Hit Test`,i),c[e.ScheduleStyleRecalculation]=new TimelineRecordStyle(ls`Schedule Style Recalculation`,i),c[e.RecalculateStyles]=new TimelineRecordStyle(ls`Recalculate Style`,i),c[e.UpdateLayoutTree]=new TimelineRecordStyle(ls`Recalculate Style`,i),c[e.InvalidateLayout]=new TimelineRecordStyle(ls`Invalidate Layout`,i,!0),c[e.Layout]=new TimelineRecordStyle(ls`Layout`,i),c[e.PaintSetup]=new TimelineRecordStyle(ls`Paint Setup`,s),c[e.PaintImage]=new TimelineRecordStyle(ls`Paint Image`,s,!0),c[e.UpdateLayer]=new TimelineRecordStyle(ls`Update Layer`,s,!0),c[e.UpdateLayerTree]=new TimelineRecordStyle(ls`Update Layer Tree`,i),c[e.Paint]=new TimelineRecordStyle(ls`Paint`,s),c[e.RasterTask]=new TimelineRecordStyle(ls`Rasterize Paint`,s),c[e.ScrollLayer]=new TimelineRecordStyle(ls`Scroll`,i),c[e.CompositeLayers]=new TimelineRecordStyle(ls`Composite Layers`,s),c[e.ParseHTML]=new TimelineRecordStyle(ls`Parse HTML`,l),c[e.ParseAuthorStyleSheet]=new TimelineRecordStyle(ls`Parse Stylesheet`,l),c[e.TimerInstall]=new TimelineRecordStyle(ls`Install Timer`,n),c[e.TimerRemove]=new TimelineRecordStyle(ls`Remove Timer`,n),c[e.TimerFire]=new TimelineRecordStyle(ls`Timer Fired`,n),c[e.XHRReadyStateChange]=new TimelineRecordStyle(ls`XHR Ready State Change`,n),c[e.XHRLoad]=new TimelineRecordStyle(ls`XHR Load`,n),c[e.CompileScript]=new TimelineRecordStyle(ls`Compile Script`,n),c[e.EvaluateScript]=new TimelineRecordStyle(ls`Evaluate Script`,n),c[e.CompileModule]=new TimelineRecordStyle(ls`Compile Module`,n),c[e.EvaluateModule]=new TimelineRecordStyle(ls`Evaluate Module`,n),c[e.StreamingCompileScript]=new TimelineRecordStyle(ls`Streaming Compile Task`,o),c[e.StreamingCompileScriptWaiting]=new TimelineRecordStyle(ls`Waiting for Network`,r),c[e.StreamingCompileScriptParsing]=new TimelineRecordStyle(ls`Parse and Compile`,n),c[e.WasmStreamFromResponseCallback]=new TimelineRecordStyle(ls`Streaming Wasm Response`,n),c[e.WasmCompiledModule]=new TimelineRecordStyle(ls`Compiled Wasm Module`,n),c[e.WasmCachedModule]=new TimelineRecordStyle(ls`Cached Wasm Module`,n),c[e.WasmModuleCacheHit]=new TimelineRecordStyle(ls`Wasm Module Cache Hit`,n),c[e.WasmModuleCacheInvalid]=new TimelineRecordStyle(ls`Wasm Module Cache Invalid`,n),c[e.FrameStartedLoading]=new TimelineRecordStyle(ls`Frame Started Loading`,l,!0),c[e.MarkLoad]=new TimelineRecordStyle(ls`Onload Event`,n,!0),c[e.MarkDOMContent]=new TimelineRecordStyle(ls`DOMContentLoaded Event`,n,!0),c[e.MarkFirstPaint]=new TimelineRecordStyle(ls`First Paint`,s,!0),c[e.MarkFCP]=new TimelineRecordStyle(ls`First Contentful Paint`,i,!0),c[e.MarkLCPCandidate]=new TimelineRecordStyle(ls`Largest Contentful Paint`,i,!0),c[e.TimeStamp]=new TimelineRecordStyle(ls`Timestamp`,n),c[e.ConsoleTime]=new TimelineRecordStyle(ls`Console Time`,n),c[e.UserTiming]=new TimelineRecordStyle(ls`User Timing`,n),c[e.ResourceWillSendRequest]=new TimelineRecordStyle(ls`Will Send Request`,l),c[e.ResourceSendRequest]=new TimelineRecordStyle(ls`Send Request`,l),c[e.ResourceReceiveResponse]=new TimelineRecordStyle(ls`Receive Response`,l),c[e.ResourceFinish]=new TimelineRecordStyle(ls`Finish Loading`,l),c[e.ResourceReceivedData]=new TimelineRecordStyle(ls`Receive Data`,l),c[e.RunMicrotasks]=new TimelineRecordStyle(ls`Run Microtasks`,n),c[e.FunctionCall]=new TimelineRecordStyle(ls`Function Call`,n),c[e.GCEvent]=new TimelineRecordStyle(ls`GC Event`,n),c[e.MajorGC]=new TimelineRecordStyle(ls`Major GC`,n),c[e.MinorGC]=new TimelineRecordStyle(ls`Minor GC`,n),c[e.JSFrame]=new TimelineRecordStyle(ls`JS Frame`,n),c[e.RequestAnimationFrame]=new TimelineRecordStyle(ls`Request Animation Frame`,n),c[e.CancelAnimationFrame]=new TimelineRecordStyle(ls`Cancel Animation Frame`,n),c[e.FireAnimationFrame]=new TimelineRecordStyle(ls`Animation Frame Fired`,n),c[e.RequestIdleCallback]=new TimelineRecordStyle(ls`Request Idle Callback`,n),c[e.CancelIdleCallback]=new TimelineRecordStyle(ls`Cancel Idle Callback`,n),c[e.FireIdleCallback]=new TimelineRecordStyle(ls`Fire Idle Callback`,n),c[e.WebSocketCreate]=new TimelineRecordStyle(ls`Create WebSocket`,n),c[e.WebSocketSendHandshakeRequest]=new TimelineRecordStyle(ls`Send WebSocket Handshake`,n),c[e.WebSocketReceiveHandshakeResponse]=new TimelineRecordStyle(ls`Receive WebSocket Handshake`,n),c[e.WebSocketDestroy]=new TimelineRecordStyle(ls`Destroy WebSocket`,n),c[e.EmbedderCallback]=new TimelineRecordStyle(ls`Embedder Callback`,n),c[e.DecodeImage]=new TimelineRecordStyle(ls`Image Decode`,s),c[e.ResizeImage]=new TimelineRecordStyle(ls`Image Resize`,s),c[e.GPUTask]=new TimelineRecordStyle(ls`GPU`,t.gpu),c[e.LatencyInfo]=new TimelineRecordStyle(ls`Input Latency`,n),c[e.GCCollectGarbage]=new TimelineRecordStyle(ls`DOM GC`,n),c[e.CryptoDoEncrypt]=new TimelineRecordStyle(ls`Encrypt`,n),c[e.CryptoDoEncryptReply]=new TimelineRecordStyle(ls`Encrypt Reply`,n),c[e.CryptoDoDecrypt]=new TimelineRecordStyle(ls`Decrypt`,n),c[e.CryptoDoDecryptReply]=new TimelineRecordStyle(ls`Decrypt Reply`,n),c[e.CryptoDoDigest]=new TimelineRecordStyle(ls`Digest`,n),c[e.CryptoDoDigestReply]=new TimelineRecordStyle(ls`Digest Reply`,n),c[e.CryptoDoSign]=new TimelineRecordStyle(ls`Sign`,n),c[e.CryptoDoSignReply]=new TimelineRecordStyle(ls`Sign Reply`,n),c[e.CryptoDoVerify]=new TimelineRecordStyle(ls`Verify`,n),c[e.CryptoDoVerifyReply]=new TimelineRecordStyle(ls`Verify Reply`,n),c[e.AsyncTask]=new TimelineRecordStyle(ls`Async Task`,t.async),c[e.LayoutShift]=new TimelineRecordStyle(ls`Layout Shift`,a),TimelineUIUtils._eventStylesMap=c,c}static setEventStylesMap(e){TimelineUIUtils._eventStylesMap=e}static inputEventDisplayName(e){if(!TimelineUIUtils._inputEventToDisplayName){const e=TimelineModel.TimelineIRModel.InputEvents;TimelineUIUtils._inputEventToDisplayName=new Map([[e.Char,ls`Key Character`],[e.KeyDown,ls`Key Down`],[e.KeyDownRaw,ls`Key Down`],[e.KeyUp,ls`Key Up`],[e.Click,ls`Click`],[e.ContextMenu,ls`Context Menu`],[e.MouseDown,ls`Mouse Down`],[e.MouseMove,ls`Mouse Move`],[e.MouseUp,ls`Mouse Up`],[e.MouseWheel,ls`Mouse Wheel`],[e.ScrollBegin,ls`Scroll Begin`],[e.ScrollEnd,ls`Scroll End`],[e.ScrollUpdate,ls`Scroll Update`],[e.FlingStart,ls`Fling Start`],[e.FlingCancel,ls`Fling Halt`],[e.Tap,ls`Tap`],[e.TapCancel,ls`Tap Halt`],[e.ShowPress,ls`Tap Begin`],[e.TapDown,ls`Tap Down`],[e.TouchCancel,ls`Touch Cancel`],[e.TouchEnd,ls`Touch End`],[e.TouchMove,ls`Touch Move`],[e.TouchStart,ls`Touch Start`],[e.PinchBegin,ls`Pinch Begin`],[e.PinchEnd,ls`Pinch End`],[e.PinchUpdate,ls`Pinch Update`]])}return TimelineUIUtils._inputEventToDisplayName.get(e)||null}static frameDisplayName(e){if(!TimelineModel.TimelineJSProfile.TimelineJSProfileProcessor.isNativeRuntimeFrame(e))return UI.UIUtils.beautifyFunctionName(e.functionName);const t=TimelineModel.TimelineJSProfile.TimelineJSProfileProcessor.nativeGroup(e.functionName),i=TimelineModel.TimelineJSProfile.TimelineJSProfileProcessor.NativeGroups;switch(t){case i.Compile:return ls`Compile`;case i.Parse:return ls`Parse`}return e.functionName}static testContentMatching(e,t){const i=[TimelineUIUtils.eventStyle(e).title],n=TimelineModel.TimelineModel.TimelineData.forEvent(e).url;return n&&i.push(n),function e(t,n){if(!n)return;for(const l in t){const a=t[l],s=typeof a;"string"===s?i.push(a):"number"===s?i.push(String(a)):"object"===s&&e(a,n-1)}}(e.args,2),t.test(i.join("|"))}static eventURL(e){const t=e.args.data||e.args.beginData,i=t&&t.url;if(i)return i;const n=t&&t.stackTrace,l=n&&n.length&&n[0]||TimelineModel.TimelineModel.TimelineData.forEvent(e).topFrame();return l&&l.url||null}static eventStyle(e){const t=TimelineUIUtils._initEventStyles();if(e.hasCategory(TimelineModel.TimelineModel.TimelineModelImpl.Category.Console)||e.hasCategory(TimelineModel.TimelineModel.TimelineModelImpl.Category.UserTiming))return new TimelineRecordStyle(e.name,TimelineUIUtils.categories().scripting);if(e.hasCategory(TimelineModel.TimelineModel.TimelineModelImpl.Category.LatencyInfo)){const t="InputLatency::",i=e.name.startsWith(t)?e.name.substr(t.length):e.name,n=TimelineUIUtils.inputEventDisplayName(i);return new TimelineRecordStyle(n||i,TimelineUIUtils.categories().scripting)}let i=t[e.name];return i||(i=new TimelineRecordStyle(e.name,TimelineUIUtils.categories().other,!0),t[e.name]=i),i}static eventColor(e){if(e.name===TimelineModel.TimelineModel.RecordType.JSFrame){const t=e.args.data;if(TimelineUIUtils.isUserFrame(t))return TimelineUIUtils.colorForId(t.url)}const t=TimelineUIUtils.eventStyle(e).category.color;return e.name===TimelineModel.TimelineModel.RecordType.StreamingCompileScriptWaiting?Common.Color.Color.parse(TimelineUIUtils.categories().scripting.color).setAlpha(.3).asString(null):t}static eventColorByProduct(e,t,i){const n=TimelineUIUtils.eventURL(i)||"";let l=t.get(n);if(l)return l;const a=Common.ParsedURL.ParsedURL.fromString(n);if(!a)return"#f2ecdc";const s=a.host;return e.rootFrames().some(e=>new Common.ParsedURL.ParsedURL(e.url).host===s)&&(l="#f2ecdc"),l||(l="#f2ecdc"),t.set(n,l),l}static eventTitle(e){const t=TimelineModel.TimelineModel.RecordType,i=e.args.data;if(e.name===t.JSFrame)return TimelineUIUtils.frameDisplayName(i);const n=TimelineUIUtils.eventStyle(e).title;return e.hasCategory(TimelineModel.TimelineModel.TimelineModelImpl.Category.Console)?n:e.name===t.TimeStamp?ls`${n}: ${i.message}`:e.name===t.Animation&&i&&i.name?ls`${n}: ${i.name}`:e.name===t.EventDispatch&&i&&i.type?ls`${n}: ${i.type}`:n}static _interactionPhaseStyles(){let e=TimelineUIUtils._interactionPhaseStylesMap;return e||(e=new Map([[TimelineModel.TimelineIRModel.Phases.Idle,{color:"white",label:"Idle"}],[TimelineModel.TimelineIRModel.Phases.Response,{color:"hsl(43, 83%, 64%)",label:ls`Response`}],[TimelineModel.TimelineIRModel.Phases.Scroll,{color:"hsl(256, 67%, 70%)",label:ls`Scroll`}],[TimelineModel.TimelineIRModel.Phases.Fling,{color:"hsl(256, 67%, 70%)",label:ls`Fling`}],[TimelineModel.TimelineIRModel.Phases.Drag,{color:"hsl(256, 67%, 70%)",label:ls`Drag`}],[TimelineModel.TimelineIRModel.Phases.Animation,{color:"hsl(256, 67%, 70%)",label:ls`Animation`}],[TimelineModel.TimelineIRModel.Phases.Uncategorized,{color:"hsl(0, 0%, 87%)",label:ls`Uncategorized`}]]),TimelineUIUtils._interactionPhaseStylesMap=e),e}static interactionPhaseColor(e){return TimelineUIUtils._interactionPhaseStyles().get(e).color}static interactionPhaseLabel(e){return TimelineUIUtils._interactionPhaseStyles().get(e).label}static isUserFrame(e){return"0"!==e.scriptId&&!(e.url&&e.url.startsWith("native "))}static networkRequestCategory(e){const t=NetworkCategory;switch(e.mimeType){case"text/html":return t.HTML;case"application/javascript":case"application/x-javascript":case"text/javascript":return t.Script;case"text/css":return t.Style;case"audio/ogg":case"image/gif":case"image/jpeg":case"image/png":case"image/svg+xml":case"image/webp":case"image/x-icon":case"font/opentype":case"font/woff2":case"application/font-woff":return t.Media;default:return t.Other}}static networkCategoryColor(e){const t=NetworkCategory;switch(e){case t.HTML:return"hsl(214, 67%, 66%)";case t.Script:return"hsl(43, 83%, 64%)";case t.Style:return"hsl(256, 67%, 70%)";case t.Media:return"hsl(109, 33%, 55%)";default:return"hsl(0, 0%, 70%)"}}static async buildDetailsTextForTraceEvent(e,t){const i=TimelineModel.TimelineModel.RecordType;let n;const l=e.args.data;switch(e.name){case i.GCEvent:case i.MajorGC:case i.MinorGC:{const t=e.args.usedHeapSizeBefore-e.args.usedHeapSizeAfter;n=Common.UIString.UIString("%s collected",Platform.NumberUtilities.bytesToString(t));break}case i.FunctionCall:l&&(n=await a(l.scriptId,l.lineNumber,l.columnNumber));break;case i.JSFrame:n=TimelineUIUtils.frameDisplayName(l);break;case i.EventDispatch:n=l?l.type:null;break;case i.Paint:{const e=TimelineUIUtils.quadWidth(l.clip),t=TimelineUIUtils.quadHeight(l.clip);e&&t&&(n=Common.UIString.UIString("%d × %d",e,t));break}case i.ParseHTML:{const t=e.args.beginData.startLine,i=e.args.endData&&e.args.endData.endLine,l=Bindings.ResourceUtils.displayNameForURL(e.args.beginData.url);n=i>=0?Common.UIString.UIString("%s [%s…%s]",l,t+1,i+1):Common.UIString.UIString("%s [%s…]",l,t+1);break}case i.CompileModule:n=Bindings.ResourceUtils.displayNameForURL(e.args.fileName);break;case i.CompileScript:case i.EvaluateScript:{const e=l&&l.url;e&&(n=Bindings.ResourceUtils.displayNameForURL(e)+":"+(l.lineNumber+1));break}case i.WasmCompiledModule:case i.WasmModuleCacheHit:{const t=e.args.url;t&&(n=Bindings.ResourceUtils.displayNameForURL(t));break}case i.StreamingCompileScript:case i.XHRReadyStateChange:case i.XHRLoad:{const e=l.url;e&&(n=Bindings.ResourceUtils.displayNameForURL(e));break}case i.TimeStamp:n=l.message;break;case i.WebSocketCreate:case i.WebSocketSendHandshakeRequest:case i.WebSocketReceiveHandshakeResponse:case i.WebSocketDestroy:case i.ResourceWillSendRequest:case i.ResourceSendRequest:case i.ResourceReceivedData:case i.ResourceReceiveResponse:case i.ResourceFinish:case i.PaintImage:case i.DecodeImage:case i.ResizeImage:case i.DecodeLazyPixelRef:{const t=TimelineModel.TimelineModel.TimelineData.forEvent(e).url;t&&(n=Bindings.ResourceUtils.displayNameForURL(t));break}case i.EmbedderCallback:n=l.callbackName;break;case i.Animation:n=l&&l.name;break;case i.AsyncTask:n=l?l.name:null;break;default:n=e.hasCategory(TimelineModel.TimelineModel.TimelineModelImpl.Category.Console)?null:await async function(){const t=TimelineModel.TimelineModel.TimelineData.forEvent(e).topFrame();if(!t)return null;let i=await a(t.scriptId,t.lineNumber,t.columnNumber);i||(i=t.url,"number"==typeof t.lineNumber&&(i+=":"+(t.lineNumber+1)));return i}()}return n;async function a(e,i,n){const l=t?t.model(SDK.DebuggerModel.DebuggerModel):null;if(!t||t.isDisposed()||!e||!l)return null;const a=l.createRawLocationByScriptId(e,i,n);if(!a)return null;const s=await Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().rawLocationToUILocation(a);return s?s.linkText():null}}static async buildDetailsNodeForTraceEvent(e,t,i){const n=TimelineModel.TimelineModel.RecordType;let l,a=null;const s=e.args.data;switch(e.name){case n.GCEvent:case n.MajorGC:case n.MinorGC:case n.EventDispatch:case n.Paint:case n.Animation:case n.EmbedderCallback:case n.ParseHTML:case n.WasmStreamFromResponseCallback:case n.WasmCompiledModule:case n.WasmModuleCacheHit:case n.WasmCachedModule:case n.WasmModuleCacheInvalid:case n.WebSocketCreate:case n.WebSocketSendHandshakeRequest:case n.WebSocketReceiveHandshakeResponse:case n.WebSocketDestroy:l=await TimelineUIUtils.buildDetailsTextForTraceEvent(e,t);break;case n.PaintImage:case n.DecodeImage:case n.ResizeImage:case n.DecodeLazyPixelRef:case n.XHRReadyStateChange:case n.XHRLoad:case n.ResourceWillSendRequest:case n.ResourceSendRequest:case n.ResourceReceivedData:case n.ResourceReceiveResponse:case n.ResourceFinish:{const t=TimelineModel.TimelineModel.TimelineData.forEvent(e).url;t&&(a=Components.Linkifier.Linkifier.linkifyURL(t,{tabStop:!0}));break}case n.FunctionCall:case n.JSFrame:{a=createElement("span"),a.createTextChild(TimelineUIUtils.frameDisplayName(s));const e=o(s.scriptId,s.url,s.lineNumber,s.columnNumber);e&&(a.createTextChild(" @ "),a.appendChild(e));break}case n.CompileModule:a=o("",e.args.fileName,0,0);break;case n.CompileScript:case n.EvaluateScript:{const e=s.url;e&&(a=o("",e,s.lineNumber,0));break}case n.StreamingCompileScript:{const e=s.url;e&&(a=o("",e,0,0));break}default:e.hasCategory(TimelineModel.TimelineModel.TimelineModelImpl.Category.Console)?l=null:a=function(){const n=TimelineModel.TimelineModel.TimelineData.forEvent(e).topFrame();return n?i.maybeLinkifyConsoleCallFrame(t,n,{className:"timeline-details",tabStop:!0}):null}()}return!a&&l&&(a=createTextNode(l)),a;function o(e,n,l,a){const s={columnNumber:a,className:"timeline-details",tabStop:!0};return i.linkifyScriptLocation(t,e,n,l,s)}}static buildDetailsNodeForPerformanceEvent(e){let t="https://developers.google.com/web/fundamentals/performance/user-centric-performance-metrics#user-centric_performance_metrics",i="page performance metrics";const n=TimelineModel.TimelineModel.RecordType;switch(e.name){case n.MarkLCPCandidate:t="https://web.dev/largest-contentful-paint",i="largest contentful paint";break;case n.MarkFCP:t="https://web.dev/first-contentful-paint",i="first contentful paint"}return UI.Fragment.html`<div>${UI.XLink.XLink.create(t,ls`Learn more`)} about ${i}.</div>`}static buildCompilationCacheDetails(e,t){"producedCacheSize"in e?(t.appendTextRow(ls`Compilation cache status`,ls`script saved to cache`),t.appendTextRow(ls`Compilation cache size`,Platform.NumberUtilities.bytesToString(e.producedCacheSize))):"consumedCacheSize"in e?(t.appendTextRow(ls`Compilation cache status`,ls`script loaded from cache`),t.appendTextRow(ls`Compilation cache size`,Platform.NumberUtilities.bytesToString(e.consumedCacheSize))):e&&e.cacheRejected?t.appendTextRow(ls`Compilation cache status`,ls`failed to load script from cache`):t.appendTextRow(ls`Compilation cache status`,ls`script not eligible`)}static async buildTraceEventDetails(e,t,i,n){const l=t.targetByEvent(e);let a=null;if(l){const t=l;if(void 0===e[previewElementSymbol]){let i=null;const n=TimelineModel.TimelineModel.TimelineData.forEvent(e).url;n?i=await Components.ImagePreview.ImagePreview.build(t,n,!1,{imageAltText:Components.ImagePreview.ImagePreview.defaultAltTextForImageURL(n)}):TimelineModel.TimelineModel.TimelineData.forEvent(e).picture&&(i=await TimelineUIUtils.buildPicturePreviewContent(e,t)),e[previewElementSymbol]=i}const i=new Set,n=TimelineModel.TimelineModel.TimelineData.forEvent(e);n.backendNodeId&&i.add(n.backendNodeId);const s=TimelineModel.TimelineModel.InvalidationTracker.invalidationEventsFor(e);if(s&&TimelineUIUtils._collectInvalidationNodeIds(i,s),i.size){const e=t.model(SDK.DOMModel.DOMModel);e&&(a=await e.pushNodesByBackendIdsToFrontend(i))}}const s=TimelineModel.TimelineModel.RecordType;let o;e.name===s.LayoutShift&&(n=!1);const r=new TimelineDetailsContentHelper(t.targetByEvent(e),i),c=t.isMarkerEvent(e)?TimelineUIUtils.markerStyleForEvent(e).color:TimelineUIUtils.eventStyle(e).category.color;r.addSection(TimelineUIUtils.eventTitle(e),c);const d=e.args.data,m=TimelineModel.TimelineModel.TimelineData.forEvent(e),p=m.initiator();let T=null;if(m.warning&&r.appendWarningRow(e),e.name===s.JSFrame&&d.deoptReason&&r.appendWarningRow(e,TimelineModel.TimelineModel.TimelineModelImpl.WarningType.V8Deopt),n&&!Number.isNaN(e.duration+0)&&(r.appendTextRow(ls`Total Time`,Number.millisToString(e.duration,!0)),r.appendTextRow(ls`Self Time`,Number.millisToString(e.selfTime,!0))),t.isGenericTrace()){for(const t in e.args)try{r.appendTextRow(t,JSON.stringify(e.args[t]))}catch(i){r.appendTextRow(t,`<${typeof e.args[t]}>`)}return r.fragment}switch(e.name){case s.GCEvent:case s.MajorGC:case s.MinorGC:{const t=e.args.usedHeapSizeBefore-e.args.usedHeapSizeAfter;r.appendTextRow(ls`Collected`,Platform.NumberUtilities.bytesToString(t));break}case s.JSFrame:case s.FunctionCall:{const n=await TimelineUIUtils.buildDetailsNodeForTraceEvent(e,t.targetByEvent(e),i);n&&r.appendElementRow(ls`Function`,n);break}case s.TimerFire:case s.TimerInstall:case s.TimerRemove:r.appendTextRow(ls`Timer ID`,d.timerId),e.name===s.TimerInstall&&(r.appendTextRow(ls`Timeout`,Number.millisToString(d.timeout)),r.appendTextRow(ls`Repeats`,!d.singleShot));break;case s.FireAnimationFrame:r.appendTextRow(ls`Callback ID`,d.id);break;case s.ResourceWillSendRequest:case s.ResourceSendRequest:case s.ResourceReceiveResponse:case s.ResourceReceivedData:case s.ResourceFinish:if(T=m.url,T&&r.appendElementRow(ls`Resource`,Components.Linkifier.Linkifier.linkifyURL(T,{tabStop:!0})),d.requestMethod&&r.appendTextRow(ls`Request Method`,d.requestMethod),"number"==typeof d.statusCode&&r.appendTextRow(ls`Status Code`,d.statusCode),d.mimeType&&r.appendTextRow(ls`MIME Type`,d.mimeType),"priority"in d){const e=PerfUI.NetworkPriorities.uiLabelForNetworkPriority(d.priority);r.appendTextRow(ls`Priority`,e)}d.encodedDataLength&&r.appendTextRow(ls`Encoded Data`,ls`${d.encodedDataLength} Bytes`),d.decodedBodyLength&&r.appendTextRow(ls`Decoded Body`,ls`${d.decodedBodyLength} Bytes`);break;case s.CompileModule:r.appendLocationRow(ls`Module`,e.args.fileName,0);break;case s.CompileScript:{T=d&&d.url,T&&r.appendLocationRow(ls`Script`,T,d.lineNumber,d.columnNumber);const e=d.streamed;r.appendTextRow(ls`Streamed`,e+(e?"":": "+d.notStreamedReason)),TimelineUIUtils.buildCompilationCacheDetails(d,r);break}case s.EvaluateScript:T=d&&d.url,T&&r.appendLocationRow(ls`Script`,T,d.lineNumber,d.columnNumber);break;case s.WasmStreamFromResponseCallback:case s.WasmCompiledModule:case s.WasmCachedModule:case s.WasmModuleCacheHit:case s.WasmModuleCacheInvalid:if(d){T=e.args.url,T&&r.appendTextRow(ls`Url`,T);const t=e.args.producedCachedSize;t&&r.appendTextRow(ls`Produced Cache Size`,t);const i=e.args.consumedCachedSize;i&&r.appendTextRow(ls`Consumed Cache Size`,i)}break;case s.Paint:{const e=d.clip;r.appendTextRow(ls`Location`,ls`(${e[0]}, ${e[1]})`);const t=TimelineUIUtils.quadWidth(e),i=TimelineUIUtils.quadHeight(e);r.appendTextRow(ls`Dimensions`,ls`${t} × ${i}`)}case s.PaintSetup:case s.Rasterize:case s.ScrollLayer:o=ls`Layer Root`;break;case s.PaintImage:case s.DecodeLazyPixelRef:case s.DecodeImage:case s.ResizeImage:case s.DrawLazyPixelRef:o=ls`Owner Element`,T=m.url,T&&r.appendElementRow(ls`Image URL`,Components.Linkifier.Linkifier.linkifyURL(T,{tabStop:!0}));break;case s.ParseAuthorStyleSheet:T=d.styleSheetUrl,T&&r.appendElementRow(ls`Stylesheet URL`,Components.Linkifier.Linkifier.linkifyURL(T,{tabStop:!0}));break;case s.UpdateLayoutTree:case s.RecalculateStyles:r.appendTextRow(ls`Elements Affected`,e.args.elementCount);break;case s.Layout:{const t=e.args.beginData;r.appendTextRow(ls`Nodes That Need Layout`,ls`${t.dirtyObjects} of ${t.totalObjects}`),o=ls`Layout root`;break}case s.ConsoleTime:r.appendTextRow(ls`Message`,e.name);break;case s.WebSocketCreate:case s.WebSocketSendHandshakeRequest:case s.WebSocketReceiveHandshakeResponse:case s.WebSocketDestroy:{const e=p?p.args.data:d;void 0!==e.webSocketURL&&r.appendTextRow(ls`URL`,e.webSocketURL),void 0!==e.webSocketProtocol&&r.appendTextRow(ls`WebSocket Protocol`,e.webSocketProtocol),void 0!==d.message&&r.appendTextRow(ls`Message`,d.message);break}case s.EmbedderCallback:r.appendTextRow(ls`Callback Function`,d.callbackName);break;case s.Animation:e.phase===SDK.TracingModel.Phase.NestableAsyncInstant&&r.appendTextRow(ls`State`,d.state);break;case s.ParseHTML:{const t=e.args.beginData,i=t.startLine-1,n=e.args.endData?e.args.endData.endLine-1:void 0;T=t.url,T&&r.appendLocationRange(ls`Range`,T,i,n);break}case s.FireIdleCallback:r.appendTextRow(ls`Allotted Time`,Number.millisToString(d.allottedMilliseconds)),r.appendTextRow(ls`Invoked by Timeout`,d.timedOut);case s.RequestIdleCallback:case s.CancelIdleCallback:r.appendTextRow(ls`Callback ID`,d.id);break;case s.EventDispatch:r.appendTextRow(ls`Type`,d.type);break;case s.MarkLCPCandidate:r.appendTextRow(ls`Type`,String(d.type)),r.appendTextRow(ls`Size`,String(d.size));case s.MarkFirstPaint:case s.MarkFCP:case s.MarkLoad:case s.MarkDOMContent:{let i=e.startTime-t.minimumRecordTime();const{navigationId:n}=e.args.data;if(n){const l=t.navStartTimes().get(n);l&&(i=e.startTime-l.startTime)}r.appendTextRow(ls`Timestamp`,Number.preciseMillisToString(i,1)),r.appendElementRow(ls`Details`,TimelineUIUtils.buildDetailsNodeForPerformanceEvent(e));break}case s.LayoutShift:{const e=createElement("span"),t=UI.UIUtils.createWebDevLink("cls/",ls`Cumulative Layout Shifts`);e.appendChild(UI.UIUtils.formatLocalized("%s can result in poor user experiences.",[t])),r.appendElementRow(ls`Warning`,e,!0),r.appendTextRow(ls`Score`,d.score.toPrecision(4)),r.appendTextRow(ls`Cumulative Score`,d.cumulative_score.toPrecision(4)),r.appendTextRow(ls`Had recent input`,d.had_recent_input?ls`Yes`:ls`No`);for(const e of d.impacted_nodes){const t=new CLSRect(e.old_rect),i=new CLSRect(e.new_rect),n=await Common.Linkifier.Linkifier.linkify(t),l=await Common.Linkifier.Linkifier.linkify(i);r.appendElementRow(ls`Moved from`,n),r.appendElementRow(ls`Moved to`,l)}break}default:{const n=await TimelineUIUtils.buildDetailsNodeForTraceEvent(e,t.targetByEvent(e),i);n&&r.appendElementRow(ls`Details`,n);break}}m.timeWaitingForMainThread&&r.appendTextRow(ls`Time Waiting for Main Thread`,Number.millisToString(m.timeWaitingForMainThread,!0));const u=a&&a.get(m.backendNodeId);if(u){const e=await Common.Linkifier.Linkifier.linkify(u);r.appendElementRow(o||ls`Related Node`,e)}e[previewElementSymbol]&&(r.addSection(ls`Preview`),r.appendElementRow("",e[previewElementSymbol])),(p||m.stackTraceForSelfOrInitiator()||TimelineModel.TimelineModel.InvalidationTracker.invalidationEventsFor(e))&&TimelineUIUtils._generateCauses(e,t.targetByEvent(e),a,r);const h={};if(n&&TimelineUIUtils._aggregatedStatsForTraceEvent(h,t,e)){r.addSection(ls`Aggregated Time`);const t=TimelineUIUtils.generatePieChart(h,TimelineUIUtils.eventStyle(e).category,e.selfTime);r.appendElementRow("",t)}return r.fragment}static statsForTimeRange(e,t,i){if(!e.length)return{idle:i-t};!function(e){if(e[categoryBreakdownCacheSymbol])return;const t={},i=[];let n=0;function l(e,i){let l=t[e];if(l||(l={time:[],value:[]},t[e]=l),l.time.length&&l.time.peekLast()===i||n>i)return;const a=l.value.length?l.value.peekLast():0;l.value.push(a+i-n),l.time.push(i)}function a(e,t,i){e&&l(e,i),n=i,t&&l(t,i)}TimelineModel.TimelineModel.TimelineModelImpl.forEachEvent(e,(function(e){const t=TimelineUIUtils.eventStyle(e).category.name,n=i.length?i.peekLast():null;t!==n&&a(n,t,e.startTime),i.push(t)}),(function(e){const t=i.pop(),n=i.length?i.peekLast():null;t!==n&&a(t,n,e.endTime)}),void 0,void 0,void 0,function(){const e=TimelineUIUtils.visibleEventsFilter();return t=>e.accept(t)||SDK.TracingModel.TracingModel.isTopLevelEvent(t)}());e[categoryBreakdownCacheSymbol]=t}(e);const n=function(e,t){const i=Object.assign({},e);for(const e in t)i[e]-=t[e];return i}(a(i),a(t)),l=Object.values(n).reduce((e,t)=>e+t,0);return n.idle=Math.max(0,i-t-l),n;function a(t){const i={},n=e[categoryBreakdownCacheSymbol];for(const e in n){const l=n[e],a=l.time.upperBound(t);let s;if(0===a)s=0;else if(a===l.time.length)s=l.value.peekLast();else{const e=l.time[a-1],i=l.time[a],n=l.value[a-1];s=n+(l.value[a]-n)*(t-e)/(i-e)}i[e]=s}return i}}static async buildNetworkRequestDetails(e,t,i){const n=t.targetByEvent(e.children[0]),l=new TimelineDetailsContentHelper(n,i),a=TimelineUIUtils.networkRequestCategory(e),s=TimelineUIUtils.networkCategoryColor(a);l.addSection(ls`Network request`,s),e.url&&l.appendElementRow(ls`URL`,Components.Linkifier.Linkifier.linkifyURL(e.url));const o=e.endTime-(e.getStartTime()||-1/0);if(isFinite(o)){let t=Number.millisToString(o,!0);const i=e.finishTime-e.getStartTime(),n=e.endTime-e.finishTime;if(isFinite(i)&&isFinite(n)){const l=Number.millisToString(i,!0),a=Number.millisToString(n,!0),s=e.cached()?ls`load from cache`:ls`network transfer`;t+=ls` (${l} ${s} + ${a} resource loading)`}l.appendTextRow(ls`Duration`,t)}if(e.requestMethod&&l.appendTextRow(ls`Request Method`,e.requestMethod),"string"==typeof e.priority){const t=PerfUI.NetworkPriorities.uiLabelForNetworkPriority(e.priority);l.appendTextRow(ls`Priority`,t)}e.mimeType&&l.appendTextRow(ls`Mime Type`,e.mimeType);let r="";e.memoryCached()?r+=ls` (from memory cache)`:e.cached()?r+=ls` (from cache)`:e.timing&&e.timing.pushStart&&(r+=ls` (from push)`),e.fromServiceWorker&&(r+=ls` (from service worker)`),!e.encodedDataLength&&r||(r=`${Platform.NumberUtilities.bytesToString(e.encodedDataLength)}${r}`),l.appendTextRow(ls`Encoded Data`,r),e.decodedBodyLength&&l.appendTextRow(ls`Decoded Body`,Platform.NumberUtilities.bytesToString(e.decodedBodyLength));const c=ls`Initiator`,d=e.children[0],m=TimelineModel.TimelineModel.TimelineData.forEvent(d).topFrame();if(m){const e=i.maybeLinkifyConsoleCallFrame(n,m,{tabStop:!0});e&&l.appendElementRow(c,e)}else{const e=TimelineModel.TimelineModel.TimelineData.forEvent(d).initiator();if(e){const t=TimelineModel.TimelineModel.TimelineData.forEvent(e).url;if(t){const e=i.maybeLinkifyScriptLocation(n,null,t,0,{tabStop:!0});e&&l.appendElementRow(c,e)}}}return!e.previewElement&&e.url&&n&&(e.previewElement=await Components.ImagePreview.ImagePreview.build(n,e.url,!1,{imageAltText:Components.ImagePreview.ImagePreview.defaultAltTextForImageURL(e.url)})),e.previewElement&&l.appendElementRow(ls`Preview`,e.previewElement),l.fragment}static _stackTraceFromCallFrames(e){return{callFrames:e}}static _generateCauses(e,t,i,n){const l=TimelineModel.TimelineModel.RecordType;let a,s;switch(e.name){case l.TimerFire:a=ls`Timer Installed`;break;case l.FireAnimationFrame:a=ls`Animation Frame Requested`;break;case l.FireIdleCallback:a=ls`Idle Callback Requested`;break;case l.UpdateLayoutTree:case l.RecalculateStyles:s=ls`Recalculation Forced`;break;case l.Layout:a=ls`First Layout Invalidation`,s=ls`Layout Forced`}const o=TimelineModel.TimelineModel.TimelineData.forEvent(e);o.stackTrace&&o.stackTrace.length&&(n.addSection(ls`Call Stacks`),n.appendStackTrace(s||ls`Stack Trace`,TimelineUIUtils._stackTraceFromCallFrames(o.stackTrace)));const r=TimelineModel.TimelineModel.TimelineData.forEvent(e).initiator();if(TimelineModel.TimelineModel.InvalidationTracker.invalidationEventsFor(e)&&t)n.addSection(ls`Invalidations`),TimelineUIUtils._generateInvalidations(e,t,i,n);else if(r){const t=e.startTime-r.startTime;n.appendTextRow(ls`Pending for`,Number.preciseMillisToString(t,1));const i=document.createElement("span");i.classList.add("devtools-link"),UI.ARIAUtils.markAsLink(i),i.tabIndex=0,i.textContent=ls`Reveal`,i.addEventListener("click",()=>{TimelinePanel.instance().select(TimelineSelection.fromTraceEvent(r))}),i.addEventListener("keydown",e=>{isEnterKey(e)&&(TimelinePanel.instance().select(TimelineSelection.fromTraceEvent(r)),e.consume(!0))}),n.appendElementRow(ls`Initiator`,i);const l=TimelineModel.TimelineModel.TimelineData.forEvent(r).stackTrace;l&&n.appendStackTrace(a||ls`First Invalidated`,TimelineUIUtils._stackTraceFromCallFrames(l))}}static _generateInvalidations(e,t,i,n){const l=TimelineModel.TimelineModel.InvalidationTracker.invalidationEventsFor(e),a={};l.forEach((function(e){a[e.type]?a[e.type].push(e):a[e.type]=[e]})),Object.keys(a).forEach((function(e){TimelineUIUtils._generateInvalidationsForType(e,t,a[e],i,n)}))}static _generateInvalidationsForType(e,t,i,n,l){let a;switch(e){case TimelineModel.TimelineModel.RecordType.StyleRecalcInvalidationTracking:a=ls`Style Invalidations`;break;case TimelineModel.TimelineModel.RecordType.LayoutInvalidationTracking:a=ls`Layout Invalidations`;break;default:a=ls`Other Invalidations`}const s=new UI.TreeOutline.TreeOutlineInShadow;s.registerRequiredCSS("timeline/invalidationsTree.css"),s.element.classList.add("invalidations-tree");(function(e){const t=new Map;for(let i=0;i<e.length;i++){const n=e[i];let l="";n.cause.reason&&(l+=n.cause.reason+"."),n.cause.stackTrace&&n.cause.stackTrace.forEach((function(e){l+=e.functionName+".",l+=e.scriptId+".",l+=e.url+".",l+=e.lineNumber+".",l+=e.columnNumber+"."})),t.has(l)?t.get(l).push(n):t.set(l,[n])}return[...t.values()]})(i).forEach((function(e){const i=new InvalidationsGroupElement(t,n,l,e);s.appendChild(i)})),l.appendElementRow(a,s.element,!1,!0)}static _collectInvalidationNodeIds(e,t){Platform.SetUtilities.addAll(e,t.map(e=>e.nodeId).filter(e=>e))}static _aggregatedStatsForTraceEvent(e,t,i){const n=t.inspectedTargetEvents();const l=n.binaryIndexOf(i.startTime,(function(e,t){return e-t.startTime}));if(l<0)return!1;let a=!1;const s=i.endTime;if(s)for(let t=l;t<n.length;t++){const o=n[t];if(o.startTime>=s)break;if(!o.selfTime)continue;if(o.thread!==i.thread)continue;t>l&&(a=!0);const r=TimelineUIUtils.eventStyle(o).category.name;e[r]=(e[r]||0)+o.selfTime}if(SDK.TracingModel.TracingModel.isAsyncPhase(i.phase)){if(i.endTime){let t=0;for(const i in e)t+=e[i];e.idle=Math.max(0,i.endTime-i.startTime-t)}return!1}return a}static async buildPicturePreviewContent(e,t){const i=await new TimelineModel.TimelineFrameModel.LayerPaintEvent(e,t).snapshotPromise();if(!i)return null;const n=i.snapshot.replay();i.snapshot.release();const l=await n;if(!l)return null;const a=createElement("div");UI.Utils.appendStyle(a,"components/imagePreview.css"),a.classList.add("image-preview-container","vbox","link");const s=a.createChild("img");s.src=l,s.alt=Components.ImagePreview.ImagePreview.defaultAltTextForImageURL(l);return a.createChild("a").textContent=ls`Paint Profiler`,UI.ARIAUtils.markAsLink(a),a.tabIndex=0,a.addEventListener("click",()=>TimelinePanel.instance().select(TimelineSelection.fromTraceEvent(e)),!1),a.addEventListener("keydown",t=>{isEnterKey(t)&&(TimelinePanel.instance().select(TimelineSelection.fromTraceEvent(e)),t.consume(!0))}),a}static createEventDivider(e,t){const i=document.createElement("div");i.classList.add("resources-event-divider");const n=Number.millisToString(e.startTime-t);i.title=Common.UIString.UIString("%s at %s",TimelineUIUtils.eventTitle(e),n);const l=TimelineUIUtils.markerStyleForEvent(e);return l.tall&&(i.style.backgroundColor=l.color),i}static _visibleTypes(){const e=TimelineUIUtils._initEventStyles(),t=[];for(const i in e)e[i].hidden||t.push(i);return t}static visibleEventsFilter(){return new TimelineModel.TimelineModelFilter.TimelineVisibleEventsFilter(TimelineUIUtils._visibleTypes())}static categories(){return TimelineUIUtils._categories||(TimelineUIUtils._categories={loading:new TimelineCategory("loading",ls`Loading`,!0,"hsl(214, 67%, 74%)","hsl(214, 67%, 66%)"),experience:new TimelineCategory("experience",ls`Experience`,!1,"hsl(5, 80%, 74%)","hsl(5, 80%, 66%)"),scripting:new TimelineCategory("scripting",ls`Scripting`,!0,"hsl(43, 83%, 72%)","hsl(43, 83%, 64%) "),rendering:new TimelineCategory("rendering",ls`Rendering`,!0,"hsl(256, 67%, 76%)","hsl(256, 67%, 70%)"),painting:new TimelineCategory("painting",ls`Painting`,!0,"hsl(109, 33%, 64%)","hsl(109, 33%, 55%)"),gpu:new TimelineCategory("gpu",ls`GPU`,!1,"hsl(109, 33%, 64%)","hsl(109, 33%, 55%)"),async:new TimelineCategory("async",ls`Async`,!1,"hsl(0, 100%, 50%)","hsl(0, 100%, 40%)"),other:new TimelineCategory("other",ls`System`,!1,"hsl(0, 0%, 87%)","hsl(0, 0%, 79%)"),idle:new TimelineCategory("idle",ls`Idle`,!1,"hsl(0, 0%, 98%)","hsl(0, 0%, 98%)")}),TimelineUIUtils._categories}static setCategories(e){TimelineUIUtils._categories=e}static getTimelineMainEventCategories(){return TimelineUIUtils._eventCategories||(TimelineUIUtils._eventCategories=["idle","loading","painting","rendering","scripting","other"]),TimelineUIUtils._eventCategories}static setTimelineMainEventCategories(e){TimelineUIUtils._eventCategories=e}static generatePieChart(e,t,i){let n=0;for(const t in e)n+=e[t];const l=document.createElement("div");l.classList.add("timeline-details-view-pie-chart-wrapper"),l.classList.add("hbox");const a=new PerfUI.PieChart.PieChart({chartName:ls`Time spent in rendering`,size:110,formatter:e=>Number.preciseMillisToString(e),showLegend:!0});a.element.classList.add("timeline-details-view-pie-chart"),a.initializeWithTotal(n);function s(e,t,i,n){i&&a.addSlice(i,n,t)}if(l.createChild("div","vbox").appendChild(a.element),t){i&&s(t.name,Common.UIString.UIString("%s (self)",t.title),i,t.color);const n=e[t.name]-i;n>0&&s(t.name,Common.UIString.UIString("%s (children)",t.title),n,t.childColor)}for(const i in TimelineUIUtils.categories()){const n=TimelineUIUtils.categories()[i];n!==t&&s(n.name,n.title,e[n.name],n.childColor)}return l}static generateDetailsContentForFrame(e,t){const i=new TimelineDetailsContentHelper(null,null);i.addSection(ls`Frame`);const n=TimelineUIUtils.frameDuration(e);i.appendElementRow(ls`Duration`,n,e.hasWarnings());const l=e.endTime-e.startTime;if(i.appendTextRow(ls`FPS`,Math.floor(1e3/l)),i.appendTextRow(ls`CPU time`,Number.millisToString(e.cpuTime,!0)),t){const e=document.createElement("div");e.classList.add("timeline-filmstrip-preview"),t.imageDataPromise().then(e=>UI.UIUtils.loadImageFromData(e)).then(t=>t&&e.appendChild(t)),i.appendElementRow("",e),e.addEventListener("click",function(e){new PerfUI.FilmStripView.Dialog(e,0)}.bind(null,t),!1)}return e.layerTree&&i.appendElementRow(ls`Layer tree`,Components.Linkifier.Linkifier.linkifyRevealable(e.layerTree,ls`Show`)),i.fragment}static frameDuration(e){const t=Common.UIString.UIString("%s (at %s)",Number.millisToString(e.endTime-e.startTime,!0),Number.millisToString(e.startTimeOffset,!0));if(!e.hasWarnings())return UI.UIUtils.formatLocalized("%s",[t]);const i=UI.XLink.XLink.create("https://developers.google.com/web/fundamentals/performance/rendering/",ls`jank`);return UI.UIUtils.formatLocalized("%s. Long frame times are an indication of %s",[t,i])}static createFillStyle(e,t,i,n,l,a){const s=e.createLinearGradient(0,0,t,i);return s.addColorStop(0,n),s.addColorStop(.25,l),s.addColorStop(.75,l),s.addColorStop(1,a),s}static quadWidth(e){return Math.round(Math.sqrt(Math.pow(e[0]-e[2],2)+Math.pow(e[1]-e[3],2)))}static quadHeight(e){return Math.round(Math.sqrt(Math.pow(e[0]-e[6],2)+Math.pow(e[1]-e[7],2)))}static eventDispatchDesciptors(){if(TimelineUIUtils._eventDispatchDesciptors)return TimelineUIUtils._eventDispatchDesciptors;const e="hsl(40,100%,50%)";return TimelineUIUtils._eventDispatchDesciptors=[new EventDispatchTypeDescriptor(1,"hsl(40,100%,80%)",["mousemove","mouseenter","mouseleave","mouseout","mouseover"]),new EventDispatchTypeDescriptor(1,"hsl(40,100%,80%)",["pointerover","pointerout","pointerenter","pointerleave","pointermove"]),new EventDispatchTypeDescriptor(2,"hsl(90,100%,40%)",["wheel"]),new EventDispatchTypeDescriptor(3,e,["click","mousedown","mouseup"]),new EventDispatchTypeDescriptor(3,e,["touchstart","touchend","touchmove","touchcancel"]),new EventDispatchTypeDescriptor(3,e,["pointerdown","pointerup","pointercancel","gotpointercapture","lostpointercapture"]),new EventDispatchTypeDescriptor(3,"hsl(256,100%,75%)",["keydown","keyup","keypress"])],TimelineUIUtils._eventDispatchDesciptors}static markerShortTitle(e){const t=TimelineModel.TimelineModel.RecordType;switch(e.name){case t.MarkDOMContent:return ls`DCL`;case t.MarkLoad:return ls`L`;case t.MarkFirstPaint:return ls`FP`;case t.MarkFCP:return ls`FCP`;case t.MarkLCPCandidate:return ls`LCP`}return null}static markerStyleForEvent(e){const t=[6,4],i=TimelineUIUtils.eventTitle(e),n=TimelineModel.TimelineModel.RecordType;if(e.name!==n.NavigationStart&&(e.hasCategory(TimelineModel.TimelineModel.TimelineModelImpl.Category.Console)||e.hasCategory(TimelineModel.TimelineModel.TimelineModelImpl.Category.UserTiming)))return{title:i,dashStyle:t,lineWidth:.5,color:e.hasCategory(TimelineModel.TimelineModel.TimelineModelImpl.Category.UserTiming)?"purple":"orange",tall:!1,lowPriority:!1};let l=!1,a="grey";switch(e.name){case n.NavigationStart:a="#FF9800",l=!0;break;case n.FrameStartedLoading:a="green",l=!0;break;case n.MarkDOMContent:a="#0867CB",l=!0;break;case n.MarkLoad:a="#B31412",l=!0;break;case n.MarkFirstPaint:a="#228847",l=!0;break;case n.MarkFCP:a="#1A6937",l=!0;break;case n.MarkLCPCandidate:a="#1A3422",l=!0;break;case n.TimeStamp:a="orange"}return{title:i,dashStyle:t,lineWidth:.5,color:a,tall:l,lowPriority:!1}}static markerStyleForFrame(){return{title:ls`Frame`,color:"rgba(100, 100, 100, 0.4)",lineWidth:3,dashStyle:[3],tall:!0,lowPriority:!0}}static colorForId(e){return TimelineUIUtils.colorForId._colorGenerator||(TimelineUIUtils.colorForId._colorGenerator=new Common.Color.Generator({min:30,max:330},{min:50,max:80,count:3},85),TimelineUIUtils.colorForId._colorGenerator.setColorForID("","#f2ecdc")),TimelineUIUtils.colorForId._colorGenerator.colorForID(e)}static eventWarning(e,t){const i=TimelineModel.TimelineModel.TimelineData.forEvent(e),n=t||i.warning;if(!n)return null;const l=TimelineModel.TimelineModel.TimelineModelImpl.WarningType,a=createElement("span"),s=e.args.data;switch(n){case l.ForcedStyle:case l.ForcedLayout:{const e=UI.UIUtils.createDocumentationLink("../../fundamentals/performance/rendering/avoid-large-complex-layouts-and-layout-thrashing#avoid-forced-synchronous-layouts",ls`Forced reflow`);a.appendChild(UI.UIUtils.formatLocalized("%s is a likely performance bottleneck.",[e]));break}case l.IdleDeadlineExceeded:{const t=Number.millisToString(e.duration-s.allottedMilliseconds,!0);a.textContent=ls`Idle callback execution extended beyond deadline by ${t}`;break}case l.LongHandler:a.textContent=Common.UIString.UIString("Handler took %s",Number.millisToString(e.duration,!0));break;case l.LongRecurringHandler:a.textContent=Common.UIString.UIString("Recurring handler took %s",Number.millisToString(e.duration,!0));break;case l.LongTask:{const t=UI.UIUtils.createDocumentationLink("../../fundamentals/performance/rail#goals-and-guidelines",ls`Long task`);a.appendChild(UI.UIUtils.formatLocalized("%s took %s.",[t,Number.millisToString(e.duration,!0)]));break}case l.V8Deopt:a.appendChild(UI.XLink.XLink.create("https://github.com/GoogleChrome/devtools-docs/issues/53",Common.UIString.UIString("Not optimized"))),a.createTextChild(Common.UIString.UIString(": %s",s.deoptReason));break;default:console.assert(!1,"Unhandled TimelineModel.WarningType")}return a}static displayNameForFrame(e,t){return t||(t=30),e.url.startsWith("about:")?`"${e.name.trimMiddle(t)}"`:e.url.trimEnd(t)}}export class TimelineRecordStyle{constructor(e,t,i=!1){this.title=e,this.category=t,this.hidden=i}}export const NetworkCategory={HTML:Symbol("HTML"),Script:Symbol("Script"),Style:Symbol("Style"),Media:Symbol("Media"),Other:Symbol("Other")};export const aggregatedStatsKey=Symbol("aggregatedStats");export class InvalidationsGroupElement extends UI.TreeOutline.TreeElement{constructor(e,t,i,n){super("",!0),this.listItemElement.classList.add("header"),this.selectable=!1,this.toggleOnClick=!0,this._relatedNodesMap=t,this._contentHelper=i,this._invalidations=n,this.title=this._createTitle(e)}_createTitle(e){const t=this._invalidations[0],i=t.cause.reason||ls`Unknown cause`,n=t.cause.stackTrace&&t.cause.stackTrace[0],l=this._getTruncatedNodesElement(this._invalidations);if(null===l)return UI.UIUtils.formatLocalized(i,[]);const a=UI.UIUtils.formatLocalized("%s for %s",[i,l]);if(n&&this._contentHelper.linkifier()){const t=document.createElement("span");t.classList.add("monospace");const i=UI.UIUtils.formatLocalized("%s. %s",[a,t]);t.createChild("span").textContent=TimelineUIUtils.frameDisplayName(n);const l=this._contentHelper.linkifier().maybeLinkifyConsoleCallFrame(e,n);return l&&(t.createChild("span").textContent=" @ ",t.createChild("span").appendChild(l)),i}return a}async onpopulate(){const e=document.createElement("div");e.classList.add("content");const t=this._invalidations[0];if(t.cause.stackTrace){const i=e.createChild("div");i.createTextChild(ls`Stack trace:`),this._contentHelper.createChildStackTraceElement(i,TimelineUIUtils._stackTraceFromCallFrames(t.cause.stackTrace))}e.createTextChild(1!==this._invalidations.length?ls`Nodes:`:ls`Node:`);const i=e.createChild("div","node-list");let n=!0;for(let e=0;e<this._invalidations.length;e++){const t=this._invalidations[e],l=this._createInvalidationNode(t,!0);if(l){n||i.createTextChild(ls`, `),n=!1,i.appendChild(l);const e=t.extraData?", "+t.extraData:"";t.changedId?i.createTextChild(Common.UIString.UIString('(changed id to "%s"%s)',t.changedId,e)):t.changedClass?i.createTextChild(Common.UIString.UIString('(changed class to "%s"%s)',t.changedClass,e)):t.changedAttribute?i.createTextChild(Common.UIString.UIString('(changed attribute to "%s"%s)',t.changedAttribute,e)):t.changedPseudo?i.createTextChild(Common.UIString.UIString('(changed pesudo to "%s"%s)',t.changedPseudo,e)):t.selectorPart&&i.createTextChild(Common.UIString.UIString('(changed "%s"%s)',t.selectorPart,e))}}const l=new UI.TreeOutline.TreeElement(e,!1);l.selectable=!1,this.appendChild(l)}_getTruncatedNodesElement(e){const t=[],i={};for(let n=0;n<e.length;n++){const l=e[n],a=this._createInvalidationNode(l,!1);a.addEventListener("click",e=>e.consume(),!1),a&&!i[l.nodeId]&&(t.push(a),i[l.nodeId]=!0)}return 1===t.length?t[0]:2===t.length?UI.UIUtils.formatLocalized("%s and %s",t):3===t.length?UI.UIUtils.formatLocalized("%s, %s, and 1 other",t.slice(0,2)):t.length>=4?UI.UIUtils.formatLocalized("%s, %s, and %s others",[...t.slice(0,2),(t.length-2).toString()]):null}_createInvalidationNode(e,t){const i=e.nodeId&&this._relatedNodesMap?this._relatedNodesMap.get(e.nodeId):null;if(i){const e=createElement("span");return Common.Linkifier.Linkifier.linkify(i).then(t=>e.appendChild(t)),e}if(e.nodeName){const t=createElement("span");return t.textContent=Common.UIString.UIString("[ %s ]",e.nodeName),t}if(t){return createElement("span").createTextChild(Common.UIString.UIString("[ unknown node ]"))}}}export const previewElementSymbol=Symbol("previewElement");export class EventDispatchTypeDescriptor{constructor(e,t,i){this.priority=e,this.color=t,this.eventTypes=i}}export class TimelineCategory extends Common.ObjectWrapper.ObjectWrapper{constructor(e,t,i,n,l){super(),this.name=e,this.title=t,this.visible=i,this.childColor=n,this.color=l,this.hidden=!1}get hidden(){return this._hidden}set hidden(e){this._hidden=e,this.dispatchEventToListeners(TimelineCategory.Events.VisibilityChanged,this)}}TimelineCategory.Events={VisibilityChanged:Symbol("VisibilityChanged")};export class TimelinePopupContentHelper{constructor(e){this._contentTable=createElement("table");const t=this._createCell(Common.UIString.UIString("%s - Details",e),"timeline-details-title");t.colSpan=2;const i=createElement("tr");i.appendChild(t),this._contentTable.appendChild(i)}contentTable(){return this._contentTable}_createCell(e,t){createElement("label").createTextChild(String(e));const i=createElement("td");return i.className="timeline-details",t&&(i.className+=" "+t),i.textContent=e,i}appendTextRow(e,t){const i=createElement("tr");i.appendChild(this._createCell(e,"timeline-details-row-title")),i.appendChild(this._createCell(t,"timeline-details-row-data")),this._contentTable.appendChild(i)}appendElementRow(e,t){const i=createElement("tr"),n=this._createCell(e,"timeline-details-row-title");i.appendChild(n);const l=createElement("td");l.className="details",t instanceof Node?l.appendChild(t):l.createTextChild(t||""),i.appendChild(l),this._contentTable.appendChild(i)}}export class TimelineDetailsContentHelper{constructor(e,t){this.fragment=createDocumentFragment(),this._linkifier=t,this._target=e,this.element=document.createElement("div"),this.element.classList.add("timeline-details-view-block"),this._tableElement=this.element.createChild("div","vbox timeline-details-chip-body"),this.fragment.appendChild(this.element)}addSection(e,t){if(this._tableElement.hasChildNodes()?(this.element=document.createElement("div"),this.element.classList.add("timeline-details-view-block"),this.fragment.appendChild(this.element)):this.element.removeChildren(),e){const i=this.element.createChild("div","timeline-details-chip-title");t&&(i.createChild("div").style.backgroundColor=t),i.createTextChild(e)}this._tableElement=this.element.createChild("div","vbox timeline-details-chip-body"),this.fragment.appendChild(this.element)}linkifier(){return this._linkifier}appendTextRow(e,t){const i=this._tableElement.createChild("div","timeline-details-view-row");i.createChild("div","timeline-details-view-row-title").textContent=e,i.createChild("div","timeline-details-view-row-value").textContent=t}appendElementRow(e,t,i,n){const l=this._tableElement.createChild("div","timeline-details-view-row");i&&l.classList.add("timeline-details-warning"),n&&l.classList.add("timeline-details-stack-values");l.createChild("div","timeline-details-view-row-title").textContent=e;const a=l.createChild("div","timeline-details-view-row-value");t instanceof Node?a.appendChild(t):a.createTextChild(t||"")}appendLocationRow(e,t,i,n){if(!this._linkifier||!this._target)return;const l=this._linkifier.maybeLinkifyScriptLocation(this._target,null,t,i,{columnNumber:n,tabStop:!0});l&&this.appendElementRow(e,l)}appendLocationRange(e,t,i,n){if(!this._linkifier||!this._target)return;const l=createElement("span"),a=this._linkifier.maybeLinkifyScriptLocation(this._target,null,t,i,{tabStop:!0});a&&(l.appendChild(a),l.createTextChild(Platform.StringUtilities.sprintf(" [%s…%s]",i+1,n+1||"")),this.appendElementRow(e,l))}appendStackTrace(e,t){if(!this._linkifier||!this._target)return;const i=this._tableElement.createChild("div","timeline-details-view-row");i.createChild("div","timeline-details-view-row-title").textContent=e,this.createChildStackTraceElement(i,t)}createChildStackTraceElement(e,t){if(!this._linkifier||!this._target)return;e.classList.add("timeline-details-stack-values");const i=e.createChild("div","timeline-details-view-row-value timeline-details-view-row-stack-trace"),n=Components.JSPresentationUtils.buildStackTracePreviewContents(this._target,this._linkifier,{stackTrace:t,tabStops:!0});i.appendChild(n.element)}appendWarningRow(e,t){const i=TimelineUIUtils.eventWarning(e,t);i&&this.appendElementRow(ls`Warning`,i,!0)}}export const categoryBreakdownCacheSymbol=Symbol("categoryBreakdownCache");export let TimelineMarkerStyle;