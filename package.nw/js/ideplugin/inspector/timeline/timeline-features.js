import{TimelinePanel}from"./TimelinePanel.js";import{TimelineController}from"./TimelineController.js";import{TimelineFlameChartDataProvider,EntryType}from"./TimelineFlameChartDataProvider.js";import*as TimelineModel from"../timeline_model/timeline_model.js";import*as Common from"../common/common.js";import*as UI from"../ui/ui.js";import*as SDK from"../sdk/sdk.js";import PluginMessenger from"../wx_main/PluginMessenger.js";let traceMessenger;function getTraceMessenger(){return traceMessenger||(traceMessenger=new PluginMessenger("PLUGIN_trace_miniprogram"),traceMessenger.send("ON_PANNEL_SHOW")),traceMessenger}if(wxMain.isFeatureEnabled("hackTimeline")){const e=getTraceMessenger(),n=TimelinePanel.instance();TimelinePanel.prototype._selectFileToLoad=function(){e.send("TRACE_CLICK_LOAD")},n._showScreenshotsToolbarCheckbox.setVisible(!1);const t=n._showMemoryToolbarCheckbox.element;t.textElement.textContent=Common.UIString.UIString("Counter"),UI.Tooltip.Tooltip.install(n._showMemoryToolbarCheckbox.inputElement,"Show counters"),UI.Tooltip.Tooltip.install(t.textElement,"Show counters");const i=n._flameChart._countersView,r=i._countersByName,o=i._counterUI;["documents","nodes","jsEventListeners","gpuMemoryUsedKB"].forEach(e=>delete r[e]);for(let e=1,n=o.length;e<n;e++)i._toolbar._contentElement.removeChild(o[e]._filter.element);i._counterUI=o.slice(0,1),i._counters=i._counters.slice(0,1),r.memory=i._createCounter(Common.UIString.UIString("MEMORY"),Common.UIString.UIString("MEMORY [MB]: %s"),"hsl(0, 90%, 43%)"),r.cpu=i._createCounter(Common.UIString.UIString("CPU"),Common.UIString.UIString("CPU [%]: %s"),"hsl(120, 90%, 43%)"),r.fps=i._createCounter(Common.UIString.UIString("FPS"),Common.UIString.UIString("FPS: %s"),"hsl(38, 90%, 43%)"),TimelineController.prototype.startRecording=async function(e,n){function t(e){return"disabled-by-default-"+e}const i=["-*","devtools.timeline",t("devtools.timeline"),"v8.execute"];i.push(TimelineModel.TimelineModel.TimelineModelImpl.Category.LatencyInfo),Root.Runtime.experiments.isEnabled("timelineFlowEvents")&&i.push("devtools.timeline.async"),Root.Runtime.experiments.isEnabled("timelineV8RuntimeCallStats")&&e.enableJSSampling&&i.push(t("v8.runtime_stats_sampling")),!Root.Runtime.queryParam("timelineTracingJSProfileDisabled")&&e.enableJSSampling&&i.push(t("v8.cpu_profiler")),i.push(t("devtools.timeline.stack")),Root.Runtime.experiments.isEnabled("timelineInvalidationTracking")&&i.push(t("devtools.timeline.invalidationTracking")),this._performanceModel.setRecordStartTime(Date.now());const r=await this._startRecordingWithCategories(i.join(","),e.enableJSSampling);return r[ProtocolClient.InspectorBackend.ProtocolError]&&(await this._waitForTracingToStop(!1),await SDK.SDKModel.TargetManager.instance().resumeAllTargets()),r},TimelineFlameChartDataProvider.prototype._processInspectorTrace=function(){this._appendInteractionRecords();const e=EntryType.Event,n=e=>{switch(e.type){case TimelineModel.TimelineModel.TrackType.Timings:return 2;case TimelineModel.TimelineModel.TrackType.Console:return 3;case TimelineModel.TimelineModel.TrackType.Experience:return 4;case TimelineModel.TimelineModel.TrackType.MainThread:return e.forMainFrame?5:6}},t=this._model.tracks().slice();t.sort((e,t)=>n(e)-n(t));for(const n of t)switch(n.type){case TimelineModel.TimelineModel.TrackType.Timings:{const t=n.asyncEvents.length>0?this._collapsibleTimingsHeader:this._timingsHeader;this._appendHeader(ls`Timings`,t,!0)._track=n,this._appendPageMetrics(),this._appendAsyncEventsGroup(n,null,n.asyncEvents,t,e,!0);break}case TimelineModel.TimelineModel.TrackType.Console:this._appendAsyncEventsGroup(n,ls`Console`,n.asyncEvents,this._headerLevel1,e,!0);break;case TimelineModel.TimelineModel.TrackType.MainThread:if(n.forMainFrame){const t=this._appendSyncEvents(n,n.events,n.url?ls`Main \u2014 ${n.url}`:ls`Main`,this._headerLevel1,e,!0);t&&(this._timelineData.selectedGroup=t)}else this._appendSyncEvents(n,n.events,n.url?ls`Frame \u2014 ${n.url}`:ls`Subframe`,this._headerLevel1,e,!0)}this._timelineData.selectedGroup&&(this._timelineData.selectedGroup.expanded=!0);for(let e=0;e<this._extensionInfo.length;e++)this._innerAppendExtensionEvents(e);this._markers.sort((e,n)=>e.startTime()-n.startTime()),this._timelineData.markers=this._markers,this._flowEventIndexById.clear()}}if(wxMain.isFeatureEnabled("hackTimeline")||wxMain.isFeatureEnabled("importTrace")){const e=getTraceMessenger(),n=TimelinePanel.instance();e.on("TRACE_LOAD_FILE",(function({data:e}){e.traceEvents&&(e=e.traceEvents),n.loadFromEvents(e)})),TimelineFlameChartDataProvider.prototype._processGenericTrace=function(){const e=this._buildGroupStyle({shareHeaderLine:!1}),n=this._buildGroupStyle({padding:2,nestingLevel:1,shareHeaderLine:!1}),t=EntryType.Event,i=new Platform.Multimap;for(const e of this._model.tracks())null!==e.thread?i.set(e.thread.process(),e):console.error("Failed to process track");for(const r of i.keysArray()){if(i.size>1){const n=`${r.name()} ${r.id()}`;this._appendHeader(n,e,!1)}for(const e of i.get(r)){this._appendAsyncEventsGroup(e,e.name,e.asyncEvents,this._headerLevel1,t,!0);const i=this._appendSyncEvents(e,e.events,e.name,n,t,!0);this._timelineData.selectedGroup&&e.name!==TimelineModel.TimelineModel.TimelineModelImpl.BrowserMainThreadName||(this._timelineData.selectedGroup=i)}}};const t=TimelineModel.TimelineModel.TimelineModelImpl.prototype._processAsyncEvents;TimelineModel.TimelineModel.TimelineModelImpl.prototype._processAsyncEvents=function(e,n){t.call(this,e,n);const i=e.asyncEvents().filter(e=>e.hasCategory("async"));if(i.length>0){const n=this._ensureNamedTrack("async");n.thread=e,n.asyncEvents=n.asyncEvents=n.asyncEvents.mergeOrdered(i,SDK.TracingModel.Event.compareStartTime)}},SDK.TracingModel.TracingModel.browserMainThread=function(e){const n=e.sortedProcesses();if(!n.length)return null;const t=[],i=[];for(const e of n)e.name().toLowerCase().endsWith("browser")&&t.push(e),i.push(...e.sortedThreads().filter(e=>"CrBrowserMain"===e.name()));if(1===i.length)return i[0];if(1===t.length)return t[0].threadByName("CrBrowserMain");const r=e.devToolsMetadataEvents().filter(e=>"TracingStartedInBrowser"===e.name);return 1===r.length?r[0].thread:null}}TimelineModel.TimelineModel.TimelineModelImpl.prototype._buildLoadingEvents=function(e,n){const t=e.threadByName("Renderer","CrRendererMain");if(!t)return;const i=this._ensureNamedTrack(TimelineModel.TimelineModel.TrackType.Experience);i.thread=t,i.events=n;for(const e of i.events)if(e.categoriesString="experience",e.name===TimelineModel.TimelineModel.RecordType.LayoutShift){const n=e.args.data||e.args.beginData||{},t=TimelineModel.TimelineModel.TimelineData.forEvent(e);n.impacted_nodes&&(t.backendNodeId=n.impacted_nodes[0].node_id)}};