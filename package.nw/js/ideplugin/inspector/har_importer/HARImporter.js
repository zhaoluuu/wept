import*as Common from"../common/common.js";import*as SDK from"../sdk/sdk.js";import{HAREntry,HARLog,HARPage,HARTimings}from"./HARFormat.js";export class Importer{static requestsFromHARLog(e){const t=new Map;for(const s of e.pages)t.set(s.id,s);e.entries.sort((e,t)=>e.startedDateTime-t.startedDateTime);const s=new Map,o=[];for(const r of e.entries){let e=s.get(r.pageref);const n=e?e.mainRequest.url():r.request.url;let i=null;r._initiator&&(i={type:r._initiator.type,url:r._initiator.url,lineNumber:r._initiator.lineNumber});const c=new SDK.NetworkRequest.NetworkRequest("har-"+o.length,r.request.url,n,"","",i),a=t.get(r.pageref);!e&&a&&(e=Importer._buildPageLoad(a,c),s.set(r.pageref,e)),Importer._fillRequestFromHAREntry(c,r,e),e&&e.bindRequest(c),o.push(c)}return o}static _buildPageLoad(e,t){const s=new SDK.NetworkLog.PageLoad(t);return s.startTime=e.startedDateTime,s.contentLoadTime=1e3*e.pageTimings.onContentLoad,s.loadTime=1e3*e.pageTimings.onLoad,s}static _fillRequestFromHAREntry(e,t,s){t.request.postData?e.setRequestFormData(!0,t.request.postData.text):e.setRequestFormData(!1,null),e.connectionId=t.connection||"",e.requestMethod=t.request.method,e.setRequestHeaders(t.request.headers),t.response.content.mimeType&&"x-unknown"!==t.response.content.mimeType&&(e.mimeType=t.response.content.mimeType),e.responseHeaders=t.response.headers,e.statusCode=t.response.status,e.statusText=t.response.statusText;let o=t.response.httpVersion.toLowerCase();"http/2.0"===o&&(o="h2"),e.protocol=o.replace(/^http\/2\.0?\+quic/,"http/2+quic");const r=t.startedDateTime.getTime()/1e3;e.setIssueTime(r,r);const n=t.response.content.size>0?t.response.content.size:0,i=t.response.headersSize>0?t.response.headersSize:0,c=t.response.bodySize>0?t.response.bodySize:0;e.resourceSize=n||i+c;let a=t.response.customAsNumber("transferSize");void 0===a&&(a=t.response.headersSize+t.response.bodySize),e.setTransferSize(a>=0?a:0);const m=t.customAsString("fromCache");"memory"===m?e.setFromMemoryCache():"disk"===m&&e.setFromDiskCache();const u={error:null,content:null,encoded:"base64"===t.response.content.encoding};void 0!==t.response.content.text&&(u.content=t.response.content.text),e.setContentDataProvider(async()=>u),Importer._setupTiming(e,r,t.time,t.timings),e.setRemoteAddress(t.serverIPAddress||"",80),e.setResourceType(Importer._getResourceType(e,t,s));const p=t.customAsString("priority");Protocol.Network.ResourcePriority.hasOwnProperty(p)&&e.setPriority(p);const d=t.customAsArray("webSocketMessages");if(d)for(const t of d){if(void 0===t.time)continue;if(!Object.values(SDK.NetworkRequest.WebSocketFrameType).includes(t.type))continue;if(void 0===t.opcode)continue;if(void 0===t.data)continue;const s=t.type===SDK.NetworkRequest.WebSocketFrameType.Send;e.addFrame({time:t.time,text:t.data,opCode:t.opcode,mask:s,type:t.type})}e.finished=!0}static _getResourceType(e,t,s){const o=t.customAsString("resourceType");if(o){const e=Common.ResourceType.ResourceType.fromName(o);if(e)return e}if(s&&s.mainRequest===e)return Common.ResourceType.resourceTypes.Document;const r=Common.ResourceType.ResourceType.fromMimeType(t.response.content.mimeType);if(r!==Common.ResourceType.resourceTypes.Other)return r;const n=Common.ResourceType.ResourceType.fromURL(t.request.url);return n||Common.ResourceType.resourceTypes.Other}static _setupTiming(e,t,s,o){function r(e){return void 0===e||e<0?-1:(n+=e,n)}let n=o.blocked>=0?o.blocked:0;const i=o.customAsNumber("blocked_proxy")||-1,c=o.customAsNumber("blocked_queueing")||-1,a=o.ssl>=0?o.ssl:0;o.connect>0&&(o.connect-=a);const m={proxyStart:i>0?n-i:-1,proxyEnd:i>0?n:-1,requestTime:t+(c>0?c:0)/1e3,dnsStart:o.dns>=0?n:-1,dnsEnd:r(o.dns),connectStart:o.connect>=0?n:-1,connectEnd:r(o.connect)+a,sslStart:o.ssl>=0?n:-1,sslEnd:r(o.ssl),workerStart:-1,workerReady:-1,workerFetchStart:-1,workerRespondWithSettled:-1,sendStart:o.send>=0?n:-1,sendEnd:r(o.send),pushStart:0,pushEnd:0,receiveHeadersEnd:r(o.wait)};r(o.receive),e.timing=m,e.endTime=t+Math.max(s,n)/1e3}}