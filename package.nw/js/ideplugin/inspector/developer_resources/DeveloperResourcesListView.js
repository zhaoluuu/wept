import*as DataGrid from"../data_grid/data_grid.js";import{ls}from"../platform/platform.js";import*as SDK from"../sdk/sdk.js";import*as TextUtils from"../text_utils/text_utils.js";import*as UI from"../ui/ui.js";export class DeveloperResourcesListView extends UI.Widget.VBox{constructor(e){super(!0),this._nodeForItem=new Map,this._isVisibleFilter=e,this._highlightRegExp=null,this.registerRequiredCSS("developer_resources/developerResourcesListView.css");const t=[{id:"status",title:ls`Status`,width:"60px",fixedWidth:!0,sortable:!0},{id:"url",title:ls`URL`,width:"250px",fixedWidth:!1,sortable:!0},{id:"frame",title:ls`Frame`,width:"80px",fixedWidth:!1,sortable:!0},{id:"size",title:ls`Total Bytes`,width:"80px",fixedWidth:!0,sortable:!0,align:DataGrid.DataGrid.Align.Right},{id:"errorMessage",title:ls`Error`,width:"200px",fixedWidth:!1,sortable:!0}];this._dataGrid=new DataGrid.SortableDataGrid.SortableDataGrid({displayName:ls`Developer Resources`,columns:t}),this._dataGrid.setResizeMethod(DataGrid.DataGrid.ResizeMethod.Last),this._dataGrid.element.classList.add("flex-auto"),this._dataGrid.addEventListener(DataGrid.DataGrid.Events.SortingChanged,this._sortingChanged,this);const i=this._dataGrid.asWidget();i.show(this.contentElement),this.setDefaultFocusedChild(i)}update(e){let t=!1;const i=this._dataGrid.rootNode();for(const s of e){let e=this._nodeForItem.get(s);e?this._isVisibleFilter(e.item)&&(t=e._refreshIfNeeded()||t):(e=new GridNode(s),this._nodeForItem.set(s,e),this._isVisibleFilter(e.item)&&(i.appendChild(e),t=!0))}t&&this._sortingChanged()}reset(){this._nodeForItem.clear(),this._dataGrid.rootNode().removeChildren()}updateFilterAndHighlight(e){this._highlightRegExp=e;let t=!1;for(const e of this._nodeForItem.values()){const i=this._isVisibleFilter(e.item),s=!!e.parent;i&&e._setHighlight(this._highlightRegExp),i!==s&&(t=!0,i?this._dataGrid.rootNode().appendChild(e):e.remove())}t&&this._sortingChanged()}_sortingChanged(){const e=this._dataGrid.sortColumnId();if(!e)return;const t=GridNode.sortFunctionForColumn(e);t&&this._dataGrid.sortNodes(t,!this._dataGrid.isSortOrderAscending())}}class GridNode extends DataGrid.SortableDataGrid.SortableDataGridNode{constructor(e){super(),this.item=e,this._highlightRegExp=null}_setHighlight(e){this._highlightRegExp!==e&&(this._highlightRegExp=e,this.refresh())}_refreshIfNeeded(){return this.refresh(),!0}createCell(e){const t=this.createTD(e);switch(e){case"url":{t.title=this.item.url;const i=t.createChild("div","url-outer"),s=i.createChild("div","url-prefix"),r=i.createChild("div","url-suffix"),a=/^(.*)(\/[^/]*)$/.exec(this.item.url);s.textContent=a?a[1]:this.item.url,r.textContent=a?a[2]:"",this._highlightRegExp&&this._highlight(i,this.item.url),this.setCellAccessibleName(this.item.url,t,e);break}case"frame":{const e=SDK.FrameManager.FrameManager.instance().getFrame(this.item.frameId);t.textContent=e?e.displayName():this.item.frameId,t.onmouseenter=()=>{const e=SDK.FrameManager.FrameManager.instance().getFrame(this.item.frameId);e&&e.highlight()},t.onmouseleave=()=>SDK.OverlayModel.OverlayModel.hideDOMNodeHighlight();break}case"status":null===this.item.success?t.textContent=ls`pending`:t.textContent=this.item.success?ls`success`:ls`failure`;break;case"size":{const i=this.item.size;if(null!==i){t.createChild("span").textContent=Number.withThousandsSeparator(i);const s=1===i?ls`1 byte`:ls`${i} bytes`;this.setCellAccessibleName(s,t,e)}break}case"errorMessage":t.classList.add("error-message"),this.item.errorMessage&&(t.textContent=this.item.errorMessage,this._highlightRegExp&&this._highlight(t,this.item.errorMessage))}return t}_highlight(e,t){if(!this._highlightRegExp)return;const i=this._highlightRegExp.exec(t);if(!i||!i.length)return;const s=new TextUtils.TextRange.SourceRange(i.index,i[0].length);UI.UIUtils.highlightRangesWithStyleClass(e,[s],"filter-highlight")}static sortFunctionForColumn(e){const t=e=>null===e?-1:Number(e);switch(e){case"url":return(e,t)=>e.item.url.localeCompare(t.item.url);case"status":return(e,i)=>t(e.item.success)-t(i.item.success);case"size":return(e,i)=>t(e.item.size)-t(i.item.size);case"frame":return(e,t)=>e.item.frameId.localeCompare(t.item.frameId);case"errorMessage":return(e,t)=>(e.item.errorMessage||"").localeCompare(t.item.errorMessage||"");default:return console.assert(!1,"Unknown sort field: "+e),null}}}