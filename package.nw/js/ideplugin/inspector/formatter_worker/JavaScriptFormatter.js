import*as Acorn from"../third_party/acorn/acorn.js";import{AcornTokenizer,ECMA_VERSION,TokenOrComment}from"./AcornTokenizer.js";import{ESTreeWalker}from"./ESTreeWalker.js";import{FormattedContentBuilder}from"./FormattedContentBuilder.js";export class JavaScriptFormatter{constructor(t){this._builder=t,this._tokenizer,this._content,this._fromOffset,this._lastLineNumber}format(t,e,r,n){this._fromOffset=r,this._toOffset=n,this._content=t.substring(this._fromOffset,this._toOffset),this._lastLineNumber=0,this._tokenizer=new AcornTokenizer(this._content);const i=Acorn.parse(this._content,{ranges:!1,preserveParens:!0,allowImportExportEverywhere:!0,ecmaVersion:ECMA_VERSION});new ESTreeWalker(this._beforeVisit.bind(this),this._afterVisit.bind(this)).walk(i)}_push(t,e){for(let r=0;r<e.length;++r)"s"===e[r]?this._builder.addSoftSpace():"S"===e[r]?this._builder.addHardSpace():"n"===e[r]?this._builder.addNewLine():">"===e[r]?this._builder.increaseNestingLevel():"<"===e[r]?this._builder.decreaseNestingLevel():"t"===e[r]&&(this._tokenizer.tokenLineStart()-this._lastLineNumber>1&&this._builder.addNewLine(!0),this._lastLineNumber=this._tokenizer.tokenLineEnd(),t&&this._builder.addToken(this._content.substring(t.start,t.end),this._fromOffset+t.start))}_beforeVisit(t){if(!t.parent)return;let e;for(;(e=this._tokenizer.peekToken())&&e.start<t.start;){const e=this._tokenizer.nextToken(),r=this._formatToken(t.parent,e);this._push(e,r)}}_afterVisit(t){let e;for(;(e=this._tokenizer.peekToken())&&e.start<t.end;){const e=this._tokenizer.nextToken(),r=this._formatToken(t,e);this._push(e,r)}this._push(null,this._finishNode(t))}_inForLoopHeader(t){const e=t.parent;if(!e)return!1;if("ForStatement"===e.type){const r=e;return t===r.init||t===r.test||t===r.update}if("ForInStatement"===e.type||"ForOfStatement"===e.type){const r=e;return t===r.left||t===r.right}return!1}_formatToken(t,e){const r=AcornTokenizer;if(r.lineComment(e))return"tn";if(r.blockComment(e))return"tn";const n=e;if("ContinueStatement"===t.type||"BreakStatement"===t.type)return t.label&&r.keyword(n)?"ts":"t";if("Identifier"===t.type)return"t";if("ReturnStatement"===t.type)return r.punctuator(n,";")?"t":t.argument?"ts":"t";if("AwaitExpression"===t.type)return r.punctuator(n,";")?"t":t.argument?"ts":"t";if("Property"===t.type)return r.punctuator(n,":")?"ts":"t";if("ArrayExpression"===t.type)return r.punctuator(n,",")?"ts":"t";if("LabeledStatement"===t.type){if(r.punctuator(n,":"))return"ts"}else if("LogicalExpression"===t.type||"AssignmentExpression"===t.type||"BinaryExpression"===t.type){if(r.punctuator(n)&&!r.punctuator(n,"()"))return"sts"}else if("ConditionalExpression"===t.type){if(r.punctuator(n,"?:"))return"sts"}else if("VariableDeclarator"===t.type){if(r.punctuator(n,"="))return"sts"}else if("ObjectPattern"===t.type){if(t.parent&&"VariableDeclarator"===t.parent.type&&r.punctuator(n,"{"))return"st";if(r.punctuator(n,","))return"ts"}else if("FunctionDeclaration"===t.type){if(r.punctuator(n,",)"))return"ts"}else if("FunctionExpression"===t.type){if(r.punctuator(n,",)"))return"ts";if(r.keyword(n,"function"))return t.id?"ts":"t"}else if("WithStatement"===t.type){if(r.punctuator(n,")"))return t.body&&"BlockStatement"===t.body.type?"ts":"tn>"}else if("SwitchStatement"===t.type){if(r.punctuator(n,"{"))return"tn>";if(r.punctuator(n,"}"))return"n<tn";if(r.punctuator(n,")"))return"ts"}else if("SwitchCase"===t.type){if(r.keyword(n,"case"))return"n<ts";if(r.keyword(n,"default"))return"n<t";if(r.punctuator(n,":"))return"tn>"}else if("VariableDeclaration"===t.type){if(r.punctuator(n,",")){let e=!0;const r=t.declarations;for(let t=0;t<r.length;++t)e=e&&!!r[t].init;return!this._inForLoopHeader(t)&&e?"nSSts":"ts"}}else if("BlockStatement"===t.type){if(r.punctuator(n,"{"))return t.body.length?"tn>":"t";if(r.punctuator(n,"}"))return t.body.length?"n<t":"t"}else if("CatchClause"===t.type){if(r.punctuator(n,")"))return"ts"}else if("ObjectExpression"===t.type){if(!t.properties.length)return"t";if(r.punctuator(n,"{"))return"tn>";if(r.punctuator(n,"}"))return"n<t";if(r.punctuator(n,","))return"tn"}else if("IfStatement"===t.type){if(r.punctuator(n,")"))return t.consequent&&"BlockStatement"===t.consequent.type?"ts":"tn>";if(r.keyword(n,"else")){const e=t.consequent&&"BlockStatement"===t.consequent.type?"st":"n<t";let r="n>";return!t.alternate||"BlockStatement"!==t.alternate.type&&"IfStatement"!==t.alternate.type||(r="s"),e+r}}else if("CallExpression"===t.type){if(r.punctuator(n,","))return"ts"}else{if("SequenceExpression"===t.type&&r.punctuator(n,","))return t.parent&&"SwitchCase"===t.parent.type?"ts":"tn";if("ForStatement"===t.type||"ForOfStatement"===t.type||"ForInStatement"===t.type){if(r.punctuator(n,";"))return"ts";if(r.keyword(n,"in")||r.identifier(n,"of"))return"sts";if(r.punctuator(n,")"))return t.body&&"BlockStatement"===t.body.type?"ts":"tn>"}else if("WhileStatement"===t.type){if(r.punctuator(n,")"))return t.body&&"BlockStatement"===t.body.type?"ts":"tn>"}else if("DoWhileStatement"===t.type){const e=t.body&&"BlockStatement"===t.body.type;if(r.keyword(n,"do"))return e?"ts":"tn>";if(r.keyword(n,"while"))return e?"sts":"n<ts"}else{if("ClassBody"===t.type)return r.punctuator(n,"{")?"stn>":r.punctuator(n,"}")?"<ntn":"t";if("YieldExpression"===t.type)return"t";if("Super"===t.type)return"t";if("ImportExpression"===t.type)return"t";if("ExportAllDeclaration"===t.type)return r.punctuator(n,"*")?"sts":"t";if("ExportNamedDeclaration"===t.type||"ImportDeclaration"===t.type)return r.punctuator(n,"{")?"st":r.punctuator(n,",")?"ts":r.punctuator(n,"}")?t.source?"ts":"t":r.punctuator(n,"*")?"sts":"t"}}return r.keyword(n)&&!r.keyword(n,"this")?"ts":"t"}_finishNode(t){if("WithStatement"===t.type){if(t.body&&"BlockStatement"!==t.body.type)return"n<"}else if("VariableDeclaration"===t.type){if(!this._inForLoopHeader(t))return"n"}else if("ForStatement"===t.type||"ForOfStatement"===t.type||"ForInStatement"===t.type){if(t.body&&"BlockStatement"!==t.body.type)return"n<"}else{if("BlockStatement"===t.type){if(t.parent&&"IfStatement"===t.parent.type){const e=t.parent;if(e.alternate&&e.consequent===t)return""}if(t.parent&&"FunctionExpression"===t.parent.type&&t.parent.parent&&"Property"===t.parent.parent.type)return"";if(t.parent&&"FunctionExpression"===t.parent.type&&t.parent.parent&&"VariableDeclarator"===t.parent.parent.type)return"";if(t.parent&&"FunctionExpression"===t.parent.type&&t.parent.parent&&"CallExpression"===t.parent.parent.type)return"";if(t.parent&&"DoWhileStatement"===t.parent.type)return"";if(t.parent&&"TryStatement"===t.parent.type){if(t.parent.block===t)return"s"}if(t.parent&&"CatchClause"===t.parent.type){const e=t.parent;if(e.parent&&e.parent.finalizer)return"s"}return"n"}if("WhileStatement"===t.type){if(t.body&&"BlockStatement"!==t.body.type)return"n<"}else if("IfStatement"===t.type){if(t.alternate){if("BlockStatement"!==t.alternate.type&&"IfStatement"!==t.alternate.type)return"<"}else if(t.consequent&&"BlockStatement"!==t.consequent.type)return"<"}else{if("BreakStatement"===t.type||"ContinueStatement"===t.type||"ThrowStatement"===t.type||"ReturnStatement"===t.type||"ExpressionStatement"===t.type)return"n";if("ImportDeclaration"===t.type||"ExportAllDeclaration"===t.type||"ExportDefaultDeclaration"===t.type||"ExportNamedDeclaration"===t.type)return"n"}}return""}}