import*as Platform from"../platform/platform.js";import{blendColors,luminance,rgbaToHsla}from"./ColorUtils.js";let _rgbaToNickname;export class Color{constructor(r,t,e){this._hsla=void 0,this._rgba=r,this._originalText=e||null,this._originalTextIsValid=!!this._originalText,this._format=t,void 0===this._rgba[3]&&(this._rgba[3]=1);for(let r=0;r<4;++r)this._rgba[r]<0&&(this._rgba[r]=0,this._originalTextIsValid=!1),this._rgba[r]>1&&(this._rgba[r]=1,this._originalTextIsValid=!1)}static parse(r){let t=r.toLowerCase().replace(/\s+/g,"").match(/^(?:#([0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})|(\w+))$/i);if(t){if(t[1]){let e,o=t[1].toLowerCase();3===o.length?(e=Format.ShortHEX,o=o.charAt(0)+o.charAt(0)+o.charAt(1)+o.charAt(1)+o.charAt(2)+o.charAt(2)):4===o.length?(e=Format.ShortHEXA,o=o.charAt(0)+o.charAt(0)+o.charAt(1)+o.charAt(1)+o.charAt(2)+o.charAt(2)+o.charAt(3)+o.charAt(3)):e=6===o.length?Format.HEX:Format.HEXA;const a=parseInt(o.substring(0,2),16),i=parseInt(o.substring(2,4),16),n=parseInt(o.substring(4,6),16);let l=1;return 8===o.length&&(l=parseInt(o.substring(6,8),16)/255),new Color([a/255,i/255,n/255,l],e,r)}if(t[2]){const e=t[2].toLowerCase();if(e in Nicknames){const t=Nicknames[e],o=Color.fromRGBA(t);return o._format=Format.Nickname,o._originalText=r,o}return null}return null}if(t=r.toLowerCase().match(/^\s*(?:(rgba?)|(hsla?))\((.*)\)\s*$/),t){const e=t[3].trim();let o=e.split(/\s*,\s*/);if(1===o.length)if(o=e.split(/\s+/),"/"===o[3]){if(o.splice(3,1),4!==o.length)return null}else if(o.length>2&&-1!==o[2].indexOf("/")||o.length>3&&-1!==o[3].indexOf("/")){const r=o.slice(2,4).join("");o=o.slice(0,2).concat(r.split(/\//)).concat(o.slice(4))}else if(o.length>=4)return null;if(3!==o.length&&4!==o.length||o.indexOf("")>-1)return null;const a=void 0!==o[3];if(t[1]){const t=[Color._parseRgbNumeric(o[0]),Color._parseRgbNumeric(o[1]),Color._parseRgbNumeric(o[2]),a?Color._parseAlphaNumeric(o[3]):1];return t.indexOf(null)>-1?null:new Color(t,a?Format.RGBA:Format.RGB,r)}if(t[2]){const t=[Color._parseHueNumeric(o[0]),Color._parseSatLightNumeric(o[1]),Color._parseSatLightNumeric(o[2]),a?Color._parseAlphaNumeric(o[3]):1];if(t.indexOf(null)>-1)return null;const e=[];return Color.hsl2rgb(t,e),new Color(e,a?Format.HSLA:Format.HSL,r)}}return null}static fromRGBA(r){return new Color([r[0]/255,r[1]/255,r[2]/255,r[3]],Format.RGBA)}static fromHSVA(r){const t=[];return Color.hsva2rgba(r,t),new Color(t,Format.HSLA)}static _parsePercentOrNumber(r){if(isNaN(r.replace("%","")))return null;const t=parseFloat(r);return-1!==r.indexOf("%")?r.indexOf("%")!==r.length-1?null:t/100:t}static _parseRgbNumeric(r){const t=Color._parsePercentOrNumber(r);return null===t?null:-1!==r.indexOf("%")?t:t/255}static _parseHueNumeric(r){const t=r.replace(/(deg|g?rad|turn)$/,"");if(isNaN(t)||r.match(/\s+(deg|g?rad|turn)/))return null;const e=parseFloat(t);return-1!==r.indexOf("turn")?e%1:-1!==r.indexOf("grad")?e/400%1:-1!==r.indexOf("rad")?e/(2*Math.PI)%1:e/360%1}static _parseSatLightNumeric(r){if(r.indexOf("%")!==r.length-1||isNaN(r.replace("%","")))return null;const t=parseFloat(r);return Math.min(1,t/100)}static _parseAlphaNumeric(r){return Color._parsePercentOrNumber(r)}static _hsva2hsla(r,t){const e=r[0];let o=r[1];const a=r[2],i=(2-o)*a;0===a||0===o?o=0:o*=a/(i<1?i:2-i),t[0]=e,t[1]=o,t[2]=i/2,t[3]=r[3]}static hsl2rgb(r,t){const e=r[0];let o=r[1];const a=r[2];function i(r,t,e){return e<0?e+=1:e>1&&(e-=1),6*e<1?r+(t-r)*e*6:2*e<1?t:3*e<2?r+(t-r)*(2/3-e)*6:r}let n;o<0&&(o=0),n=a<=.5?a*(1+o):a+o-a*o;const l=2*a-n,s=e+1/3,h=e,c=e-1/3;t[0]=i(l,n,s),t[1]=i(l,n,h),t[2]=i(l,n,c),t[3]=r[3]}static hsva2rgba(r,t){Color._hsva2hsla(r,_tmpHSLA),Color.hsl2rgb(_tmpHSLA,t);for(let r=0;r<_tmpHSLA.length;r++)_tmpHSLA[r]=0}static desiredLuminance(r,t,e){function o(){return e?(r+.05)*t-.05:(r+.05)/t-.05}let a=o();return(a<0||a>1)&&(e=!e,a=o()),a}static approachColorValue(r,t,e,o){const a=()=>luminance(blendColors(Color.fromHSVA(r).rgba(),t));let i=r[e],n=1,l=a()-o,s=Math.sign(l);for(let t=100;t;t--){if(Math.abs(l)<2e-4)return r[e]=i,i;const t=Math.sign(l);if(t!==s)n/=2,s=t;else if(i<0||i>1)return null;i+=n*(2===e?-l:l),r[e]=i,l=a()-o}return console.error("Loop exited unexpectedly"),null}static findFgColorForContrast(r,t,e){const o=r.hsva(),a=t.rgba(),i=luminance(t.rgba()),n=luminance(blendColors(Color.fromHSVA(o).rgba(),a))>i,l=Color.desiredLuminance(i,e,n);return Color.approachColorValue(o,a,2,l)?Color.fromHSVA(o):(o[2]=1,Color.approachColorValue(o,a,1,l)?Color.fromHSVA(o):null)}format(){return this._format}hsla(){return this._hsla||(this._hsla=rgbaToHsla(this._rgba)),this._hsla}canonicalHSLA(){const r=this.hsla();return[Math.round(360*r[0]),Math.round(100*r[1]),Math.round(100*r[2]),r[3]]}hsva(){const r=this.hsla(),t=r[0];let e=r[1];const o=r[2];return e*=o<.5?o:1-o,[t,0!==e?2*e/(o+e):0,o+e,r[3]]}hasAlpha(){return 1!==this._rgba[3]}detectHEXFormat(){let r=!0;for(let t=0;t<4;++t){if(Math.round(255*this._rgba[t])%17){r=!1;break}}const t=this.hasAlpha(),e=Format;return r?t?e.ShortHEXA:e.ShortHEX:t?e.HEXA:e.HEX}asString(r){if(r===this._format&&this._originalTextIsValid)return this._originalText;function t(r){return Math.round(255*r)}function e(r){const t=Math.round(255*r).toString(16);return 1===t.length?"0"+t:t}function o(r){return(Math.round(255*r)/17).toString(16)}switch(r||(r=this._format),r){case Format.Original:return this._originalText;case Format.RGB:case Format.RGBA:{const r=Platform.StringUtilities.sprintf("rgb(%d %d %d",t(this._rgba[0]),t(this._rgba[1]),t(this._rgba[2]));return this.hasAlpha()?r+Platform.StringUtilities.sprintf(" / %d%)",Math.round(100*this._rgba[3])):r+")"}case Format.HSL:case Format.HSLA:{const r=this.hsla(),t=Platform.StringUtilities.sprintf("hsl(%ddeg %d% %d%",Math.round(360*r[0]),Math.round(100*r[1]),Math.round(100*r[2]));return this.hasAlpha()?t+Platform.StringUtilities.sprintf(" / %d%)",Math.round(100*r[3])):t+")"}case Format.HEXA:return Platform.StringUtilities.sprintf("#%s%s%s%s",e(this._rgba[0]),e(this._rgba[1]),e(this._rgba[2]),e(this._rgba[3])).toLowerCase();case Format.HEX:return this.hasAlpha()?null:Platform.StringUtilities.sprintf("#%s%s%s",e(this._rgba[0]),e(this._rgba[1]),e(this._rgba[2])).toLowerCase();case Format.ShortHEXA:{const r=this.detectHEXFormat();return r!==Format.ShortHEXA&&r!==Format.ShortHEX?null:Platform.StringUtilities.sprintf("#%s%s%s%s",o(this._rgba[0]),o(this._rgba[1]),o(this._rgba[2]),o(this._rgba[3])).toLowerCase()}case Format.ShortHEX:return this.hasAlpha()||this.detectHEXFormat()!==Format.ShortHEX?null:Platform.StringUtilities.sprintf("#%s%s%s",o(this._rgba[0]),o(this._rgba[1]),o(this._rgba[2])).toLowerCase();case Format.Nickname:return this.nickname()}return this._originalText}rgba(){return this._rgba.slice()}canonicalRGBA(){const r=new Array(4);for(let t=0;t<3;++t)r[t]=Math.round(255*this._rgba[t]);return r[3]=this._rgba[3],r}nickname(){if(!_rgbaToNickname){_rgbaToNickname=new Map;for(const r in Nicknames){let t=Nicknames[r];4!==t.length&&(t=t.concat(1)),_rgbaToNickname.set(String(t),r)}}return _rgbaToNickname.get(String(this.canonicalRGBA()))||null}toProtocolRGBA(){const r=this.canonicalRGBA(),t={r:r[0],g:r[1],b:r[2],a:void 0};return 1!==r[3]&&(t.a=r[3]),t}invert(){const r=[];return r[0]=1-this._rgba[0],r[1]=1-this._rgba[1],r[2]=1-this._rgba[2],r[3]=this._rgba[3],new Color(r,Format.RGBA)}setAlpha(r){const t=this._rgba.slice();return t[3]=r,new Color(t,Format.RGBA)}blendWith(r){const t=blendColors(r._rgba,this._rgba);return new Color(t,Format.RGBA)}setFormat(r){this._format=r}}export const Regex=/((?:rgb|hsl)a?\([^)]+\)|#[0-9a-fA-F]{8}|#[0-9a-fA-F]{6}|#[0-9a-fA-F]{3,4}|\b[a-zA-Z]+\b(?!-))/g;export const Format={Original:"original",Nickname:"nickname",HEX:"hex",ShortHEX:"shorthex",HEXA:"hexa",ShortHEXA:"shorthexa",RGB:"rgb",RGBA:"rgba",HSL:"hsl",HSLA:"hsla"};export const Nicknames={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[237,20,61],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgrey:[169,169,169],darkgreen:[0,100,0],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],grey:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgreen:[144,238,144],lightgray:[211,211,211],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50],transparent:[0,0,0,0]};export const PageHighlight={Content:Color.fromRGBA([111,168,220,.66]),ContentLight:Color.fromRGBA([111,168,220,.5]),ContentOutline:Color.fromRGBA([9,83,148]),Padding:Color.fromRGBA([147,196,125,.55]),PaddingLight:Color.fromRGBA([147,196,125,.4]),Border:Color.fromRGBA([255,229,153,.66]),BorderLight:Color.fromRGBA([255,229,153,.5]),Margin:Color.fromRGBA([246,178,107,.66]),MarginLight:Color.fromRGBA([246,178,107,.5]),EventTarget:Color.fromRGBA([255,196,196,.66]),Shape:Color.fromRGBA([96,82,177,.8]),ShapeMargin:Color.fromRGBA([96,82,127,.6]),CssGrid:Color.fromRGBA([75,0,130,1]),GridRowLine:Color.fromRGBA([147,52,230,1]),GridColumnLine:Color.fromRGBA([147,52,230,1]),GridBorder:Color.fromRGBA([147,52,230,1]),GridRowGapBackground:Color.fromRGBA([147,52,230,.3]),GridColumnGapBackground:Color.fromRGBA([147,52,230,.3]),GridRowGapHatch:Color.fromRGBA([147,52,230,.8]),GridColumnGapHatch:Color.fromRGBA([147,52,230,.8]),GridAreaBorder:Color.fromRGBA([26,115,232,1])};export const SourceOrderHighlight={ParentOutline:Color.fromRGBA([224,90,183,1]),ChildOutline:Color.fromRGBA([0,120,212,1])};export class Generator{constructor(r,t,e,o){this._hueSpace=r||{min:0,max:360,count:void 0},this._satSpace=t||67,this._lightnessSpace=e||80,this._alphaSpace=o||1,this._colors=new Map}setColorForID(r,t){this._colors.set(r,t)}colorForID(r){let t=this._colors.get(r);return t||(t=this._generateColorForID(r),this._colors.set(r,t)),t}_generateColorForID(r){const t=String.hashCode(r),e=this._indexToValueInSpace(t,this._hueSpace),o=this._indexToValueInSpace(t>>8,this._satSpace),a=this._indexToValueInSpace(t>>16,this._lightnessSpace),i=this._indexToValueInSpace(t>>24,this._alphaSpace),n=`hsl(${e}deg ${o}% ${a}%`;return 1!==i?`${n} / ${Math.floor(100*i)}%)`:n+")"}_indexToValueInSpace(r,t){if("number"==typeof t)return t;const e=t.count||t.max-t.min;return r%=e,t.min+Math.floor(r/(e-1)*(t.max-t.min))}}const _tmpHSLA=[0,0,0,0];