import*as Common from"../common/common.js";import*as SDK from"../sdk/sdk.js";import{RecordType}from"./TimelineModel.js";export class TimelineIRModel{constructor(){this.reset()}static phaseForEvent(e){return e[TimelineIRModel._eventIRPhase]}populate(e,n){if(this.reset(),!e)return;this._processInputLatencies(e),n&&this._processAnimations(n);const s=new Common.SegmentedRange.SegmentedRange;s.appendRange(this._drags),s.appendRange(this._cssAnimations),s.appendRange(this._scrolls),s.appendRange(this._responses),this._segments=s.segments()}_processInputLatencies(e){const n=InputEvents,s=Phases,t=TimelineIRModel._mergeThresholdsMs;let o,a,r,i,l,m,c;for(let d=0;d<e.length;++d){const u=e[d];d>0&&e[d].startTime<e[d-1].startTime&&console.assert(!1,"Unordered input events");switch(this._inputEventType(u.name)){case n.ScrollBegin:this._scrolls.append(this._segmentForEvent(u,s.Scroll)),o=u;break;case n.ScrollEnd:o?this._scrolls.append(this._segmentForEventRange(o,u,s.Scroll)):this._scrolls.append(this._segmentForEvent(u,s.Scroll)),o=null;break;case n.ScrollUpdate:r=null,this._scrolls.append(this._segmentForEvent(u,s.Scroll));break;case n.FlingStart:if(a){Common.Console.Console.instance().error(Common.UIString.UIString("Two flings at the same time? %s vs %s",a.startTime,u.startTime));break}a=u;break;case n.FlingCancel:if(!a)break;this._scrolls.append(this._segmentForEventRange(a,u,s.Fling)),a=null;break;case n.ImplSideFling:this._scrolls.append(this._segmentForEvent(u,s.Fling));break;case n.ShowPress:case n.Tap:case n.KeyDown:case n.KeyDownRaw:case n.KeyUp:case n.Char:case n.Click:case n.ContextMenu:this._responses.append(this._segmentForEvent(u,s.Response));break;case n.TouchStart:if(r){Common.Console.Console.instance().error(Common.UIString.UIString("Two touches at the same time? %s vs %s",r.startTime,u.startTime));break}r=u,u.steps[0][TimelineIRModel._eventIRPhase]=s.Response,i=null;break;case n.TouchCancel:r=null;break;case n.TouchMove:i?this._drags.append(this._segmentForEvent(u,s.Drag)):r&&(i=u,this._responses.append(this._segmentForEventRange(r,u,s.Response)));break;case n.TouchEnd:r=null;break;case n.MouseDown:m=u,c=null;break;case n.MouseMove:m&&!c&&m.startTime+t.mouse>u.startTime?(this._responses.append(this._segmentForEvent(m,s.Response)),this._responses.append(this._segmentForEvent(u,s.Response))):m&&this._drags.append(this._segmentForEvent(u,s.Drag)),c=u;break;case n.MouseUp:this._responses.append(this._segmentForEvent(u,s.Response)),m=null;break;case n.MouseWheel:l&&(p=t.mouse,g=u,(h=l).endTime<g.startTime&&g.startTime<h.endTime+p)?this._scrolls.append(this._segmentForEventRange(l,u,s.Scroll)):this._scrolls.append(this._segmentForEvent(u,s.Scroll)),l=u}}var p,h,g}_processAnimations(e){for(let n=0;n<e.length;++n)this._cssAnimations.append(this._segmentForEvent(e[n],Phases.Animation))}_segmentForEvent(e,n){return this._setPhaseForEvent(e,n),new Common.SegmentedRange.Segment(e.startTime,e.endTime,n)}_segmentForEventRange(e,n,s){return this._setPhaseForEvent(e,s),this._setPhaseForEvent(n,s),new Common.SegmentedRange.Segment(e.startTime,n.endTime,s)}_setPhaseForEvent(e,n){e.steps[0][TimelineIRModel._eventIRPhase]=n}interactionRecords(){return this._segments}reset(){const e=TimelineIRModel._mergeThresholdsMs;function n(e,n,s){return n.end+e>=s.begin&&n.data===s.data?n:null}this._segments=[],this._drags=new Common.SegmentedRange.SegmentedRange(n.bind(null,e.mouse)),this._cssAnimations=new Common.SegmentedRange.SegmentedRange(n.bind(null,e.animation)),this._responses=new Common.SegmentedRange.SegmentedRange(n.bind(null,0)),this._scrolls=new Common.SegmentedRange.SegmentedRange(n.bind(null,e.animation))}_inputEventType(e){return e.startsWith("InputLatency::")?e.substr("InputLatency::".length):e===InputEvents.ImplSideFling?e:(console.error("Unrecognized input latency event: "+e),null)}}export const Phases={Idle:"Idle",Response:"Response",Scroll:"Scroll",Fling:"Fling",Drag:"Drag",Animation:"Animation",Uncategorized:"Uncategorized"};export const InputEvents={Char:"Char",Click:"GestureClick",ContextMenu:"ContextMenu",FlingCancel:"GestureFlingCancel",FlingStart:"GestureFlingStart",ImplSideFling:RecordType.ImplSideFling,KeyDown:"KeyDown",KeyDownRaw:"RawKeyDown",KeyUp:"KeyUp",LatencyScrollUpdate:"ScrollUpdate",MouseDown:"MouseDown",MouseMove:"MouseMove",MouseUp:"MouseUp",MouseWheel:"MouseWheel",PinchBegin:"GesturePinchBegin",PinchEnd:"GesturePinchEnd",PinchUpdate:"GesturePinchUpdate",ScrollBegin:"GestureScrollBegin",ScrollEnd:"GestureScrollEnd",ScrollUpdate:"GestureScrollUpdate",ScrollUpdateRenderer:"ScrollUpdate",ShowPress:"GestureShowPress",Tap:"GestureTap",TapCancel:"GestureTapCancel",TapDown:"GestureTapDown",TouchCancel:"TouchCancel",TouchEnd:"TouchEnd",TouchMove:"TouchMove",TouchStart:"TouchStart"};TimelineIRModel._mergeThresholdsMs={animation:1,mouse:40},TimelineIRModel._eventIRPhase=Symbol("eventIRPhase");