import*as Bindings from"../bindings/bindings.js";import*as Common from"../common/common.js";import*as Host from"../host/host.js";import*as Platform from"../platform/platform.js";import*as SDK from"../sdk/sdk.js";import*as SourceFrame from"../source_frame/source_frame.js";import*as UI from"../ui/ui.js";import*as Workspace from"../workspace/workspace.js";import{CoverageDecorationManager,decoratorType}from"./CoverageDecorationManager.js";import{CoverageListView}from"./CoverageListView.js";import{CoverageInfo,CoverageModel,CoverageType,Events,URLCoverageInfo}from"./CoverageModel.js";export class CoverageView extends UI.Widget.VBox{constructor(){super(!0),this._model=null,this._decorationManager=null,this._resourceTreeModel=null,this.registerRequiredCSS("coverage/coverageView.css");const e=this.contentElement.createChild("div","coverage-toolbar-container"),t=new UI.Toolbar.Toolbar("coverage-toolbar",e);this._coverageTypeComboBox=new UI.Toolbar.ToolbarComboBox(this._onCoverageTypeComboBoxSelectionChanged.bind(this),ls`Choose coverage granularity: Per function has low overhead, per block has significant overhead.`);const o=[{label:ls`Per function`,value:CoverageType.JavaScript|CoverageType.JavaScriptPerFunction},{label:ls`Per block`,value:CoverageType.JavaScript}];for(const e of o)this._coverageTypeComboBox.addOption(this._coverageTypeComboBox.createOption(e.label,e.value));this._coverageTypeComboBoxSetting=Common.Settings.Settings.instance().createSetting("coverageViewCoverageType",0),this._coverageTypeComboBox.setSelectedIndex(this._coverageTypeComboBoxSetting.get()),this._coverageTypeComboBox.setEnabled(!0),t.appendToolbarItem(this._coverageTypeComboBox),this._toggleRecordAction=UI.ActionRegistry.ActionRegistry.instance().action("coverage.toggle-recording"),this._toggleRecordButton=UI.Toolbar.Toolbar.createActionButton(this._toggleRecordAction),t.appendToolbarItem(this._toggleRecordButton);const i=SDK.SDKModel.TargetManager.instance().mainTarget();if(i&&i.model(SDK.ResourceTreeModel.ResourceTreeModel)){this._inlineReloadButton=null;const e=UI.ActionRegistry.ActionRegistry.instance().action("coverage.start-with-reload");this._startWithReloadButton=UI.Toolbar.Toolbar.createActionButton(e),t.appendToolbarItem(this._startWithReloadButton),this._toggleRecordButton.setEnabled(!1),this._toggleRecordButton.setVisible(!1)}this._clearButton=new UI.Toolbar.ToolbarButton(Common.UIString.UIString("Clear all"),"largeicon-clear"),this._clearButton.addEventListener(UI.Toolbar.ToolbarButton.Events.Click,this._clear.bind(this)),t.appendToolbarItem(this._clearButton),t.appendSeparator(),this._saveButton=new UI.Toolbar.ToolbarButton(Common.UIString.UIString("Export..."),"largeicon-download"),this._saveButton.addEventListener(UI.Toolbar.ToolbarButton.Events.Click,e=>{this._exportReport()}),t.appendToolbarItem(this._saveButton),this._saveButton.setEnabled(!1),this._textFilterRegExp=null,t.appendSeparator(),this._filterInput=new UI.Toolbar.ToolbarInput(Common.UIString.UIString("URL filter"),"",.4,1),this._filterInput.setEnabled(!1),this._filterInput.addEventListener(UI.Toolbar.ToolbarInput.Event.TextChanged,this._onFilterChanged,this),t.appendToolbarItem(this._filterInput),t.appendSeparator(),this._typeFilterValue=null,this._filterByTypeComboBox=new UI.Toolbar.ToolbarComboBox(this._onFilterByTypeChanged.bind(this),ls`Filter coverage by type`);const s=[{label:ls`All`,value:""},{label:ls`CSS`,value:CoverageType.CSS},{label:ls`JavaScript`,value:CoverageType.JavaScript|CoverageType.JavaScriptPerFunction}];for(const e of s)this._filterByTypeComboBox.addOption(this._filterByTypeComboBox.createOption(e.label,e.value));this._filterByTypeComboBox.setSelectedIndex(0),this._filterByTypeComboBox.setEnabled(!1),t.appendToolbarItem(this._filterByTypeComboBox),t.appendSeparator(),this._showContentScriptsSetting=Common.Settings.Settings.instance().createSetting("showContentScripts",!1),this._showContentScriptsSetting.addChangeListener(this._onFilterChanged,this);const r=new UI.Toolbar.ToolbarSettingCheckbox(this._showContentScriptsSetting,Common.UIString.UIString("Include extension content scripts"),Common.UIString.UIString("Content scripts"));t.appendToolbarItem(r),this._coverageResultsElement=this.contentElement.createChild("div","coverage-results"),this._landingPage=this._buildLandingPage(),this._listView=new CoverageListView(this._isVisible.bind(this,!1)),this._statusToolbarElement=this.contentElement.createChild("div","coverage-toolbar-summary"),this._statusMessageElement=this._statusToolbarElement.createChild("div","coverage-message"),this._landingPage.show(this._coverageResultsElement)}_buildLandingPage(){const e=new UI.Widget.VBox;let t;if(this._startWithReloadButton)this._inlineReloadButton=UI.UIUtils.createInlineButton(UI.Toolbar.Toolbar.createActionButtonForId("coverage.start-with-reload")),t=UI.UIUtils.formatLocalized("Click the reload button %s to reload and start capturing coverage.",[this._inlineReloadButton]);else{const e=UI.UIUtils.createInlineButton(UI.Toolbar.Toolbar.createActionButton(this._toggleRecordAction));t=UI.UIUtils.formatLocalized("Click the record button %s to start capturing coverage.",[e])}return t.classList.add("message"),e.contentElement.appendChild(t),e.element.classList.add("landing-page"),e}_clear(){this._model&&this._model.reset(),this._reset()}_reset(){this._decorationManager&&(this._decorationManager.dispose(),this._decorationManager=null),this._listView.reset(),this._listView.detach(),this._landingPage.show(this._coverageResultsElement),this._statusMessageElement.textContent="",this._filterInput.setEnabled(!1),this._filterByTypeComboBox.setEnabled(!1),this._saveButton.setEnabled(!1)}_toggleRecording(){!this._toggleRecordAction.toggled()?this._startRecording({reload:!1,jsCoveragePerBlock:this.isBlockCoverageSelected()}):this.stopRecording()}isBlockCoverageSelected(){return Number(this._coverageTypeComboBox.selectedOption().value)===CoverageType.JavaScript}_selectCoverageType(e){const t=e?1:0;this._coverageTypeComboBox.setSelectedIndex(t)}_onCoverageTypeComboBoxSelectionChanged(){this._coverageTypeComboBoxSetting.set(this._coverageTypeComboBox.selectedIndex())}async ensureRecordingStarted(){this._toggleRecordAction.toggled()&&await this.stopRecording(),await this._startRecording({reload:!1,jsCoveragePerBlock:!1})}async _startRecording(e){let t,o;this._startWithReloadButton&&this._startWithReloadButton.element.hasFocus()||this._inlineReloadButton&&this._inlineReloadButton.hasFocus()?o=!0:this.hasFocus()&&(t=!0),this._reset();const i=SDK.SDKModel.TargetManager.instance().mainTarget();if(!i)return;const{reload:s,jsCoveragePerBlock:r}={reload:!1,jsCoveragePerBlock:!1,...e};this._model&&!s||(this._model=i.model(CoverageModel)),Host.userMetrics.actionTaken(Host.UserMetrics.Action.CoverageStarted),r&&Host.userMetrics.actionTaken(Host.UserMetrics.Action.CoverageStartedPerBlock);await this._model.start(r)&&(this._selectCoverageType(r),this._model.addEventListener(Events.CoverageUpdated,this._onCoverageDataReceived,this),this._resourceTreeModel=i.model(SDK.ResourceTreeModel.ResourceTreeModel),this._resourceTreeModel&&this._resourceTreeModel.addEventListener(SDK.ResourceTreeModel.Events.MainFrameNavigated,this._onMainFrameNavigated,this),this._decorationManager=new CoverageDecorationManager(this._model),this._toggleRecordAction.setToggled(!0),this._clearButton.setEnabled(!1),this._startWithReloadButton&&(this._startWithReloadButton.setEnabled(!1),this._startWithReloadButton.setVisible(!1),this._toggleRecordButton.setEnabled(!0),this._toggleRecordButton.setVisible(!0),o&&this._toggleRecordButton.element.focus()),this._coverageTypeComboBox.setEnabled(!1),this._filterInput.setEnabled(!0),this._filterByTypeComboBox.setEnabled(!0),this._landingPage.isShowing()&&this._landingPage.detach(),this._listView.show(this._coverageResultsElement),t&&!o&&this._listView.focus(),s&&this._resourceTreeModel?this._resourceTreeModel.reloadPage():this._model.startPolling())}_onCoverageDataReceived(e){const t=e.data;this._updateViews(t)}async stopRecording(){this._resourceTreeModel&&(this._resourceTreeModel.removeEventListener(SDK.ResourceTreeModel.Events.MainFrameNavigated,this._onMainFrameNavigated,this),this._resourceTreeModel=null),this.hasFocus()&&this._listView.focus(),await this._model.stop(),this._model.removeEventListener(Events.CoverageUpdated,this._onCoverageDataReceived,this),this._toggleRecordAction.setToggled(!1),this._coverageTypeComboBox.setEnabled(!0),this._startWithReloadButton&&(this._startWithReloadButton.setEnabled(!0),this._startWithReloadButton.setVisible(!0),this._toggleRecordButton.setEnabled(!1),this._toggleRecordButton.setVisible(!1)),this._clearButton.setEnabled(!0)}processBacklog(){this._model.processJSBacklog()}_onMainFrameNavigated(){this._model.reset(),this._decorationManager.reset(),this._listView.reset(),this._model.startPolling()}_updateViews(e){this._updateStats(),this._listView.update(this._model.entries()),this._saveButton.setEnabled(this._model.entries().length>0),this._decorationManager.update(e)}_updateStats(){const e={total:0,unused:0},t={total:0,unused:0};let o=!1;for(const i of this._model.entries())e.total+=i.size(),e.unused+=i.unusedSize(),this._isVisible(!1,i)?(t.total+=i.size(),t.unused+=i.unusedSize()):o=!0;function i({total:e,unused:t}){const o=e-t,i=e?Math.round(100*o/e):0;return ls`${Platform.NumberUtilities.bytesToString(o)} of ${Platform.NumberUtilities.bytesToString(e)} (${i}%) used so far,
        ${Platform.NumberUtilities.bytesToString(t)} unused.`}this._statusMessageElement.textContent=o?ls`Filtered: ${i(t)}  Total: ${i(e)}`:i(e)}_onFilterChanged(){if(!this._listView)return;const e=this._filterInput.value();this._textFilterRegExp=e?createPlainTextSearchRegex(e,"i"):null,this._listView.updateFilterAndHighlight(this._textFilterRegExp),this._updateStats()}_onFilterByTypeChanged(){if(!this._listView)return;Host.userMetrics.actionTaken(Host.UserMetrics.Action.CoverageReportFiltered);const e=this._filterByTypeComboBox.selectedOption().value;this._typeFilterValue=parseInt(e,10)||null,this._listView.updateFilterAndHighlight(this._textFilterRegExp),this._updateStats()}_isVisible(e,t){const o=t.url();return!o.startsWith(CoverageView._extensionBindingsURLPrefix)&&(!(t.isContentScript()&&!this._showContentScriptsSetting.get())&&(!(this._typeFilterValue&&!(t.type()&this._typeFilterValue))&&(e||!this._textFilterRegExp||this._textFilterRegExp.test(o))))}async _exportReport(){const e=new Bindings.FileUtils.FileOutputStream,t=`Coverage-${Platform.DateUtilities.toISO8601Compact(new Date)}.json`;await e.open(t)&&this._model.exportReport(e)}selectCoverageItemByUrl(e){this._listView.selectByUrl(e)}}CoverageView._extensionBindingsURLPrefix="extensions::";export class ActionDelegate{handleAction(e,t){return UI.ViewManager.ViewManager.instance().showView("coverage",!1,!0).then(()=>UI.ViewManager.ViewManager.instance().view("coverage").widget()).then(e=>this._innerHandleAction(e,t)),!0}_innerHandleAction(e,t){switch(t){case"coverage.toggle-recording":e._toggleRecording();break;case"coverage.start-with-reload":e._startRecording({reload:!0,jsCoveragePerBlock:e.isBlockCoverageSelected()});break;default:console.assert(!1,"Unknown action: "+t)}}}export class LineDecorator{constructor(){this._listeners=new WeakMap}decorate(e,t){const o=e.decorationsForType(decoratorType);if(!o||!o.size)return void this._uninstallGutter(t);o.values().next().value.data().usageByLine(e).then(o=>{t.operation(()=>this._innerDecorate(e,t,o))})}_innerDecorate(e,t,o){const i=LineDecorator._gutterType;this._uninstallGutter(t),o.length&&this._installGutter(t,e.url());for(let e=0;e<o.length;++e){if("boolean"!=typeof o[e])continue;const s=o[e]?"text-editor-coverage-used-marker":"text-editor-coverage-unused-marker",r=document.createElement("div");r.classList.add(s),t.setGutterDecoration(e,i,r)}}makeGutterClickHandler(e){return function(t){if(t.data.gutterType!==LineDecorator._gutterType)return;UI.ViewManager.ViewManager.instance().showView("coverage").then(()=>UI.ViewManager.ViewManager.instance().view("coverage").widget()).then(t=>{const o=e.match(/(.*):formatted$/),i=o&&o[1]||e;t.selectCoverageItemByUrl(i)})}}_installGutter(e,t){let o=this._listeners.get(e);o||(o=this.makeGutterClickHandler(t),this._listeners.set(e,o)),e.installGutter(LineDecorator._gutterType,!1),e.addEventListener(SourceFrame.SourcesTextEditor.Events.GutterClick,o,this)}_uninstallGutter(e){e.uninstallGutter(LineDecorator._gutterType);const t=this._listeners.get(e);t&&(e.removeEventListener(SourceFrame.SourcesTextEditor.Events.GutterClick,t,this),this._listeners.delete(e))}}LineDecorator._gutterType="CodeMirror-gutter-coverage";