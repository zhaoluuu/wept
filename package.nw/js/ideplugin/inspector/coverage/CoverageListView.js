import*as Common from"../common/common.js";import*as DataGrid from"../data_grid/data_grid.js";import*as Formatter from"../formatter/formatter.js";import{ls}from"../platform/platform.js";import*as TextUtils from"../text_utils/text_utils.js";import*as UI from"../ui/ui.js";import*as Workspace from"../workspace/workspace.js";import{CoverageType,URLCoverageInfo}from"./CoverageModel.js";export function coverageTypeToString(e){const t=[];return e&CoverageType.CSS&&t.push(ls`CSS`),e&CoverageType.JavaScriptPerFunction?t.push(ls`JS (per function)`):e&CoverageType.JavaScript&&t.push(ls`JS (per block)`),t.join("+")}export class CoverageListView extends UI.Widget.VBox{constructor(e){super(!0),this._nodeForCoverageInfo=new Map,this._isVisibleFilter=e,this._highlightRegExp=null,this.registerRequiredCSS("coverage/coverageListView.css");const t=[{id:"url",title:ls`URL`,width:"250px",fixedWidth:!1,sortable:!0},{id:"type",title:ls`Type`,width:"45px",fixedWidth:!0,sortable:!0},{id:"size",title:ls`Total Bytes`,width:"60px",fixedWidth:!0,sortable:!0,align:DataGrid.DataGrid.Align.Right},{id:"unusedSize",title:ls`Unused Bytes`,width:"100px",fixedWidth:!0,sortable:!0,align:DataGrid.DataGrid.Align.Right,sort:DataGrid.DataGrid.Order.Descending},{id:"bars",title:ls`Usage Visualization`,width:"250px",fixedWidth:!1,sortable:!0}];this._dataGrid=new DataGrid.SortableDataGrid.SortableDataGrid({displayName:ls`Code Coverage`,columns:t}),this._dataGrid.setResizeMethod(DataGrid.DataGrid.ResizeMethod.Last),this._dataGrid.element.classList.add("flex-auto"),this._dataGrid.element.addEventListener("keydown",this._onKeyDown.bind(this),!1),this._dataGrid.addEventListener(DataGrid.DataGrid.Events.OpenedNode,this._onOpenedNode,this),this._dataGrid.addEventListener(DataGrid.DataGrid.Events.SortingChanged,this._sortingChanged,this);const i=this._dataGrid.asWidget();i.show(this.contentElement),this.setDefaultFocusedChild(i)}update(e){let t=!1;const i=e.reduce((e,t)=>Math.max(e,t.size()),0),r=this._dataGrid.rootNode();for(const s of e){let e=this._nodeForCoverageInfo.get(s);e?this._isVisibleFilter(e._coverageInfo)&&(t=e._refreshIfNeeded(i)||t):(e=new GridNode(s,i),this._nodeForCoverageInfo.set(s,e),this._isVisibleFilter(e._coverageInfo)&&(r.appendChild(e),t=!0))}t&&this._sortingChanged()}reset(){this._nodeForCoverageInfo.clear(),this._dataGrid.rootNode().removeChildren()}updateFilterAndHighlight(e){this._highlightRegExp=e;let t=!1;for(const e of this._nodeForCoverageInfo.values()){const i=this._isVisibleFilter(e._coverageInfo),r=!!e.parent;i&&e._setHighlight(this._highlightRegExp),i!==r&&(t=!0,i?this._dataGrid.rootNode().appendChild(e):e.remove())}t&&this._sortingChanged()}selectByUrl(e){for(const[t,i]of this._nodeForCoverageInfo.entries())if(t.url()===e){i.revealAndSelect();break}}_onOpenedNode(){this._revealSourceForSelectedNode()}_onKeyDown(e){isEnterKey(e)&&(e.consume(!0),this._revealSourceForSelectedNode())}async _revealSourceForSelectedNode(){const e=this._dataGrid.selectedNode;if(!e)return;const t=e._coverageInfo;let i=Workspace.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(t.url());if(!i)return;i=(await Formatter.sourceFormatter.format(i)).formattedSourceCode,this._dataGrid.selectedNode===e&&Common.Revealer.reveal(i)}_sortingChanged(){const e=this._dataGrid.sortColumnId();if(!e)return;const t=GridNode.sortFunctionForColumn(e);t&&this._dataGrid.sortNodes(t,!this._dataGrid.isSortOrderAscending())}}export class GridNode extends DataGrid.SortableDataGrid.SortableDataGridNode{constructor(e,t){super(),this._coverageInfo=e,this._lastUsedSize,this._url=e.url(),this._maxSize=t,this._highlightRegExp=null}_setHighlight(e){this._highlightRegExp!==e&&(this._highlightRegExp=e,this.refresh())}_refreshIfNeeded(e){return(this._lastUsedSize!==this._coverageInfo.usedSize()||e!==this._maxSize)&&(this._lastUsedSize=this._coverageInfo.usedSize(),this._maxSize=e,this.refresh(),!0)}createCell(e){const t=this.createTD(e);switch(e){case"url":{t.title=this._url;const i=t.createChild("div","url-outer"),r=i.createChild("div","url-prefix"),s=i.createChild("div","url-suffix"),o=/^(.*)(\/[^/]*)$/.exec(this._url);r.textContent=o?o[1]:this._url,s.textContent=o?o[2]:"",this._highlightRegExp&&this._highlight(i,this._url),this.setCellAccessibleName(this._url,t,e);break}case"type":t.textContent=coverageTypeToString(this._coverageInfo.type()),this._coverageInfo.type()&CoverageType.JavaScriptPerFunction?t.title=ls`JS coverage with per function granularity: Once a function was executed, the whole function is marked as covered.`:this._coverageInfo.type()&CoverageType.JavaScript&&(t.title=ls`JS coverage with per block granularity: Once a block of JavaScript was executed, that block is marked as covered.`);break;case"size":{t.createChild("span").textContent=Number.withThousandsSeparator(this._coverageInfo.size()||0);const i=1===this._coverageInfo.size()?ls`1 byte`:ls`${this._coverageInfo.size()||0} bytes`;this.setCellAccessibleName(i,t,e);break}case"unusedSize":{const i=this._coverageInfo.unusedSize()||0,r=t.createChild("span"),s=t.createChild("span","percent-value");r.textContent=Number.withThousandsSeparator(i);const o=ls`${this._percentageString(this._coverageInfo.unusedPercentage())} %`;s.textContent=o;const a=1===i?ls`1 byte, ${o}`:ls`${i} bytes, ${o}`;this.setCellAccessibleName(a,t,e);break}case"bars":{const i=t.createChild("div","bar-container"),r=this._percentageString(this._coverageInfo.unusedPercentage()),s=this._percentageString(this._coverageInfo.usedPercentage());if(this._coverageInfo.unusedSize()>0){const e=i.createChild("div","bar bar-unused-size");e.style.width=(this._coverageInfo.unusedSize()/this._maxSize*100||0)+"%",this._coverageInfo.type()&CoverageType.JavaScriptPerFunction?e.title=ls`${this._coverageInfo.unusedSize()} bytes (${r} %) belong to functions that have not (yet) been executed.`:this._coverageInfo.type()&CoverageType.JavaScript&&(e.title=ls`${this._coverageInfo.unusedSize()} bytes (${r} %) belong to blocks of JavaScript that have not (yet) been executed.`)}if(this._coverageInfo.usedSize()>0){const e=i.createChild("div","bar bar-used-size");e.style.width=(this._coverageInfo.usedSize()/this._maxSize*100||0)+"%",this._coverageInfo.type()&CoverageType.JavaScriptPerFunction?e.title=ls`${this._coverageInfo.usedSize()} bytes (${s} %) belong to functions that have executed at least once.`:this._coverageInfo.type()&CoverageType.JavaScript&&(e.title=ls`${this._coverageInfo.usedSize()} bytes (${s} %) belong to blocks of JavaScript that have executed at least once.`)}this.setCellAccessibleName(ls`${r} % of file unused, ${s} % of file used`,t,e)}}return t}_percentageString(e){return e.toFixed(1)}_highlight(e,t){if(!this._highlightRegExp)return;const i=this._highlightRegExp.exec(t);if(!i||!i.length)return;const r=new TextUtils.TextRange.SourceRange(i.index,i[0].length);UI.UIUtils.highlightRangesWithStyleClass(e,[r],"filter-highlight")}static sortFunctionForColumn(e){const t=(e,t)=>e._url.localeCompare(t._url);switch(e){case"url":return t;case"type":return(e,i)=>{const r=coverageTypeToString(e._coverageInfo.type()),s=coverageTypeToString(i._coverageInfo.type());return r.localeCompare(s)||t(e,i)};case"size":return(e,i)=>e._coverageInfo.size()-i._coverageInfo.size()||t(e,i);case"bars":case"unusedSize":return(e,i)=>e._coverageInfo.unusedSize()-i._coverageInfo.unusedSize()||t(e,i);default:return console.assert(!1,"Unknown sort field: "+e),null}}}