import*as Common from"../common/common.js";import*as PerfUI from"../perf_ui/perf_ui.js";import*as SDK from"../sdk/sdk.js";import{NetworkLogView}from"./NetworkLogView.js";import{NetworkTimeBoundary}from"./NetworkTimeCalculator.js";import{RequestTimeRangeNames,RequestTimingView}from"./RequestTimingView.js";export class NetworkOverview extends PerfUI.TimelineOverviewPane.TimelineOverviewBase{constructor(){super(),this._selectedFilmStripTime=-1,this.element.classList.add("network-overview"),this._numBands=1,this._updateScheduled=!1,this._highlightedRequest=null,SDK.SDKModel.TargetManager.instance().addModelListener(SDK.ResourceTreeModel.ResourceTreeModel,SDK.ResourceTreeModel.Events.Load,this._loadEventFired,this),SDK.SDKModel.TargetManager.instance().addModelListener(SDK.ResourceTreeModel.ResourceTreeModel,SDK.ResourceTreeModel.Events.DOMContentLoaded,this._domContentLoadedEventFired,this),this.reset()}setHighlightedRequest(e){this._highlightedRequest=e,this.scheduleUpdate()}setFilmStripModel(e){this._filmStripModel=e,this.scheduleUpdate()}selectFilmStripFrame(e){this._selectedFilmStripTime=e,this.scheduleUpdate()}clearFilmStripFrame(){this._selectedFilmStripTime=-1,this.scheduleUpdate()}_loadEventFired(e){const t=e.data.loadTime;t&&this._loadEvents.push(1e3*t),this.scheduleUpdate()}_domContentLoadedEventFired(e){const t=e.data;t&&this._domContentLoadedEvents.push(1e3*t),this.scheduleUpdate()}_bandId(e){if(!e||"0"===e)return-1;if(this._bandMap.has(e))return this._bandMap.get(e);const t=this._nextBand++;return this._bandMap.set(e,t),t}updateRequest(e){this._requestsSet.has(e)||(this._requestsSet.add(e),this._requestsList.push(e)),this.scheduleUpdate()}wasShown(){this.onResize()}onResize(){const e=this.element.offsetWidth,t=this.element.offsetHeight;this.calculator().setDisplayWidth(e),this.resetCanvas();const s=(t-_padding-1)/_bandHeight-1|0;this._numBands=s>0?s:1,this.scheduleUpdate()}reset(){this._filmStripModel=null,this._span=1,this._lastBoundary=null,this._nextBand=0,this._bandMap=new Map,this._requestsList=[],this._requestsSet=new Set,this._loadEvents=[],this._domContentLoadedEvents=[],this.resetCanvas()}scheduleUpdate(){!this._updateScheduled&&this.isShowing()&&(this._updateScheduled=!0,this.element.window().requestAnimationFrame(this.update.bind(this)))}update(){this._updateScheduled=!1;const e=this.calculator(),t=new NetworkTimeBoundary(e.minimumBoundary(),e.maximumBoundary());if(!this._lastBoundary||!t.equals(this._lastBoundary)){const t=e.boundarySpan();for(;this._span<t;)this._span*=1.25;e.setBounds(e.minimumBoundary(),e.minimumBoundary()+this._span),this._lastBoundary=new NetworkTimeBoundary(e.minimumBoundary(),e.maximumBoundary())}const s=this.context(),i={},n=_padding;function o(t){const o=i[t];if(!o)return;const a=o.length;s.beginPath(),s.strokeStyle=RequestTimeRangeNameToColor[t];for(let t=0;t<a;){const i=o[t++]*_bandHeight+n,a=o[t++];let m=o[t++];m===Number.MAX_VALUE&&(m=e.maximumBoundary()),s.moveTo(e.computePosition(a),i),s.lineTo(e.computePosition(m)+1,i)}s.stroke()}function a(e,t,s,n){let o=i[e];o||(o=[],i[e]=o),o.push(t,s,n)}const m=this._requestsList,r=m.length;for(let e=0;e<r;++e){const t=m[e],s=this._bandId(t.connectionId),i=-1===s?0:s%this._numBands+1,n=RequestTimingView.calculateRequestTimeRanges(t,this.calculator().minimumBoundary());for(let e=0;e<n.length;++e){const t=n[e].name;-1===s&&t!==RequestTimeRangeNames.Total||a(t,i,1e3*n[e].start,1e3*n[e].end)}}if(s.clearRect(0,0,this.width(),this.height()),s.save(),s.scale(window.devicePixelRatio,window.devicePixelRatio),s.lineWidth=2,o(RequestTimeRangeNames.Total),o(RequestTimeRangeNames.Blocking),o(RequestTimeRangeNames.Connecting),o(RequestTimeRangeNames.ServiceWorker),o(RequestTimeRangeNames.ServiceWorkerPreparation),o(RequestTimeRangeNames.ServiceWorkerRespondWith),o(RequestTimeRangeNames.Push),o(RequestTimeRangeNames.Proxy),o(RequestTimeRangeNames.DNS),o(RequestTimeRangeNames.SSL),o(RequestTimeRangeNames.Sending),o(RequestTimeRangeNames.Waiting),o(RequestTimeRangeNames.Receiving),this._highlightedRequest){const t=5,i=2,o=this._highlightedRequest,a=this._bandId(o.connectionId),m=(-1===a?0:a%this._numBands+1)*_bandHeight+n,r=RequestTimingView.calculateRequestTimeRanges(o,this.calculator().minimumBoundary());s.fillStyle=self.UI.themeSupport.getComputedValue("--selection-bg-color");const d=1e3*r[0].start,u=1e3*r[0].end;s.fillRect(e.computePosition(d)-i,m-t/2-i,e.computePosition(u)-e.computePosition(d)+1+2*i,t*i);for(let i=0;i<r.length;++i){const n=r[i].name;if(-1!==a||n===RequestTimeRangeNames.Total){s.beginPath(),s.strokeStyle=RequestTimeRangeNameToColor[n],s.lineWidth=t;const o=1e3*r[i].start,a=1e3*r[i].end;s.moveTo(e.computePosition(o)-0,m),s.lineTo(e.computePosition(a)+1,m),s.stroke()}}}const d=this.element.offsetHeight;s.lineWidth=1,s.beginPath(),s.strokeStyle=NetworkLogView.getDCLEventColor();for(let t=this._domContentLoadedEvents.length-1;t>=0;--t){const i=Math.round(e.computePosition(this._domContentLoadedEvents[t]))+.5;s.moveTo(i,0),s.lineTo(i,d)}s.stroke(),s.beginPath(),s.strokeStyle=NetworkLogView.getLoadEventColor();for(let t=this._loadEvents.length-1;t>=0;--t){const i=Math.round(e.computePosition(this._loadEvents[t]))+.5;s.moveTo(i,0),s.lineTo(i,d)}if(s.stroke(),-1!==this._selectedFilmStripTime){s.lineWidth=2,s.beginPath(),s.strokeStyle=self.UI.themeSupport.getComputedValue("--network-frame-divider-color");const t=Math.round(e.computePosition(this._selectedFilmStripTime));s.moveTo(t,0),s.lineTo(t,d),s.stroke()}s.restore()}}export const RequestTimeRangeNameToColor={[RequestTimeRangeNames.Total]:"#CCCCCC",[RequestTimeRangeNames.Blocking]:"#AAAAAA",[RequestTimeRangeNames.Connecting]:"#FF9800",[RequestTimeRangeNames.ServiceWorker]:"#FF9800",[RequestTimeRangeNames.ServiceWorkerPreparation]:"#FF9800",[RequestTimeRangeNames.ServiceWorkerRespondWith]:"#00FFFF",[RequestTimeRangeNames.Push]:"#8CDBff",[RequestTimeRangeNames.Proxy]:"#A1887F",[RequestTimeRangeNames.DNS]:"#009688",[RequestTimeRangeNames.SSL]:"#9C27B0",[RequestTimeRangeNames.Sending]:"#B0BEC5",[RequestTimeRangeNames.Waiting]:"#00C853",[RequestTimeRangeNames.Receiving]:"#03A9F4"};export const _bandHeight=3;export const _padding=5;