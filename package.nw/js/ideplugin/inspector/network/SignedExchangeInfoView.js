import*as Common from"../common/common.js";import*as Components from"../components/components.js";import*as Host from"../host/host.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";export class SignedExchangeInfoView extends UI.Widget.VBox{constructor(e){super();const t=e.signedExchangeInfo();console.assert(t),this.registerRequiredCSS("network/signedExchangeInfoView.css"),this.element.classList.add("signed-exchange-info-view");const r=new UI.TreeOutline.TreeOutlineInShadow;r.registerRequiredCSS("network/signedExchangeInfoTree.css"),r.element.classList.add("signed-exchange-info-tree"),r.setFocusable(!1),r.makeDense(),r.expandTreeElementsWhenArrowing=!0,this.element.appendChild(r.element);const n=new Map;if(t.errors&&t.errors.length){const e=new Category(r,Common.UIString.UIString("Errors"));for(const r of t.errors){const t=createDocumentFragment();if(t.appendChild(UI.Icon.Icon.create("smallicon-error","prompt-icon")),t.createChild("div","error-log").textContent=r.message,e.createLeaf(t),r.errorField){let e=n.get(r.signatureIndex);e||(e=new Set,n.set(r.signatureIndex,e)),e.add(r.errorField)}}}const a=createDocumentFragment();a.createChild("div","header-name").textContent=Common.UIString.UIString("Signed HTTP exchange");const o=UI.XLink.XLink.create("https://github.com/WICG/webpackage",Common.UIString.UIString("LearnÂ more"),"header-toggle");a.appendChild(o);const i=new Category(r,a);if(t.header){const a=t.header,o=e.redirectDestination(),s=this._formatHeader(Common.UIString.UIString("Request URL"),a.requestUrl);if(o){const e=Components.Linkifier.Linkifier.linkifyRevealable(o,"View request");e.classList.add("header-toggle"),s.appendChild(e)}i.createLeaf(s),i.createLeaf(this._formatHeader(Common.UIString.UIString("Response code"),a.responseCode+"")),i.createLeaf(this._formatHeader(Common.UIString.UIString("Header integrity hash"),a.headerIntegrity)),this._responseHeadersItem=i.createLeaf(this._formatHeader(Common.UIString.UIString("Response headers"),""));const d=a.responseHeaders;for(const e in d){const t=new UI.TreeOutline.TreeElement(this._formatHeader(e,d[e]));t.selectable=!1,this._responseHeadersItem.appendChild(t)}this._responseHeadersItem.expand();for(let e=0;e<a.signatures.length;++e){const t=n.get(e)||new Set,o=a.signatures[e],i=new Category(r,Common.UIString.UIString("Signature"));if(i.createLeaf(this._formatHeader(Common.UIString.UIString("Label"),o.label)),i.createLeaf(this._formatHeaderForHexData(Common.UIString.UIString("Signature"),o.signature,t.has(Protocol.Network.SignedExchangeErrorField.SignatureSig))),o.certUrl){const e=this._formatHeader(Common.UIString.UIString("Certificate URL"),o.certUrl,t.has(Protocol.Network.SignedExchangeErrorField.SignatureCertUrl));if(o.certificates){const t=e.createChild("span","devtools-link header-toggle");t.textContent=Common.UIString.UIString("View certificate"),t.addEventListener("click",Host.InspectorFrontendHost.InspectorFrontendHostInstance.showCertificateViewer.bind(null,o.certificates),!1)}i.createLeaf(e)}i.createLeaf(this._formatHeader(Common.UIString.UIString("Integrity"),o.integrity,t.has(Protocol.Network.SignedExchangeErrorField.SignatureIntegrity))),o.certSha256&&i.createLeaf(this._formatHeaderForHexData(Common.UIString.UIString("Certificate SHA256"),o.certSha256,t.has(Protocol.Network.SignedExchangeErrorField.SignatureCertSha256))),i.createLeaf(this._formatHeader(Common.UIString.UIString("Validity URL"),o.validityUrl,t.has(Protocol.Network.SignedExchangeErrorField.SignatureValidityUrl))),i.createLeaf().title=this._formatHeader(Common.UIString.UIString("Date"),new Date(1e3*o.date).toUTCString(),t.has(Protocol.Network.SignedExchangeErrorField.SignatureTimestamps)),i.createLeaf().title=this._formatHeader(Common.UIString.UIString("Expires"),new Date(1e3*o.expires).toUTCString(),t.has(Protocol.Network.SignedExchangeErrorField.SignatureTimestamps))}}if(t.securityDetails){const e=t.securityDetails,n=new Category(r,Common.UIString.UIString("Certificate"));n.createLeaf(this._formatHeader(Common.UIString.UIString("Subject"),e.subjectName)),n.createLeaf(this._formatHeader(Common.UIString.UIString("Valid from"),new Date(1e3*e.validFrom).toUTCString())),n.createLeaf(this._formatHeader(Common.UIString.UIString("Valid until"),new Date(1e3*e.validTo).toUTCString())),n.createLeaf(this._formatHeader(Common.UIString.UIString("Issuer"),e.issuer))}}_formatHeader(e,t,r){const n=createDocumentFragment(),a=n.createChild("div","header-name");a.textContent=e+": ",n.createChild("span","header-separator");const o=n.createChild("div","header-value source-code");return o.textContent=t,r&&(a.classList.add("error-field"),o.classList.add("error-field")),n}_formatHeaderForHexData(e,t,r){const n=createDocumentFragment(),a=n.createChild("div","header-name");a.textContent=e+": ",n.createChild("span","header-separator");const o=n.createChild("div","header-value source-code hex-data");return o.textContent=t.replace(/(.{2})/g,"$1 "),r&&(a.classList.add("error-field"),o.classList.add("error-field")),n}}export class Category extends UI.TreeOutline.TreeElement{constructor(e,t){super(t,!0),this.selectable=!1,this.toggleOnClick=!0,this.expanded=!0,e.appendChild(this)}createLeaf(e){const t=new UI.TreeOutline.TreeElement(e);return t.selectable=!1,this.appendChild(t),t}}