import*as DataGrid from"../data_grid/data_grid.js";import*as UI from"../ui/ui.js";export class DatabaseQueryView extends UI.Widget.VBox{constructor(e){super(),this.database=e,this.element.classList.add("storage-view","query","monospace"),this.element.addEventListener("selectstart",this._selectStart.bind(this),!1),this._queryWrapper=this.element.createChild("div","database-query-group-messages"),this._queryWrapper.addEventListener("focusin",this._onFocusIn.bind(this)),this._queryWrapper.addEventListener("focusout",this._onFocusOut.bind(this)),this._queryWrapper.addEventListener("keydown",this._onKeyDown.bind(this)),this._queryWrapper.tabIndex=-1,this._promptContainer=this.element.createChild("div","database-query-prompt-container"),this._promptContainer.appendChild(UI.Icon.Icon.create("smallicon-text-prompt","prompt-icon")),this._promptElement=this._promptContainer.createChild("div"),this._promptElement.className="database-query-prompt",this._promptElement.addEventListener("keydown",this._promptKeyDown.bind(this)),this._prompt=new UI.TextPrompt.TextPrompt,this._prompt.initialize(this.completions.bind(this)," "),this._proxyElement=this._prompt.attach(this._promptElement),this.element.addEventListener("click",this._messagesClicked.bind(this),!0),this._queryResults=[],this._virtualSelectedIndex=-1,this._lastSelectedElement,this._selectionTimeout=0}_messagesClicked(){this._prompt.focus(),this._prompt.isCaretInsidePrompt()||this.element.hasSelection()||this._prompt.moveCaretToEndOfPrompt()}_onKeyDown(e){if(!UI.UIUtils.isEditing()&&this._queryResults.length&&!e.shiftKey){switch(e.key){case"ArrowUp":if(!(this._virtualSelectedIndex>0))return;this._virtualSelectedIndex--;break;case"ArrowDown":if(!(this._virtualSelectedIndex<this._queryResults.length-1))return;this._virtualSelectedIndex++;break;case"Home":this._virtualSelectedIndex=0;break;case"End":this._virtualSelectedIndex=this._queryResults.length-1;break;default:return}e.consume(!0),this._updateFocusedItem()}}_onFocusIn(e){-1===this._virtualSelectedIndex&&this._isOutsideViewport(e.relatedTarget)&&e.target===this._queryWrapper&&this._queryResults.length&&(this._virtualSelectedIndex=this._queryResults.length-1),this._updateFocusedItem()}_onFocusOut(e){this._isOutsideViewport(e.relatedTarget)&&(this._virtualSelectedIndex=-1),this._updateFocusedItem(),this._queryWrapper.scrollTop=1e7}_isOutsideViewport(e){return!!e&&!e.isSelfOrDescendant(this._queryWrapper)}_updateFocusedItem(){let e=this._virtualSelectedIndex;this._queryResults.length&&this._virtualSelectedIndex<0&&(e=this._queryResults.length-1);const t=e>=0?this._queryResults[e]:null,s=this._lastSelectedElement!==t,i=this._queryWrapper===this.element.ownerDocument.deepActiveElement();t&&(s||i)&&this.element.hasFocus()&&(t.hasFocus()||t.focus()),this._queryResults.length&&!this._queryWrapper.hasFocus()?this._queryWrapper.tabIndex=0:this._queryWrapper.tabIndex=-1,this._lastSelectedElement=t}async completions(e,t,s){if(!t)return[];t=t.toLowerCase();return(await this.database.tableNames()).map(e=>e+" ").concat(SQL_BUILT_INS).filter(e=>e.toLowerCase().startsWith(t)).map(e=>({text:e}))}_selectStart(e){this._selectionTimeout&&clearTimeout(this._selectionTimeout),this._prompt.clearAutocomplete(),this._selectionTimeout=setTimeout(function(){delete this._selectionTimeout,this._prompt.isCaretInsidePrompt()||this.element.hasSelection()||this._prompt.moveCaretToEndOfPrompt(),this._prompt.autoCompleteSoon()}.bind(this),100)}_promptKeyDown(e){isEnterKey(e)&&this._enterKeyPressed(e)}async _enterKeyPressed(e){e.consume(!0);const t=this._prompt.textWithCurrentSuggestion();if(this._prompt.clearAutocomplete(),t.length){this._prompt.setEnabled(!1);try{const e=await new Promise((e,s)=>{this.database.executeSql(t,(t,s)=>e({columnNames:t,values:s}),e=>s(e))});this._queryFinished(t,e.columnNames,e.values)}catch(e){this._appendErrorQueryResult(t,e)}this._prompt.setEnabled(!0),this._prompt.setText(""),this._prompt.focus()}}_queryFinished(e,t,s){const i=DataGrid.SortableDataGrid.SortableDataGrid.create(t,s,ls`Database Query`),r=e.trim();let a=null;i&&(i.setStriped(!0),i.renderInline(),i.autoSizeColumns(5),a=i.asWidget(),i.setFocusable(!1)),this._appendViewQueryResult(r,a),(r.match(/^create /i)||r.match(/^drop table /i))&&this.dispatchEventToListeners(Events.SchemaUpdated,this.database)}_appendViewQueryResult(e,t){const s=this._appendQueryResult(e);t?t.show(s):s.remove(),this._scrollResultIntoView()}_appendErrorQueryResult(e,t){const s=this._appendQueryResult(e);s.classList.add("error"),s.appendChild(UI.Icon.Icon.create("smallicon-error","prompt-icon")),s.createTextChild(t),this._scrollResultIntoView()}_scrollResultIntoView(){this._queryResults[this._queryResults.length-1].scrollIntoView(!1),this._promptElement.scrollIntoView(!1)}_appendQueryResult(e){const t=createElement("div");t.className="database-user-query",t.tabIndex=-1,UI.ARIAUtils.setAccessibleName(t,ls`Query: ${e}`),this._queryResults.push(t),this._updateFocusedItem(),t.appendChild(UI.Icon.Icon.create("smallicon-user-command","prompt-icon"));const s=createElement("span");s.className="database-query-text",s.textContent=e,t.appendChild(s);const i=createElement("div");return i.className="database-query-result",t.appendChild(i),this._queryWrapper.appendChild(t),i}}export const Events={SchemaUpdated:Symbol("SchemaUpdated")};export const SQL_BUILT_INS=["SELECT ","FROM ","WHERE ","LIMIT ","DELETE FROM ","CREATE ","DROP ","TABLE ","INDEX ","UPDATE ","INSERT INTO ","VALUES ("];