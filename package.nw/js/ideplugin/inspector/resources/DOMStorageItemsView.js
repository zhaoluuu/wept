import*as Common from"../common/common.js";import*as DataGrid from"../data_grid/data_grid.js";import*as SourceFrame from"../source_frame/source_frame.js";import*as TextUtils from"../text_utils/text_utils.js";import*as UI from"../ui/ui.js";import{DOMStorage}from"./DOMStorageModel.js";import{StorageItemsView}from"./StorageItemsView.js";export class DOMStorageItemsView extends StorageItemsView{constructor(e){super(Common.UIString.UIString("DOM Storage"),"domStoragePanel"),this._domStorage=e,this.element.classList.add("storage-view","table");const t=[{id:"key",title:Common.UIString.UIString("Key"),sortable:!1,editable:!0,longText:!0,weight:50},{id:"value",title:Common.UIString.UIString("Value"),sortable:!1,editable:!0,longText:!0,weight:50}];this._dataGrid=new DataGrid.DataGrid.DataGridImpl({displayName:ls`DOM Storage Items`,columns:t,editCallback:this._editingCallback.bind(this),deleteCallback:this._deleteCallback.bind(this),refreshCallback:this.refreshItems.bind(this)}),this._dataGrid.addEventListener(DataGrid.DataGrid.Events.SelectedNode,e=>{this._previewEntry(e.data)}),this._dataGrid.addEventListener(DataGrid.DataGrid.Events.DeselectedNode,e=>{this._previewEntry(null)}),this._dataGrid.setStriped(!0),this._dataGrid.setName("DOMStorageItemsView"),this._splitWidget=new UI.SplitWidget.SplitWidget(!1,!0,"domStorageSplitViewState"),this._splitWidget.show(this.element),this._previewPanel=new UI.Widget.VBox,this._previewPanel.setMinimumSize(0,50);const i=this._previewPanel.element.createChild("div","preview-panel-resizer"),a=this._dataGrid.asWidget();a.setMinimumSize(0,50),this._splitWidget.setMainWidget(a),this._splitWidget.setSidebarWidget(this._previewPanel),this._splitWidget.installResizer(i),this._preview=null,this._previewValue=null,this._showPreview(null,null),this._eventListeners=[],this.setStorage(e)}setStorage(e){Common.EventTarget.EventTarget.removeEventListeners(this._eventListeners),this._domStorage=e,this._eventListeners=[this._domStorage.addEventListener(DOMStorage.Events.DOMStorageItemsCleared,this._domStorageItemsCleared,this),this._domStorage.addEventListener(DOMStorage.Events.DOMStorageItemRemoved,this._domStorageItemRemoved,this),this._domStorage.addEventListener(DOMStorage.Events.DOMStorageItemAdded,this._domStorageItemAdded,this),this._domStorage.addEventListener(DOMStorage.Events.DOMStorageItemUpdated,this._domStorageItemUpdated,this)],this.refreshItems()}_domStorageItemsCleared(){this.isShowing()&&this._dataGrid&&(this._dataGrid.rootNode().removeChildren(),this._dataGrid.addCreationNode(!1),this.setCanDeleteSelected(!1))}_domStorageItemRemoved(e){if(!this.isShowing()||!this._dataGrid)return;const t=e.data,i=this._dataGrid.rootNode(),a=i.children;for(let e=0;e<a.length;++e){const r=a[e];if(r.data.key===t.key)return i.removeChild(r),void this.setCanDeleteSelected(a.length>1)}}_domStorageItemAdded(e){if(!this.isShowing()||!this._dataGrid)return;const t=e.data,i=this._dataGrid.rootNode(),a=i.children;for(let e=0;e<a.length;++e)if(a[e].data.key===t.key)return;const r=new DataGrid.DataGrid.DataGridNode({key:t.key,value:t.value},!1);i.insertChild(r,a.length-1)}_domStorageItemUpdated(e){if(!this.isShowing()||!this._dataGrid)return;const t=e.data,i=this._dataGrid.rootNode().children.find(e=>e.data.key===t.key);i&&i.data.value!==t.value&&(i.data.value=t.value,i.refresh(),i.selected&&(this._previewEntry(i),this.setCanDeleteSelected(!0)))}_showDOMStorageItems(e){const t=this._dataGrid.rootNode();let i=null;for(const e of t.children)if(e.selected){i=e.data.key;break}t.removeChildren();let a=null;const r=e=>`${e[0]} ${e[1]}`;for(const s of this.filter(e,r)){const e=s[0],r=s[1],d=new DataGrid.DataGrid.DataGridNode({key:e,value:r},!1);d.selectable=!0,t.appendChild(d),a&&e!==i||(a=d)}a&&(a.selected=!0),this._dataGrid.addCreationNode(!1),this.setCanDeleteSelected(!!a)}deleteSelectedItem(){this._dataGrid&&this._dataGrid.selectedNode&&this._deleteCallback(this._dataGrid.selectedNode)}refreshItems(){this._domStorage.getItems().then(e=>e&&this._showDOMStorageItems(e))}deleteAllItems(){this._domStorage.clear(),this._domStorageItemsCleared()}_editingCallback(e,t,i,a){const r=this._domStorage;"key"===t?("string"==typeof i&&r.removeItem(i),r.setItem(a,e.data.value||""),this._removeDupes(e)):r.setItem(e.data.key||"",a)}_removeDupes(e){const t=this._dataGrid.rootNode(),i=t.children;for(let a=i.length-1;a>=0;--a){const r=i[a];r.data.key===e.data.key&&e!==r&&t.removeChild(r)}}_deleteCallback(e){e&&!e.isCreationNode&&this._domStorage&&this._domStorage.removeItem(e.data.key)}_showPreview(e,t){this._preview&&this._previewValue===t||(this._preview&&this._preview.detach(),e||(e=new UI.EmptyWidget.EmptyWidget(Common.UIString.UIString("Select a value to preview"))),this._previewValue=t,this._preview=e,e.show(this._previewPanel.contentElement))}async _previewEntry(e){const t=e&&e.data&&e.data.value;if(!t)return void this._showPreview(null,t);const i=`${this._domStorage.isLocalStorage?"localstorage":"sessionstorage"}://${e.key}`,a=TextUtils.StaticContentProvider.StaticContentProvider.fromString(i,Common.ResourceType.resourceTypes.XHR,t),r=await SourceFrame.PreviewFactory.PreviewFactory.createPreview(a,"text/plain");e.selected&&this._showPreview(r,t)}}