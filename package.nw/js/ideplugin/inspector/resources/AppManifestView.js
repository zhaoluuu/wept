import*as Common from"../common/common.js";import*as Components from"../components/components.js";import*as InlineEditor from"../inline_editor/inline_editor.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";export class AppManifestView extends UI.Widget.VBox{constructor(){super(!0),this.registerRequiredCSS("resources/appManifestView.css"),Common.Settings.Settings.instance().moduleSetting("colorFormat").addChangeListener(this._updateManifest.bind(this,!0)),this._emptyView=new UI.EmptyWidget.EmptyWidget(Common.UIString.UIString("No manifest detected")),this._emptyView.appendLink("https://developers.google.com/web/fundamentals/engage-and-retain/web-app-manifest/?utm_source=devtools"),this._emptyView.show(this.contentElement),this._emptyView.hideWidget(),this._reportView=new UI.ReportView.ReportView(Common.UIString.UIString("App Manifest")),this._reportView.show(this.contentElement),this._reportView.hideWidget(),this._errorsSection=this._reportView.appendSection(Common.UIString.UIString("Errors and warnings")),this._installabilitySection=this._reportView.appendSection(Common.UIString.UIString("Installability")),this._identitySection=this._reportView.appendSection(Common.UIString.UIString("Identity")),this._presentationSection=this._reportView.appendSection(Common.UIString.UIString("Presentation")),this._iconsSection=this._reportView.appendSection(Common.UIString.UIString("Icons"),"report-section-icons"),this._shortcutSections=[],this._nameField=this._identitySection.appendField(Common.UIString.UIString("Name")),this._shortNameField=this._identitySection.appendField(Common.UIString.UIString("Short name")),this._startURLField=this._presentationSection.appendField(Common.UIString.UIString("Start URL"));const e=this._presentationSection.appendField(Common.UIString.UIString("Theme color"));this._themeColorSwatch=InlineEditor.ColorSwatch.ColorSwatch.create(),e.appendChild(this._themeColorSwatch);const t=this._presentationSection.appendField(Common.UIString.UIString("Background color"));this._backgroundColorSwatch=InlineEditor.ColorSwatch.ColorSwatch.create(),t.appendChild(this._backgroundColorSwatch),this._orientationField=this._presentationSection.appendField(Common.UIString.UIString("Orientation")),this._displayField=this._presentationSection.appendField(Common.UIString.UIString("Display")),this._throttler=new Common.Throttler.Throttler(1e3),SDK.SDKModel.TargetManager.instance().observeTargets(this)}targetAdded(e){this._target||(this._target=e,this._resourceTreeModel=e.model(SDK.ResourceTreeModel.ResourceTreeModel),this._serviceWorkerManager=e.model(SDK.ServiceWorkerManager.ServiceWorkerManager),this._resourceTreeModel&&this._serviceWorkerManager&&(this._updateManifest(!0),this._registeredListeners=[this._resourceTreeModel.addEventListener(SDK.ResourceTreeModel.Events.DOMContentLoaded,e=>{this._updateManifest(!0)}),this._serviceWorkerManager.addEventListener(SDK.ServiceWorkerManager.Events.RegistrationUpdated,e=>{this._updateManifest(!1)})]))}targetRemoved(e){this._target===e&&this._resourceTreeModel&&this._serviceWorkerManager&&(delete this._resourceTreeModel,delete this._serviceWorkerManager,Common.EventTarget.EventTarget.removeEventListeners(this._registeredListeners))}async _updateManifest(e){const{url:t,data:o,errors:i}=await this._resourceTreeModel.fetchAppManifest(),n=await this._resourceTreeModel.getInstallabilityErrors(),s=await this._resourceTreeModel.getManifestIcons();this._throttler.schedule(()=>this._renderManifest(t,o,i,n,s),e)}async _renderManifest(e,t,o,i,n){if(!t&&!o.length)return this._emptyView.showWidget(),void this._reportView.hideWidget();this._emptyView.hideWidget(),this._reportView.showWidget();const s=Components.Linkifier.Linkifier.linkifyURL(e);s.tabIndex=0,this._reportView.setURL(s),this._errorsSection.clearContent(),this._errorsSection.element.classList.toggle("hidden",!o.length);for(const e of o)this._errorsSection.appendRow().appendChild(UI.UIUtils.createIconLabel(e.message,e.critical?"smallicon-error":"smallicon-warning"));if(!t)return;65279===t.charCodeAt(0)&&(t=t.slice(1));const r=JSON.parse(t);this._nameField.textContent=S("name"),this._shortNameField.textContent=S("short_name"),this._startURLField.removeChildren();const a=S("start_url");if(a){const t=Common.ParsedURL.ParsedURL.completeURL(e,a),o=Components.Linkifier.Linkifier.linkifyURL(t,{text:a});o.tabIndex=0,this._startURLField.appendChild(o)}this._themeColorSwatch.classList.toggle("hidden",!S("theme_color"));const l=Common.Color.Color.parse(S("theme_color")||"white")||Common.Color.Color.parse("white");this._themeColorSwatch.setColor(l),this._themeColorSwatch.setFormat(Common.Settings.detectColorFormat(this._themeColorSwatch.color())),this._backgroundColorSwatch.classList.toggle("hidden",!S("background_color"));const c=Common.Color.Color.parse(S("background_color")||"white")||Common.Color.Color.parse("white");this._backgroundColorSwatch.setColor(c),this._backgroundColorSwatch.setFormat(Common.Settings.detectColorFormat(this._backgroundColorSwatch.color())),this._orientationField.textContent=S("orientation");const d=S("display");this._displayField.textContent=d;const h=r.icons||[];this._iconsSection.clearContent();const p=r.shortcuts||[];for(const e of this._shortcutSections)e.detach(!0);const m=[],g=UI.UIUtils.CheckboxLabel.create(Common.UIString.UIString("Show only the minimum safe area for maskable icons"));g.classList.add("mask-checkbox"),g.addEventListener("click",()=>{this._iconsSection.setIconMasked(g.checkboxElement.checked)}),this._iconsSection.appendRow().appendChild(g);const u=UI.XLink.XLink.create("https://web.dev/maskable-icon/",ls`documentation on maskable icons`);if(this._iconsSection.appendRow().appendChild(UI.UIUtils.formatLocalized("Need help? Read our %s.",[u])),n&&n.primaryIcon){const t=createElement("div");t.classList.add("image-wrapper");const o=createElement("img");o.style.maxWidth="200px",o.style.maxHeight="200px",o.src="data:image/png;base64,"+n.primaryIcon,o.alt=ls`Primary manifest icon from ${e}`;const i=ls`Primary icon\nas used by Chrome`,s=this._iconsSection.appendFlexedField(i);t.appendChild(o),s.appendChild(t)}for(const t of h){const o=await this._appendIconResourceToSection(e,t,this._iconsSection);m.push(...o)}let f=1;for(const t of p){const o=this._reportView.appendSection(ls`Shortcut #${f}`);this._shortcutSections.push(o),o.appendFlexedField("Name",t.name),t.short_name&&o.appendFlexedField("Short name",t.short_name),t.description&&o.appendFlexedField("Description",t.description);const i=o.appendFlexedField("URL"),n=Common.ParsedURL.ParsedURL.completeURL(e,t.url),s=Components.Linkifier.Linkifier.linkifyURL(n,{text:t.url});s.tabIndex=0,i.appendChild(s);const r=t.icons||[];let a=!1;for(const t of r){const i=await this._appendIconResourceToSection(e,t,o);if(i.length>0&&m.push(...i),!a&&t.sizes){const e=t.sizes.match(/^(\d+)x(\d+)$/);e&&e[1]>=96&&e[2]>=96&&(a=!0)}}a||m.push(ls`Shortcut #${f} should include a 96x96 pixel icon`),f++}this._installabilitySection.clearContent(),this._installabilitySection.element.classList.toggle("hidden",!i.length);const _=this.getInstallabilityErrorMessages(i);for(const e of _)this._installabilitySection.appendRow().appendChild(UI.UIUtils.createIconLabel(e,"smallicon-warning"));this._errorsSection.element.classList.toggle("hidden",!o.length&&!m.length);for(const e of m)this._errorsSection.appendRow().appendChild(UI.UIUtils.createIconLabel(e,"smallicon-warning"));function S(e){const t=r[e];return"string"!=typeof t?"":t}}getInstallabilityErrorMessages(e){const t=[];for(const o of e){let e;switch(o.errorId){case"not-in-main-frame":e=ls`Page is not loaded in the main frame`;break;case"not-from-secure-origin":e=ls`Page is not served from a secure origin`;break;case"no-manifest":e=ls`Page has no manifest <link> URL`;break;case"manifest-empty":e=ls`Manifest could not be fetched, is empty, or could not be parsed`;break;case"start-url-not-valid":e=ls`Manifest start URL is not valid`;break;case"manifest-missing-name-or-short-name":e=ls`Manifest does not contain a 'name' or 'short_name' field`;break;case"manifest-display-not-supported":e=ls`Manifest 'display' property must be one of 'standalone', 'fullscreen', or 'minimal-ui'`;break;case"manifest-missing-suitable-icon":if(1!==o.errorArguments.length||"minimum-icon-size-in-pixels"!==o.errorArguments[0].name){console.error("Installability error does not have the correct errorArguments");break}e=ls`Manifest does not contain a suitable icon - PNG, SVG or WebP format of at least ${o.errorArguments[0].value}px is required, the sizes attribute must be set, and the purpose attribute, if set, must include "any" or "maskable".`;break;case"no-matching-service-worker":e=ls`No matching service worker detected. You may need to reload the page, or check that the scope of the service worker for the current page encloses the scope and start URL from the manifest.`;break;case"no-acceptable-icon":if(1!==o.errorArguments.length||"minimum-icon-size-in-pixels"!==o.errorArguments[0].name){console.error("Installability error does not have the correct errorArguments");break}e=ls`No supplied icon is at least ${o.errorArguments[0].value}px square in PNG, SVG or WebP format`;break;case"cannot-download-icon":e=ls`Could not download a required icon from the manifest`;break;case"no-icon-available":e=ls`Downloaded icon was empty or corrupted`;break;case"platform-not-supported-on-android":e=ls`The specified application platform is not supported on Android`;break;case"no-id-specified":e=ls`No Play store ID provided`;break;case"ids-do-not-match":e=ls`The Play Store app URL and Play Store ID do not match`;break;case"already-installed":e=ls`The app is already installed`;break;case"url-not-supported-for-webapk":e=ls`A URL in the manifest contains a username, password, or port`;break;case"in-incognito":e=ls`Page is loaded in an incognito window`;break;case"not-offline-capable":e=ls`Page does not work offline`;break;case"no-url-for-service-worker":e=ls`Could not check service worker without a 'start_url' field in the manifest`;break;case"prefer-related-applications":e=ls`Manifest specifies prefer_related_applications: true`;break;case"prefer-related-applications-only-beta-stable":e=ls`prefer_related_applications is only supported on Chrome Beta and Stable channels on Android.`;break;case"manifest-display-override-not-supported":e=ls`Manifest contains 'display_override' field, and the first supported display mode must be one of 'standalone', 'fullscreen', or 'minimal-ui'`;break;default:console.error(`Installability error id '${o.errorId}' is not recognized`)}t&&t.push(e)}return t}async _loadImage(e){const t=createElement("div");t.classList.add("image-wrapper");const o=createElement("img"),i=new Promise((e,t)=>{o.onload=e,o.onerror=t});o.src=e,o.alt=ls`Image from ${e}`,t.appendChild(o);try{return await i,{wrapper:t,image:o}}catch(e){}return null}async _appendIconResourceToSection(e,t,o){const i=[];if(!t.src)return i.push(ls`Icon src is not set`),i;const n=Common.ParsedURL.ParsedURL.completeURL(e,t.src),s=await this._loadImage(n);if(!s)return i.push(ls`Icon ${n} failed to load`),i;const{wrapper:r,image:a}=s,l=(t.sizes?t.sizes.replace("x","×")+"px":"")+"\n"+(t.type||""),c=o.appendFlexedField(l);if(t.sizes)if(/^\d+x\d+$/.test(t.sizes)){const[e,o]=t.sizes.split("x").map(e=>parseInt(e,10));e!==o?i.push(ls`Icon ${n} dimensions should be square`):a.naturalWidth!==e&&a.naturalHeight!==o?i.push(ls`Actual size (${a.naturalWidth}×${a.naturalHeight})px of icon ${n} does not match specified size (${e}×${o}px)`):a.naturalWidth!==e?i.push(ls`Actual width (${a.naturalWidth}px) of icon ${n} does not match specified width (${e}px)`):a.naturalHeight!==o&&i.push(ls`Actual height (${a.naturalHeight}px) of icon ${n} does not match specified height (${o}px)`)}else i.push(ls`Icon ${n} should specify its size as \`{width}x{height}\``);else i.push(ls`Icon ${n} does not specify its size in the manifest`);return c.appendChild(r),i}}