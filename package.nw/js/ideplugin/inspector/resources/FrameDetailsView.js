import*as Common from"../common/common.js";import*as Network from"../network/network.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";import*as Workspace from"../workspace/workspace.js";const booleanToYesNo=e=>e?ls`Yes`:ls`No`;export class FrameDetailsView extends UI.ThrottledWidget.ThrottledWidget{constructor(e){super(),this._frame=e,this._reportView=new UI.ReportView.ReportView(e.displayName()),this._reportView.registerRequiredCSS("resources/frameDetailsReportView.css"),this._reportView.show(this.contentElement),this._generalSection=this._reportView.appendSection(ls`Document`),this._urlFieldValue=this._generalSection.appendField(ls`URL`),this._unreachableURL=this._generalSection.appendField(ls`Unreachable URL`),this._originFieldValue=this._generalSection.appendField(ls`Origin`),this._ownerElementFieldValue=this._generalSection.appendField(ls`Owner Element`),this._ownerElementFieldValue.classList.add("devtools-link"),this._ownerElementFieldValue.title=ls`Click to reveal in Elements panel`,this._ownerDomNode=null,this._ownerElementFieldValue.addEventListener("click",()=>{this._ownerDomNode&&Common.Revealer.reveal(this._ownerDomNode)}),this._adStatus=this._generalSection.appendField(ls`Ad Status`),this._isolationSection=this._reportView.appendSection(ls`Security & Isolation`),this._secureContext=this._isolationSection.appendField(ls`Secure Context`),this._coepPolicy=this._isolationSection.appendField(ls`Cross-Origin Embedder Policy`),this._coopPolicy=this._isolationSection.appendField(ls`Cross-Origin Opener Policy`),this.update()}async doUpdate(){if(this._urlFieldValue.textContent=this._frame.url,!this._frame.unreachableUrl()){const e=this._urlFieldValue.createChild("span","report-field-value-part devtools-link");e.textContent=ls`View Source`,e.addEventListener("click",()=>{const e=Workspace.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(this._frame.url);Common.Revealer.reveal(e)})}FrameDetailsView.maybeAppendLinkToRequest(this._urlFieldValue,this._frame.resourceForURL(this._frame.url)),this._maybeAppendLinkForUnreachableUrl(),this._frame.securityOrigin&&"://"!==this._frame.securityOrigin?(this._originFieldValue.textContent=this._frame.securityOrigin,this._generalSection.setFieldVisible(ls`Origin`,!0)):this._generalSection.setFieldVisible(ls`Origin`,!1),this._ownerDomNode=await this._frame.getOwnerDOMNodeOrDocument(),this._updateAdStatus(),this._ownerDomNode&&(this._ownerElementFieldValue.textContent=`<${this._ownerDomNode.nodeName().toLocaleLowerCase()}>`),await this._updateCoopCoepStatus(),this._updateContextStatus()}async _updateCoopCoepStatus(){const e=await this._frame.resourceTreeModel().target().model(SDK.NetworkManager.NetworkManager).getSecurityIsolationStatus(this._frame.id);this._coepPolicy.textContent=e.coep.value,this._coopPolicy.textContent=e.coop.value}_explanationFromSecureContextType(e){switch(e){case Protocol.Page.SecureContextType.Secure:return null;case Protocol.Page.SecureContextType.SecureLocalhost:return ls`Localhost is always a secure context`;case Protocol.Page.SecureContextType.InsecureAncestor:return ls`A frame ancestor is an insecure context`;case Protocol.Page.SecureContextType.InsecureScheme:return ls`The frame's scheme is insecure`}return null}_updateContextStatus(){if(this._frame.unreachableUrl())return void this._isolationSection.setFieldVisible(ls`Secure Context`,!1);this._isolationSection.setFieldVisible(ls`Secure Context`,!0),this._secureContext.textContent=booleanToYesNo(this._frame.isSecureContext());const e=this._explanationFromSecureContextType(this._frame.getSecureContextType());if(e){this._secureContext.createChild("span","report-field-value-part more-info").textContent=e}}static maybeAppendLinkToRequest(e,t){if(t&&t.request){const i=t.request,s=e.createChild("span","report-field-value-part");s.textContent=ls`View Request`,s.classList.add("devtools-link"),s.addEventListener("click",()=>{Network.NetworkPanel.NetworkPanel.selectAndShowRequest(i,Network.NetworkItemView.Tabs.Headers)})}}_maybeAppendLinkForUnreachableUrl(){if(!this._frame.unreachableUrl())return void this._generalSection.setFieldVisible(ls`Unreachable URL`,!1);this._generalSection.setFieldVisible(ls`Unreachable URL`,!0),this._unreachableURL.textContent=this._frame.unreachableUrl();const e=Common.ParsedURL.ParsedURL.fromString(this._frame.unreachableUrl());if(!e)return;const t=this._unreachableURL.createChild("span","report-field-value-part devtools-link");t.textContent=ls`Show matching requests`,t.title=ls`Requires network log, try reloading the inspected page if unavailable`,t.addEventListener("click",()=>{Network.NetworkPanel.NetworkPanel.revealAndFilter([{filterType:"domain",filterValue:e.domain()},{filterType:null,filterValue:e.path}])})}_updateAdStatus(){switch(this._frame.adFrameType()){case Protocol.Page.AdFrameType.Root:this._generalSection.setFieldVisible(ls`Ad Status`,!0),this._adStatus.textContent=ls`root`,this._adStatus.title=ls`This frame has been identified as the root frame of an ad`;break;case Protocol.Page.AdFrameType.Child:this._generalSection.setFieldVisible(ls`Ad Status`,!0),this._adStatus.textContent=ls`child`,this._adStatus.title=ls`This frame has been identified as the a child frame of an ad`;break;default:this._generalSection.setFieldVisible(ls`Ad Status`,!1)}}}export class OpenedWindowDetailsView extends UI.ThrottledWidget.ThrottledWidget{constructor(e,t){super(),this._targetInfo=e,this._isWindowClosed=t,this._reportView=new UI.ReportView.ReportView(this.buildTitle()),this._reportView.registerRequiredCSS("resources/frameDetailsReportView.css"),this._reportView.show(this.contentElement),this._documentSection=this._reportView.appendSection(ls`Document`),this._URLFieldValue=this._documentSection.appendField(ls`URL`),this._securitySection=this._reportView.appendSection(ls`Security`),this._hasDOMAccessValue=this._securitySection.appendField(ls`Access to opener`),this.update()}async doUpdate(){this._reportView.setTitle(this.buildTitle()),this._URLFieldValue.textContent=this._targetInfo.url,this._hasDOMAccessValue.textContent=booleanToYesNo(this._targetInfo.canAccessOpener)}buildTitle(){let e=this._targetInfo.title||ls`Window without title`;return this._isWindowClosed&&(e+=` (${ls`closed`})`),e}setIsWindowClosed(e){this._isWindowClosed=e}setTargetInfo(e){this._targetInfo=e}}