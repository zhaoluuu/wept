import*as Common from"../common/common.js";import*as UI from"../ui/ui.js";import*as DataGrid from"../data_grid/data_grid.js";import*as SourceFrame from"../source_frame/source_frame.js";import*as TextUtils from"../text_utils/text_utils.js";import PluginMessenger from"../wx_main/PluginMessenger.js";import{each,fileSize,isJson,lowerCase,upperFirst,type,keys,contain,trim,isEqual,difference,debounce}from"../third_party/licia.js";export class StoragePanel extends UI.Widget.VBox{constructor(){super(!1),this._initMessenger(),this.registerRequiredCSS("storage/storagePanel.css"),this._storage=null,this._storageId=0,this._filterRegex=null,this._refreshButton=this._addButton(Common.UIString.UIString("Refresh"),"largeicon-refresh",this.refreshItems),this._mainToolbar=new UI.Toolbar.Toolbar("top-resources-toolbar",this.element),this._filterItem=new UI.Toolbar.ToolbarInput(Common.UIString.UIString("Filter"),"",.4),this._filterItem.addEventListener(UI.Toolbar.ToolbarInput.Event.TextChanged,this._filterChanged,this),this._deleteAllButton=this._addButton(Common.UIString.UIString("Clear All"),"largeicon-clear",this.deleteAllItems),this._deleteSelectedButton=this._addButton(Common.UIString.UIString("Delete Selected"),"largeicon-delete",this.deleteSelectedItem),this._currentSize=new UI.Toolbar.ToolbarText("Current Size: 0B");const e=[this._refreshButton,this._filterItem,new UI.Toolbar.ToolbarSeparator,this._deleteAllButton,this._deleteSelectedButton,new UI.Toolbar.ToolbarSeparator,this._currentSize];if("Game"===wxMain.type){const t=new UI.Toolbar.ToolbarComboBox(this._storageChanged.bind(this),ls`Storage`);t.addOption(t.createOption("game","game")),t.addOption(t.createOption("opendata","opendata")),e.splice(1,0,new UI.Toolbar.ToolbarSeparator,t,new UI.Toolbar.ToolbarSeparator),this._storageSelect=t}for(const t of e)this._mainToolbar.appendToolbarItem(t);this.element.classList.add("storage-view","table");const t=[{id:"key",title:Common.UIString.UIString("Key"),sortable:!1,editable:!0,longText:!0,weight:30},{id:"value",title:Common.UIString.UIString("Value"),sortable:!1,editable:!0,longText:!0,weight:50},{id:"type",title:Common.UIString.UIString("Type"),sortable:!1,editable:!0,longText:!1,weight:20}];this._dataGrid=new DataGrid.DataGrid.DataGridImpl({displayName:ls`Storage Items`,columns:t,editCallback:this._editingCallback.bind(this),deleteCallback:this._deleteCallback.bind(this),refreshCallback:this.refreshItems.bind(this)}),this._dataGrid.addEventListener(DataGrid.DataGrid.Events.SelectedNode,e=>{this._previewEntry(e.data)}),this._dataGrid.addEventListener(DataGrid.DataGrid.Events.DeselectedNode,e=>{this._previewEntry(null)}),this._dataGrid.setStriped(!0),this._dataGrid.setName("storageItemsView"),this._splitWidget=new UI.SplitWidget.SplitWidget(!1,!0,"storageSplitViewState"),this._splitWidget.show(this.element),this._previewPanel=new UI.Widget.VBox,this._previewPanel.setMinimumSize(0,50);const i=this._previewPanel.element.createChild("div","preview-panel-resizer"),s=this._dataGrid.asWidget();s.setMinimumSize(0,50),this._splitWidget.setMainWidget(s),this._splitWidget.setSidebarWidget(this._previewPanel),this._splitWidget.installResizer(i),this._preview=null,this._previewValue=null,this._showPreview(null,null),this._showStorageItems=debounce(()=>{this._innerShowStorageItems()},100)}_storageChanged(){const e=this._storageSelect.selectedOption().value;this._storageId="opendata"===e?1:0,this._showCurrentSize(),this._showStorageItems()}setStorage(e){this._storage=e,this._showCurrentSize(),this._showStorageItems()}_initMessenger(){let e="miniprogram";"Game"===wxMain.type?e="game":"RemoteDebug"===wxMain.type&&(e="remotedebug");const t=new PluginMessenger("PLUGIN_storage_"+e);t.on("UPDATE_STORAGE",e=>{this.setStorage(e)}),"Game"!==wxMain.type&&t.on("UPDATE_USERDATA_SCOPE",e=>{this._storageId=e.storageId}),this._storageMessenger=t}_addButton(e,t,i){const s=new UI.Toolbar.ToolbarButton(e,t);return s.addEventListener(UI.Toolbar.ToolbarButton.Events.Click,i,this),s}_filterChanged(e){const t=e.data;this._filterRegex=t?new RegExp(t.escapeForRegExp(),"i"):null,this.refreshItems()}_editingCallback(e,t,i,s){"key"===t?("string"==typeof i&&this._removeStorage(i),this._setStorage(s,e.data.value||"",e.data.type||"String")):"type"===t?this._setStorage(e.data.key||"",e.data.value||"",s):this._setStorage(e.data.key||"",s,e.data.type||"")}_setStorage(e,t,i){let s=!1;isValidType(i=upperFirst(lowerCase(trim(i))))||(i="String"),"String"!==i&&(isJson(t)&&type(JSON.parse(t))===lowerCase(i)||(s=!0)),s&&(t=defaultData[i]),this._storageMessenger.send("EXEC_STORAGE_SDK",{api:"setStorage",args:{storageId:this._storageId,key:e,data:t,dataType:i}})}_removeStorage(e){this._storageMessenger.send("EXEC_STORAGE_SDK",{api:"removeStorage",args:{storageId:this._storageId,key:e}})}_deleteCallback(e){e&&!e.isCreationNode&&this._removeStorage(e.data.key)}_showPreview(e,t){this._preview&&this._previewValue===t||(this._preview&&this._preview.detach(),e||(e=new UI.EmptyWidget.EmptyWidget(Common.UIString.UIString("Select a value to preview"))),this._previewValue=t,this._preview=e,e.show(this._previewPanel.contentElement))}filter(e,t){if(this._filterRegex){const i=this._filterRegex;return e.filter(e=>i.test(t(e)))}return e}wasShown(){this.refreshItems()}deleteAllItems(){this._storageMessenger.send("EXEC_STORAGE_SDK",{api:"clearStorage",args:{storageId:this._storageId}})}_showCurrentSize(){const e=this._getItems();let t=0;for(const i of e)t+=i[0].length,t+=i[1].length;this._currentSize.setText("Current Size: "+fileSize(t)+"B")}_innerShowStorageItems(){const e=this._getItems(),t=this._dataGrid,i=t.rootNode(),s=i.children,a={};t.creationNode||t.addCreationNode(!1);const r=[];each(s,e=>{e!==t.creationNode&&(a[e.data.key]?r.push(e):a[e.data.key]=e)}),each(r,e=>{i.removeChild(e)});const o=this.filter(e,e=>`${e[0]} ${e[1]}`).map(e=>({key:e[0],value:e[1],type:e[2]}));each(o,(e,t)=>{const s=e.key;let r;a[s]?(r=a[s],isEqual(e,r.data)||(r.data=e)):(r=new DataGrid.DataGrid.DataGridNode(e,!1),r.selectable=!0,i.insertChild(r,t))});const n=difference(keys(a),o.map(e=>e.key));each(n,e=>{o[e]||i.removeChild(a[e])}),this.setCanDeleteSelected(!1);for(const e of i.children)if(e.selected){this.setCanDeleteSelected(!0);break}}_getItems(){const e=this._storage[this._storageId]||{},t=[];return each(e,({data:e,dataType:i},s)=>{t.push([s,e,i])}),t}setCanDeleteSelected(e){this._deleteSelectedButton.setEnabled(e)}deleteSelectedItem(){this._dataGrid&&this._dataGrid.selectedNode&&this._deleteCallback(this._dataGrid.selectedNode)}refreshItems(){this._storageMessenger.send("STORAGE_PANNEL_SHOW")}async _previewEntry(e){const t=e&&e.data&&e.data.value;if(!t)return void this._showPreview(null,t);const i="storage://"+e.key,s=TextUtils.StaticContentProvider.StaticContentProvider.fromString(i,Common.ResourceType.resourceTypes.XHR,t),a=await SourceFrame.PreviewFactory.PreviewFactory.createPreview(s,"text/plain");e.selected&&this._showPreview(a,t)}}const defaultData={Object:"{}",String:"",Array:"[]",Number:"0",Null:"null",Boolean:"false"};function isValidType(e){return contain(keys(defaultData),e)}