import*as Common from"../common/common.js";import*as UI from"../ui/ui.js";import{SearchConfig,SearchResult,SearchScope}from"./SearchConfig.js";import{SearchResultsPane}from"./SearchResultsPane.js";export class SearchView extends UI.Widget.VBox{constructor(e){super(!0),this.setMinimumSize(0,40),this.registerRequiredCSS("search/searchView.css"),this._focusOnShow=!1,this._isIndexing=!1,this._searchId=1,this._searchMatchesCount=0,this._searchResultsCount=0,this._nonEmptySearchResultsCount=0,this._searchingView=null,this._notFoundView=null,this._searchConfig=null,this._pendingSearchConfig=null,this._searchResultsPane=null,this._progressIndicator=null,this._visiblePane=null,this.contentElement.classList.add("search-view"),this._searchPanelElement=this.contentElement.createChild("div","search-drawer-header"),this._searchPanelElement.addEventListener("keydown",this._onKeyDown.bind(this),!1),this._searchResultsElement=this.contentElement.createChild("div"),this._searchResultsElement.className="search-results";const t=createElement("div");t.style.flex="auto",t.style.justifyContent="start",t.style.maxWidth="300px",this._search=UI.HistoryInput.HistoryInput.create(),t.appendChild(this._search),this._search.placeholder=Common.UIString.UIString("Search"),this._search.setAttribute("type","text"),this._search.setAttribute("results","0"),this._search.setAttribute("size",42),UI.ARIAUtils.setAccessibleName(this._search,ls`Search Query`);const s=new UI.Toolbar.ToolbarItem(t),n=new UI.Toolbar.Toolbar("search-toolbar",this._searchPanelElement);this._matchCaseButton=SearchView._appendToolbarToggle(n,"Aa",Common.UIString.UIString("Match Case")),this._regexButton=SearchView._appendToolbarToggle(n,".*",Common.UIString.UIString("Use Regular Expression")),n.appendToolbarItem(s);const i=new UI.Toolbar.ToolbarButton(Common.UIString.UIString("Refresh"),"largeicon-refresh"),h=new UI.Toolbar.ToolbarButton(Common.UIString.UIString("Clear"),"largeicon-clear");n.appendToolbarItem(i),n.appendToolbarItem(h),i.addEventListener(UI.Toolbar.ToolbarButton.Events.Click,this._onAction.bind(this)),h.addEventListener(UI.Toolbar.ToolbarButton.Events.Click,()=>{this._resetSearch(),this._onSearchInputClear()});const r=this.contentElement.createChild("div","search-toolbar-summary");this._searchMessageElement=r.createChild("div","search-message"),this._searchProgressPlaceholderElement=r.createChild("div","flex-centered"),this._searchResultsMessageElement=r.createChild("div","search-message"),this._advancedSearchConfig=Common.Settings.Settings.instance().createLocalSetting(e+"SearchConfig",new SearchConfig("",!0,!1).toPlainObject()),this._load(),this._searchScope=null}static _appendToolbarToggle(e,t,s){const n=new UI.Toolbar.ToolbarToggle(s);return n.setText(t),n.addEventListener(UI.Toolbar.ToolbarButton.Events.Click,()=>n.setToggled(!n.toggled())),e.appendToolbarItem(n),n}_buildSearchConfig(){return new SearchConfig(this._search.value,!this._matchCaseButton.toggled(),this._regexButton.toggled())}async toggle(e,t){e&&(this._search.value=e),this.isShowing()?this.focus():this._focusOnShow=!0,this._initScope(),t?this._onAction():this._startIndexing()}createScope(){throw new Error("Not implemented")}_initScope(){this._searchScope=this.createScope()}wasShown(){this._focusOnShow&&(this.focus(),this._focusOnShow=!1)}_onIndexingFinished(){const e=!this._progressIndicator.isCanceled();if(this._progressIndicator.done(),this._progressIndicator=null,this._isIndexing=!1,this._indexingFinished(e),e||(this._pendingSearchConfig=null),!this._pendingSearchConfig)return;const t=this._pendingSearchConfig;this._pendingSearchConfig=null,this._innerStartSearch(t)}_startIndexing(){this._isIndexing=!0,this._progressIndicator&&this._progressIndicator.done(),this._progressIndicator=new UI.ProgressIndicator.ProgressIndicator,this._searchMessageElement.textContent=Common.UIString.UIString("Indexing…"),this._progressIndicator.show(this._searchProgressPlaceholderElement),this._searchScope.performIndexing(new Common.Progress.ProgressProxy(this._progressIndicator,this._onIndexingFinished.bind(this)))}_onSearchInputClear(){this._search.value="",this.focus()}_onSearchResult(e,t){e===this._searchId&&this._progressIndicator&&(this._progressIndicator&&this._progressIndicator.isCanceled()?this._onIndexingFinished():(this._addSearchResult(t),t.matchesCount()&&(this._searchResultsPane||(this._searchResultsPane=new SearchResultsPane(this._searchConfig),this._showPane(this._searchResultsPane)),this._searchResultsPane.addSearchResult(t))))}_onSearchFinished(e,t){e===this._searchId&&this._progressIndicator&&(this._searchResultsPane||this._nothingFound(),this._searchFinished(t),this._searchConfig=null,UI.ARIAUtils.alert(this._searchMessageElement.textContent+" "+this._searchResultsMessageElement.textContent,this._searchMessageElement))}async _startSearch(e){this._resetSearch(),++this._searchId,this._initScope(),this._isIndexing||this._startIndexing(),this._pendingSearchConfig=e}_innerStartSearch(e){this._searchConfig=e,this._progressIndicator&&this._progressIndicator.done(),this._progressIndicator=new UI.ProgressIndicator.ProgressIndicator,this._searchStarted(this._progressIndicator),this._searchScope.performSearch(e,this._progressIndicator,this._onSearchResult.bind(this,this._searchId),this._onSearchFinished.bind(this,this._searchId))}_resetSearch(){this._stopSearch(),this._showPane(null),this._searchResultsPane=null}_stopSearch(){this._progressIndicator&&!this._isIndexing&&this._progressIndicator.cancel(),this._searchScope&&this._searchScope.stopSearch(),this._searchConfig=null}_searchStarted(e){this._resetCounters(),this._searchingView||(this._searchingView=new UI.EmptyWidget.EmptyWidget(Common.UIString.UIString("Searching…"))),this._showPane(this._searchingView),this._searchMessageElement.textContent=Common.UIString.UIString("Searching…"),e.show(this._searchProgressPlaceholderElement),this._updateSearchResultsMessage()}_indexingFinished(e){this._searchMessageElement.textContent=e?"":Common.UIString.UIString("Indexing interrupted.")}_updateSearchResultsMessage(){this._searchMatchesCount&&this._searchResultsCount?1===this._searchMatchesCount&&1===this._nonEmptySearchResultsCount?this._searchResultsMessageElement.textContent=Common.UIString.UIString("Found 1 matching line in 1 file."):this._searchMatchesCount>1&&1===this._nonEmptySearchResultsCount?this._searchResultsMessageElement.textContent=Common.UIString.UIString("Found %d matching lines in 1 file.",this._searchMatchesCount):this._searchResultsMessageElement.textContent=Common.UIString.UIString("Found %d matching lines in %d files.",this._searchMatchesCount,this._nonEmptySearchResultsCount):this._searchResultsMessageElement.textContent=""}_showPane(e){this._visiblePane&&this._visiblePane.detach(),e&&e.show(this._searchResultsElement),this._visiblePane=e}_resetCounters(){this._searchMatchesCount=0,this._searchResultsCount=0,this._nonEmptySearchResultsCount=0}_nothingFound(){this._notFoundView||(this._notFoundView=new UI.EmptyWidget.EmptyWidget(Common.UIString.UIString("No matches found."))),this._showPane(this._notFoundView),this._searchResultsMessageElement.textContent=Common.UIString.UIString("No matches found.")}_addSearchResult(e){const t=e.matchesCount();this._searchMatchesCount+=t,this._searchResultsCount++,t&&this._nonEmptySearchResultsCount++,this._updateSearchResultsMessage()}_searchFinished(e){this._searchMessageElement.textContent=e?Common.UIString.UIString("Search finished."):Common.UIString.UIString("Search interrupted.")}focus(){this._search.focus(),this._search.select()}willHide(){this._stopSearch()}_onKeyDown(e){switch(e.keyCode){case UI.KeyboardShortcut.Keys.Enter.code:this._onAction()}}_save(){this._advancedSearchConfig.set(this._buildSearchConfig().toPlainObject())}_load(){const e=SearchConfig.fromPlainObject(this._advancedSearchConfig.get());this._search.value=e.query(),this._matchCaseButton.setToggled(!e.ignoreCase()),this._regexButton.setToggled(e.isRegex())}_onAction(){UI.ARIAUtils.alert(" ",this._searchMessageElement);const e=this._buildSearchConfig();e.query()&&e.query().length&&(this._save(),this._startSearch(e))}}