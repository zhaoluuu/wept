import*as Bindings from"../bindings/bindings.js";import*as Common from"../common/common.js";import*as Platform from"../platform/platform.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";import*as Workspace from"../workspace/workspace.js";export class MediaQueryInspector extends UI.Widget.Widget{constructor(e,t){super(!0),this.registerRequiredCSS("emulation/mediaQueryInspector.css"),this.contentElement.classList.add("media-inspector-view"),this.contentElement.addEventListener("click",this._onMediaQueryClicked.bind(this),!1),this.contentElement.addEventListener("contextmenu",this._onContextMenu.bind(this),!1),this._mediaThrottler=new Common.Throttler.Throttler(0),this._getWidthCallback=e,this._setWidthCallback=t,this._scale=1,SDK.SDKModel.TargetManager.instance().observeModels(SDK.CSSModel.CSSModel,this),UI.ZoomManager.ZoomManager.instance().addEventListener(UI.ZoomManager.Events.ZoomChanged,this._renderMediaQueries.bind(this),this)}modelAdded(e){this._cssModel||(this._cssModel=e,this._cssModel.addEventListener(SDK.CSSModel.Events.StyleSheetAdded,this._scheduleMediaQueriesUpdate,this),this._cssModel.addEventListener(SDK.CSSModel.Events.StyleSheetRemoved,this._scheduleMediaQueriesUpdate,this),this._cssModel.addEventListener(SDK.CSSModel.Events.StyleSheetChanged,this._scheduleMediaQueriesUpdate,this),this._cssModel.addEventListener(SDK.CSSModel.Events.MediaQueryResultChanged,this._scheduleMediaQueriesUpdate,this))}modelRemoved(e){e===this._cssModel&&(this._cssModel.removeEventListener(SDK.CSSModel.Events.StyleSheetAdded,this._scheduleMediaQueriesUpdate,this),this._cssModel.removeEventListener(SDK.CSSModel.Events.StyleSheetRemoved,this._scheduleMediaQueriesUpdate,this),this._cssModel.removeEventListener(SDK.CSSModel.Events.StyleSheetChanged,this._scheduleMediaQueriesUpdate,this),this._cssModel.removeEventListener(SDK.CSSModel.Events.MediaQueryResultChanged,this._scheduleMediaQueriesUpdate,this),delete this._cssModel)}setAxisTransform(e){Math.abs(this._scale-e)<1e-8||(this._scale=e,this._renderMediaQueries())}_onMediaQueryClicked(e){const t=e.target.enclosingNodeOrSelfWithClass("media-inspector-bar");if(!t)return;const i=t._model;if(i.section()===Section.Max)return void this._setWidthCallback(i.maxWidthExpression().computedLength());if(i.section()===Section.Min)return void this._setWidthCallback(i.minWidthExpression().computedLength());this._getWidthCallback()!==i.minWidthExpression().computedLength()?this._setWidthCallback(i.minWidthExpression().computedLength()):this._setWidthCallback(i.maxWidthExpression().computedLength())}_onContextMenu(e){if(!this._cssModel||!this._cssModel.isEnabled())return;const t=e.target.enclosingNodeOrSelfWithClass("media-inspector-bar");if(!t)return;const i=t._locations,s=new Map;for(let e=0;e<i.length;++e){const t=Bindings.CSSWorkspaceBinding.CSSWorkspaceBinding.instance().rawLocationToUILocation(i[e]);if(!t)continue;const n=Platform.StringUtilities.sprintf("%s:%d:%d",t.uiSourceCode.url(),t.lineNumber+1,t.columnNumber+1);s.set(n,t)}const n=[...s.keys()].sort(),o=new UI.ContextMenu.ContextMenu(e),r=o.defaultSection().appendSubMenuItem(Common.UIString.UIString("Reveal in source code"));for(let e=0;e<n.length;++e){const t=n[e];r.defaultSection().appendItem(t,this._revealSourceLocation.bind(this,s.get(t)))}o.show()}_revealSourceLocation(e){Common.Revealer.reveal(e)}_scheduleMediaQueriesUpdate(){this.isShowing()&&this._mediaThrottler.schedule(this._refetchMediaQueries.bind(this))}_refetchMediaQueries(){return this.isShowing()&&this._cssModel?this._cssModel.mediaQueriesPromise().then(this._rebuildMediaQueries.bind(this)):Promise.resolve()}_squashAdjacentEqual(e){const t=[];for(let i=0;i<e.length;++i){const s=t.peekLast();s&&s.equals(e[i])||t.push(e[i])}return t}_rebuildMediaQueries(e){let t=[];for(let i=0;i<e.length;++i){const s=e[i];if(s.mediaList)for(let e=0;e<s.mediaList.length;++e){const i=s.mediaList[e],n=MediaQueryUIModel.createFromMediaQuery(s,i);n&&t.push(n)}}t.sort((function(e,t){return e.compareTo(t)})),t=this._squashAdjacentEqual(t);let i=this._cachedQueryModels&&this._cachedQueryModels.length===t.length;for(let e=0;i&&e<t.length;++e)i=i&&this._cachedQueryModels[e].equals(t[e]);i||(this._cachedQueryModels=t,this._renderMediaQueries())}_renderMediaQueries(){if(!this._cachedQueryModels||!this.isShowing())return;const e=[];let t=null;for(let i=0;i<this._cachedQueryModels.length;++i){const s=this._cachedQueryModels[i];t&&t.model.dimensionsEqual(s)?t.active=t.active||s.active():(t={active:s.active(),model:s,locations:[]},e.push(t));const n=s.rawLocation();n&&t.locations.push(n)}this.contentElement.removeChildren();let i=null;for(let t=0;t<e.length;++t){t&&e[t].model.section()===e[t-1].model.section()||(i=this.contentElement.createChild("div","media-inspector-marker-container"));const s=e[t],n=this._createElementFromMediaQueryModel(s.model);n._model=s.model,n._locations=s.locations,n.classList.toggle("media-inspector-marker-inactive",!s.active),i.appendChild(n)}}_zoomFactor(){return UI.ZoomManager.ZoomManager.instance().zoomFactor()/this._scale}wasShown(){this._scheduleMediaQueriesUpdate()}_createElementFromMediaQueryModel(e){const t=this._zoomFactor(),i=e.minWidthExpression()?e.minWidthExpression().computedLength()/t:0,s=e.maxWidthExpression()?e.maxWidthExpression().computedLength()/t:0,n=document.createElement("div");if(n.classList.add("media-inspector-bar"),e.section()===Section.Max){n.createChild("div","media-inspector-marker-spacer");const t=n.createChild("div","media-inspector-marker media-inspector-marker-max-width");t.style.width=s+"px",t.title=e.mediaText(),o(t,e.maxWidthExpression(),!1,!1),o(t,e.maxWidthExpression(),!0,!0),n.createChild("div","media-inspector-marker-spacer")}if(e.section()===Section.MinMax){n.createChild("div","media-inspector-marker-spacer");const t=n.createChild("div","media-inspector-marker media-inspector-marker-min-max-width");t.style.width=.5*(s-i)+"px",t.title=e.mediaText(),o(t,e.maxWidthExpression(),!0,!1),o(t,e.minWidthExpression(),!1,!0),n.createChild("div","media-inspector-marker-spacer").style.flex="0 0 "+i+"px";const r=n.createChild("div","media-inspector-marker media-inspector-marker-min-max-width");r.style.width=.5*(s-i)+"px",r.title=e.mediaText(),o(r,e.minWidthExpression(),!0,!1),o(r,e.maxWidthExpression(),!1,!0),n.createChild("div","media-inspector-marker-spacer")}if(e.section()===Section.Min){const t=n.createChild("div","media-inspector-marker media-inspector-marker-min-width media-inspector-marker-min-width-left");t.title=e.mediaText(),o(t,e.minWidthExpression(),!1,!1),n.createChild("div","media-inspector-marker-spacer").style.flex="0 0 "+i+"px";const s=n.createChild("div","media-inspector-marker media-inspector-marker-min-width media-inspector-marker-min-width-right");s.title=e.mediaText(),o(s,e.minWidthExpression(),!0,!0)}function o(e,t,i,s){e.createChild("div","media-inspector-marker-label-container "+(i?"media-inspector-marker-label-container-left":"media-inspector-marker-label-container-right")).createChild("span","media-inspector-marker-label "+(s?"media-inspector-label-left":"media-inspector-label-right")).textContent=t.value()+t.unit()}return n}}export const Section={Max:0,MinMax:1,Min:2};export class MediaQueryUIModel{constructor(e,t,i,s){this._cssMedia=e,this._minWidthExpression=t,this._maxWidthExpression=i,this._active=s,this._section=i&&!t?Section.Max:t&&i?Section.MinMax:Section.Min}static createFromMediaQuery(e,t){let i=null,s=Number.MAX_VALUE,n=null,o=Number.MIN_VALUE;const r=t.expressions();for(let e=0;e<r.length;++e){const t=r[e],a=t.feature();if(-1===a.indexOf("width"))continue;const d=t.computedLength();a.startsWith("max-")&&d<s?(i=t,s=d):a.startsWith("min-")&&d>o&&(n=t,o=d)}return o>s||!i&&!n?null:new MediaQueryUIModel(e,n,i,t.active())}equals(e){return 0===this.compareTo(e)}dimensionsEqual(e){return!(this.section()!==e.section()||this.minWidthExpression()&&this.minWidthExpression().computedLength()!==e.minWidthExpression().computedLength()||this.maxWidthExpression()&&this.maxWidthExpression().computedLength()!==e.maxWidthExpression().computedLength())}compareTo(e){if(this.section()!==e.section())return this.section()-e.section();if(this.dimensionsEqual(e)){const t=this.rawLocation(),i=e.rawLocation();return t||i?t&&!i?1:!t&&i?-1:this.active()!==e.active()?this.active()?-1:1:t.url.compareTo(i.url)||t.lineNumber-i.lineNumber||t.columnNumber-i.columnNumber:this.mediaText().compareTo(e.mediaText())}return this.section()===Section.Max?e.maxWidthExpression().computedLength()-this.maxWidthExpression().computedLength():this.section()===Section.Min?this.minWidthExpression().computedLength()-e.minWidthExpression().computedLength():this.minWidthExpression().computedLength()-e.minWidthExpression().computedLength()||e.maxWidthExpression().computedLength()-this.maxWidthExpression().computedLength()}section(){return this._section}mediaText(){return this._cssMedia.text}rawLocation(){return this._rawLocation||(this._rawLocation=this._cssMedia.rawLocation()),this._rawLocation}minWidthExpression(){return this._minWidthExpression}maxWidthExpression(){return this._maxWidthExpression}active(){return this._active}}