import*as Common from"../common/common.js";import*as Host from"../host/host.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";import{EmulatedDevice,Horizontal,HorizontalSpanned,Mode,Vertical,VerticalSpanned}from"./EmulatedDevices.js";export class DeviceModeModel extends Common.ObjectWrapper.ObjectWrapper{constructor(){super(),this._screenRect=new UI.Geometry.Rect(0,0,1,1),this._visiblePageRect=new UI.Geometry.Rect(0,0,1,1),this._availableSize=new UI.Geometry.Size(1,1),this._preferredSize=new UI.Geometry.Size(1,1),this._initialized=!1,this._appliedDeviceSize=new UI.Geometry.Size(1,1),this._appliedDeviceScaleFactor=window.devicePixelRatio,this._appliedUserAgentType=UA.Desktop,this._experimentDualScreenSupport=Root.Runtime.experiments.isEnabled("dualScreenSupport"),this._webPlatformExperimentalFeaturesEnabled=!!eval("window.getWindowSegments"),this._scaleSetting=Common.Settings.Settings.instance().createSetting("emulation.deviceScale",1),this._scaleSetting.get()||this._scaleSetting.set(1),this._scaleSetting.addChangeListener(this._scaleSettingChanged,this),this._widthSetting=Common.Settings.Settings.instance().createSetting("emulation.deviceWidth",400),this._widthSetting.get()<MinDeviceSize&&this._widthSetting.set(MinDeviceSize),this._widthSetting.get()>MaxDeviceSize&&this._widthSetting.set(MaxDeviceSize),this._widthSetting.addChangeListener(this._widthSettingChanged,this),this._heightSetting=Common.Settings.Settings.instance().createSetting("emulation.deviceHeight",0),this._heightSetting.get()&&this._heightSetting.get()<MinDeviceSize&&this._heightSetting.set(MinDeviceSize),this._heightSetting.get()>MaxDeviceSize&&this._heightSetting.set(MaxDeviceSize),this._heightSetting.addChangeListener(this._heightSettingChanged,this),this._uaSetting=Common.Settings.Settings.instance().createSetting("emulation.deviceUA",UA.Mobile),this._uaSetting.addChangeListener(this._uaSettingChanged,this),this._deviceScaleFactorSetting=Common.Settings.Settings.instance().createSetting("emulation.deviceScaleFactor",0),this._deviceScaleFactorSetting.addChangeListener(this._deviceScaleFactorSettingChanged,this),this._deviceOutlineSetting=Common.Settings.Settings.instance().moduleSetting("emulation.showDeviceOutline"),this._deviceOutlineSetting.addChangeListener(this._deviceOutlineSettingChanged,this),this._toolbarControlsEnabledSetting=Common.Settings.Settings.instance().createSetting("emulation.toolbarControlsEnabled",!0,Common.Settings.SettingStorageType.Session),this._type=Type.None,this._device=null,this._mode=null,this._fitScale=1,this._touchEnabled=!1,this._touchMobile=!1,this._emulationModel=null,this._onModelAvailable=null,SDK.SDKModel.TargetManager.instance().observeModels(SDK.EmulationModel.EmulationModel,this)}static widthValidator(e){let t,i=!1;return/^[\d]+$/.test(e)?e>MaxDeviceSize?t=ls`Width must be less than or equal to ${MaxDeviceSize}.`:e<MinDeviceSize?t=ls`Width must be greater than or equal to ${MinDeviceSize}.`:i=!0:t=ls`Width must be a number.`,{valid:i,errorMessage:t}}static heightValidator(e){let t,i=!1;return/^[\d]+$/.test(e)?e>MaxDeviceSize?t=ls`Height must be less than or equal to ${MaxDeviceSize}.`:e<MinDeviceSize?t=ls`Height must be greater than or equal to ${MinDeviceSize}.`:i=!0:t=ls`Height must be a number.`,{valid:i,errorMessage:t}}static scaleValidator(e){let t,i=!1;const n=Number(e.trim());return e?Number.isNaN(n)?t=ls`Device pixel ratio must be a number or blank.`:e>MaxDeviceScaleFactor?t=ls`Device pixel ratio must be less than or equal to ${MaxDeviceScaleFactor}.`:e<MinDeviceScaleFactor?t=ls`Device pixel ratio must be greater than or equal to ${MinDeviceScaleFactor}.`:i=!0:i=!0,{valid:i,errorMessage:t}}setAvailableSize(e,t){this._availableSize=e,this._preferredSize=t,this._initialized=!0,this._calculateAndEmulate(!1)}emulate(e,t,i,n){const a=this._type!==e||this._device!==t||this._mode!==i;if(this._type=e,e===Type.Device){if(console.assert(t&&i,"Must pass device and mode for device emulation"),this._mode=i,this._device=t,this._initialized){const e=t.orientationByName(i.orientation);this._scaleSetting.set(n||this._calculateFitScale(e.width,e.height,this._currentOutline(),this._currentInsets()))}}else this._device=null,this._mode=null;e!==Type.None&&Host.userMetrics.actionTaken(Host.UserMetrics.Action.DeviceModeEnabled),this._calculateAndEmulate(a)}setWidth(e){const t=Math.min(MaxDeviceSize,this._preferredScaledWidth());e=Math.max(Math.min(e,t),1),this._widthSetting.set(e)}setWidthAndScaleToFit(e){e=Math.max(Math.min(e,MaxDeviceSize),1),this._scaleSetting.set(this._calculateFitScale(e,this._heightSetting.get())),this._widthSetting.set(e)}setHeight(e){const t=Math.min(MaxDeviceSize,this._preferredScaledHeight());(e=Math.max(Math.min(e,t),0))===this._preferredScaledHeight()&&(e=0),this._heightSetting.set(e)}setHeightAndScaleToFit(e){e=Math.max(Math.min(e,MaxDeviceSize),0),this._scaleSetting.set(this._calculateFitScale(this._widthSetting.get(),e)),this._heightSetting.set(e)}setScale(e){this._scaleSetting.set(e)}device(){return this._device}mode(){return this._mode}type(){return this._type}screenImage(){return this._device&&this._mode?this._device.modeImage(this._mode):""}outlineImage(){return this._device&&this._mode&&this._deviceOutlineSetting.get()?this._device.outlineImage(this._mode):""}outlineRect(){return this._outlineRect}screenRect(){return this._screenRect}visiblePageRect(){return this._visiblePageRect}scale(){return this._scale}fitScale(){return this._fitScale}appliedDeviceSize(){return this._appliedDeviceSize}appliedDeviceScaleFactor(){return this._appliedDeviceScaleFactor}appliedUserAgentType(){return this._appliedUserAgentType}isFullHeight(){return!this._heightSetting.get()}_isMobile(){switch(this._type){case Type.Device:return this._device.mobile();case Type.None:return!1;case Type.Responsive:return this._uaSetting.get()===UA.Mobile||this._uaSetting.get()===UA.MobileNoTouch}return!1}enabledSetting(){return Common.Settings.Settings.instance().createSetting("emulation.showDeviceMode",!1)}scaleSetting(){return this._scaleSetting}uaSetting(){return this._uaSetting}deviceScaleFactorSetting(){return this._deviceScaleFactorSetting}deviceOutlineSetting(){return this._deviceOutlineSetting}toolbarControlsEnabledSetting(){return this._toolbarControlsEnabledSetting}reset(){this._deviceScaleFactorSetting.set(0),this._scaleSetting.set(1),this.setWidth(400),this.setHeight(0),this._uaSetting.set(UA.Mobile)}modelAdded(e){if(!this._emulationModel&&e.supportsDeviceEmulation()){if(this._emulationModel=e,this._onModelAvailable){const e=this._onModelAvailable;this._onModelAvailable=null,e()}const t=e.target().model(SDK.ResourceTreeModel.ResourceTreeModel);t&&(t.addEventListener(SDK.ResourceTreeModel.Events.FrameResized,this._onFrameChange,this),t.addEventListener(SDK.ResourceTreeModel.Events.FrameNavigated,this._onFrameChange,this))}else e.emulateTouch(this._touchEnabled,this._touchMobile)}modelRemoved(e){this._emulationModel===e&&(this._emulationModel=null)}inspectedURL(){return this._emulationModel?this._emulationModel.target().inspectedURL():null}_onFrameChange(){const e=this._emulationModel?this._emulationModel.overlayModel():null;e&&this._showHingeIfApplicable(e)}_scaleSettingChanged(){this._calculateAndEmulate(!1)}_widthSettingChanged(){this._calculateAndEmulate(!1)}_heightSettingChanged(){this._calculateAndEmulate(!1)}_uaSettingChanged(){this._calculateAndEmulate(!0)}_deviceScaleFactorSettingChanged(){this._calculateAndEmulate(!1)}_deviceOutlineSettingChanged(){this._calculateAndEmulate(!1)}_preferredScaledWidth(){return Math.floor(this._preferredSize.width/(this._scaleSetting.get()||1))}_preferredScaledHeight(){return Math.floor(this._preferredSize.height/(this._scaleSetting.get()||1))}_currentOutline(){let e=new UI.Geometry.Insets(0,0,0,0);if(this._type!==Type.Device)return e;const t=this._device.orientationByName(this._mode.orientation);return this._deviceOutlineSetting.get()&&(e=t.outlineInsets||e),e}_currentInsets(){return this._type!==Type.Device?new UI.Geometry.Insets(0,0,0,0):this._mode.insets}_getScreenOrientationType(){switch(console.assert(this._mode,"Can only get display feature orientation when current mode is set."),this._mode.orientation){case VerticalSpanned:case Vertical:return Protocol.Emulation.ScreenOrientationType.PortraitPrimary;case HorizontalSpanned:case Horizontal:default:return Protocol.Emulation.ScreenOrientationType.LandscapePrimary}}_calculateAndEmulate(e){this._emulationModel||(this._onModelAvailable=this._calculateAndEmulate.bind(this,e));const t=this._isMobile(),i=this._emulationModel?this._emulationModel.overlayModel():null;if(i&&this._showHingeIfApplicable(i),this._type===Type.Device){const i=this._device.orientationByName(this._mode.orientation),n=this._currentOutline(),a=this._currentInsets();this._fitScale=this._calculateFitScale(i.width,i.height,n,a),this._appliedUserAgentType=t?this._device.touch()?UA.Mobile:UA.MobileNoTouch:this._device.touch()?UA.DesktopTouch:UA.Desktop,this._applyDeviceMetrics(new UI.Geometry.Size(i.width,i.height),a,n,this._scaleSetting.get(),this._device.deviceScaleFactor,t,this._getScreenOrientationType(),e,this._webPlatformExperimentalFeaturesEnabled),this._applyUserAgent(this._device.userAgent,this._device.userAgentMetadata),this._applyTouch(this._device.touch(),t)}else if(this._type===Type.None)this._fitScale=this._calculateFitScale(this._availableSize.width,this._availableSize.height),this._appliedUserAgentType=UA.Desktop,this._applyDeviceMetrics(this._availableSize,new UI.Geometry.Insets(0,0,0,0),new UI.Geometry.Insets(0,0,0,0),1,0,t,null,e),this._applyUserAgent("",null),this._applyTouch(!1,!1);else if(this._type===Type.Responsive){let i=this._widthSetting.get();(!i||i>this._preferredScaledWidth())&&(i=this._preferredScaledWidth());let n=this._heightSetting.get();(!n||n>this._preferredScaledHeight())&&(n=this._preferredScaledHeight());const a=t?defaultMobileScaleFactor:0;this._fitScale=this._calculateFitScale(this._widthSetting.get(),this._heightSetting.get()),this._appliedUserAgentType=this._uaSetting.get(),this._applyDeviceMetrics(new UI.Geometry.Size(i,n),new UI.Geometry.Insets(0,0,0,0),new UI.Geometry.Insets(0,0,0,0),this._scaleSetting.get(),this._deviceScaleFactorSetting.get()||a,t,n>=i?Protocol.Emulation.ScreenOrientationType.PortraitPrimary:Protocol.Emulation.ScreenOrientationType.LandscapePrimary,e),this._applyUserAgent(t?_defaultMobileUserAgent:"",t?_defaultMobileUserAgentMetadata:null),this._applyTouch(this._uaSetting.get()===UA.DesktopTouch||this._uaSetting.get()===UA.Mobile,this._uaSetting.get()===UA.Mobile)}i&&i.setShowViewportSizeOnResize(this._type===Type.None),this.dispatchEventToListeners(Events.Updated)}_calculateFitScale(e,t,i,n){const a=i?i.left+i.right:0,s=i?i.top+i.bottom:0,o=n?n.left+n.right:0,l=n?n.top+n.bottom:0;let r=Math.min(e?this._preferredSize.width/(e+a):1,t?this._preferredSize.height/(t+s):1);r=Math.min(Math.floor(100*r),100);let h=r;for(;h>.7*r;){let i=!0;if(e&&(i=i&&Number.isInteger((e-o)*h/100)),t&&(i=i&&Number.isInteger((t-l)*h/100)),i)return h/100;h-=1}return r/100}setSizeAndScaleToFit(e,t){this._scaleSetting.set(this._calculateFitScale(e,t)),this.setWidth(e),this.setHeight(t)}_applyUserAgent(e,t){SDK.NetworkManager.MultitargetNetworkManager.instance().setUserAgentOverride(e,t)}_applyDeviceMetrics(e,t,i,n,a,s,o,l,r=!1){e.width=Math.max(1,Math.floor(e.width)),e.height=Math.max(1,Math.floor(e.height));let h=e.width-t.left-t.right,c=e.height-t.top-t.bottom;this._emulatedPageSize=new UI.Geometry.Size(h,c);const d=t.left,u=t.top,g=o===Protocol.Emulation.ScreenOrientationType.LandscapePrimary?90:0;if(this._appliedDeviceSize=e,this._appliedDeviceScaleFactor=a||window.devicePixelRatio,this._screenRect=new UI.Geometry.Rect(Math.max(0,(this._availableSize.width-e.width*n)/2),i.top*n,e.width*n,e.height*n),this._outlineRect=new UI.Geometry.Rect(this._screenRect.left-i.left*n,0,(i.left+e.width+i.right)*n,(i.top+e.height+i.bottom)*n),this._visiblePageRect=new UI.Geometry.Rect(d*n,u*n,Math.min(h*n,this._availableSize.width-this._screenRect.left-d*n),Math.min(c*n,this._availableSize.height-this._screenRect.top-u*n)),this._scale=n,r||(1===n&&this._availableSize.width>=e.width&&this._availableSize.height>=e.height&&(h=0,c=0),this._visiblePageRect.width===h*n&&this._visiblePageRect.height===c*n&&Number.isInteger(h*n)&&Number.isInteger(c*n)&&(h=0,c=0)),this._emulationModel)if(l&&this._emulationModel.resetPageScaleFactor(),h||c||s||a||1!==n||o||r){const t={width:h,height:c,deviceScaleFactor:a,mobile:s,scale:n,screenWidth:e.width,screenHeight:e.height,positionX:d,positionY:u,dontSetVisibleSize:!0},i=this._getDisplayFeature();i&&(t.displayFeature=i),o&&(t.screenOrientation={type:o,angle:g}),this._emulationModel.emulateDevice(t)}else this._emulationModel.emulateDevice(null)}exitHingeMode(){const e=this._emulationModel?this._emulationModel.overlayModel():null;e&&e.showHingeForDualScreen(!1)}webPlatformExperimentalFeaturesEnabled(){return this._webPlatformExperimentalFeaturesEnabled}shouldReportDisplayFeature(){return this._webPlatformExperimentalFeaturesEnabled&&this._experimentDualScreenSupport}async captureScreenshot(e,t){const i=this._emulationModel?this._emulationModel.target().model(SDK.ScreenCaptureModel.ScreenCaptureModel):null;if(!i)return null;const n=this._emulationModel?this._emulationModel.overlayModel():null;let a;if(n&&n.setShowViewportSizeOnResize(!1),e){const e=await i.fetchLayoutMetrics();if(!e)return null;const n=Math.min(16384/this._appliedDeviceScaleFactor,e.contentHeight);a={width:Math.floor(e.contentWidth),height:Math.floor(n),deviceScaleFactor:this._appliedDeviceScaleFactor,mobile:this._isMobile()};const s=this._getDisplayFeature();if(s&&(a.displayFeature=s),t={x:0,y:0,width:a.width,height:a.height,scale:1},this._device){const e=this._mode.orientation===Horizontal?Protocol.Emulation.ScreenOrientationType.LandscapePrimary:Protocol.Emulation.ScreenOrientationType.PortraitPrimary,t=e===Protocol.Emulation.ScreenOrientationType.LandscapePrimary?90:0;a.screenOrientation={type:e,angle:t}}await this._emulationModel.resetPageScaleFactor(),await this._emulationModel.emulateDevice(a)}const s=await i.captureScreenshot("png",100,t);if(e){if(this._device){const e=this._device.orientationByName(this._mode.orientation);a.width=e.width,a.height=e.height;const t=this._getDisplayFeature();t&&(a.displayFeature=t)}else a.width=0,a.height=0;await this._emulationModel.emulateDevice(a)}return this._calculateAndEmulate(!1),s}_applyTouch(e,t){this._touchEnabled=e,this._touchMobile=t;for(const i of SDK.SDKModel.TargetManager.instance().models(SDK.EmulationModel.EmulationModel))i.emulateTouch(e,t)}_showHingeIfApplicable(e){const t=this._device&&this._mode?this._device.orientationByName(this._mode.orientation):null;this._experimentDualScreenSupport&&t&&t.hinge?e.showHingeForDualScreen(!0,t.hinge):e.showHingeForDualScreen(!1)}_getDisplayFeatureOrientation(){switch(console.assert(this._mode,"Can only get display feature orientation when current mode is set."),this._mode.orientation){case VerticalSpanned:case Vertical:return Protocol.Emulation.DisplayFeatureOrientation.Vertical;case HorizontalSpanned:case Horizontal:default:return Protocol.Emulation.DisplayFeatureOrientation.Horizontal}}_getDisplayFeature(){if(!this.shouldReportDisplayFeature())return null;if(!this._device||!this._mode||this._mode.orientation!==VerticalSpanned&&this._mode.orientation!==HorizontalSpanned)return null;const e=this._device.orientationByName(this._mode.orientation);if(!e||!e.hinge)return null;const t=e.hinge;return{orientation:this._getDisplayFeatureOrientation(),offset:this._mode.orientation===VerticalSpanned?t.x:t.y,maskLength:this._mode.orientation===VerticalSpanned?t.width:t.height}}}export const Events={Updated:"Updated"};export const Type={None:"None",Responsive:"Responsive",Device:"Device"};export const UA={Mobile:Common.UIString.UIString("Mobile"),MobileNoTouch:Common.UIString.UIString("Mobile (no touch)"),Desktop:Common.UIString.UIString("Desktop"),DesktopTouch:Common.UIString.UIString("Desktop (touch)")};export const MinDeviceSize=50;export const MaxDeviceSize=9999;export const MinDeviceScaleFactor=0;export const MaxDeviceScaleFactor=10;export const MaxDeviceNameLength=50;const _mobileUserAgent="Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/%s Mobile Safari/537.36";export const _defaultMobileUserAgent=SDK.NetworkManager.MultitargetNetworkManager.patchUserAgentWithChromeVersion(_mobileUserAgent);export const _defaultMobileUserAgentMetadata={brands:SDK.NetworkManager.MultitargetNetworkManager.getChromeBrands(),fullVersion:SDK.NetworkManager.MultitargetNetworkManager.getChromeVersion(),platform:"Android",platformVersion:"6.0",architecture:"",model:"Nexus 5",mobile:!0};export const defaultMobileScaleFactor=2;