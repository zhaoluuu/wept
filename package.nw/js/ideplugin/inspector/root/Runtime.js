import"../wx_main/wx_main.js";const REMOTE_MODULE_FALLBACK_REVISION="@9c7912d3335c02d62f63be2749d84b2d0b788982",instanceSymbol=Symbol("instance"),originalConsole=console,originalAssert=console.assert,queryParamsObject=new URLSearchParams(location.search);let remoteBase,importScriptPathPrefix,runtimePlatform="",l10nCallback,runtimeInstance;export class Runtime{constructor(e){this._modules=[],this._modulesMap={},this._extensions=[],this._cachedTypeClasses={},this._descriptorsMap={};for(let t=0;t<e.length;++t)this._registerModule(e[t])}static instance(e={forceNew:null,moduleDescriptors:null}){const{forceNew:t,moduleDescriptors:s}=e;if(!s||t){if(!s)throw new Error("Unable to create settings: targetManager and workspace must be provided: "+(new Error).stack);runtimeInstance=new Runtime(s)}return runtimeInstance}loadBinaryResourcePromise(e){return internalLoadResourcePromise(e,!0)}static normalizePath(e){if(-1===e.indexOf("..")&&-1===e.indexOf("."))return e;const t=[],s=e.split("/");for(let e=0;e<s.length;e++){const r=s[e];"."!==r&&(".."===r?t.pop():r&&t.push(r))}let r=t.join("/");return"/"===r[r.length-1]||("/"===e[0]&&r&&(r="/"+r),"/"!==e[e.length-1]&&"."!==s[s.length-1]&&".."!==s[s.length-1]||(r+="/")),r}static queryParam(e){return queryParamsObject.get(e)}static _experimentsSetting(){try{return JSON.parse(self.localStorage&&self.localStorage.experiments?self.localStorage.experiments:"{}")}catch(e){return console.error("Failed to parse localStorage['experiments']"),{}}}static _assert(e,t){e||originalAssert.call(originalConsole,e,t+" "+(new Error).stack)}static setPlatform(e){runtimePlatform=e}static _isDescriptorEnabled(e){const t=e.experiment;if("*"===t)return!0;if(t&&t.startsWith("!")&&experiments.isEnabled(t.substring(1)))return!1;if(t&&!t.startsWith("!")&&!experiments.isEnabled(t))return!1;const s=e.condition;return!(s&&!s.startsWith("!")&&!Runtime.queryParam(s))&&!(s&&s.startsWith("!")&&Runtime.queryParam(s.substring(1)))}static resolveSourceURL(e){let t=self.location.href;return self.location.search&&(t=t.replace(self.location.search,"")),t=t.substring(0,t.lastIndexOf("/")+1)+e,"\n/*# sourceURL="+t+" */"}static setL10nCallback(e){l10nCallback=e}useTestBase(){remoteBase="http://localhost:8000/inspector-sources/",Runtime.queryParam("debugFrontend")&&(remoteBase+="debug/")}module(e){return this._modulesMap[e]}_registerModule(e){const t=new Module(this,e);this._modules.push(t),this._modulesMap[e.name]=t}loadModulePromise(e){return this._modulesMap[e]._loadPromise()}loadAutoStartModules(e){const t=[];for(let s=0;s<e.length;++s)t.push(this.loadModulePromise(e[s]));return Promise.all(t)}_checkExtensionApplicability(e,t){if(!t)return!1;const s=e.descriptor().contextTypes;if(!s)return!0;for(let e=0;e<s.length;++e){const r=this._resolve(s[e]);if(!!r&&t(r))return!0}return!1}isExtensionApplicableToContext(e,t){return!t||this._checkExtensionApplicability(e,(function(e){return t instanceof e}))}isExtensionApplicableToContextTypes(e,t){if(!e.descriptor().contextTypes)return!0;let s=null;return t&&(s=e=>t.has(e)),this._checkExtensionApplicability(e,s)}extensions(e,t,s){return this._extensions.filter((function(s){if(s._type!==e&&s._typeClass()!==e)return!1;if(!s.enabled())return!1;return!t||s.isApplicable(t)})).sort(s?function(e,t){const s=e.title()||"",r=t.title()||"";return s.localeCompare(r)}:function(e,t){const s=e.descriptor().order||0,r=t.descriptor().order||0;return s-r})}extension(e,t){return this.extensions(e,t)[0]||null}allInstances(e,t){return Promise.all(this.extensions(e,t).map(e=>e.instance()))}_resolve(e){if(!this._cachedTypeClasses[e]){const t=e.split(".");let s=self;for(let e=0;s&&e<t.length;++e)s=s[t[e]];s&&(this._cachedTypeClasses[e]=s)}return this._cachedTypeClasses[e]||null}sharedInstance(e){if(instanceSymbol in e&&Object.getOwnPropertySymbols(e).includes(instanceSymbol))return e[instanceSymbol];const t=new e;return e[instanceSymbol]=t,t}}export class ModuleDescriptor{constructor(){this.name,this.extensions,this.dependencies,this.scripts,this.modules,this.resources,this.condition,this.remote,this.experiment}}export class RuntimeExtensionDescriptor{constructor(){this.type,this.className,this.factoryName,this.contextTypes,this.bindings,this.order,this.extension,this.actionId,this.experiment,this.condition,this.settingName,this.settingType,this.defaultValue,this.storageType,this.userActionCondition,this.startPage,this.name}}const specialCases={sdk:"SDK",js_sdk:"JSSDK",browser_sdk:"BrowserSDK",ui:"UI",object_ui:"ObjectUI",javascript_metadata:"JavaScriptMetadata",perf_ui:"PerfUI",har_importer:"HARImporter",sdk_test_runner:"SDKTestRunner",cpu_profiler_test_runner:"CPUProfilerTestRunner"};export class Module{constructor(e,t){this._manager=e,this._descriptor=t,this._name=t.name,this._extensions=[],this._extensionsByClassName=new Map;const s=t.extensions;for(let e=0;s&&e<s.length;++e){const t=new Extension(this,s[e]);this._manager._extensions.push(t),this._extensions.push(t)}this._loadedForTest=!1}name(){return this._name}enabled(){return Runtime._isDescriptorEnabled(this._descriptor)}resource(e){const t=this._name+"/"+e,s=self.Runtime.cachedResources[t];if(!s)throw new Error(t+" not preloaded. Check module.json");return s}_loadPromise(){if(!this.enabled())return Promise.reject(new Error("Module "+this._name+" is not enabled"));if(this._pendingLoadPromise)return this._pendingLoadPromise;const e=this._descriptor.dependencies,t=[];for(let s=0;e&&s<e.length;++s)t.push(this._manager._modulesMap[e[s]]._loadPromise());return this._pendingLoadPromise=Promise.all(t).then(this._loadResources.bind(this)).then(this._loadModules.bind(this)).then(this._loadScripts.bind(this)).then(()=>(this._loadedForTest=!0,this._loadedForTest)),this._pendingLoadPromise}_loadResources(){const e=this._descriptor.resources;if(!e||!e.length)return Promise.resolve();const t=[];for(const s of e){const e=this._modularizeURL(s),r=!(e.endsWith(".html")||e.endsWith(".md"));t.push(loadResourceIntoCache(e,r))}return Promise.all(t).then(void 0)}_loadModules(){if(!this._descriptor.modules||!this._descriptor.modules.length)return Promise.resolve();const namespace=this._computeNamespace();self[namespace]=self[namespace]||{};const legacyFileName=this._name+"-legacy.js",fileName=this._descriptor.modules.includes(legacyFileName)?legacyFileName:this._name+".js";return eval(`import('../${this._name}/${fileName}')`)}_loadScripts(){if(!this._descriptor.scripts||!this._descriptor.scripts.length)return Promise.resolve();const e=this._computeNamespace();return self[e]=self[e]||{},loadScriptsPromise(this._descriptor.scripts.map(this._modularizeURL,this),this._remoteBase())}_computeNamespace(){return specialCases[this._name]||this._name.split("_").map(e=>e.substring(0,1).toUpperCase()+e.substring(1)).join("")}_modularizeURL(e){return Runtime.normalizePath(this._name+"/"+e)}_remoteBase(){return!Runtime.queryParam("debugFrontend")&&this._descriptor.remote&&remoteBase||void 0}fetchResource(e){const t=this._remoteBase(),s=getResourceURL(this._modularizeURL(e),t);return t?loadResourcePromiseWithFallback(s):loadResourcePromise(s)}substituteURL(e){const t=this._remoteBase()||"";return e.replace(/@url\(([^\)]*?)\)/g,function(e,s){return t+this._modularizeURL(s)}.bind(this))}}export class Extension{constructor(e,t){this._module=e,this._descriptor=t,this._type=t.type,this._hasTypeClass="@"===this._type.charAt(0),this._className=t.className||null,this._factoryName=t.factoryName||null}descriptor(){return this._descriptor}module(){return this._module}enabled(){return this._module.enabled()&&Runtime._isDescriptorEnabled(this.descriptor())}_typeClass(){return this._hasTypeClass?this._module._manager._resolve(this._type.substring(1)):null}isApplicable(e){return this._module._manager.isExtensionApplicableToContext(this,e)}instance(){return this._module._loadPromise().then(this._createInstance.bind(this))}canInstantiate(){return!(!this._className&&!this._factoryName)}_createInstance(){const e=this._className||this._factoryName;if(!e)throw new Error("Could not instantiate extension with no class");const t=self.eval(e);if(!(t instanceof Function))throw new Error("Could not instantiate: "+e);return this._className?this._module._manager.sharedInstance(t):new t(this)}title(){const e=this._descriptor["title-"+runtimePlatform]||this._descriptor.title;return e&&l10nCallback?l10nCallback(e):e}hasContextType(e){const t=this.descriptor().contextTypes;if(!t)return!1;for(let s=0;s<t.length;++s)if(e===this._module._manager._resolve(t[s]))return!0;return!1}}export class ExperimentsSupport{constructor(){this._experiments=[],this._experimentNames={},this._enabledTransiently={},this._serverEnabled=new Set}allConfigurableExperiments(){const e=[];for(let t=0;t<this._experiments.length;t++){const s=this._experiments[t];this._enabledTransiently[s.name]||e.push(s)}return e}enabledExperiments(){return this._experiments.filter(e=>e.isEnabled())}_setExperimentsSetting(e){self.localStorage&&(self.localStorage.experiments=JSON.stringify(e))}register(e,t,s){Runtime._assert(!this._experimentNames[e],"Duplicate registration of experiment "+e),this._experimentNames[e]=!0,this._experiments.push(new Experiment(this,e,t,!!s))}isEnabled(e){return this._checkExperiment(e),!1!==Runtime._experimentsSetting()[e]&&(!!this._enabledTransiently[e]||(!!this._serverEnabled.has(e)||!!Runtime._experimentsSetting()[e]))}setEnabled(e,t){this._checkExperiment(e);const s=Runtime._experimentsSetting();s[e]=t,this._setExperimentsSetting(s)}setDefaultExperiments(e){for(let t=0;t<e.length;++t)this._checkExperiment(e[t]),this._enabledTransiently[e[t]]=!0}setServerEnabledExperiments(e){for(const t of e)this._checkExperiment(t),this._serverEnabled.add(t)}enableForTest(e){this._checkExperiment(e),this._enabledTransiently[e]=!0}clearForTest(){this._experiments=[],this._experimentNames={},this._enabledTransiently={},this._serverEnabled.clear()}cleanUpStaleExperiments(){const e=Runtime._experimentsSetting(),t={};for(let s=0;s<this._experiments.length;++s){const r=this._experiments[s].name;e[r]&&(t[r]=!0)}this._setExperimentsSetting(t)}_checkExperiment(e){Runtime._assert(this._experimentNames[e],"Unknown experiment "+e)}}class Experiment{constructor(e,t,s,r){this.name=t,this.title=s,this.unstable=r,this._experiments=e}isEnabled(){return this._experiments.isEnabled(this.name)}setEnabled(e){this._experiments.setEnabled(this.name,e)}}function internalLoadResourcePromise(e,t){return new Promise((function(s,r){const n=new XMLHttpRequest;n.open("GET",e,!0),t&&(n.responseType="arraybuffer");n.onreadystatechange=function(i){if(n.readyState!==XMLHttpRequest.DONE)return;const{response:o}=i.target,a=t?(new TextDecoder).decode(o):o,l=/^HTTP\/1.1 404/.test(a)?404:n.status;-1===[0,200,304].indexOf(l)?r(new Error("While loading from url "+e+" server responded with a status of "+l)):s(o)},n.send(null)}))}const loadedScripts={};function loadScriptsPromise(e,t){const s=[],r=[],n=new Array(e.length);let i=0;for(let n=0;n<e.length;++n){const i=getResourceURL(e[n],t);if(loadedScripts[i])continue;r.push(i);const a=t?loadResourcePromiseWithFallback(i):loadResourcePromise(i);s.push(a.then(o.bind(null,n),o.bind(null,n,void 0)))}return Promise.all(s).then(void 0);function o(e,t){for(n[e]=t||"";void 0!==n[i];)a(r[i],n[i]),++i}function a(e,t){loadedScripts[e]=!0,t?self.eval(t+"\n//# sourceURL="+e):console.error("Empty response arrived for script '"+e+"'")}}function loadResourcePromiseWithFallback(e){return loadResourcePromise(e).catch(t=>{const s=e.replace(/@[0-9a-f]{40}/,REMOTE_MODULE_FALLBACK_REVISION);if(s===e||!e.includes("lighthouse_worker_module"))throw t;return loadResourcePromise(s)})}function loadResourceIntoCache(e,t){return loadResourcePromise(e).then(s.bind(null,e),s.bind(null,e,void 0));function s(e,s){if(!s)return void console.error("Failed to load resource: "+e);const r=t?Runtime.resolveSourceURL(e):"";self.Runtime.cachedResources[e]=s+r}}export function loadResourcePromise(e){return internalLoadResourcePromise(e,!1)}function getResourceURL(e,t){const s=(t||importScriptPathPrefix)+e,r=s.indexOf("://")+3;let n=s.indexOf("/",r);return-1===n&&(n=s.length),s.substring(0,n)+Runtime.normalizePath(s.substring(n))}!function(){if(location.href.startsWith("devtools://devtools/bundled/")){const e=Runtime.queryParam("remoteBase");if(e){const t=/\/serve_file\/(@[0-9a-zA-Z]+)\/?$/.exec(e);t&&(remoteBase=`${location.origin}/remote/serve_file/${t[1]}/`)}}}(),function(){const e=self.location?self.location.origin+self.location.pathname:"";importScriptPathPrefix=e.substring(0,e.lastIndexOf("/")+1)}();export const experiments=new ExperimentsSupport;