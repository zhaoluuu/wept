import*as Bindings from"../bindings/bindings.js";import*as Common from"../common/common.js";import*as Platform from"../platform/platform.js";import*as SDK from"../sdk/sdk.js";import*as SourceFrame from"../source_frame/source_frame.js";import*as TextEditor from"../text_editor/text_editor.js";import*as Workspace from"../workspace/workspace.js";export class Performance{constructor(){this._helper=new Helper("performance")}reset(){this._helper.reset()}_appendLegacyCPUProfile(e){const t=e.target(),o=[e.profileHead],i=(e.profileEndTime-e.profileStartTime)/e.totalHitCount;for(;o.length;){const e=o.pop().children;for(let r=0;r<e.length;++r){const s=e[r];if(o.push(s),s.url&&s.positionTicks)for(let e=0;e<s.positionTicks.length;++e){const o=s.positionTicks[e],r=o.line,n=o.ticks*i;this._helper.addLineData(t,s.url,r,n)}}}}appendCPUProfile(e){if(!e.lines)return this._appendLegacyCPUProfile(e),void this._helper.scheduleUpdate();const t=e.target();for(let o=1;o<e.samples.length;++o){const i=e.lines[o];if(!i)continue;const r=e.nodeByIndex(o),s=r.scriptId||r.url;if(!s)continue;const n=e.timestamps[o]-e.timestamps[o-1];this._helper.addLineData(t,s,i,n)}this._helper.scheduleUpdate()}}export class Memory{constructor(){this._helper=new Helper("memory")}reset(){this._helper.reset()}appendHeapProfile(e,t){const o=this._helper;!function e(i){if(i.children.forEach(e),!i.selfSize)return;const r=Number(i.callFrame.scriptId)||i.callFrame.url;if(!r)return;const s=i.callFrame.lineNumber+1;o.addLineData(t,r,s,i.selfSize)}(e.head),o.scheduleUpdate()}}export class Helper{constructor(e){this._type=e,this._locationPool=new Bindings.LiveLocation.LiveLocationPool,this._updateTimer=null,this.reset()}reset(){this._lineData=new Map,this.scheduleUpdate()}addLineData(e,t,o,i){let r=this._lineData.get(e);r||(r=new Map,this._lineData.set(e,r));let s=r.get(t);s||(s=new Map,r.set(t,s)),s.set(o,(s.get(o)||0)+i)}scheduleUpdate(){this._updateTimer||(this._updateTimer=setTimeout(()=>{this._updateTimer=null,this._doUpdate()},0))}_doUpdate(){this._locationPool.disposeAll(),Workspace.Workspace.WorkspaceImpl.instance().uiSourceCodes().forEach(e=>e.removeDecorationsForType(this._type));for(const e of this._lineData){const t=e[0],o=t?t.model(SDK.DebuggerModel.DebuggerModel):null,i=e[1];for(const e of i){const t=e[0],i=e[1],r=o||"string"!=typeof t?null:Workspace.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(t);if(o||r)for(const e of i){const i=e[0]-1,s=e[1];if(r){r.addLineDecoration(i,this._type,s);continue}const n="string"==typeof t?o.createRawLocationByURL(t,i,0):o.createRawLocationByScriptId(String(t),i,0);n&&new Presentation(n,this._type,s,this._locationPool)}}}}}export class Presentation{constructor(e,t,o,i){this._type=t,this._time=o,this._uiLocation=null,Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().createLiveLocation(e,this.updateLocation.bind(this),i)}async updateLocation(e){this._uiLocation&&this._uiLocation.uiSourceCode.removeDecorationsForType(this._type),this._uiLocation=await e.uiLocation(),this._uiLocation&&this._uiLocation.uiSourceCode.addLineDecoration(this._uiLocation.lineNumber,this._type,this._time)}}export class LineDecorator{decorate(e,t,o){const i="CodeMirror-gutter-"+o,r=e.decorationsForType(o);if(t.uninstallGutter(i),r&&r.size){t.installGutter(i,!1);for(const e of r){const r=e.data(),s=this._createElement(o,r);t.setGutterDecoration(e.range().startLine,i,s)}}}_createElement(e,t){const o=document.createElement("div");if(o.classList.add("text-editor-line-marker-text"),"performance"===e){const e=Platform.NumberUtilities.clamp(Math.log10(1+10*t)/5,.02,1);o.textContent=Common.UIString.UIString("%.1f",t),o.style.backgroundColor=`hsla(44, 100%, 50%, ${e.toFixed(3)})`,o.createChild("span","line-marker-units").textContent=ls`ms`}else{const e=Platform.NumberUtilities.clamp(Math.log10(1+.002*t)/5,.02,1);let i,r;o.style.backgroundColor=`hsla(217, 100%, 70%, ${e.toFixed(3)})`,(t/=1e3)>=1e3?(i=ls`MB`,r=(t/=1e3)>=20?0:1):(i=ls`KB`,r=0),o.textContent=Common.UIString.UIString(`%.${r}f`,t),o.createChild("span","line-marker-units").textContent=i}return o}}