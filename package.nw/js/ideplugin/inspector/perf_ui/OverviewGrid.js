import*as Common from"../common/common.js";import*as Platform from"../platform/platform.js";import*as UI from"../ui/ui.js";import{Calculator,TimelineGrid}from"./TimelineGrid.js";export class OverviewGrid{constructor(t,e){this.element=createElement("div"),this.element.id=t+"-overview-container",this._grid=new TimelineGrid,this._grid.element.id=t+"-overview-grid",this._grid.setScrollTop(0),this.element.appendChild(this._grid.element),this._window=new Window(this.element,this._grid.dividersLabelBarElement,e)}clientWidth(){return this.element.clientWidth}updateDividers(t){this._grid.updateDividers(t)}addEventDividers(t){this._grid.addEventDividers(t)}removeEventDividers(){this._grid.removeEventDividers()}reset(){this._window.reset()}windowLeft(){return this._window.windowLeft}windowRight(){return this._window.windowRight}setWindow(t,e){this._window._setWindow(t,e)}addEventListener(t,e,i){return this._window.addEventListener(t,e,i)}setClickHandler(t){this._window.setClickHandler(t)}zoom(t,e){this._window._zoom(t,e)}setResizeEnabled(t){this._window.setEnabled(t)}}export const MinSelectableSize=14;export const WindowScrollSpeedFactor=.3;export const ResizerOffset=3.5;export const OffsetFromWindowEnds=10;export class Window extends Common.ObjectWrapper.ObjectWrapper{constructor(t,e,i){super(),this._parentElement=t,UI.ARIAUtils.markAsGroup(this._parentElement),this._calculator=i,UI.ARIAUtils.setAccessibleName(this._parentElement,ls`Overview grid window`),UI.UIUtils.installDragHandle(this._parentElement,this._startWindowSelectorDragging.bind(this),this._windowSelectorDragging.bind(this),this._endWindowSelectorDragging.bind(this),"text",null),e&&UI.UIUtils.installDragHandle(e,this._startWindowDragging.bind(this),this._windowDragging.bind(this),null,"-webkit-grabbing","-webkit-grab"),this._parentElement.addEventListener("mousewheel",this._onMouseWheel.bind(this),!0),this._parentElement.addEventListener("dblclick",this._resizeWindowMaximum.bind(this),!0),UI.Utils.appendStyle(this._parentElement,"perf_ui/overviewGrid.css"),this._leftResizeElement=t.createChild("div","overview-grid-window-resizer"),UI.UIUtils.installDragHandle(this._leftResizeElement,this._resizerElementStartDragging.bind(this),this._leftResizeElementDragging.bind(this),null,"ew-resize"),this._rightResizeElement=t.createChild("div","overview-grid-window-resizer"),UI.UIUtils.installDragHandle(this._rightResizeElement,this._resizerElementStartDragging.bind(this),this._rightResizeElementDragging.bind(this),null,"ew-resize"),UI.ARIAUtils.setAccessibleName(this._leftResizeElement,ls`Left Resizer`),UI.ARIAUtils.markAsSlider(this._leftResizeElement),this._leftResizeElement.addEventListener("keydown",t=>this._handleKeyboardResizing(t,!1)),UI.ARIAUtils.setAccessibleName(this._rightResizeElement,ls`Right Resizer`),UI.ARIAUtils.markAsSlider(this._rightResizeElement),this._rightResizeElement.addEventListener("keydown",t=>this._handleKeyboardResizing(t,!0)),this._rightResizeElement.addEventListener("focus",this._onRightResizeElementFocused.bind(this)),this._leftCurtainElement=t.createChild("div","window-curtain-left"),this._rightCurtainElement=t.createChild("div","window-curtain-right"),this.reset()}_onRightResizeElementFocused(){this._parentElement.scrollLeft=0}reset(){this.windowLeft=0,this.windowRight=1,this.setEnabled(!0),this._updateCurtains()}setEnabled(t){this._enabled=t,this._rightResizeElement.tabIndex=t?0:-1,this._leftResizeElement.tabIndex=t?0:-1}setClickHandler(t){this._clickHandler=t}_resizerElementStartDragging(t){return!!this._enabled&&(this._resizerParentOffsetLeft=t.pageX-t.offsetX-t.target.offsetLeft,t.stopPropagation(),!0)}_leftResizeElementDragging(t){this._resizeWindowLeft(t.pageX-this._resizerParentOffsetLeft),t.preventDefault()}_rightResizeElementDragging(t){this._resizeWindowRight(t.pageX-this._resizerParentOffsetLeft),t.preventDefault()}_handleKeyboardResizing(t,e){let i=!1;if("ArrowLeft"===t.key||"ArrowRight"===t.key){"ArrowRight"===t.key&&(i=!0);const s=this._getNewResizerPosition(t.target.offsetLeft,i,t.ctrlKey);e?this._resizeWindowRight(s):this._resizeWindowLeft(s),t.consume(!0)}}_getNewResizerPosition(t,e,i){let s,n=i?10:2;n=e?n:-Math.abs(n);return s=t+3.5+n,e&&s<10?s=10:!e&&s>this._parentElement.clientWidth-10&&(s=this._parentElement.clientWidth-10),s}_startWindowSelectorDragging(t){if(!this._enabled)return!1;this._offsetLeft=this._parentElement.totalOffsetLeft();const e=t.x-this._offsetLeft;return this._overviewWindowSelector=new WindowSelector(this._parentElement,e),!0}_windowSelectorDragging(t){this._overviewWindowSelector._updatePosition(t.x-this._offsetLeft),t.preventDefault()}_endWindowSelectorDragging(t){const e=this._overviewWindowSelector._close(t.x-this._offsetLeft);delete this._overviewWindowSelector;if(e.end-e.start<3){if(this._clickHandler&&this._clickHandler.call(null,t))return;const i=e.end;e.start=Math.max(0,i-7),e.end=Math.min(this._parentElement.clientWidth,i+7)}else e.end-e.start<14&&(this._parentElement.clientWidth-e.end>14?e.end=e.start+14:e.start=e.end-14);this._setWindowPosition(e.start,e.end)}_startWindowDragging(t){return this._dragStartPoint=t.pageX,this._dragStartLeft=this.windowLeft,this._dragStartRight=this.windowRight,t.stopPropagation(),!0}_windowDragging(t){t.preventDefault();let e=(t.pageX-this._dragStartPoint)/this._parentElement.clientWidth;this._dragStartLeft+e<0&&(e=-this._dragStartLeft),this._dragStartRight+e>1&&(e=1-this._dragStartRight),this._setWindow(this._dragStartLeft+e,this._dragStartRight+e)}_resizeWindowLeft(t){t<10?t=0:t>this._rightResizeElement.offsetLeft-4&&(t=this._rightResizeElement.offsetLeft-4),this._setWindowPosition(t,null)}_resizeWindowRight(t){t>this._parentElement.clientWidth-10?t=this._parentElement.clientWidth:t<this._leftResizeElement.offsetLeft+14&&(t=this._leftResizeElement.offsetLeft+14),this._setWindowPosition(null,t)}_resizeWindowMaximum(){this._setWindowPosition(0,this._parentElement.clientWidth)}_getRawSliderValue(t){const e=this._calculator.minimumBoundary(),i=this._calculator.maximumBoundary()-e;return t?e+i*this.windowLeft:e+i*this.windowRight}_updateResizeElementPositionValue(t,e){const i=t.toFixed(2),s=e.toFixed(2);UI.ARIAUtils.setAriaValueNow(this._leftResizeElement,i),UI.ARIAUtils.setAriaValueNow(this._rightResizeElement,s);const n=s-.5,r=Number(i)+.5;UI.ARIAUtils.setAriaValueMinMax(this._leftResizeElement,"0",n.toString()),UI.ARIAUtils.setAriaValueMinMax(this._rightResizeElement,r.toString(),"100")}_updateResizeElementPositionLabels(){const t=this._calculator.formatValue(this._getRawSliderValue(!0)),e=this._calculator.formatValue(this._getRawSliderValue(!1));UI.ARIAUtils.setAriaValueText(this._leftResizeElement,String(t)),UI.ARIAUtils.setAriaValueText(this._rightResizeElement,String(e))}_updateResizeElementPercentageLabels(t,e){UI.ARIAUtils.setAriaValueText(this._leftResizeElement,t),UI.ARIAUtils.setAriaValueText(this._rightResizeElement,e)}_calculateWindowPosition(){return{rawStartValue:Number(this._getRawSliderValue(!0)),rawEndValue:Number(this._getRawSliderValue(!1))}}_setWindow(t,e){let i;this.windowLeft=t,this.windowRight=e,this._updateCurtains(),this._calculator&&(i=this._calculateWindowPosition()),this.dispatchEventToListeners(Events.WindowChanged,i)}_updateCurtains(){let t=this.windowLeft,e=this.windowRight;const i=e-t;if(0!==this._parentElement.clientWidth){const s=i*this._parentElement.clientWidth,n=7;if(s<n){const r=n/s;t=(this.windowRight+this.windowLeft-i*r)/2,e=(this.windowRight+this.windowLeft+i*r)/2}}const s=100*t,n=100*e,r=100-100*e,l=s+"%",o=n+"%";this._leftResizeElement.style.left=l,this._rightResizeElement.style.left=o,this._leftCurtainElement.style.width=l,this._rightCurtainElement.style.width=r+"%",this._updateResizeElementPositionValue(s,n),this._calculator?this._updateResizeElementPositionLabels():this._updateResizeElementPercentageLabels(l,o)}_setWindowPosition(t,e){const i=this._parentElement.clientWidth,s="number"==typeof t?t/i:this.windowLeft,n="number"==typeof e?e/i:this.windowRight;this._setWindow(s,n)}_onMouseWheel(t){if(this._enabled){if("number"==typeof t.wheelDeltaY&&t.wheelDeltaY){const e=1.1,i=1/120,s=t.offsetX/t.target.clientWidth;this._zoom(Math.pow(e,-t.wheelDeltaY*i),s)}if("number"==typeof t.wheelDeltaX&&t.wheelDeltaX){let e=Math.round(.3*t.wheelDeltaX);const i=this._leftResizeElement.offsetLeft+3.5,s=this._rightResizeElement.offsetLeft+3.5;i-e<0&&(e=i),s-e>this._parentElement.clientWidth&&(e=s-this._parentElement.clientWidth),this._setWindowPosition(i-e,s-e),t.preventDefault()}}}_zoom(t,e){let i=this.windowLeft,s=this.windowRight;const n=s-i;let r=t*n;r>1&&(r=1,t=r/n),i=e+(i-e)*t,i=Platform.NumberUtilities.clamp(i,0,1-r),s=e+(s-e)*t,s=Platform.NumberUtilities.clamp(s,r,1),this._setWindow(i,s)}}export const Events={WindowChanged:Symbol("WindowChanged")};export class WindowSelector{constructor(t,e){this._startPosition=e,this._width=t.offsetWidth,this._windowSelector=createElement("div"),this._windowSelector.className="overview-grid-window-selector",this._windowSelector.style.left=this._startPosition+"px",this._windowSelector.style.right=this._width-this._startPosition+"px",t.appendChild(this._windowSelector)}_close(t){return t=Math.max(0,Math.min(t,this._width)),this._windowSelector.remove(),this._startPosition<t?{start:this._startPosition,end:t}:{start:t,end:this._startPosition}}_updatePosition(t){(t=Math.max(0,Math.min(t,this._width)))<this._startPosition?(this._windowSelector.style.left=t+"px",this._windowSelector.style.right=this._width-this._startPosition+"px"):(this._windowSelector.style.left=this._startPosition+"px",this._windowSelector.style.right=this._width-t+"px")}}