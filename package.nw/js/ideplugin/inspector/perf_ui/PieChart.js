import*as UI from"../ui/ui.js";export class PieChart{constructor(t){const{size:e,formatter:s,showLegend:i,chartName:l}=t;this._sliceToLegendItem=new Map,this.element=createElement("div"),this._shadowRoot=UI.Utils.createShadowRootWithCoreStyles(this.element,"perf_ui/pieChart.css");const h=this._shadowRoot.createChild("div","root");UI.ARIAUtils.markAsGroup(h),UI.ARIAUtils.setAccessibleName(h,l),this._chartRoot=h.createChild("div","chart-root");const n=this._createSVGChild(this._chartRoot,"svg");this._group=this._createSVGChild(n,"g"),this._innerR=.618;const c=1/e;let a=this._createSVGChild(this._group,"circle");a.setAttribute("r",1),a.setAttribute("stroke","hsl(0, 0%, 80%)"),a.setAttribute("fill","transparent"),a.setAttribute("stroke-width",c),a=this._createSVGChild(this._group,"circle"),a.setAttribute("r",this._innerR),a.setAttribute("stroke","hsl(0, 0%, 80%)"),a.setAttribute("fill","transparent"),a.setAttribute("stroke-width",c),this._foregroundElement=this._chartRoot.createChild("div","pie-chart-foreground"),this._totalElement=this._foregroundElement.createChild("div","pie-chart-total"),this._totalElementClickHandler=this._focusClickedElement.bind(this,this._totalElement),this._totalElement.addEventListener("click",this._totalElementClickHandler),this._formatter=s,this._slices=[],this._lastAngle=-Math.PI/2,i&&(this._legend=h.createChild("div","pie-chart-legend")),this._setSize(e),h.addEventListener("keydown",this._onKeyDown.bind(this))}initializeWithTotal(t){for(let t=0;t<this._slices.length;++t)this._slices[t].remove();let e;this._slices=[],this._totalValue=t,this._lastAngle=-Math.PI/2,e=t?this._formatter?this._formatter(t):t:"",this._totalElement.textContent=e;const s=ls`Total`;if(this._legend){this._legend.removeChildren(),this._sliceToLegendItem.clear();const e=this._addLegendItem(t,this._totalElementClickHandler,s);this._sliceToLegendItem.set(this._totalElement,e)}this._setSelectedElement(this._totalElement),UI.ARIAUtils.setAccessibleName(this._totalElement,s)}_setSize(t){this._group.setAttribute("transform","scale("+t/2+") translate(1, 1) scale(0.99, 0.99)");const e=t+"px";this._chartRoot.style.width=e,this._chartRoot.style.height=e}addSlice(t,e,s){let i=t/this._totalValue*2*Math.PI;if(!isFinite(i))return;i=Math.min(i,2*Math.PI*.9999);const l=this._createSVGChild(this._group,"path");l.classList.add("slice"),l.tabIndex=-1;const h=Math.cos(this._lastAngle),n=Math.sin(this._lastAngle);this._lastAngle+=i;const c=Math.cos(this._lastAngle),a=Math.sin(this._lastAngle),o=this._innerR,r=c*o,d=a*o,_=h*o,m=n*o,g=i>Math.PI?1:0;l.setAttribute("d",`M${h},${n} A1,1,0,${g},1,${c},${a} L${r},${d} A${o},${o},0,${g},0,${_},${m} Z`),l.setAttribute("fill",e),this._slices.push(l);const u=this._focusClickedElement.bind(this,l);if(l.addEventListener("click",u),this._legend){const i=this._addLegendItem(t,u,s,e);this._sliceToLegendItem.set(l,i)}s&&UI.ARIAUtils.setAccessibleName(l,s)}_createSVGChild(t,e){const s=t.ownerDocument.createElementNS("http://www.w3.org/2000/svg",e);return t.appendChild(s),s}_addLegendItem(t,e,s,i){const l=this._legend.ownerDocument.createElement("div");l.addEventListener("click",e),l.className="pie-chart-legend-row",this._legend.childElementCount?(this._legend.insertBefore(l,this._legend.lastElementChild),l.tabIndex=-1):(l.tabIndex=0,this._legend.appendChild(l));const h=l.createChild("div","pie-chart-size"),n=l.createChild("div","pie-chart-swatch"),c=l.createChild("div","pie-chart-name");i?n.style.backgroundColor=i:n.classList.add("pie-chart-empty-swatch"),c.textContent=s;const a=this._formatter?this._formatter(t):t;return h.textContent=a,l}_onKeyDown(t){let e=!1;"ArrowDown"===t.key?(this._focusNextElement(),e=!0):"ArrowUp"===t.key&&(this._focusPreviousElement(),e=!0),e&&t.consume(!0)}_focusClickedElement(t){this._setSelectedElement(t)}_setSelectedElement(t){if(this._activeElement){this._legend||(this._activeElement.tabIndex=-1),this._activeElement.classList.remove("selected");const t=this._sliceToLegendItem.get(this._activeElement);t&&(t.classList.remove("selected"),t.tabIndex=-1)}this._activeElement=t,this._legend||(this._activeElement.tabIndex=1),this._activeElement.classList.add("selected");const e=this._sliceToLegendItem.get(this._activeElement);e&&(e.classList.add("selected"),e.tabIndex=0),this._activeElement.classList.contains("slice")&&this._group.appendChild(this._activeElement)}_focusNextElement(){let t=null;const e=this._slices.length-1,s=this._slices.indexOf(this._activeElement);s===e?t=this._totalElement:s>=0?t=this._slices[s+1]:this._activeElement===this._totalElement&&(t=this._slices[0]),t&&(this._setSelectedElement(t),this._legend?this._sliceToLegendItem.get(t).focus():t.focus())}_focusPreviousElement(){let t=null;const e=this._slices.length-1,s=this._slices.indexOf(this._activeElement);this._activeElement===this._totalElement?t=this._slices[e]:s>0?t=this._slices[s-1]:0===s&&(t=this._totalElement),t&&(this._setSelectedElement(t),this._legend?this._sliceToLegendItem.get(t).focus():t.focus())}}export let PieChartOptions;