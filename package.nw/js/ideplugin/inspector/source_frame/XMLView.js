import*as Common from"../common/common.js";import*as Platform from"../platform/platform.js";import*as TextUtils from"../text_utils/text_utils.js";import*as UI from"../ui/ui.js";export class XMLView extends UI.Widget.Widget{constructor(e){super(!0),this.registerRequiredCSS("source_frame/xmlView.css"),this.contentElement.classList.add("shadow-xml-view","source-code"),this._treeOutline=new UI.TreeOutline.TreeOutlineInShadow,this._treeOutline.registerRequiredCSS("source_frame/xmlTree.css"),this.contentElement.appendChild(this._treeOutline.element),this._searchableView,this._currentSearchFocusIndex=0,this._currentSearchTreeElements=[],this._searchConfig,XMLViewNode.populate(this._treeOutline,e,this),this._treeOutline.firstChild().select(!0,!1)}static createSearchableView(e){const t=new XMLView(e),s=new UI.SearchableView.SearchableView(t);return s.setPlaceholder(Common.UIString.UIString("Find")),t._searchableView=s,t.show(s.element),s}static parseXML(e,t){let s;try{s=(new DOMParser).parseFromString(e,t)}catch(e){return null}return s.body?null:s}_jumpToMatch(e,t){if(!this._searchConfig)return;const s=this._searchConfig.toSearchRegex(!0),i=this._currentSearchTreeElements[this._currentSearchFocusIndex];i&&i.setSearchRegex(s);const r=this._currentSearchTreeElements[e];r?(this._updateSearchIndex(e),t&&r.reveal(!0),r.setSearchRegex(s,UI.UIUtils.highlightedCurrentSearchResultClassName)):this._updateSearchIndex(0)}_updateSearchCount(e){this._searchableView&&this._searchableView.updateSearchMatchesCount(e)}_updateSearchIndex(e){this._currentSearchFocusIndex=e,this._searchableView&&this._searchableView.updateCurrentMatchIndex(e)}_innerPerformSearch(e,t){if(!this._searchConfig)return;let s=this._currentSearchFocusIndex;const i=this._currentSearchTreeElements[s];this._innerSearchCanceled(),this._currentSearchTreeElements=[];const r=this._searchConfig.toSearchRegex(!0);for(let e=this._treeOutline.rootElement();e;e=e.traverseNextTreeElement(!1)){if(!(e instanceof XMLViewNode))continue;const h=e.setSearchRegex(r);if(h&&this._currentSearchTreeElements.push(e),i===e){const e=this._currentSearchTreeElements.length-1;s=h||t?e:e+1}}this._updateSearchCount(this._currentSearchTreeElements.length),this._currentSearchTreeElements.length?(s=Platform.NumberUtilities.mod(s,this._currentSearchTreeElements.length),this._jumpToMatch(s,e)):this._updateSearchIndex(0)}_innerSearchCanceled(){for(let e=this._treeOutline.rootElement();e;e=e.traverseNextTreeElement(!1))e instanceof XMLViewNode&&e.revertHighlightChanges();this._updateSearchCount(0),this._updateSearchIndex(0)}searchCanceled(){this._searchConfig=null,this._currentSearchTreeElements=[],this._innerSearchCanceled()}performSearch(e,t,s){this._searchConfig=e,this._innerPerformSearch(t,s)}jumpToNextSearchResult(){if(!this._currentSearchTreeElements.length)return;const e=Platform.NumberUtilities.mod(this._currentSearchFocusIndex+1,this._currentSearchTreeElements.length);this._jumpToMatch(e,!0)}jumpToPreviousSearchResult(){if(!this._currentSearchTreeElements.length)return;const e=Platform.NumberUtilities.mod(this._currentSearchFocusIndex-1,this._currentSearchTreeElements.length);this._jumpToMatch(e,!0)}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!0}}export class XMLViewNode extends UI.TreeOutline.TreeElement{constructor(e,t,s){super("",!t&&!!e.childElementCount),this._node=e,this._closeTag=t,this.selectable=!0,this._highlightChanges=[],this._xmlView=s,this._updateTitle()}static populate(e,t,s){let i=t.firstChild;for(;i;){const t=i;i=i.nextSibling;const r=t.nodeType;3===r&&t.nodeValue.match(/\s+/)||(1!==r&&3!==r&&4!==r&&7!==r&&8!==r||e.appendChild(new XMLViewNode(t,!1,s)))}}setSearchRegex(e,t){if(this.revertHighlightChanges(),!e)return!1;if(this._closeTag&&this.parent&&!this.parent.expanded)return!1;e.lastIndex=0;let s=UI.UIUtils.highlightedSearchResultClassName;t&&(s+=" "+t);const i=this.listItemElement.textContent.replace(/\xA0/g," ");let r=e.exec(i);const h=[];for(;r;)h.push(new TextUtils.TextRange.SourceRange(r.index,r[0].length)),r=e.exec(i);return h.length&&UI.UIUtils.highlightRangesWithStyleClass(this.listItemElement,h,s,this._highlightChanges),!!this._highlightChanges.length}revertHighlightChanges(){UI.UIUtils.revertDomChanges(this._highlightChanges),this._highlightChanges=[]}_updateTitle(){const e=this._node;switch(e.nodeType){case 1:{const t=e.tagName;if(this._closeTag)return void this._setTitle(["</"+t+">","shadow-xml-view-tag"]);const s=["<"+t,"shadow-xml-view-tag"],i=e.attributes;for(let e=0;e<i.length;++e){const t=i.item(e);s.push(" ","shadow-xml-view-tag",t.name,"shadow-xml-view-attribute-name",'="',"shadow-xml-view-tag",t.value,"shadow-xml-view-attribute-value",'"',"shadow-xml-view-tag")}return this.expanded||(e.childElementCount?s.push(">","shadow-xml-view-tag","…","shadow-xml-view-comment","</"+t,"shadow-xml-view-tag"):this._node.textContent?s.push(">","shadow-xml-view-tag",e.textContent,"shadow-xml-view-text","</"+t,"shadow-xml-view-tag"):s.push(" /","shadow-xml-view-tag")),s.push(">","shadow-xml-view-tag"),void this._setTitle(s)}case 3:return void this._setTitle([e.nodeValue,"shadow-xml-view-text"]);case 4:return void this._setTitle(["<![CDATA[","shadow-xml-view-cdata",e.nodeValue,"shadow-xml-view-text","]]>","shadow-xml-view-cdata"]);case 7:return void this._setTitle(["<?"+e.nodeName+" "+e.nodeValue+"?>","shadow-xml-view-processing-instruction"]);case 8:return void this._setTitle(["\x3c!--"+e.nodeValue+"--\x3e","shadow-xml-view-comment"])}}_setTitle(e){const t=createDocumentFragment();for(let s=0;s<e.length;s+=2)t.createChild("span",e[s+1]).textContent=e[s];this.title=t,this._xmlView._innerPerformSearch(!1,!1)}onattach(){this.listItemElement.classList.toggle("shadow-xml-view-close-tag",this._closeTag)}onexpand(){this._updateTitle()}oncollapse(){this._updateTitle()}async onpopulate(){XMLViewNode.populate(this,this._node,this._xmlView),this.appendChild(new XMLViewNode(this._node,!0,this._xmlView))}}