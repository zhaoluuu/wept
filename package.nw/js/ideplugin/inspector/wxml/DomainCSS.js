import{each,trim,startWith,clone,map,cloneDeep,isNaN,contain,isUndef,css,escapeRegExp,endWith}from"../third_party/licia.js";class MatchedCSSRule{constructor(e){this._matchedCSSRule=e,this._wxcsProps={},this._matchingSelectors=[],this._selectorList={},this._origin="regular",this._cssProperties=[],this._cssText="",this._range={},this._styleSheetId="",this._shorthandEntries=[],this._process()}updateStyle(e){this._matchedCSSRule.rule.style=e,this._process()}correctEdit(e){e.range=this._matchedCSSRule.rule.style.range,e.styleSheetId=this._matchedCSSRule.rule.styleSheetId;const t=this._wxcsProps.fileinfo;t&&(e.text+="wxcs_fileinfo:"+t+";");const s=this._wxcsProps.originclass;s&&(e.text+="wxcs_originclass:"+s+";")}get(){return{matchingSelectors:this._matchingSelectors,rule:{origin:this._origin,selectorList:this._selectorList,style:{cssProperties:this._cssProperties,cssText:this._cssText,range:this._range,shorthandEntries:this._shorthandEntries,styleSheetId:this._styleSheetId},styleSheetId:this._styleSheetId}}}_process(){this._getWxcsProps(),this._getSelector(),this._getStyleSheetId(),this._getOrigin(),this._getCssProperties(),this._getShorthandEntries(),this._getCssText(),this._getRange()}_getShorthandEntries(){const e=this._matchedCSSRule.rule.style.shorthandEntries;e&&(this._shorthandEntries=e)}_getCssText(){let e="";const t=this._matchedCSSRule.rule.style.range,{startColumn:s}=t;let{startLine:n}=t;const r=this._getFileInfo();r&&(n=r.startLine);let i=s;each(this._cssProperties,t=>{if(2===Object.keys(t).length)return;const{name:s,value:r,disabled:o}=t;let l=s+":"+r+";";o&&(l=t.text),e+=l,t.range={startLine:n,startColumn:i,endLine:n,endColumn:i+l.length},o||(t.text=l),i+=l.length}),this._cssText=e}_getRange(){const e=this._matchedCSSRule.rule.style.range,{startColumn:t}=e;let{startLine:s}=e;const n=this._getFileInfo();n&&(s=n.startLine),this._range={startLine:s,startColumn:t,endLine:s,endColumn:t+this._cssText.length}}_getFileInfo(){const e=this._wxcsProps.fileinfo;if(e){const t=e.split(" ");return{sourceURL:t[0],startLine:+t[1]}}}_getCssProperties(){const e=[];each(this._matchedCSSRule.rule.style.cssProperties,(t,s)=>{const{name:n,disabled:r,range:i,text:o}=t;let{value:l}=t;if(startWith(n,"wxcs_"))return;const c=this._wxcsProps["style_"+t.name];c&&c[s]&&(l=c[s]),l=trim(l," ;");const h={name:n,value:l};isUndef(r)||(h.disabled=r),i&&(h.range=clone(i)),o&&(h.text=o),h.important=endWith(l,"!important"),e.push(h)}),this._cssProperties=e}_getOrigin(){"RemoteDebug"===wxMain.type?this._origin="style_0"===this._styleSheetId?"user-agent":"regular":this._origin=this._wxcsProps.fileinfo?"regular":"user-agent"}_getStyleSheetId(){const e=this._matchedCSSRule.rule.styleSheetId;let t="";const s=this._getFileInfo();s&&(t=s.sourceURL),styleSheets[e]||(Wxml.connection.trigger("CSS.styleSheetAdded",{header:{styleSheetId:e,sourceURL:t,startColumn:0,startLine:0,endColumn:0,endLine:0}}),styleSheets[e]=!0),this._styleSheetId=e}_getSelector(){const{rule:e}=this._matchedCSSRule,t={text:this._wxcsProps.originclass||e.selectorList.text,selectors:[]},s=[];each(t.text.split(","),(e,n)=>{s.push(n);let r=trim(e.replace(/^wx-/,""));"body"===r&&(r="page"),t.selectors.push({range:{startLine:0,startColumn:0,endLine:0,endColumn:0},text:r})}),this._selectorList=t,this._matchingSelectors=s}_getWxcsProps(){const{cssProperties:e}=this._matchedCSSRule.rule.style,t={};each(e,(e,s)=>{if(startWith(e.name,"wxcs_")){const n=e.name.replace("wxcs_","");startWith(n,"style_")?(t[n]||(t[n]={}),t[n][s-1]=e.value):t[n]=e.value}}),this._wxcsProps=t}}class InlineStyle{constructor(e){this._inlineStyle=e,this._cssProperties=[],this._styleSheetId="",this._range={},this._cssText="",this._wxcsProps={},this._process()}get(){return{cssProperties:this._cssProperties,cssText:this._cssText,shorthandEntries:[],styleSheetId:this._styleSheetId,range:this._range}}_getCssText(){let e="",t=0;each(this._cssProperties,s=>{const{name:n,value:r,disabled:i}=s;let o=n+":"+r+";";i&&(o=s.text),e+=o,s.range={startLine:0,startColumn:t,endLine:0,endColumn:t+o.length},i||(s.text=o),t+=o.length}),this._cssText=e}_process(){this._getWxcsProps(),this._getStyleSheetId(),this._getCssProperties(),this._getCssText(),this._getRange()}_getStyleSheetId(){this._styleSheetId=this._inlineStyle.styleSheetId}_getRange(){this._range={startLine:0,startColumn:0,endLine:0,endColumn:this._cssText.length}}_getWxcsProps(){const{cssProperties:e}=this._inlineStyle,t={};each(e,(e,s)=>{if(startWith(e.name,"wxcs_")){const n=e.name.replace("wxcs_","");startWith(n,"style_")?(t[n]||(t[n]={}),t[n][s-1]=e.value):t[n]=e.value}}),this._wxcsProps=t}_getCssProperties(){const e=[];each(this._inlineStyle.cssProperties,(t,s)=>{const{name:n,disabled:r,range:i,text:o}=t;let{value:l}=t;if(startWith(n,"wxcs_"))return;const c=this._wxcsProps["style_"+t.name];c&&c[s]&&(l=c[s]),l=trim(l," ;"),e.push({name:n,value:l,disabled:r,important:endWith(l,"!important"),range:clone(i),text:o||""})}),this._cssProperties=e}}let curMatchedCSSRules=[],curNodeId=0,styleSheets={},bypassSheets={},deviceInfo={};export function enable(){Wxml.remoteMessenger.on("debuggeeChanged",()=>documentUpdated())}export async function getInlineStylesForNode(e){if(Wxml.ChromeTree.isChromeNode(e.nodeId)){const e=Error("Element is not a style sheet");throw e.code=-32e3,e}const{inlineStyle:t}=await getMatchedStylesForNode(e);return{inlineStyle:t}}export async function getMatchedStylesForNode(e){if(curNodeId=e.nodeId,"RemoteDebug"!==wxMain.type&&Wxml.ChromeTree.isChromeNode(e.nodeId)){e.nodeId=Wxml.ChromeTree.toNodeId(e.nodeId);const{matchedCSSRules:t}=await Wxml.chromeMessenger.send("CSS.getMatchedStylesForNode",e);curMatchedCSSRules=[];const s=[];return each(t,e=>{const t=new MatchedCSSRule(e);curMatchedCSSRules.push(t),s.push(t.get())}),{matchedCSSRules:s}}checkNodeIsElement(e.nodeId);const t=await Wxml.remoteMessenger.send("CSS.getMatchedStylesForNode",e);if(t.trustMe)return t;const{inlineStyle:s,matchedCSSRules:n}=t;curMatchedCSSRules=[];const r=new InlineStyle(s),i=[];return each(n,e=>{const t=new MatchedCSSRule(e);curMatchedCSSRules.push(t),i.push(t.get())}),{matchedCSSRules:i,inlineStyle:r.get()}}export async function getComputedStyleForNode(e){if("RemoteDebug"!==wxMain.type&&Wxml.ChromeTree.isChromeNode(e.nodeId))return e.nodeId=Wxml.ChromeTree.toNodeId(e.nodeId),await Wxml.chromeMessenger.send("CSS.getComputedStyleForNode",e);checkNodeIsElement(e.nodeId);return await Wxml.remoteMessenger.send("CSS.getComputedStyleForNode",e)}export async function setStyleTexts(e){if(bypassSheets[e.styleSheetId])return await Wxml.remoteMessenger.send("CSS.setStyleTexts",e);let t=e.edits;const s=[],n=cloneDeep(t);for(let e=0,n=t.length;e<n;e++){const n=t[e];for(let t=0,r=curMatchedCSSRules.length;t<r;t++){const r=curMatchedCSSRules[t],{style:i}=r.get().rule;if(i.styleSheetId===n.styleSheetId){const t=i.range;if(t.startLine===n.range.startLine&&t.startColumn===n.range.startColumn){r.correctEdit(n),s[e]=r;break}}}n.text=transRpx(n.text)}if("RemoteDebug"!==wxMain.type&&Wxml.ChromeTree.isChromeNode(curNodeId)){const{styles:t}=await Wxml.chromeMessenger.send("CSS.setStyleTexts",e);return{styles:map(t,(e,t)=>{const n=s[t];return n.updateStyle(e),n.get().rule.style})}}await Wxml.remoteMessenger.send("CSS.setStyleTexts",e),t=n;const{inlineStyle:r,matchedCSSRules:i}=await getMatchedStylesForNode({nodeId:curNodeId});return{styles:map(t,e=>{const{styleSheetId:t}=e;if(startWith(t,"node_"))return r;for(let s=0,n=i.length;s<n;s++){const{style:n}=i[s].rule;if(n.styleSheetId===t){const t=n.range;if(t.startLine===e.range.startLine&&t.startColumn===e.range.startColumn)return n}}return{styleSheetId:t}})}}const regRpx=/(-?\d+(?:\.\d+)?)rpx/g;function transRpx(e){if(!contain(e,"rpx"))return e;const t=`.name {${e}}`,s=css.parse(t).rules[0].declarations;for(let t=0,n=s.length;t<n;t++){const{property:n,value:r}=s[t];if(regRpx.test(r)){const t=new RegExp(`${n}:\\s*${escapeRegExp(r)};?`),s=r.replace(regRpx,(e,t)=>{let s=0;return isNaN(t=+t)||(s=transformByDPR(t)),s+"px"});e=e.replace(t,`${n}:${s};wxcs_style_${n}:${r};`)}}return e}const BASE_DEVICE_WIDTH=750;function transformByDPR(e){const t=deviceInfo.width,s=deviceInfo.dpr;return e=e/750*t,0===(e=Math.floor(e+1e-4))?1===s?1:.5:e}function checkNodeIsElement(e){const t=Wxml.tree.getNode(e);if(Wxml.ShadowTree.isShadowRoot(e)||1!==t.nodeType){const e=Error("Node is not an Element");throw e.code=-32e3,e}}function documentUpdated(){styleSheets={}}Wxml.remoteMessenger.on("message",({method:e,params:t})=>{switch(e){case"DOM.documentUpdated":documentUpdated();break;case"CSS.styleSheetChanged":{const{styleSheetId:e}=t;Wxml.connection.trigger("CSS.styleSheetChanged",{styleSheetId:e});break}case"CSS.styleSheetAdded":case"CSS.styleSheetRemoved":{const{styleSheetId:s}=t,n="CSS.styleSheetAdded"===e;styleSheets[s]=bypassSheets[s]=n,Wxml.connection.trigger(e,t)}}}),Wxml.wxmlMessenger.on("SEND_DEVICEINFO",e=>{deviceInfo=e}),self.Wxml=self.Wxml||{},Wxml=Wxml||{},Wxml.transRpx=transRpx;