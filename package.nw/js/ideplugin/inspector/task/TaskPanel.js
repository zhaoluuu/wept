import*as UI from"../ui/ui.js";import*as Common from"../common/common.js";import*as DataGrid from"../data_grid/data_grid.js";import PluginMessenger from"../wx_main/PluginMessenger.js";import{filter,map,each,mapObj,isEqual,fileSize,arrToMap,toStr,extend,startWith,contain,Url,clone,pick}from"../third_party/licia.js";import"../third_party/luna-performance-monitor.js";export class TaskPanel extends UI.Widget.VBox{constructor(){super(!1),this._initMessenger(),this.registerRequiredCSS("task/taskPanel.css"),this.registerRequiredCSS("third_party/luna-performance-monitor.css"),this._mainToolbar=new UI.Toolbar.Toolbar("task-toolbar",this.element);const t=new UI.Toolbar.ToolbarComboBox(this._filterChanged.bind(this),ls`Filter`);t.addOption(t.createOption("Simulator","simulator")),t.addOption(t.createOption("Project","project")),t.addOption(t.createOption("All","all")),this._filterSelect=t,this._filter="simulator",this._totalMemory=new UI.Toolbar.ToolbarText("Memory 0"),this._totalMemory.element.addEventListener("click",()=>this.deselect()),this._totalCPU=new UI.Toolbar.ToolbarText("CPU 0"),this._totalCPU.element.addEventListener("click",()=>this.deselect()),extend(this._totalCPU.element.style,{minWidth:"60px",justifyContent:"left"});const e=[t,new UI.Toolbar.ToolbarSeparator,this._totalCPU,this._totalMemory];for(const t of e)this._mainToolbar.appendToolbarItem(t);this.element.classList.add("task-view","table");const i=[{id:"id",title:Common.UIString.UIString("ID"),sortable:!0,weight:0},{id:"task",title:Common.UIString.UIString("Task"),longText:!0,weight:60},{id:"processId",title:Common.UIString.UIString("Process ID"),sortable:!0,weight:15,align:DataGrid.DataGrid.Align.Right},{id:"cpu",title:Common.UIString.UIString("CPU"),sortable:!0,weight:15,align:DataGrid.DataGrid.Align.Right},{id:"memory",title:Common.UIString.UIString("Memory"),sortable:!0,weight:15,align:DataGrid.DataGrid.Align.Right},{id:"jsMemory",title:Common.UIString.UIString("JavaScript memory"),sortable:!0,weight:25,align:DataGrid.DataGrid.Align.Right},{id:"network",title:Common.UIString.UIString("Network"),weight:20,align:DataGrid.DataGrid.Align.Right}];this._dataGrid=new DataGrid.SortableDataGrid.SortableDataGrid({displayName:ls`Task Items`,columns:i}),this._dataGrid.setStriped(!0),this._dataGrid.setColumnsVisiblity(arrToMap(filter(map(i,t=>t.id),t=>"id"!==t))),this._dataGrid.addEventListener(DataGrid.DataGrid.Events.SelectedNode,t=>{this._restartMonitor()}),this._dataGrid.addEventListener(DataGrid.DataGrid.Events.SortingChanged,this._sortingChanged,this),this._splitWidget=new UI.SplitWidget.SplitWidget(!1,!0,"taskSplitViewState"),this._splitWidget.show(this.element),this._monitorPanel=new UI.Widget.VBox,this._monitorPanel.setMinimumSize(0,50);const o=this._monitorPanel.element.createChild("div","monitor-panel-resizer"),r=this._dataGrid.asWidget();r.setMinimumSize(0,50),this._splitWidget.setMainWidget(r),this._splitWidget.setSidebarWidget(this._monitorPanel),this._splitWidget.installResizer(o);const a=this._monitorPanel.element.createChild("div","monitor");extend(a.style,{overflow:"auto"}),this._cpuMonitorContainer=a.createChild("div","cpu-monitor"),extend(this._cpuMonitorContainer.style,{marginBottom:"10px"}),this._memoryMonitorContainer=a.createChild("div","memory-monitor"),this._cpuMonitorData=0,this._memoryMonitorData=0}wasShown(){this._taskMessenger.send("TASK_PANEL_SHOW"),this._showMonitor()}deselect(){this._dataGrid.selectedNode&&this._dataGrid.selectedNode.deselect(),this._restartMonitor()}willHide(){this._taskMessenger.send("TASK_PANEL_HIDE"),this._hideMonitor()}setProcesses(t){const e=this._dataGrid,i=e.rootNode();let o=0,r=0,a=mapObj(t,t=>{let e=fileSize(t.network);"0"!==e&&(e+="B/s");let i=t.cpu||0;i/=navigator.hardwareConcurrency;let o="-";t.jsMemoryAllocated&&(o=`${fileSize(t.jsMemoryAllocated)} (${fileSize(t.jsMemoryUsed)} live)`);const r=clone(t.tasks),a={id:t.id,task:getTaskTitle(r),network:e,cpu:i.toFixed(1),memory:fileSize(t.privateMemory),processId:t.osProcessId,jsMemory:o,isCurrentProject:t.isCurrentProject};return r.length>0&&(a.tasks=r,a.tasks=map(a.tasks,({title:t})=>({title:formatTaskTitle(t)}))),a});const s=this._filter;"all"!==s&&(a=pick(a,t=>{const e=t.isCurrentProject;return delete t.isCurrentProject,!!e&&!("simulator"===s&&"App Service"!==t.task&&!contain(t.task,"Webview"))})),each(a,e=>{const i=t[e.id];let a=i.cpu||0;a/=navigator.hardwareConcurrency,o+=a,r+=i.privateMemory}),this._totalCPU.setText(`CPU ${o.toFixed(1)}%`),this._totalMemory.setText("Memory "+fileSize(r));const n={};each(i.children,t=>{n[t.data.id]=t}),each(a,t=>{let e;if(n[t.id]){const i=n[t.id];e=i,isEqual(t,i.data)||(i.data=t)}else e=new DataGrid.SortableDataGrid.SortableDataGridNode(t,!0),e.selectable=!0,i.appendChild(e);if(t.tasks){const i=clone(e.children),o=t.tasks;delete t.tasks,each(o,(t,o)=>{const r=document.createElement("span");r.style.paddingLeft="20px",r.innerText=t.title;const a={task:r};if(i[o])i[o].data=a;else{const t=new DataGrid.SortableDataGrid.SortableDataGridNode({task:r});t.selectable=!1,e.appendChild(t)}});for(let t=o.length;t<i.length;t++)e.removeChild(i[t]);e.expand()}}),each(n,t=>{a[t.data.id]||(t===e.selectedNode&&this.deselect(),i.removeChild(t))});const l=this._dataGrid.selectedNode;if(l){const e=t[l.data.id];this._cpuMonitorData=e.cpu/navigator.hardwareConcurrency,this._memoryMonitorData=e.privateMemory}else this._cpuMonitorData=o,this._memoryMonitorData=r}_filterChanged(){this._filter=this._filterSelect.selectedOption().value}_showMonitor(){this._cpuMonitor=new LunaPerformanceMonitor(this._cpuMonitorContainer,{title:"CPU",unit:"%",data:()=>this._cpuMonitorData.toFixed(1)}),this._cpuMonitor.start(),this._memoryMonitor=new LunaPerformanceMonitor(this._memoryMonitorContainer,{title:"Memory",unit:"MB",color:"#614d82",smooth:!1,data:()=>(this._memoryMonitorData/1024/1024).toFixed(2)}),this._memoryMonitor.start();"dark"===self.UI.themeSupport.themeName()&&(this._cpuMonitor.setOption("theme","dark"),this._memoryMonitor.setOption("theme","dark"))}_hideMonitor(){this._cpuMonitor.destroy(),this._memoryMonitor.destroy()}_restartMonitor(){this._cpuMonitorData=0,this._memoryMonitorData=0,this._hideMonitor(),this._showMonitor()}_initMessenger(){const t=new PluginMessenger("PLUGIN_task_miniprogram");t.on("UPDATE_TASK",({processes:t})=>{this.setProcesses(t)}),this._taskMessenger=t}_sortingChanged(){const t=this._dataGrid.sortColumnId();t&&this._dataGrid.sortNodes((function(e,i){return String.naturalOrderComparator(toStr(e.data[t]),toStr(i.data[t]))}),!this._dataGrid.isSortOrderAscending())}}function getTaskTitle(t){let e=t[0];for(let i=1,o=t.length;i<o;i++)if(contain(t[i].title,"chrome-extension")){e=t[i];break}return t.splice(t.indexOf(e),1),formatTaskTitle(e.title)}const titleCnToEnMap={"浏览器":"Browser","GPU 进程":"GPU Process","V8 代理解析工具":"V8 Proxy Resolver","小程序逻辑层":"App Service","小程序渲染层":"Webview: standby","微信开发者工具":"Project List Window Background"};function formatTaskTitle(t){if(each(["实用程序：","应用：","网页视图：","标签页：","后台网页：","辅助框架："],e=>{startWith(t,e)&&(t=t.replace(e,""))}),titleCnToEnMap[t])return titleCnToEnMap[t];if(startWith(t,"DevTools -"))return contain(t,"appservice")?"DevTools: App Service":t.replace("DevTools -","DevTools:");if(contain(t,"html/entrance.html"))return"Project List Window";if(contain(t,"html/index.html")){return"Project Window: "+new Url(t).query.projectpath}return t}