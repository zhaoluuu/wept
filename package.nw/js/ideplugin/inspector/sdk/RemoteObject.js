import*as ProtocolClient from"../protocol_client/protocol_client.js";import{DebuggerModel,FunctionDetails}from"./DebuggerModel.js";import{RuntimeModel}from"./RuntimeModel.js";export class RemoteObject{static fromLocalObject(e){return new LocalJSONObject(e)}static type(e){if(null===e)return"null";const t=typeof e;return"object"!==t&&"function"!==t?t:e.type}static arrayNameFromDescription(e){return e.replace(_descriptionLengthParenRegex,"").replace(_descriptionLengthSquareRegex,"")}static arrayLength(e){if("array"!==e.subtype&&"typedarray"!==e.subtype)return 0;const t=e.description.match(_descriptionLengthParenRegex),r=e.description.match(_descriptionLengthSquareRegex);return t?parseInt(t[1],10):r?parseInt(r[1],10):0}static unserializableDescription(e){const t=typeof e;if("number"===t){const t=String(e);if(0===e&&1/e<0)return UnserializableNumber.Negative0;if(t===UnserializableNumber.NaN||t===UnserializableNumber.Infinity||t===UnserializableNumber.NegativeInfinity)return t}return"bigint"===t?e+"n":null}static toCallArgument(e){const t=typeof e;if("undefined"===t)return{};const r=RemoteObject.unserializableDescription(e);if("number"===t)return null!==r?{unserializableValue:r}:{value:e};if("bigint"===t)return{unserializableValue:r};if("string"===t||"boolean"===t)return{value:e};if(!e)return{value:null};if(e instanceof RemoteObject){const t=e.unserializableValue();if(void 0!==t)return{unserializableValue:t}}else if(void 0!==e.unserializableValue)return{unserializableValue:e.unserializableValue};return void 0!==e.objectId?{objectId:e.objectId}:{value:e.value}}static async loadFromObjectPerProto(e,t){const r=await Promise.all([e.getAllProperties(!0,t),e.getOwnProperties(t)]),n=r[0].properties,i=r[1].properties,o=r[1].internalProperties;if(!i||!n)return{properties:null,internalProperties:null};const s=new Map,l=[];for(let e=0;e<n.length;e++){const t=n[e];t.symbol?l.push(t):s.set(t.name,t)}for(let e=0;e<i.length;e++){const t=i[e];t.isAccessorProperty()||(t.symbol?l.push(t):s.set(t.name,t))}return{properties:[...s.values()].concat(l),internalProperties:o||null}}customPreview(){return null}get objectId(){return"Not implemented"}get type(){throw"Not implemented"}get subtype(){throw"Not implemented"}get value(){throw"Not implemented"}unserializableValue(){throw"Not implemented"}get description(){throw"Not implemented"}get hasChildren(){throw"Not implemented"}get preview(){}get className(){return null}arrayLength(){throw"Not implemented"}getOwnProperties(e){throw"Not implemented"}getAllProperties(e,t){throw"Not implemented"}async deleteProperty(e){throw"Not implemented"}async setPropertyValue(e,t){throw"Not implemented"}callFunction(e,t){throw"Not implemented"}callFunctionJSON(e,t){throw"Not implemented"}release(){}debuggerModel(){throw new Error("DebuggerModel-less object")}runtimeModel(){throw new Error("RuntimeModel-less object")}isNode(){return!1}}export class RemoteObjectImpl extends RemoteObject{constructor(e,t,r,n,i,o,s,l,a,c){super(),this._runtimeModel=e,this._runtimeAgent=e.target().runtimeAgent(),this._type=r,this._subtype=n,t?(this._objectId=t,this._description=s,this._hasChildren="symbol"!==r,this._preview=l):(this._description=s,!this.description&&o&&(this._description=o),this._description||"object"==typeof i&&null!==i||(this._description=i+""),this._hasChildren=!1,"string"==typeof o?(this._unserializableValue=o,o===UnserializableNumber.Infinity||o===UnserializableNumber.NegativeInfinity||o===UnserializableNumber.Negative0||o===UnserializableNumber.NaN?this._value=Number(o):"bigint"===r&&o.endsWith("n")?this._value=BigInt(o.substring(0,o.length-1)):this._value=o):this._value=i),this._customPreview=a||null,this._className="string"==typeof c?c:null}customPreview(){return this._customPreview}get objectId(){return this._objectId}get type(){return this._type}get subtype(){return this._subtype}get value(){return this._value}unserializableValue(){return this._unserializableValue}get description(){return this._description}get hasChildren(){return this._hasChildren}get preview(){return this._preview}get className(){return this._className}getOwnProperties(e){return this.doGetProperties(!0,!1,e)}getAllProperties(e,t){return this.doGetProperties(!1,e,t)}async doGetProperties(e,t,r){if(!this._objectId)return{properties:null,internalProperties:null};const n=await this._runtimeAgent.invoke_getProperties({objectId:this._objectId,ownProperties:e,accessorPropertiesOnly:t,generatePreview:r});if(n[ProtocolClient.InspectorBackend.ProtocolError])return{properties:null,internalProperties:null};if(n.exceptionDetails)return this._runtimeModel.exceptionThrown(Date.now(),n.exceptionDetails),{properties:null,internalProperties:null};const{result:i=[],internalProperties:o=[],privateProperties:s=[]}=n,l=[];for(const e of i){const t=e.value?this._runtimeModel.createRemoteObject(e.value):null,r=e.symbol?this._runtimeModel.createRemoteObject(e.symbol):null,n=new RemoteObjectProperty(e.name,t,!!e.enumerable,!!e.writable,!!e.isOwn,!!e.wasThrown,r);void 0===e.value&&(e.get&&"undefined"!==e.get.type&&(n.getter=this._runtimeModel.createRemoteObject(e.get)),e.set&&"undefined"!==e.set.type&&(n.setter=this._runtimeModel.createRemoteObject(e.set))),l.push(n)}for(const e of s){const t=this._runtimeModel.createRemoteObject(e.value),r=new RemoteObjectProperty(e.name,t,!0,!0,!0,!1,void 0,!1,void 0,!0);l.push(r)}const a=[];for(const e of o){if(!e.value)continue;if("[[StableObjectId]]"===e.name)continue;const t=this._runtimeModel.createRemoteObject(e.value);a.push(new RemoteObjectProperty(e.name,t,!0,!1,void 0,void 0,void 0,!0))}return{properties:l,internalProperties:a}}async setPropertyValue(e,t){if(!this._objectId)return"Can’t set a property of non-object.";const r=await this._runtimeAgent.invoke_evaluate({expression:t,silent:!0});if(r[ProtocolClient.InspectorBackend.ProtocolError]||r.exceptionDetails)return r[ProtocolClient.InspectorBackend.ProtocolError]||("string"!==r.result.type?r.result.description:r.result.value);"string"==typeof e&&(e=RemoteObject.toCallArgument(e));const n=this.doSetObjectPropertyValue(r.result,e);return r.result.objectId&&this._runtimeAgent.releaseObject(r.result.objectId),n}async doSetObjectPropertyValue(e,t){const r=[t,RemoteObject.toCallArgument(e)],n=await this._runtimeAgent.invoke_callFunctionOn({objectId:this._objectId,functionDeclaration:"function(a, b) { this[a] = b; }",arguments:r,silent:!0}),i=n[ProtocolClient.InspectorBackend.ProtocolError];return i||n.exceptionDetails?i||n.result.description:void 0}async deleteProperty(e){if(!this._objectId)return"Can’t delete a property of non-object.";const t=await this._runtimeAgent.invoke_callFunctionOn({objectId:this._objectId,functionDeclaration:"function(a) { delete this[a]; return !(a in this); }",arguments:[e],silent:!0});return t[ProtocolClient.InspectorBackend.ProtocolError]||t.exceptionDetails?t[ProtocolClient.InspectorBackend.ProtocolError]||t.result.description:t.result.value?void 0:"Failed to delete property."}async callFunction(e,t){const r=await this._runtimeAgent.invoke_callFunctionOn({objectId:this._objectId,functionDeclaration:e.toString(),arguments:t,silent:!0});return r[ProtocolClient.InspectorBackend.ProtocolError]?{object:null,wasThrown:!1}:{object:this._runtimeModel.createRemoteObject(r.result),wasThrown:!!r.exceptionDetails}}async callFunctionJSON(e,t){const r=await this._runtimeAgent.invoke_callFunctionOn({objectId:this._objectId,functionDeclaration:e.toString(),arguments:t,silent:!0,returnByValue:!0});return r[ProtocolClient.InspectorBackend.ProtocolError]||r.exceptionDetails?null:r.result.value}release(){this._objectId&&this._runtimeAgent.releaseObject(this._objectId)}arrayLength(){return RemoteObject.arrayLength(this)}debuggerModel(){return this._runtimeModel.debuggerModel()}runtimeModel(){return this._runtimeModel}isNode(){return!!this._objectId&&"object"===this.type&&"node"===this.subtype}}export class ScopeRemoteObject extends RemoteObjectImpl{constructor(e,t,r,n,i,o,s,l,a){super(e,t,n,i,o,s,l,a),this._scopeRef=r,this._savedScopeProperties=void 0}async doGetProperties(e,t,r){if(t)return{properties:[],internalProperties:[]};if(this._savedScopeProperties)return{properties:this._savedScopeProperties.slice(),internalProperties:null};const n=await super.doGetProperties(e,t,!0);if(this._scopeRef&&Array.isArray(n.properties)&&(this._savedScopeProperties=n.properties.slice(),!this._scopeRef.callFrameId))for(const e of this._savedScopeProperties)e.writable=!1;return n}async doSetObjectPropertyValue(e,t){const r=t.value,n=await this.debuggerModel().setVariableValue(this._scopeRef.number,r,RemoteObject.toCallArgument(e),this._scopeRef.callFrameId);if(n)return n;if(this._savedScopeProperties)for(const t of this._savedScopeProperties)t.name===r&&(t.value=this._runtimeModel.createRemoteObject(e))}}export class ScopeRef{constructor(e,t){this.number=e,this.callFrameId=t}}export class RemoteObjectProperty{constructor(e,t,r,n,i,o,s,l,a,c){this.name=e,null!==t&&(this.value=t),this.enumerable=void 0===r||r;const u=!l||!!a;this.writable=void 0!==n?n:u,this.isOwn=!!i,this.wasThrown=!!o,s&&(this.symbol=s),this.synthetic=!!l,a&&(this.syntheticSetter=a),this.private=!!c}async setSyntheticValue(e){if(!this.syntheticSetter)return!1;const t=await this.syntheticSetter(e);return t&&(this.value=t),!!t}isAccessorProperty(){return!(!this.getter&&!this.setter)}}export class LocalJSONObject extends RemoteObject{constructor(e){super(),this._value=e,this._cachedDescription,this._cachedChildren}get objectId(){}get value(){return this._value}unserializableValue(){return RemoteObject.unserializableDescription(this._value)||void 0}get description(){if(this._cachedDescription)return this._cachedDescription;if("object"===this.type)switch(this.subtype){case"array":this._cachedDescription=this._concatenate("[","]",function(e){return this._formatValue(e.value)}.bind(this));break;case"date":this._cachedDescription=""+this._value;break;case"null":this._cachedDescription="null";break;default:this._cachedDescription=this._concatenate("{","}",function(e){let t=e.name;return/^\s|\s$|^$|\n/.test(t)&&(t='"'+t.replace(/\n/g,"↵")+'"'),t+": "+this._formatValue(e.value)}.bind(this))}else this._cachedDescription=String(this._value);return this._cachedDescription}_formatValue(e){if(!e)return"undefined";const t=e.description||"";return"string"===e.type?'"'+t.replace(/\n/g,"↵")+'"':t}_concatenate(e,t,r){let n=e;const i=this._children();for(let e=0;e<i.length;++e){const t=r(i[e]);if(n.length+t.length>100){n+=",…";break}e&&(n+=", "),n+=t}return n+=t,n}get type(){return typeof this._value}get subtype(){return null===this._value?"null":Array.isArray(this._value)?"array":this._value instanceof Date?"date":void 0}get hasChildren(){return"object"==typeof this._value&&null!==this._value&&!!Object.keys(this._value).length}getOwnProperties(e){return Promise.resolve({properties:this._children(),internalProperties:null})}getAllProperties(e,t){return e?Promise.resolve({properties:[],internalProperties:null}):Promise.resolve({properties:this._children(),internalProperties:null})}_children(){if(!this.hasChildren)return[];const e=this._value;return this._cachedChildren||(this._cachedChildren=Object.keys(e).map((function(t){let r=e[t];return r instanceof RemoteObject||(r=RemoteObject.fromLocalObject(r)),new RemoteObjectProperty(t,r)}))),this._cachedChildren}arrayLength(){return Array.isArray(this._value)?this._value.length:0}callFunction(e,t){const r=this._value,n=t?t.map(e=>e.value):[];let i,o=!1;try{i=e.apply(r,n)}catch(e){o=!0}const s=RemoteObject.fromLocalObject(i);return Promise.resolve({object:s,wasThrown:o})}callFunctionJSON(e,t){const r=this._value,n=t?t.map(e=>e.value):[];let i;try{i=e.apply(r,n)}catch(e){i=null}return Promise.resolve(i)}}export class RemoteArray{constructor(e){this._object=e}static objectAsArray(e){if(!e||"object"!==e.type||"array"!==e.subtype&&"typedarray"!==e.subtype)throw new Error("Object is empty or not an array");return new RemoteArray(e)}static createFromRemoteObjects(e){if(!e.length)throw new Error("Input array is empty");const t=[];for(let r=0;r<e.length;++r)t.push(RemoteObject.toCallArgument(e[r]));return e[0].callFunction((function(){if(arguments.length>1)return new Array(arguments);return[arguments[0]]}),t).then((function(e){if(e.wasThrown||!e.object)throw new Error("Call function throws exceptions or returns empty value");return RemoteArray.objectAsArray(e.object)}))}at(e){if(e<0||e>this._object.arrayLength())throw new Error("Out of range");return this._object.callFunction((function(e){return this[e]}),[RemoteObject.toCallArgument(e)]).then((function(e){if(e.wasThrown||!e.object)throw new Error("Exception in callFunction or result value is empty");return e.object}))}length(){return this._object.arrayLength()}map(e){const t=[];for(let r=0;r<this.length();++r)t.push(this.at(r).then(e));return Promise.all(t)}object(){return this._object}}export class RemoteFunction{constructor(e){this._object=e}static objectAsFunction(e){if(!e||"function"!==e.type)throw new Error("Object is empty or not a function");return new RemoteFunction(e)}targetFunction(){return this._object.getOwnProperties(!1).then(function(e){if(!e.internalProperties)return this._object;const t=e.internalProperties;for(const e of t)if("[[TargetFunction]]"===e.name)return e.value;return this._object}.bind(this))}targetFunctionDetails(){return this.targetFunction().then(function(t){const r=e.bind(null,this._object!==t?t:null);return t.debuggerModel().functionDetailsPromise(t).then(r)}.bind(this));function e(e,t){return e&&e.release(),t}}object(){return this._object}}const _descriptionLengthParenRegex=/\(([0-9]+)\)/,_descriptionLengthSquareRegex=/\[([0-9]+)\]/,UnserializableNumber={Negative0:"-0",NaN:"NaN",Infinity:"Infinity",NegativeInfinity:"-Infinity"};export let CallFunctionResult;export let GetPropertiesResult;