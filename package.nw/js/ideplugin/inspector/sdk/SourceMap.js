import*as Common from"../common/common.js";import*as TextUtils from"../text_utils/text_utils.js";import{CompilerSourceMappingContentProvider}from"./CompilerSourceMappingContentProvider.js";import{PageResourceLoader,PageResourceLoadInitiator}from"./PageResourceLoader.js";import{Script}from"./Script.js";import initWasm,{Resolver as WasmResolver}from"./wasm_source_map/pkg/wasm_source_map.js";export class SourceMap{compiledURL(){}url(){}sourceURLs(){}sourceContentProvider(e,r){}embeddedContentByURL(e){}findEntry(e,r){}sourceLineMapping(e,r,s){}mappings(){}dispose(){}}class SourceMapV3{constructor(){this.version,this.file,this.sources,this.sections,this.mappings,this.sourceRoot,this.names}}SourceMapV3.Section=class{constructor(){this.map,this.offset}},SourceMapV3.Offset=class{constructor(){this.line,this.column}};export class SourceMapEntry{constructor(e,r,s,t,o,n){this.lineNumber=e,this.columnNumber=r,this.sourceURL=s,this.sourceLineNumber=t,this.sourceColumnNumber=o,this.name=n}static compare(e,r){return e.lineNumber!==r.lineNumber?e.lineNumber-r.lineNumber:e.columnNumber-r.columnNumber}}export class EditResult{constructor(e,r,s){this.map=e,this.compiledEdits=r,this.newSources=s}}export class TextSourceMap{constructor(e,r,s,t){if(this._initiator=t,!TextSourceMap._base64Map){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";TextSourceMap._base64Map={};for(let r=0;r<e.length;++r)TextSourceMap._base64Map[e.charAt(r)]=r}if(this._json=s,this._compiledURL=e,this._sourceMappingURL=r,this._baseURL=r.startsWith("data:")?e:r,this._mappings=null,this._sourceInfos=new Map,this._json.sections){!!this._json.sections.find(e=>!!e.url)&&Common.Console.Console.instance().warn(`SourceMap "${r}" contains unsupported "URL" field in one of its sections.`)}this._eachSection(this._parseSources.bind(this))}static async load(e,r,s){let t;try{const{content:r}=await PageResourceLoader.instance().loadResource(e,s);t=r,")]}"===r.slice(0,3)&&(t=r.substring(r.indexOf("\n")))}catch(r){throw new Error(ls`Could not load content for ${e}: ${r.message}`)}try{const o=JSON.parse(t);return new TextSourceMap(r,e,o,s)}catch(r){throw new Error(ls`Could not parse content for ${e}: ${r.message}`)}}compiledURL(){return this._compiledURL}url(){return this._sourceMappingURL}sourceURLs(){return[...this._sourceInfos.keys()]}sourceContentProvider(e,r){const s=this._sourceInfos.get(e);return s.content?TextUtils.StaticContentProvider.StaticContentProvider.fromString(e,r,s.content):new CompilerSourceMappingContentProvider(e,r,this._initiator)}embeddedContentByURL(e){return this._sourceInfos.has(e)?this._sourceInfos.get(e).content:null}findEntry(e,r){const s=this.mappings(),t=s.upperBound(void 0,(s,t)=>e-t.lineNumber||r-t.columnNumber);return t?s[t-1]:null}sourceLineMapping(e,r,s){const t=this._reversedMappings(e),o=t.lowerBound(r,c),n=t.upperBound(r,c);if(o>=t.length||t[o].sourceLineNumber!==r)return null;const i=t.slice(o,n);if(!i.length)return null;const u=i.lowerBound(s,(e,r)=>e-r.sourceColumnNumber);return u>=i.length?i[i.length-1]:i[u];function c(e,r){return e-r.sourceLineNumber}}findReverseEntries(e,r,s){const t=this._reversedMappings(e),o=t.upperBound(void 0,(e,t)=>r-t.sourceLineNumber||s-t.sourceColumnNumber);let n=o;for(;n>0&&t[n-1].sourceLineNumber===t[o-1].sourceLineNumber&&t[n-1].sourceColumnNumber===t[o-1].sourceColumnNumber;)--n;return t.slice(n,o)}mappings(){return null===this._mappings&&(this._mappings=[],this._eachSection(this._parseMap.bind(this)),this._json=null),this._mappings}_reversedMappings(e){if(!this._sourceInfos.has(e))return[];const r=this.mappings(),s=this._sourceInfos.get(e);return null===s.reverseMappings&&(s.reverseMappings=r.filter(r=>r.sourceURL===e).sort((function(e,r){if(e.sourceLineNumber!==r.sourceLineNumber)return e.sourceLineNumber-r.sourceLineNumber;if(e.sourceColumnNumber!==r.sourceColumnNumber)return e.sourceColumnNumber-r.sourceColumnNumber;if(e.lineNumber!==r.lineNumber)return e.lineNumber-r.lineNumber;return e.columnNumber-r.columnNumber}))),s.reverseMappings}_eachSection(e){if(this._json.sections)for(const r of this._json.sections)e(r.map,r.offset.line,r.offset.column);else e(this._json,0,0)}_parseSources(e){const r=[];let s=e.sourceRoot||"";s&&!s.endsWith("/")&&(s+="/");for(let t=0;t<e.sources.length;++t){const o=s+e.sources[t];let n=Common.ParsedURL.ParsedURL.completeURL(this._baseURL,o)||o;const i=e.sourcesContent&&e.sourcesContent[t];n===this._compiledURL&&i&&(n+=Common.UIString.UIString("? [sm]")),this._sourceInfos.set(n,new TextSourceMap.SourceInfo(i,null)),r.push(n)}e[TextSourceMap._sourcesListSymbol]=r}_parseMap(e,r,s){let t=0,o=0,n=0,i=0;const u=e[TextSourceMap._sourcesListSymbol],c=e.names||[],a=new TextSourceMap.StringCharIterator(e.mappings);let p=u[t];for(;;){if(","===a.peek())a.next();else{for(;";"===a.peek();)r+=1,s=0,a.next();if(!a.hasNext())break}if(s+=this._decodeVLQ(a),!a.hasNext()||this._isSeparator(a.peek())){this._mappings.push(new SourceMapEntry(r,s));continue}const e=this._decodeVLQ(a);e&&(t+=e,p=u[t]),o+=this._decodeVLQ(a),n+=this._decodeVLQ(a),a.hasNext()&&!this._isSeparator(a.peek())?(i+=this._decodeVLQ(a),this._mappings.push(new SourceMapEntry(r,s,p,o,n,c[i]))):this._mappings.push(new SourceMapEntry(r,s,p,o,n))}this._mappings.sort(SourceMapEntry.compare)}_isSeparator(e){return","===e||";"===e}_decodeVLQ(e){let r,s=0,t=0;do{r=TextSourceMap._base64Map[e.next()],s+=(r&TextSourceMap._VLQ_BASE_MASK)<<t,t+=TextSourceMap._VLQ_BASE_SHIFT}while(r&TextSourceMap._VLQ_CONTINUATION_MASK);const o=1&s;return s>>=1,o?-s:s}reverseMapTextRange(e,r){function s(e,r){return e.lineNumber!==r.sourceLineNumber?e.lineNumber-r.sourceLineNumber:e.columnNumber-r.sourceColumnNumber}const t=this._reversedMappings(e);if(!t.length)return null;const o=t.lowerBound({lineNumber:r.startLine,columnNumber:r.startColumn},s),n=t.upperBound({lineNumber:r.endLine,columnNumber:r.endColumn},s),i=t[o],u=t[n];return new TextUtils.TextRange.TextRange(i.lineNumber,i.columnNumber,u.lineNumber,u.columnNumber)}dispose(){}}TextSourceMap._VLQ_BASE_SHIFT=5,TextSourceMap._VLQ_BASE_MASK=31,TextSourceMap._VLQ_CONTINUATION_MASK=32,TextSourceMap.StringCharIterator=class{constructor(e){this._string=e,this._position=0}next(){return this._string.charAt(this._position++)}peek(){return this._string.charAt(this._position)}hasNext(){return this._position<this._string.length}},TextSourceMap.SourceInfo=class{constructor(e,r){this.content=e,this.reverseMappings=r}},TextSourceMap._sourcesListSymbol=Symbol("sourcesList");export class WasmSourceMap{constructor(e,r,s){this._wasmUrl=e,this._resolver=r,this._initiator=s}static async _loadBindings(){const e=await self.runtime.loadBinaryResourcePromise("./sdk/wasm_source_map/pkg/wasm_source_map_bg.wasm",!0);return await initWasm(e),WasmResolver}static _loadBindingsOnce(){return WasmSourceMap._asyncResolver||(WasmSourceMap._asyncResolver=WasmSourceMap._loadBindings()),WasmSourceMap._asyncResolver}static async load(e,r){const[s,t]=await Promise.all([WasmSourceMap._loadBindingsOnce(),e.getWasmBytecode()]);return new WasmSourceMap(r,new s(new Uint8Array(t)),e.createPageResourceLoadInitiator())}compiledURL(){return this._wasmUrl}url(){return WasmSourceMap.FAKE_URL}sourceURLs(){return this._resolver.listFiles()}sourceContentProvider(e,r){return new CompilerSourceMappingContentProvider(e,r,this._initiator)}embeddedContentByURL(e){return null}findEntry(e,r){return 0!==e&&console.warn(new Error("Invalid non-zero line number.")),this._resolver.resolve(r)}sourceLineMapping(e,r,s){return this._resolver.resolveReverse(e,r,s)}mappings(){return this._resolver.listMappings()}dispose(){this._resolver.free()}}WasmSourceMap.FAKE_URL="wasm://dwarf";