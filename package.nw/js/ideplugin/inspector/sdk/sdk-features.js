import{ConsoleModel}from"./ConsoleModel.js";import{isRemoteDebugGame,isRemoteAppserviceMode,getMasterProxyPort}from"../wx_main/util.js";import{NetworkLog}from"./NetworkLog.js";import{each,some,contain,noop,nextTick,map}from"../third_party/licia.js";import{getProxyPort}from"../wx_main/util.js";if(wxMain.isFeatureEnabled("correctRemoteDebugContext")&&"RemoteDebug"===wxMain.type&&!isRemoteDebugGame()&&isRemoteAppserviceMode()){const e=ConsoleModel.prototype.addMessage,t=["WASubContext","WAServiceMainContext"];ConsoleModel.prototype.addMessage=function(o){if(!("error"!==o.type&&t.some(e=>o.url&&o.url.includes(e))||void 0===o.url&&"error"!==o.type&&"console-api"===o.source||"error"===o.type&&o.messageText&&o.messageText.includes("error occurs:ENOENT: no such file or directory, access '/storage/emulated/0/Android/")))return e.apply(this,[o])}}if(wxMain.isFeatureEnabled("hideRequest")){let e=!1;nextTick(()=>{wxMain.on(WxMain.Events.showAllRequests,()=>{e=!0})});const t=wxMain.getFeatureOptions("hideRequest").filter||noop;function filterRequest(o){if(e)return!1;const s=o._url;if(/(\?|&)devtools_ignore=true(&|$)/.test(s))return!0;const r=navigator.userAgent,i=[getProxyPort()];contain(r,"simple")&&i.push(getMasterProxyPort());const a=["https://servicewechat.com/wxa-qbase/qbasecheckresult","https://servicewechat.com/wxa-qbase/container_service","https://servicewechat.com/wxa-qbase/report","https://servicewechat.com/wxa-qbase/keepalive","https://servicewechat.com/ob/wxob"];if(each(i,e=>{a.push(`http://127.0.0.1:${e}/appservice`,`http://127.0.0.1:${e}/__pageframe__/mainframe.html`,`http://127.0.0.1:${e}/__pageframe__/instanceframe.html`,`http://127.0.0.1:${e}/favicon.ico`,`http://127.0.0.1:${e}/apihelper`,`http://127.0.0.1:${e}/jsbridge`,`http://127.0.0.1:${e}/calibration`)}),some(a,e=>contain(s,e)))return!0;if(t(s))return!0;return!!some([/^https:\/\/.+\.cos\.ap-.+\.myqcloud\.com\/wx[^\/]+\/common\/[^\/]+$/,/^https:\/\/.+\.cos\.ap-.+\.myqcloud\.com\/wx[^\/]+\/\d+\/[^\/]+-(appservice|webview)/,/^https:\/\/servicewechat.com\/ob\//],e=>e.test(s))||!(!/^https:\/\/.+\.cos\.ap-.+\.myqcloud\.com\/$/.test(s)||"POST"!==o.requestMethod())}const o=NetworkLog.prototype._addRequest;NetworkLog.prototype._addRequest=function(e){filterRequest(e)||o.call(this,e)};const s=NetworkLog.prototype._onRequestUpdated;NetworkLog.prototype._onRequestUpdated=function(e){filterRequest(e.data)||s.call(this,e)}}if(wxMain.isFeatureEnabled("setMaxRequestLen")){const e=wxMain.getMessenger();let t=999999;e.registerCallback(e=>{"SET_MAX_NETWORK_REQUEST_LENGTH"===e.command&&(t=e.data)}),e.send({command:"GET_MAX_NETWORK_REQUEST_LENGTH"});const o=NetworkLog.prototype._addRequest;NetworkLog.prototype._addRequest=function(e){o.call(this,e);const s=this._requests,r=this._requestsSet,i=this._requests.length;if(i>t){const e=s.slice(0,i-t);this._requests=s.slice(i-t,i),each(e,e=>{if(e.isRedirect()){e.redirectDestination().setRedirectSource(null)}r.delete(e),wxMain.emit(WxMain.Events.requestRemoved,e)}),setTimeout(()=>{wxMain.getMessenger().send({command:"NETWORK_REQUESTS_REMOVED",data:{requestsRemoved:map(e,e=>e.requestId())}})},5e3)}}}