import*as Common from"../common/common.js";import{ProfileNode,ProfileTreeModel}from"./ProfileTreeModel.js";import{Target}from"./SDKModel.js";export class CPUProfileNode extends ProfileNode{constructor(e,t){super(e.callFrame||{functionName:e.functionName,scriptId:e.scriptId,url:e.url,lineNumber:e.lineNumber-1,columnNumber:e.columnNumber-1}),this.id=e.id,this.self=e.hitCount*t,this.positionTicks=e.positionTicks,this.deoptReason=e.deoptReason&&"no reason"!==e.deoptReason?e.deoptReason:null}}export class CPUProfileDataModel extends ProfileTreeModel{constructor(e,t){super(t);!!e.head?(this.profileStartTime=1e3*e.startTime,this.profileEndTime=1e3*e.endTime,this.timestamps=e.timestamps,this._compatibilityConversionHeadToNodes(e)):(this.profileStartTime=e.startTime/1e3,this.profileEndTime=e.endTime/1e3,this.timestamps=this._convertTimeDeltas(e)),this.samples=e.samples,this.lines=e.lines,this.totalHitCount=0,this.profileHead=this._translateProfileTree(e.nodes),this.initialize(this.profileHead),this._extractMetaNodes(),this.samples&&(this._buildIdToNodeMap(),this._sortSamples(),this._normalizeTimestamps(),this._fixMissingSamples())}_compatibilityConversionHeadToNodes(e){if(!e.head||e.nodes)return;const t=[];!function e(i){return t.push(i),i.children=i.children.map(e),i.id}(e.head),e.nodes=t,delete e.head}_convertTimeDeltas(e){if(!e.timeDeltas)return null;let t=e.startTime;const i=new Array(e.timeDeltas.length);for(let s=0;s<e.timeDeltas.length;++s)t+=e.timeDeltas[s],i[s]=t;return i}_translateProfileTree(e){const t=new Map;for(let i=0;i<e.length;++i){const s=e[i];t.set(s.id,s)}!function(e,i){if("number"!=typeof e[0].hitCount){console.assert(i,"Error: Neither hitCount nor samples are present in profile.");for(let t=0;t<e.length;++t)e[t].hitCount=0;for(let e=0;e<i.length;++e)++t.get(i[e]).hitCount}}(e,this.samples),function(e){if(!e[0].children){e[0].children=[];for(let i=1;i<e.length;++i){const s=e[i],o=t.get(s.parent);o.children?o.children.push(s.id):o.children=[s.id]}}}(e),this.totalHitCount=e.reduce((e,t)=>e+t.hitCount,0);const i=(this.profileEndTime-this.profileStartTime)/this.totalHitCount,s=!!Common.Settings.Settings.instance().moduleSetting("showNativeFunctionsInJSProfile").get(),o=e[0],n=new Map([[o.id,o.id]]),r=new CPUProfileNode(o,i),l=o.children.map(()=>r),a=o.children.map(e=>t.get(e));for(;a.length;){let e=l.pop();const o=a.pop();o.children||(o.children=[]);const r=new CPUProfileNode(o,i);s||!((h=o).callFrame?h.callFrame.url&&h.callFrame.url.startsWith("native "):h.url&&h.url.startsWith("native "))?(e.children.push(r),e=r):e.self+=r.self,n.set(o.id,e.id),l.push.apply(l,o.children.map(()=>e)),a.push.apply(a,o.children.map(e=>t.get(e)))}var h;return this.samples&&(this.samples=this.samples.map(e=>n.get(e))),r}_sortSamples(){const e=this.timestamps;if(!e)return;const t=this.samples,i=e.map((e,t)=>t);i.sort((t,i)=>e[t]-e[i]);for(let s=0;s<e.length;++s){let o=i[s];if(o===s)continue;const n=e[s],r=t[s];let l=s;for(;o!==s;)t[l]=t[o],e[l]=e[o],l=o,o=i[o],i[l]=l;t[l]=r,e[l]=n}}_normalizeTimestamps(){let e=this.timestamps;if(e){for(let t=0;t<e.length;++t)e[t]/=1e3;if(this.samples.length===e.length){const t=(e.peekLast()-e[0])/(e.length-1);this.timestamps.push(e.peekLast()+t)}this.profileStartTime=e[0],this.profileEndTime=e.peekLast()}else{const t=this.profileStartTime,i=(this.profileEndTime-t)/this.samples.length;e=new Float64Array(this.samples.length+1);for(let s=0;s<e.length;++s)e[s]=t+s*i;this.timestamps=e}}_buildIdToNodeMap(){this._idToNode=new Map;const e=this._idToNode,t=[this.profileHead];for(;t.length;){const i=t.pop();e.set(i.id,i),t.push.apply(t,i.children)}}_extractMetaNodes(){const e=this.profileHead.children;for(let t=0;t<e.length&&!(this.gcNode&&this.programNode&&this.idleNode);t++){const i=e[t];"(garbage collector)"===i.functionName?this.gcNode=i:"(program)"===i.functionName?this.programNode=i:"(idle)"===i.functionName&&(this.idleNode=i)}}_fixMissingSamples(){const e=this.samples,t=e.length;if(!this.programNode||t<3)return;const i=this._idToNode,s=this.programNode.id,o=this.gcNode?this.gcNode.id:-1,n=this.idleNode?this.idleNode.id:-1;let r=e[0],l=e[1],a=0;for(let o=1;o<t-1;o++){const t=e[o+1];l!==s||p(r)||p(t)||h(i.get(r))!==h(i.get(t))||(++a,e[o]=r),r=l,l=t}function h(e){for(;e.parent&&e.parent.parent;)e=e.parent;return e}function p(e){return e===s||e===o||e===n}a&&Common.Console.Console.instance().warn(ls`DevTools: CPU profile parser is fixing ${a} missing samples.`)}forEachFrame(e,t,i,s){if(!this.profileHead||!this.samples)return;i=i||0,s=s||1/0;const o=this.samples,n=this.timestamps,r=this._idToNode,l=this.gcNode,a=o.length,h=n.lowerBound(i);let p=0;const d=[];let m,c=this.profileHead.id,f=null;const u=this.maxDepth+3;this._stackStartTimes||(this._stackStartTimes=new Float64Array(u));const g=this._stackStartTimes;this._stackChildrenDuration||(this._stackChildrenDuration=new Float64Array(u));const T=this._stackChildrenDuration;let N,_;for(_=h;_<a&&(m=n[_],!(m>=s));_++){const i=o[_];if(i===c)continue;N=r.get(i);let s=r.get(c);if(N!==l){if(s===l){const e=g[p],i=m-e;T[p-1]+=i,t(f.depth+1,l,e,i,i-T[p]),--p,s=f,c=s.id,f=null}for(;N.depth>s.depth;)d.push(N),N=N.parent;for(;s!==N;){const e=g[p],i=m-e;T[p-1]+=i,t(s.depth,s,e,i,i-T[p]),--p,N.depth===s.depth&&(d.push(N),N=N.parent),s=s.parent}for(;d.length;)N=d.pop(),e(N.depth,N,m),g[++p]=m,T[p]=0;c=i}else f=s,e(f.depth+1,l,m),g[++p]=m,T[p]=0,c=i}if(m=n[_]||this.profileEndTime,r.get(c)===l){const e=g[p],i=m-e;T[p-1]+=i,t(f.depth+1,N,e,i,i-T[p]),--p,c=f.id}for(let e=r.get(c);e.parent;e=e.parent){const i=g[p],s=m-i;T[p-1]+=s,t(e.depth,e,i,s,s-T[p]),--p}}nodeByIndex(e){return this._idToNode.get(this.samples[e])||null}}