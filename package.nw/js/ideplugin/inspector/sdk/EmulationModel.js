import*as Common from"../common/common.js";import{CSSModel}from"./CSSModel.js";import{Events,OverlayModel}from"./OverlayModel.js";import{Capability,SDKModel,Target}from"./SDKModel.js";export class EmulationModel extends SDKModel{constructor(e){super(e),this._emulationAgent=e.emulationAgent(),this._pageAgent=e.pageAgent(),this._deviceOrientationAgent=e.deviceOrientationAgent(),this._cssModel=e.model(CSSModel),this._overlayModel=e.model(OverlayModel),this._overlayModel&&this._overlayModel.addEventListener(Events.InspectModeWillBeToggled,this._updateTouch,this);const t=Common.Settings.Settings.instance().moduleSetting("javaScriptDisabled");t.addChangeListener(()=>this._emulationAgent.setScriptExecutionDisabled(t.get())),t.get()&&this._emulationAgent.setScriptExecutionDisabled(!0);const i=Common.Settings.Settings.instance().moduleSetting("emulation.touch");i.addChangeListener(()=>{const e=i.get();this.overrideEmulateTouch("force"===e)});const o=Common.Settings.Settings.instance().moduleSetting("emulation.idleDetection");o.addChangeListener(async()=>{const e=o.get();if("none"===e)return void await this.clearIdleOverride();const t=JSON.parse(e);await this.setIdleOverride(t)});const n=Common.Settings.Settings.instance().moduleSetting("emulatedCSSMedia"),a=Common.Settings.Settings.instance().moduleSetting("emulatedCSSMediaFeaturePrefersColorScheme"),s=Common.Settings.Settings.instance().moduleSetting("emulatedCSSMediaFeaturePrefersReducedMotion"),r=Common.Settings.Settings.instance().moduleSetting("emulatedCSSMediaFeaturePrefersReducedData");this._mediaConfiguration=new Map([["type",n.get()],["prefers-color-scheme",a.get()],["prefers-reduced-motion",s.get()],["prefers-reduced-data",r.get()]]),n.addChangeListener(()=>{this._mediaConfiguration.set("type",n.get()),this._updateCssMedia()}),a.addChangeListener(()=>{this._mediaConfiguration.set("prefers-color-scheme",a.get()),this._updateCssMedia()}),s.addChangeListener(()=>{this._mediaConfiguration.set("prefers-reduced-motion",s.get()),this._updateCssMedia()}),r.addChangeListener(()=>{this._mediaConfiguration.set("prefers-reduced-data",r.get()),this._updateCssMedia()}),this._updateCssMedia();const l=Common.Settings.Settings.instance().moduleSetting("emulatedVisionDeficiency");l.addChangeListener(()=>this._emulateVisionDeficiency(l.get())),l.get()&&this._emulateVisionDeficiency(l.get());const d=Common.Settings.Settings.instance().moduleSetting("localFontsDisabled");d.addChangeListener(()=>this._setLocalFontsDisabled(d.get())),d.get()&&this._setLocalFontsDisabled(d.get()),this._touchEnabled=!1,this._touchMobile=!1,this._customTouchEnabled=!1,this._touchConfiguration={enabled:!1,configuration:Protocol.Emulation.SetEmitTouchEventsForMouseRequestConfiguration.Mobile,scriptId:""}}supportsDeviceEmulation(){return this.target().hasAllCapabilities(Capability.DeviceEmulation)}resetPageScaleFactor(){return this._emulationAgent.resetPageScaleFactor()}emulateDevice(e){return e?this._emulationAgent.invoke_setDeviceMetricsOverride(e):this._emulationAgent.clearDeviceMetricsOverride()}overlayModel(){return this._overlayModel}async emulateLocation(e){if(e||(this._emulationAgent.clearGeolocationOverride(),this._emulationAgent.setTimezoneOverride(""),this._emulationAgent.setLocaleOverride(""),this._emulationAgent.setUserAgentOverride(SDK.multitargetNetworkManager.currentUserAgent())),!e.error){const t=(e,t)=>{const i=t.getError();return i?Promise.reject({type:e,message:i}):Promise.resolve(t)};return Promise.all([this._emulationAgent.invoke_setGeolocationOverride({latitude:e.latitude,longitude:e.longitude,accuracy:Location.DefaultGeoMockAccuracy}).then(e=>t("emulation-set-location",e)),this._emulationAgent.invoke_setTimezoneOverride({timezoneId:e.timezoneId}).then(e=>t("emulation-set-timezone",e)),this._emulationAgent.invoke_setLocaleOverride({locale:e.locale}).then(e=>t("emulation-set-locale",e)),this._emulationAgent.invoke_setUserAgentOverride({userAgent:SDK.multitargetNetworkManager.currentUserAgent(),acceptLanguage:e.locale}).then(e=>t("emulation-set-user-agent",e))])}this._emulationAgent.setGeolocationOverride(),this._emulationAgent.setTimezoneOverride(""),this._emulationAgent.setLocaleOverride(""),this._emulationAgent.setUserAgentOverride(SDK.multitargetNetworkManager.currentUserAgent())}emulateDeviceOrientation(e){e?this._deviceOrientationAgent.setDeviceOrientationOverride(e.alpha,e.beta,e.gamma):this._deviceOrientationAgent.clearDeviceOrientationOverride()}async setIdleOverride(e){await this._emulationAgent.invoke_setIdleOverride(e)}async clearIdleOverride(){await this._emulationAgent.invoke_clearIdleOverride()}_emulateCSSMedia(e,t){this._emulationAgent.setEmulatedMedia(e,t),this._cssModel&&this._cssModel.mediaQueryResultChanged()}_emulateVisionDeficiency(e){this._emulationAgent.setEmulatedVisionDeficiency(e)}_setLocalFontsDisabled(e){this._cssModel.setLocalFontsEnabled(!e)}setCPUThrottlingRate(e){this._emulationAgent.setCPUThrottlingRate(e)}emulateTouch(e,t){this._touchEnabled=e,this._touchMobile=t,this._updateTouch()}overrideEmulateTouch(e){this._customTouchEnabled=e,this._updateTouch()}_updateTouch(){let e={enabled:this._touchEnabled,configuration:this._touchMobile?Protocol.Emulation.SetEmitTouchEventsForMouseRequestConfiguration.Mobile:Protocol.Emulation.SetEmitTouchEventsForMouseRequestConfiguration.Desktop};this._customTouchEnabled&&(e={enabled:!0,configuration:Protocol.Emulation.SetEmitTouchEventsForMouseRequestConfiguration.Mobile}),this._overlayModel&&this._overlayModel.inspectModeEnabled()&&(e={enabled:!1,configuration:Protocol.Emulation.SetEmitTouchEventsForMouseRequestConfiguration.Mobile}),(this._touchConfiguration.enabled||e.enabled)&&(this._touchConfiguration.enabled&&e.enabled&&this._touchConfiguration.configuration===e.configuration||(this._touchConfiguration=e,this._emulationAgent.setTouchEmulationEnabled(e.enabled,1),this._emulationAgent.setEmitTouchEventsForMouse(e.enabled,e.configuration)))}_updateCssMedia(){const e=this._mediaConfiguration.get("type"),t=[{name:"prefers-color-scheme",value:this._mediaConfiguration.get("prefers-color-scheme")},{name:"prefers-reduced-motion",value:this._mediaConfiguration.get("prefers-reduced-motion")},{name:"prefers-reduced-data",value:this._mediaConfiguration.get("prefers-reduced-data")}];this._emulateCSSMedia(e,t)}}export class Location{constructor(e,t,i,o,n){this.latitude=e,this.longitude=t,this.timezoneId=i,this.locale=o,this.error=n}static parseSetting(e){if(e){const[t,i,o,n]=e.split(":"),[a,s]=t.split("@");return new Location(parseFloat(a),parseFloat(s),i,o,Boolean(n))}return new Location(0,0,"","",!1)}static parseUserInput(e,t,i,o){if(!e&&!t)return null;const{valid:n}=Location.latitudeValidator(e),{valid:a}=Location.longitudeValidator(t);if(!n&&!a)return null;const s=n?parseFloat(e):-1,r=a?parseFloat(t):-1;return new Location(s,r,i,o,!1)}static latitudeValidator(e){const t=parseFloat(e);return{valid:/^([+-]?[\d]+(\.\d+)?|[+-]?\.\d+)$/.test(e)&&t>=-90&&t<=90}}static longitudeValidator(e){const t=parseFloat(e);return{valid:/^([+-]?[\d]+(\.\d+)?|[+-]?\.\d+)$/.test(e)&&t>=-180&&t<=180}}static timezoneIdValidator(e){return{valid:""===e||/[a-zA-Z]/.test(e)}}static localeValidator(e){return{valid:""===e||/[a-zA-Z]{2}/.test(e)}}toSetting(){return`${this.latitude}@${this.longitude}:${this.timezoneId}:${this.locale}:${this.error||""}`}}Location.DefaultGeoMockAccuracy=150;export class DeviceOrientation{constructor(e,t,i){this.alpha=e,this.beta=t,this.gamma=i}static parseSetting(e){if(e){const t=JSON.parse(e);return new DeviceOrientation(t.alpha,t.beta,t.gamma)}return new DeviceOrientation(0,0,0)}static parseUserInput(e,t,i){if(!e&&!t&&!i)return null;const{valid:o}=DeviceOrientation.validator(e),{valid:n}=DeviceOrientation.validator(t),{valid:a}=DeviceOrientation.validator(i);if(!o&&!n&&!a)return null;const s=o?parseFloat(e):-1,r=n?parseFloat(t):-1,l=a?parseFloat(i):-1;return new DeviceOrientation(s,r,l)}static validator(e){return{valid:/^([+-]?[\d]+(\.\d+)?|[+-]?\.\d+)$/.test(e)}}toSetting(){return JSON.stringify(this)}}SDKModel.register(EmulationModel,Capability.Emulation,!0);