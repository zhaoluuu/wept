import*as Common from"../common/common.js";import*as Host from"../host/host.js";import*as Platform from"../platform/platform.js";import*as ProtocolClient from"../protocol_client/protocol_client.js";import*as Root from"../root/root.js";import{CSSModel}from"./CSSModel.js";import{FrameManager}from"./FrameManager.js";import{OverlayModel}from"./OverlayModel.js";import{RemoteObject}from"./RemoteObject.js";import{RuntimeModel}from"./RuntimeModel.js";import{Capability,SDKModel,Target,TargetManager}from"./SDKModel.js";export class DOMNode{constructor(e){this._domModel=e}static create(e,t,o,s){const n=new DOMNode(e);return n._init(t,o,s),n}_init(e,t,o){if(this._agent=this._domModel._agent,this.ownerDocument=e,this._isInShadowTree=t,this.id=o.nodeId,this._backendNodeId=o.backendNodeId,this._domModel._idToDOMNode[this.id]=this,this._nodeType=o.nodeType,this._nodeName=o.nodeName,this._localName=o.localName,this._nodeValue=o.nodeValue,this._pseudoType=o.pseudoType,this._shadowRootType=o.shadowRootType,this._frameOwnerFrameId=o.frameId||null,this._xmlVersion=o.xmlVersion,this._isSVGNode=!!o.isSVG,this._creationStackTrace=null,this._shadowRoots=[],this._attributes=new Map,o.attributes&&this._setAttributesPayload(o.attributes),this._markers=new Map,this._subtreeMarkerCount=0,this._childNodeCount=o.childNodeCount||0,this._children=null,this.nextSibling=null,this.previousSibling=null,this.firstChild=null,this.lastChild=null,this.parentNode=null,o.shadowRoots)for(let e=0;e<o.shadowRoots.length;++e){const t=o.shadowRoots[e],s=DOMNode.create(this._domModel,this.ownerDocument,!0,t);this._shadowRoots.push(s),s.parentNode=this}if(o.templateContent&&(this._templateContent=DOMNode.create(this._domModel,this.ownerDocument,!0,o.templateContent),this._templateContent.parentNode=this,this._children=[]),o.contentDocument)this._contentDocument=new DOMDocument(this._domModel,o.contentDocument),this._contentDocument.parentNode=this,this._children=[];else if(("IFRAME"===o.nodeName||"PORTAL"===o.nodeName)&&o.frameId){const e=TargetManager.instance().targetById(o.frameId),t=e?e.model(DOMModel):null;t&&(this._childDocumentPromiseForTesting=t.requestDocument()),this._children=[]}o.importedDocument&&(this._importedDocument=DOMNode.create(this._domModel,this.ownerDocument,!0,o.importedDocument),this._importedDocument.parentNode=this,this._children=[]),o.distributedNodes&&this._setDistributedNodePayloads(o.distributedNodes),o.children&&this._setChildrenPayload(o.children),this._setPseudoElements(o.pseudoElements),this._nodeType===Node.ELEMENT_NODE?(this.ownerDocument&&!this.ownerDocument.documentElement&&"HTML"===this._nodeName&&(this.ownerDocument.documentElement=this),this.ownerDocument&&!this.ownerDocument.body&&"BODY"===this._nodeName&&(this.ownerDocument.body=this)):this._nodeType===Node.DOCUMENT_TYPE_NODE?(this.publicId=o.publicId,this.systemId=o.systemId,this.internalSubset=o.internalSubset):this._nodeType===Node.ATTRIBUTE_NODE&&(this.name=o.name,this.value=o.value)}isAdFrameNode(){if(this.isIframe()&&this._frameOwnerFrameId){const e=FrameManager.instance().getFrame(this._frameOwnerFrameId);return!!e&&e.adFrameType()!==Protocol.Page.AdFrameType.None}return!1}isSVGNode(){return this._isSVGNode}creationStackTrace(){if(this._creationStackTrace)return this._creationStackTrace;const e=this._agent.invoke_getNodeStackTraces({nodeId:this.id});return this._creationStackTrace=e.then(e=>e.creation),this._creationStackTrace}domModel(){return this._domModel}backendNodeId(){return this._backendNodeId}children(){return this._children?this._children.slice():null}hasAttributes(){return this._attributes.size>0}childNodeCount(){return this._childNodeCount}hasShadowRoots(){return!!this._shadowRoots.length}shadowRoots(){return this._shadowRoots.slice()}templateContent(){return this._templateContent||null}contentDocument(){return this._contentDocument||null}isIframe(){return"IFRAME"===this._nodeName}isPortal(){return"PORTAL"===this._nodeName}importedDocument(){return this._importedDocument||null}nodeType(){return this._nodeType}nodeName(){return this._nodeName}pseudoType(){return this._pseudoType}hasPseudoElements(){return this._pseudoElements.size>0}pseudoElements(){return this._pseudoElements}beforePseudoElement(){return this._pseudoElements?this._pseudoElements.get(DOMNode.PseudoElementNames.Before):null}afterPseudoElement(){return this._pseudoElements?this._pseudoElements.get(DOMNode.PseudoElementNames.After):null}markerPseudoElement(){return this._pseudoElements?this._pseudoElements.get(DOMNode.PseudoElementNames.Marker):null}isInsertionPoint(){return!this.isXMLNode()&&("SHADOW"===this._nodeName||"CONTENT"===this._nodeName||"SLOT"===this._nodeName)}distributedNodes(){return this._distributedNodes||[]}isInShadowTree(){return this._isInShadowTree}ancestorShadowHost(){const e=this.ancestorShadowRoot();return e?e.parentNode:null}ancestorShadowRoot(){if(!this._isInShadowTree)return null;let e=this;for(;e&&!e.isShadowRoot();)e=e.parentNode;return e}ancestorUserAgentShadowRoot(){const e=this.ancestorShadowRoot();return e&&e.shadowRootType()===DOMNode.ShadowRootTypes.UserAgent?e:null}isShadowRoot(){return!!this._shadowRootType}shadowRootType(){return this._shadowRootType||null}nodeNameInCorrectCase(){const e=this.shadowRootType();return e?"#shadow-root ("+e+")":this.localName()?this.localName().length!==this.nodeName().length?this.nodeName():this.localName():this.nodeName()}setNodeName(e,t){this._agent.invoke_setNodeName({nodeId:this.id,name:e}).then(e=>{e[ProtocolClient.InspectorBackend.ProtocolError]||this._domModel.markUndoableState(),t&&t(e[ProtocolClient.InspectorBackend.ProtocolError]||null,this._domModel.nodeForId(e.nodeId))})}localName(){return this._localName}nodeValue(){return this._nodeValue}setNodeValue(e,t){this._agent.invoke_setNodeValue({nodeId:this.id,value:e}).then(e=>{e[ProtocolClient.InspectorBackend.ProtocolError]||this._domModel.markUndoableState(),t&&t(e[ProtocolClient.InspectorBackend.ProtocolError]||null)})}getAttribute(e){const t=this._attributes.get(e);return t?t.value:void 0}setAttribute(e,t,o){this._agent.invoke_setAttributesAsText({nodeId:this.id,text:t,name:e}).then(e=>{e[ProtocolClient.InspectorBackend.ProtocolError]||this._domModel.markUndoableState(),o&&o(e[ProtocolClient.InspectorBackend.ProtocolError]||null)})}setAttributeValue(e,t,o){this._agent.invoke_setAttributeValue({nodeId:this.id,name:e,value:t}).then(e=>{e[ProtocolClient.InspectorBackend.ProtocolError]||this._domModel.markUndoableState(),o&&o(e[ProtocolClient.InspectorBackend.ProtocolError]||null)})}setAttributeValuePromise(e,t){return new Promise(o=>this.setAttributeValue(e,t,o))}attributes(){return[...this._attributes.values()]}async removeAttribute(e){(await this._agent.invoke_removeAttribute({nodeId:this.id,name:e}))[ProtocolClient.InspectorBackend.ProtocolError]||(this._attributes.delete(e),this._domModel.markUndoableState())}getChildNodes(e){this._children?e(this.children()):this._agent.invoke_requestChildNodes({nodeId:this.id}).then(t=>{e(t[ProtocolClient.InspectorBackend.ProtocolError]?null:this.children())})}async getSubtree(e,t){return(await this._agent.invoke_requestChildNodes({nodeId:this.id,depth:e,pierce:t}))[ProtocolClient.InspectorBackend.ProtocolError]?null:this._children}getOuterHTML(){return this._agent.getOuterHTML(this.id)}setOuterHTML(e,t){this._agent.invoke_setOuterHTML({nodeId:this.id,outerHTML:e}).then(e=>{e[ProtocolClient.InspectorBackend.ProtocolError]||this._domModel.markUndoableState(),t&&t(e[ProtocolClient.InspectorBackend.ProtocolError]||null)})}removeNode(e){this._agent.invoke_removeNode({nodeId:this.id}).then(t=>{t[ProtocolClient.InspectorBackend.ProtocolError]||this._domModel.markUndoableState(),e&&e(t[ProtocolClient.InspectorBackend.ProtocolError]||null)})}async copyNode(){const e=await this._agent.getOuterHTML(this.id);return null!==e&&Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText(e),e}path(){function e(e){return e&&("index"in e||e.isShadowRoot()&&e.parentNode)&&e._nodeName.length}const t=[];let o=this;for(;e(o);){const e="number"==typeof o.index?o.index:o.shadowRootType()===DOMNode.ShadowRootTypes.UserAgent?"u":"a";t.push([e,o._nodeName]),o=o.parentNode}return t.reverse(),t.join(",")}isAncestor(e){if(!e)return!1;let t=e.parentNode;for(;t;){if(this===t)return!0;t=t.parentNode}return!1}isDescendant(e){return null!==e&&e.isAncestor(this)}frameId(){let e=this.parentNode||this;for(;!e._frameOwnerFrameId&&e.parentNode;)e=e.parentNode;return e._frameOwnerFrameId}_setAttributesPayload(e){let t=!this._attributes||e.length!==2*this._attributes.size;const o=this._attributes||new Map;this._attributes=new Map;for(let s=0;s<e.length;s+=2){const n=e[s],d=e[s+1];this._addAttribute(n,d),t||(o.has(n)&&o.get(n).value===d||(t=!0))}return t}_insertChild(e,t){const o=DOMNode.create(this._domModel,this.ownerDocument,this._isInShadowTree,t);return this._children.splice(this._children.indexOf(e)+1,0,o),this._renumber(),o}_removeChild(e){if(e.pseudoType())this._pseudoElements.delete(e.pseudoType());else{const t=this._shadowRoots.indexOf(e);-1!==t?this._shadowRoots.splice(t,1):(console.assert(-1!==this._children.indexOf(e)),this._children.splice(this._children.indexOf(e),1))}e.parentNode=null,this._subtreeMarkerCount-=e._subtreeMarkerCount,e._subtreeMarkerCount&&this._domModel.dispatchEventToListeners(Events.MarkersChanged,this),this._renumber()}_setChildrenPayload(e){this._children=[];for(let t=0;t<e.length;++t){const o=e[t],s=DOMNode.create(this._domModel,this.ownerDocument,this._isInShadowTree,o);this._children.push(s)}this._renumber()}_setPseudoElements(e){if(this._pseudoElements=new Map,e)for(let t=0;t<e.length;++t){const o=DOMNode.create(this._domModel,this.ownerDocument,this._isInShadowTree,e[t]);o.parentNode=this,this._pseudoElements.set(o.pseudoType(),o)}}_setDistributedNodePayloads(e){this._distributedNodes=[];for(const t of e)this._distributedNodes.push(new DOMNodeShortcut(this._domModel.target(),t.backendNodeId,t.nodeType,t.nodeName))}_renumber(){if(this._childNodeCount=this._children.length,0===this._childNodeCount)return this.firstChild=null,void(this.lastChild=null);this.firstChild=this._children[0],this.lastChild=this._children[this._childNodeCount-1];for(let e=0;e<this._childNodeCount;++e){const t=this._children[e];t.index=e,t.nextSibling=e+1<this._childNodeCount?this._children[e+1]:null,t.previousSibling=e-1>=0?this._children[e-1]:null,t.parentNode=this}}_addAttribute(e,t){const o={name:e,value:t,_node:this};this._attributes.set(e,o)}_setAttribute(e,t){const o=this._attributes.get(e);o?o.value=t:this._addAttribute(e,t)}_removeAttribute(e){this._attributes.delete(e)}copyTo(e,t,o){this._agent.invoke_copyTo({nodeId:this.id,targetNodeId:e.id,insertBeforeNodeId:t?t.id:void 0}).then(e=>{e[ProtocolClient.InspectorBackend.ProtocolError]||this._domModel.markUndoableState(),o&&o(e[ProtocolClient.InspectorBackend.ProtocolError]||null,e.nodeId)})}moveTo(e,t,o){this._agent.invoke_moveTo({nodeId:this.id,targetNodeId:e.id,insertBeforeNodeId:t?t.id:void 0}).then(e=>{e[ProtocolClient.InspectorBackend.ProtocolError]||this._domModel.markUndoableState(),o&&o(e[ProtocolClient.InspectorBackend.ProtocolError]||null,this._domModel.nodeForId(e.nodeId))})}isXMLNode(){return!!this._xmlVersion}setMarker(e,t){if(null!==t){if(this.parentNode&&!this._markers.has(e))for(let e=this;e;e=e.parentNode)++e._subtreeMarkerCount;this._markers.set(e,t);for(let e=this;e;e=e.parentNode)this._domModel.dispatchEventToListeners(Events.MarkersChanged,e)}else{if(!this._markers.has(e))return;this._markers.delete(e);for(let e=this;e;e=e.parentNode)--e._subtreeMarkerCount;for(let e=this;e;e=e.parentNode)this._domModel.dispatchEventToListeners(Events.MarkersChanged,e)}}marker(e){return this._markers.get(e)||null}traverseMarkers(e){!function t(o){if(o._subtreeMarkerCount){for(const t of o._markers.keys())e(o,t);if(o._children)for(const e of o._children)t(e)}}(this)}resolveURL(e){if(!e)return e;for(let t=this;t;t=t.parentNode)if(t.baseURL)return Common.ParsedURL.ParsedURL.completeURL(t.baseURL,e);return null}highlight(e){this._domModel.overlayModel().highlightInOverlay({node:this},e)}highlightForTwoSeconds(){this._domModel.overlayModel().highlightInOverlayForTwoSeconds({node:this})}async resolveToObject(e){const t=await this._agent.resolveNode(this.id,void 0,e);return t&&this._domModel._runtimeModel.createRemoteObject(t)}boxModel(){return this._agent.getBoxModel(this.id)}setAsInspectedNode(){let e=this;for(e.pseudoType()&&(e=e.parentNode);;){let t=e.ancestorUserAgentShadowRoot();if(!t)break;if(t=e.ancestorShadowHost(),!t)break;e=t}this._agent.setInspectedNode(e.id)}enclosingElementOrSelf(){let e=this;return e&&e.nodeType()===Node.TEXT_NODE&&e.parentNode&&(e=e.parentNode),e&&e.nodeType()!==Node.ELEMENT_NODE&&(e=null),e}async scrollIntoView(){const e=this.enclosingElementOrSelf();if(!e)return;const t=await e.resolveToObject();t&&(t.callFunction((function(){this.scrollIntoViewIfNeeded(!0)})),t.release(),e.highlightForTwoSeconds())}async focus(){const e=this.enclosingElementOrSelf(),t=await e.resolveToObject();t&&(await t.callFunction((function(){this.focus()})),t.release(),e.highlightForTwoSeconds(),this._domModel.target().pageAgent().bringToFront())}simpleSelector(){const e=this.localName()||this.nodeName().toLowerCase();return this.nodeType()!==Node.ELEMENT_NODE?e:"input"!==e||!this.getAttribute("type")||this.getAttribute("id")||this.getAttribute("class")?this.getAttribute("id")?e+"#"+this.getAttribute("id"):this.getAttribute("class")?("div"===e?"":e)+"."+this.getAttribute("class").trim().replace(/\s+/g,"."):e:e+'[type="'+this.getAttribute("type")+'"]'}}DOMNode.PseudoElementNames={Before:"before",After:"after",Marker:"marker"},DOMNode.ShadowRootTypes={UserAgent:"user-agent",Open:"open",Closed:"closed"};export class DeferredDOMNode{constructor(e,t){this._domModel=e.model(DOMModel),this._backendNodeId=t}resolve(e){this.resolvePromise().then(e)}async resolvePromise(){const e=await this._domModel.pushNodesByBackendIdsToFrontend(new Set([this._backendNodeId]));return e&&e.get(this._backendNodeId)||null}backendNodeId(){return this._backendNodeId}domModel(){return this._domModel}highlight(){this._domModel.overlayModel().highlightInOverlay({deferredNode:this})}}export class DOMNodeShortcut{constructor(e,t,o,s){this.nodeType=o,this.nodeName=s,this.deferredNode=new DeferredDOMNode(e,t)}}export class DOMDocument extends DOMNode{constructor(e,t){super(e),this._init(this,!1,t),this.documentURL=t.documentURL||"",this.baseURL=t.baseURL||""}}export class DOMModel extends SDKModel{constructor(e){super(e),this._agent=e.domAgent(),this._idToDOMNode={},this._document=null,this._attributeLoadNodeIds=new Set,e.registerDOMDispatcher(new DOMDispatcher(this)),this._runtimeModel=e.model(RuntimeModel),this._lastMutationId,this._pendingDocumentRequestPromise,e.suspended()||this._agent.invoke_enable({}),Root.Runtime.experiments.isEnabled("captureNodeCreationStacks")&&this._agent.invoke_setNodeStackTracesEnabled({enable:!0})}runtimeModel(){return this._runtimeModel}cssModel(){return this.target().model(CSSModel)}overlayModel(){return this.target().model(OverlayModel)}static cancelSearch(){for(const e of TargetManager.instance().models(DOMModel))e._cancelSearch()}_scheduleMutationEvent(e){this.hasEventListeners(Events.DOMMutated)&&(this._lastMutationId=(this._lastMutationId||0)+1,Promise.resolve().then(function(e,t){if(!this.hasEventListeners(Events.DOMMutated)||this._lastMutationId!==t)return;this.dispatchEventToListeners(Events.DOMMutated,e)}.bind(this,e,this._lastMutationId)))}requestDocument(){return this._document?Promise.resolve(this._document):(this._pendingDocumentRequestPromise||(this._pendingDocumentRequestPromise=this._requestDocument()),this._pendingDocumentRequestPromise)}async getOwnerNodeForFrame(e){const t=await this._agent.invoke_getFrameOwner({frameId:e});return t.getError()?null:new DeferredDOMNode(this.target(),t.backendNodeId)}async _requestDocument(){const{root:e}=await this._agent.invoke_getDocument();if(delete this._pendingDocumentRequestPromise,e&&this._setDocument(e),!this._document)return console.error("No document"),null;const t=this.parentModel();if(t&&!this._frameOwnerNode){await t.requestDocument();const e=await t._agent.invoke_getFrameOwner({frameId:this.target().id()});!e.getError()&&e.nodeId&&(this._frameOwnerNode=t.nodeForId(e.nodeId))}if(this._frameOwnerNode){const e=this._frameOwnerNode._contentDocument;this._frameOwnerNode._contentDocument=this._document,this._frameOwnerNode._children=[],this._document?(this._document.parentNode=this._frameOwnerNode,this.dispatchEventToListeners(Events.NodeInserted,this._document)):e&&this.dispatchEventToListeners(Events.NodeRemoved,{node:e,parent:this._frameOwnerNode})}return this._document}existingDocument(){return this._document}async pushNodeToFrontend(e){await this.requestDocument();const{nodeId:t}=await this._agent.invoke_requestNode({objectId:e});return t?this.nodeForId(t):null}pushNodeByPathToFrontend(e){return this.requestDocument().then(()=>this._agent.invoke_pushNodeByPathToFrontend({path:e})).then(({nodeId:e})=>e)}async pushNodesByBackendIdsToFrontend(e){await this.requestDocument();const t=[...e],{nodeIds:o}=await this._agent.invoke_pushNodesByBackendIdsToFrontend({backendNodeIds:t});if(!o)return null;const s=new Map;for(let e=0;e<o.length;++e)o[e]&&s.set(t[e],this.nodeForId(o[e]));return s}_attributeModified(e,t,o){const s=this._idToDOMNode[e];s&&(s._setAttribute(t,o),this.dispatchEventToListeners(Events.AttrModified,{node:s,name:t}),this._scheduleMutationEvent(s))}_attributeRemoved(e,t){const o=this._idToDOMNode[e];o&&(o._removeAttribute(t),this.dispatchEventToListeners(Events.AttrRemoved,{node:o,name:t}),this._scheduleMutationEvent(o))}_inlineStyleInvalidated(e){Platform.SetUtilities.addAll(this._attributeLoadNodeIds,e),this._loadNodeAttributesTimeout||(this._loadNodeAttributesTimeout=setTimeout(this._loadNodeAttributes.bind(this),20))}_loadNodeAttributes(){delete this._loadNodeAttributesTimeout;for(const e of this._attributeLoadNodeIds)this._agent.invoke_getAttributes({nodeId:e}).then(({attributes:t})=>{if(!t)return;const o=this._idToDOMNode[e];o&&o._setAttributesPayload(t)&&(this.dispatchEventToListeners(Events.AttrModified,{node:o,name:"style"}),this._scheduleMutationEvent(o))});this._attributeLoadNodeIds.clear()}_characterDataModified(e,t){const o=this._idToDOMNode[e];o._nodeValue=t,this.dispatchEventToListeners(Events.CharacterDataModified,o),this._scheduleMutationEvent(o)}nodeForId(e){return this._idToDOMNode[e]||null}_documentUpdated(){const e=this._document||this._pendingDocumentRequestPromise;this._setDocument(null),this.parentModel()&&e&&this.requestDocument()}_setDocument(e){this._idToDOMNode={},this._document=e&&"nodeId"in e?new DOMDocument(this,e):null,DOMModelUndoStack.instance()._dispose(this),this.parentModel()||this.dispatchEventToListeners(Events.DocumentUpdated,this)}_setDetachedRoot(e){"#document"===e.nodeName?new DOMDocument(this,e):DOMNode.create(this,null,!1,e)}_setChildNodes(e,t){if(!e&&t.length)return void this._setDetachedRoot(t[0]);this._idToDOMNode[e]._setChildrenPayload(t)}_childNodeCountUpdated(e,t){const o=this._idToDOMNode[e];o._childNodeCount=t,this.dispatchEventToListeners(Events.ChildNodeCountUpdated,o),this._scheduleMutationEvent(o)}_childNodeInserted(e,t,o){const s=this._idToDOMNode[e],n=this._idToDOMNode[t],d=s._insertChild(n,o);this._idToDOMNode[d.id]=d,this.dispatchEventToListeners(Events.NodeInserted,d),this._scheduleMutationEvent(d)}_childNodeRemoved(e,t){const o=this._idToDOMNode[e],s=this._idToDOMNode[t];o._removeChild(s),this._unbind(s),this.dispatchEventToListeners(Events.NodeRemoved,{node:s,parent:o}),this._scheduleMutationEvent(s)}_shadowRootPushed(e,t){const o=this._idToDOMNode[e];if(!o)return;const s=DOMNode.create(this,o.ownerDocument,!0,t);s.parentNode=o,this._idToDOMNode[s.id]=s,o._shadowRoots.unshift(s),this.dispatchEventToListeners(Events.NodeInserted,s),this._scheduleMutationEvent(s)}_shadowRootPopped(e,t){const o=this._idToDOMNode[e];if(!o)return;const s=this._idToDOMNode[t];s&&(o._removeChild(s),this._unbind(s),this.dispatchEventToListeners(Events.NodeRemoved,{node:s,parent:o}),this._scheduleMutationEvent(s))}_pseudoElementAdded(e,t){const o=this._idToDOMNode[e];if(!o)return;const s=DOMNode.create(this,o.ownerDocument,!1,t);s.parentNode=o,this._idToDOMNode[s.id]=s,console.assert(!o._pseudoElements.get(s.pseudoType())),o._pseudoElements.set(s.pseudoType(),s),this.dispatchEventToListeners(Events.NodeInserted,s),this._scheduleMutationEvent(s)}_pseudoElementRemoved(e,t){const o=this._idToDOMNode[e];if(!o)return;const s=this._idToDOMNode[t];s&&(o._removeChild(s),this._unbind(s),this.dispatchEventToListeners(Events.NodeRemoved,{node:s,parent:o}),this._scheduleMutationEvent(s))}_distributedNodesUpdated(e,t){const o=this._idToDOMNode[e];o&&(o._setDistributedNodePayloads(t),this.dispatchEventToListeners(Events.DistributedNodesChanged,o),this._scheduleMutationEvent(o))}_unbind(e){delete this._idToDOMNode[e.id];for(let t=0;e._children&&t<e._children.length;++t)this._unbind(e._children[t]);for(let t=0;t<e._shadowRoots.length;++t)this._unbind(e._shadowRoots[t]);const t=e.pseudoElements();for(const e of t.values())this._unbind(e);e._templateContent&&this._unbind(e._templateContent)}async getNodesByStyle(e,t=!1){const o=await this._agent.invoke_getNodesForSubtreeByStyle({nodeId:this._document.id,computedStyles:e,pierce:t});if(o.getError())throw o.getError();return o.nodeIds}async performSearch(e,t){const o=await this._agent.invoke_performSearch({query:e,includeUserAgentShadowDOM:t});return o.getError()||(this._searchId=o.searchId),o.getError()?0:o.resultCount}async searchResult(e){if(!this._searchId)return null;const{nodeIds:t}=await this._agent.invoke_getSearchResults({searchId:this._searchId,fromIndex:e,toIndex:e+1});return t&&1===t.length?this.nodeForId(t[0]):null}_cancelSearch(){this._searchId&&(this._agent.invoke_discardSearchResults({searchId:this._searchId}),delete this._searchId)}classNamesPromise(e){return this._agent.invoke_collectClassNamesFromSubtree({nodeId:e}).then(({classNames:e})=>e||[])}querySelector(e,t){return this._agent.invoke_querySelector({nodeId:e,selector:t}).then(({nodeId:e})=>e)}querySelectorAll(e,t){return this._agent.invoke_querySelectorAll({nodeId:e,selector:t}).then(({nodeIds:e})=>e)}markUndoableState(e){DOMModelUndoStack.instance()._markUndoableState(this,e||!1)}async nodeForLocation(e,t,o){const s=await this._agent.invoke_getNodeForLocation({x:e,y:t,includeUserAgentShadowDOM:o});return s.getError()||!s.nodeId?null:this.nodeForId(s.nodeId)}pushObjectAsNodeToFrontend(e){return e.isNode()?this.pushNodeToFrontend(e.objectId):Promise.resolve(null)}suspendModel(){return this._agent.invoke_disable().then(()=>this._setDocument(null))}async resumeModel(){await this._agent.invoke_enable()}dispose(){DOMModelUndoStack.instance()._dispose(this)}parentModel(){const e=this.target().parentTarget();return e?e.model(DOMModel):null}}export const Events={AttrModified:Symbol("AttrModified"),AttrRemoved:Symbol("AttrRemoved"),CharacterDataModified:Symbol("CharacterDataModified"),DOMMutated:Symbol("DOMMutated"),NodeInserted:Symbol("NodeInserted"),NodeRemoved:Symbol("NodeRemoved"),DocumentUpdated:Symbol("DocumentUpdated"),ChildNodeCountUpdated:Symbol("ChildNodeCountUpdated"),DistributedNodesChanged:Symbol("DistributedNodesChanged"),MarkersChanged:Symbol("MarkersChanged")};class DOMDispatcher{constructor(e){this._domModel=e}usesObjectNotation(){return!0}documentUpdated(){this._domModel._documentUpdated()}attributeModified({nodeId:e,name:t,value:o}){this._domModel._attributeModified(e,t,o)}attributeRemoved({nodeId:e,name:t}){this._domModel._attributeRemoved(e,t)}inlineStyleInvalidated({nodeIds:e}){this._domModel._inlineStyleInvalidated(e)}characterDataModified({nodeId:e,characterData:t}){this._domModel._characterDataModified(e,t)}setChildNodes({parentId:e,nodes:t}){this._domModel._setChildNodes(e,t)}childNodeCountUpdated({nodeId:e,childNodeCount:t}){this._domModel._childNodeCountUpdated(e,t)}childNodeInserted({parentNodeId:e,previousNodeId:t,node:o}){this._domModel._childNodeInserted(e,t,o)}childNodeRemoved({parentNodeId:e,nodeId:t}){this._domModel._childNodeRemoved(e,t)}shadowRootPushed({hostId:e,root:t}){this._domModel._shadowRootPushed(e,t)}shadowRootPopped({hostId:e,rootId:t}){this._domModel._shadowRootPopped(e,t)}pseudoElementAdded({parentId:e,pseudoElement:t}){this._domModel._pseudoElementAdded(e,t)}pseudoElementRemoved({parentId:e,pseudoElementId:t}){this._domModel._pseudoElementRemoved(e,t)}distributedNodesUpdated({insertionPointId:e,distributedNodes:t}){this._domModel._distributedNodesUpdated(e,t)}}let DOMModelUndoStackInstance;export class DOMModelUndoStack{constructor(){this._stack=[],this._index=0,this._lastModelWithMinorChange=null}static instance(e={forceNew:null}){const{forceNew:t}=e;return DOMModelUndoStackInstance&&!t||(DOMModelUndoStackInstance=new DOMModelUndoStack),DOMModelUndoStackInstance}_markUndoableState(e,t){this._lastModelWithMinorChange&&e!==this._lastModelWithMinorChange&&(this._lastModelWithMinorChange.markUndoableState(),this._lastModelWithMinorChange=null),t&&this._lastModelWithMinorChange===e||(this._stack=this._stack.slice(0,this._index),this._stack.push(e),this._index=this._stack.length,t?this._lastModelWithMinorChange=e:(e._agent.markUndoableState(),this._lastModelWithMinorChange=null))}undo(){return 0===this._index?Promise.resolve():(--this._index,this._lastModelWithMinorChange=null,this._stack[this._index]._agent.undo())}redo(){return this._index>=this._stack.length?Promise.resolve():(++this._index,this._lastModelWithMinorChange=null,this._stack[this._index-1]._agent.redo())}_dispose(e){let t=0;for(let o=0;o<this._index;++o)this._stack[o]===e&&++t;Platform.ArrayUtilities.removeElement(this._stack,e),this._index-=t,this._lastModelWithMinorChange===e&&(this._lastModelWithMinorChange=null)}}SDKModel.register(DOMModel,Capability.DOM,!0);export let Attribute;