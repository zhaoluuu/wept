import*as Common from"../common/common.js";import*as Host from"../host/host.js";import*as ProtocolClient from"../protocol_client/protocol_client.js";import*as Root from"../root/root.js";import{GetPropertiesResult,RemoteObject,RemoteObjectImpl,ScopeRef}from"./RemoteObject.js";import{EvaluationOptions,EvaluationResult,ExecutionContext,RuntimeModel}from"./RuntimeModel.js";import{Script}from"./Script.js";import{Capability,SDKModel,Target,Type}from"./SDKModel.js";import{SourceMapManager}from"./SourceMapManager.js";function contained(e,t){const{start:s,end:i}=t;return s.scriptId===e.scriptId&&(!(e.lineNumber<s.lineNumber||e.lineNumber>i.lineNumber)&&(!(e.lineNumber===s.lineNumber&&e.columnNumber<s.columnNumber)&&!(e.lineNumber===i.lineNumber&&e.columnNumber>=i.columnNumber)))}export class DebuggerModel extends SDKModel{constructor(e){super(e),e.registerDebuggerDispatcher(new DebuggerDispatcher(this)),this._agent=e.debuggerAgent(),this._runtimeModel=e.model(RuntimeModel),this._sourceMapManager=new SourceMapManager(e),this._sourceMapIdToScript=new Map,this._debuggerPausedDetails=null,this._scripts=new Map,this._scriptsBySourceURL=new Map,this._discardableScripts=[],this._continueToLocationCallback=null,this._selectedCallFrame=null,this._debuggerEnabled=!1,this._debuggerId=null,this._skipAllPausesTimeout=0,this._beforePausedCallback=null,this._breakpointResolvedEventTarget=new Common.ObjectWrapper.ObjectWrapper,this._autoStepSkipList=[],this._autoStepOver=!1,this._isPausing=!1,Common.Settings.Settings.instance().moduleSetting("pauseOnExceptionEnabled").addChangeListener(this._pauseOnExceptionStateChanged,this),Common.Settings.Settings.instance().moduleSetting("pauseOnCaughtException").addChangeListener(this._pauseOnExceptionStateChanged,this),Common.Settings.Settings.instance().moduleSetting("disableAsyncStackTraces").addChangeListener(this._asyncStackTracesStateChanged,this),Common.Settings.Settings.instance().moduleSetting("breakpointsActive").addChangeListener(this._breakpointsActiveChanged,this),e.suspended()||this._enableDebugger(),this._stringMap=new Map,this._sourceMapManager.setEnabled(Common.Settings.Settings.instance().moduleSetting("jsSourceMapsEnabled").get()),Common.Settings.Settings.instance().moduleSetting("jsSourceMapsEnabled").addChangeListener(e=>this._sourceMapManager.setEnabled(e.data))}static _sourceMapId(e,t,s){return s?e+":"+t+":"+s:null}sourceMapManager(){return this._sourceMapManager}runtimeModel(){return this._runtimeModel}debuggerEnabled(){return!!this._debuggerEnabled}async _enableDebugger(){if(this._debuggerEnabled)return Promise.resolve();this._debuggerEnabled=!0;const e=Root.Runtime.Runtime.queryParam("remoteFrontend")||Root.Runtime.Runtime.queryParam("ws")?1e7:1e8,t=this._agent.invoke_enable({maxScriptsCacheSize:e});t.then(this._registerDebugger.bind(this)),this._pauseOnExceptionStateChanged(),this._asyncStackTracesStateChanged(),Common.Settings.Settings.instance().moduleSetting("breakpointsActive").get()||this._breakpointsActiveChanged(),_scheduledPauseOnAsyncCall&&this._pauseOnAsyncCall(_scheduledPauseOnAsyncCall),this.dispatchEventToListeners(Events.DebuggerWasEnabled,this),await t}_registerDebugger(e){if(e.getError())return;const{debuggerId:t}=e;_debuggerIdToModel.set(t,this),this._debuggerId=t,this.dispatchEventToListeners(Events.DebuggerIsReadyToPause,this)}isReadyToPause(){return!!this._debuggerId}static modelForDebuggerId(e){return _debuggerIdToModel.get(e)||null}async _disableDebugger(){if(!this._debuggerEnabled)return Promise.resolve();this._debuggerEnabled=!1,await this._asyncStackTracesStateChanged(),await this._agent.invoke_disable(),this._isPausing=!1,this.globalObjectCleared(),this.dispatchEventToListeners(Events.DebuggerWasDisabled),"string"==typeof this._debuggerId&&_debuggerIdToModel.delete(this._debuggerId)}_skipAllPauses(e){this._skipAllPausesTimeout&&(clearTimeout(this._skipAllPausesTimeout),this._skipAllPausesTimeout=0),this._agent.invoke_setSkipAllPauses({skip:e})}skipAllPausesUntilReloadOrTimeout(e){this._skipAllPausesTimeout&&clearTimeout(this._skipAllPausesTimeout),this._agent.invoke_setSkipAllPauses({skip:!0}),this._skipAllPausesTimeout=setTimeout(this._skipAllPauses.bind(this,!1),e)}_pauseOnExceptionStateChanged(){let e;e=Common.Settings.Settings.instance().moduleSetting("pauseOnExceptionEnabled").get()?Common.Settings.Settings.instance().moduleSetting("pauseOnCaughtException").get()?Protocol.Debugger.SetPauseOnExceptionsRequestState.All:Protocol.Debugger.SetPauseOnExceptionsRequestState.Uncaught:Protocol.Debugger.SetPauseOnExceptionsRequestState.None,this._agent.invoke_setPauseOnExceptions({state:e})}_asyncStackTracesStateChanged(){const e=!Common.Settings.Settings.instance().moduleSetting("disableAsyncStackTraces").get()&&this._debuggerEnabled?32:0;return this._agent.invoke_setAsyncCallStackDepth({maxDepth:e})}_breakpointsActiveChanged(){this._agent.invoke_setBreakpointsActive({active:Common.Settings.Settings.instance().moduleSetting("breakpointsActive").get()})}async _computeAutoStepSkipList(){const e=Bindings.DebuggerWorkspaceBinding.instance().getLanguagePluginManager(this);if(e){const t=this._debuggerPausedDetails.callFrames[0].location(),s=await e.rawLocationToUILocation(t);if(s){const i=await e.uiLocationToRawLocationRanges(s.uiSourceCode,s.lineNumber,s.columnNumber);if(i)return i.filter(e=>contained(t,e))}}return[]}async stepInto(){this._autoStepSkipList=await this._computeAutoStepSkipList(),this._agent.invoke_stepInto({breakOnAsyncCall:!1})}async stepOver(){this._autoStepOver=!0,this._autoStepSkipList=await this._computeAutoStepSkipList(),this._agent.invoke_stepOver({})}stepOut(){this._agent.invoke_stepOut()}scheduleStepIntoAsync(){this._agent.invoke_stepInto({breakOnAsyncCall:!0})}resume(){this._agent.invoke_resume({terminateOnResume:!1}),this._isPausing=!1}pause(){this._isPausing=!0,this._skipAllPauses(!1),this._agent.invoke_pause()}_pauseOnAsyncCall(e){return this._agent.invoke_pauseOnAsyncCall({parentStackTraceId:e})}async setBreakpointByURL(e,t,s,i){let r;if(this.target().type()===Type.Node){r=`${Common.ParsedURL.ParsedURL.urlToPlatformPath(e,Host.Platform.isWin()).escapeForRegExp()}|${e.escapeForRegExp()}`}let a=0;const o=this._scriptsBySourceURL.get(e)||[];for(let e=0,s=o.length;e<s;++e){const s=o[e];t===s.lineOffset&&(a=a?Math.min(a,s.columnOffset):s.columnOffset)}s=Math.max(s||0,a);const n=await this._agent.invoke_setBreakpointByUrl({lineNumber:t,url:r?void 0:e,urlRegex:r,columnNumber:s,condition:i});if(n.getError())return{locations:[],breakpointId:null};let c=[];return n.locations&&(c=n.locations.map(e=>Location.fromPayload(this,e))),{locations:c,breakpointId:n.breakpointId}}async setBreakpointInAnonymousScript(e,t,s,i,r){const a=await this._agent.invoke_setBreakpointByUrl({lineNumber:s,scriptHash:t,columnNumber:i,condition:r}),o=a.getError();if(o)return"Either url or urlRegex must be specified."!==o?{locations:[],breakpointId:null}:this._setBreakpointBySourceId(e,s,i,r);let n=[];return a.locations&&(n=a.locations.map(e=>Location.fromPayload(this,e))),{locations:n,breakpointId:a.breakpointId}}async _setBreakpointBySourceId(e,t,s,i){const r=await this._agent.invoke_setBreakpoint({location:{scriptId:e,lineNumber:t,columnNumber:s},condition:i});if(r.getError())return{breakpointId:null,locations:[]};let a=[];return r.actualLocation&&(a=[Location.fromPayload(this,r.actualLocation)]),{locations:a,breakpointId:r.breakpointId}}async removeBreakpoint(e){const t=await this._agent.invoke_removeBreakpoint({breakpointId:e});t.getError()&&console.error("Failed to remove breakpoint: "+t.getError())}async getPossibleBreakpoints(e,t,s){const i=await this._agent.invoke_getPossibleBreakpoints({start:e.payload(),end:t?t.payload():void 0,restrictToFunction:s});return i.getError()||!i.locations?[]:i.locations.map(e=>BreakLocation.fromPayload(this,e))}async fetchAsyncStackTrace(e){const t=await this._agent.invoke_getStackTrace({stackTraceId:e});return t.getError()?null:t.stackTrace}_breakpointResolved(e,t){this._breakpointResolvedEventTarget.dispatchEventToListeners(e,Location.fromPayload(this,t))}globalObjectCleared(){this._setDebuggerPausedDetails(null),this._reset(),this.dispatchEventToListeners(Events.GlobalObjectCleared,this)}_reset(){for(const e of this._sourceMapIdToScript.values())this._sourceMapManager.detachSourceMap(e);const e=Bindings.DebuggerWorkspaceBinding.instance().getLanguagePluginManager(this);if(e)for(const t of this._scripts.values())e.removeScript(t);this._sourceMapIdToScript.clear(),this._scripts.clear(),this._scriptsBySourceURL.clear(),this._stringMap.clear(),this._discardableScripts=[],this._autoStepOver=!1,this._autoStepSkipList=[]}scripts(){return Array.from(this._scripts.values())}scriptForId(e){return this._scripts.get(e)||null}scriptsForSourceURL(e){return e&&this._scriptsBySourceURL.get(e)||[]}scriptsForExecutionContext(e){const t=[];for(const s of this._scripts.values())s.executionContextId===e.id&&t.push(s);return t}setScriptSource(e,t,s){const i=this._scripts.get(e);i&&i.editSource(t,this._didEditScriptSource.bind(this,e,t,s))}_didEditScriptSource(e,t,s,i,r,a,o,n,c){s(i,r),c?this.stepInto():!i&&a&&a.length&&this._debuggerPausedDetails&&this._pausedScript(a,this._debuggerPausedDetails.reason,this._debuggerPausedDetails.auxData,this._debuggerPausedDetails.breakpointIds,o,n)}get callFrames(){return this._debuggerPausedDetails?this._debuggerPausedDetails.callFrames:null}debuggerPausedDetails(){return this._debuggerPausedDetails}async _setDebuggerPausedDetails(e){if(this._isPausing=!1,this._debuggerPausedDetails=e,e){const t=e.callFrames[0].location();for(const e of this._autoStepSkipList)if(contained(t,e))return!1;if(this._beforePausedCallback&&!this._beforePausedCallback.call(null,e))return!1;const s=Bindings.DebuggerWorkspaceBinding.instance().getLanguagePluginManager(this);if(s)for(const t of e.callFrames)t.sourceScopeChain=await s.resolveScopeChain(t);this._autoStepOver=!1,this._autoStepSkipList=[],this.dispatchEventToListeners(Events.DebuggerPaused,this),this.setSelectedCallFrame(e.callFrames[0])}else this.setSelectedCallFrame(null);return!0}setBeforePausedCallback(e){this._beforePausedCallback=e}async _pausedScript(e,t,s,i,r,a,o){if(o){_scheduledPauseOnAsyncCall=o;const e=[];for(const t of _debuggerIdToModel.values())e.push(t._pauseOnAsyncCall(o));return await Promise.all(e),void this.resume()}const n=new DebuggerPausedDetails(this,e,t,s,i,r,a);if(this._continueToLocationCallback){const e=this._continueToLocationCallback;if(this._continueToLocationCallback=null,e(n))return}await this._setDebuggerPausedDetails(n)||(this._autoStepOver?this._agent.invoke_stepOver({}):this._agent.invoke_stepInto({breakOnAsyncCall:!1})),_scheduledPauseOnAsyncCall=null}_resumedScript(){this._setDebuggerPausedDetails(null),this.dispatchEventToListeners(Events.DebuggerResumed,this)}_parsedScriptSource(e,t,s,i,r,a,o,n,c,l,u,d,p,g,h,m,_,b,S){const y=this._scripts.get(e);if(y)return y;let k=!1;c&&"isDefault"in c&&(k=!c.isDefault),t=this._internString(t);const C=new Script(this,e,t,s,i,r,a,o,this._internString(n),k,l,u,d,g,h,m,_,b,S);this._registerScript(C),this.dispatchEventToListeners(Events.ParsedScriptSource,C);const f=Bindings.DebuggerWorkspaceBinding.instance().getLanguagePluginManager(this);if(!Root.Runtime.experiments.isEnabled("wasmDWARFDebugging")||!f||!f.hasPluginForScript(C)){const e=DebuggerModel._sourceMapId(C.executionContextId,C.sourceURL,C.sourceMapURL);if(e&&!p){const t=this._sourceMapIdToScript.get(e);t&&this._sourceMapManager.detachSourceMap(t),this._sourceMapIdToScript.set(e,C),this._sourceMapManager.attachSourceMap(C,C.sourceURL,C.sourceMapURL)}}return p&&C.isAnonymousScript()&&(this._discardableScripts.push(C),this._collectDiscardedScripts()),C}setSourceMapURL(e,t){let s=DebuggerModel._sourceMapId(e.executionContextId,e.sourceURL,e.sourceMapURL);s&&this._sourceMapIdToScript.get(s)===e&&this._sourceMapIdToScript.delete(s),this._sourceMapManager.detachSourceMap(e),e.sourceMapURL=t,s=DebuggerModel._sourceMapId(e.executionContextId,e.sourceURL,e.sourceMapURL),s&&(this._sourceMapIdToScript.set(s,e),this._sourceMapManager.attachSourceMap(e,e.sourceURL,e.sourceMapURL))}executionContextDestroyed(e){const t=Array.from(this._sourceMapIdToScript.keys());for(const s of t){const t=this._sourceMapIdToScript.get(s);t&&t.executionContextId===e.id&&(this._sourceMapIdToScript.delete(s),this._sourceMapManager.detachSourceMap(t))}}_registerScript(e){if(this._scripts.set(e.scriptId,e),e.isAnonymousScript())return;let t=this._scriptsBySourceURL.get(e.sourceURL);t||(t=[],this._scriptsBySourceURL.set(e.sourceURL,t)),t.push(e)}_unregisterScript(e){console.assert(e.isAnonymousScript()),this._scripts.delete(e.scriptId)}_collectDiscardedScripts(){if(this._discardableScripts.length<1e3)return;const e=this._discardableScripts.splice(0,100);for(const t of e)this._unregisterScript(t),this.dispatchEventToListeners(Events.DiscardedAnonymousScriptSource,t)}createRawLocation(e,t,s){return new Location(this,e.scriptId,t,s)}createRawLocationByURL(e,t,s){let i=null;const r=this._scriptsBySourceURL.get(e)||[];for(let e=0,a=r.length;e<a;++e){const a=r[e];if(i||(i=a),!(a.lineOffset>t||a.lineOffset===t&&a.columnOffset>s||a.endLine<t||a.endLine===t&&a.endColumn<=s)){i=a;break}}return i?new Location(this,i.scriptId,t,s):null}createRawLocationByScriptId(e,t,s){const i=this.scriptForId(e);return i?this.createRawLocation(i,t,s):null}createRawLocationsByStackTrace(e){const t=[];let s=e;for(;s;){for(const e of s.callFrames)t.push(e);s=s.parent}const i=[];for(const e of t){const t=this.createRawLocationByScriptId(e.scriptId,e.lineNumber,e.columnNumber);t&&i.push(t)}return i}isPaused(){return!!this.debuggerPausedDetails()}isPausing(){return this._isPausing}setSelectedCallFrame(e){this._selectedCallFrame!==e&&(this._selectedCallFrame=e,this.dispatchEventToListeners(Events.CallFrameSelected,this))}selectedCallFrame(){return this._selectedCallFrame}async evaluateOnSelectedCallFrame(e){const t=this.selectedCallFrame();if(!t)throw new Error("No call frame selected");return t.evaluate(e)}executeWasmEvaluator(e,t){return this._agent.invoke_executeWasmEvaluator({callFrameId:e,evaluator:t})}functionDetailsPromise(e){return e.getAllProperties(!1,!1).then(function(e){if(!e)return null;let t=null;if(e.internalProperties)for(const s of e.internalProperties)"[[FunctionLocation]]"===s.name&&(t=s.value);let s=null;if(e.properties)for(const t of e.properties)if("name"===t.name&&t.value&&"string"===t.value.type&&(s=t.value),"displayName"===t.name&&t.value&&"string"===t.value.type){s=t.value;break}let i=null;t&&(i=this.createRawLocationByScriptId(t.value.scriptId,t.value.lineNumber,t.value.columnNumber));return{location:i,functionName:s?s.value:""}}.bind(this))}async setVariableValue(e,t,s,i){const r=(await this._agent.invoke_setVariableValue({scopeNumber:e,variableName:t,newValue:s,callFrameId:i})).getError();return r&&console.error(r),r}addBreakpointListener(e,t,s){this._breakpointResolvedEventTarget.addEventListener(e,t,s)}removeBreakpointListener(e,t,s){this._breakpointResolvedEventTarget.removeEventListener(e,t,s)}async setBlackboxPatterns(e){const t=(await this._agent.invoke_setBlackboxPatterns({patterns:e})).getError();return t&&console.error(t),!t}dispose(){this._sourceMapManager.dispose(),this._debuggerId&&_debuggerIdToModel.delete(this._debuggerId),Common.Settings.Settings.instance().moduleSetting("pauseOnExceptionEnabled").removeChangeListener(this._pauseOnExceptionStateChanged,this),Common.Settings.Settings.instance().moduleSetting("pauseOnCaughtException").removeChangeListener(this._pauseOnExceptionStateChanged,this),Common.Settings.Settings.instance().moduleSetting("disableAsyncStackTraces").removeChangeListener(this._asyncStackTracesStateChanged,this)}async suspendModel(){await this._disableDebugger()}async resumeModel(){await this._enableDebugger()}_internString(e){const t=this._stringMap.get(e);return void 0===t?(this._stringMap.set(e,e),e):t}}export const _debuggerIdToModel=new Map;export let _scheduledPauseOnAsyncCall=null;export const PauseOnExceptionsState={DontPauseOnExceptions:"none",PauseOnAllExceptions:"all",PauseOnUncaughtExceptions:"uncaught"};export const Events={DebuggerWasEnabled:Symbol("DebuggerWasEnabled"),DebuggerWasDisabled:Symbol("DebuggerWasDisabled"),DebuggerPaused:Symbol("DebuggerPaused"),DebuggerResumed:Symbol("DebuggerResumed"),ParsedScriptSource:Symbol("ParsedScriptSource"),FailedToParseScriptSource:Symbol("FailedToParseScriptSource"),DiscardedAnonymousScriptSource:Symbol("DiscardedAnonymousScriptSource"),GlobalObjectCleared:Symbol("GlobalObjectCleared"),CallFrameSelected:Symbol("CallFrameSelected"),ConsoleCommandEvaluatedInSelectedCallFrame:Symbol("ConsoleCommandEvaluatedInSelectedCallFrame"),DebuggerIsReadyToPause:Symbol("DebuggerIsReadyToPause")};export const BreakReason={DOM:"DOM",EventListener:"EventListener",XHR:"XHR",Exception:"exception",PromiseRejection:"promiseRejection",Assert:"assert",DebugCommand:"debugCommand",OOM:"OOM",Other:"other"};class DebuggerDispatcher{constructor(e){this._debuggerModel=e}usesObjectNotation(){return!0}paused({callFrames:e,reason:t,data:s,hitBreakpoints:i,asyncStackTrace:r,asyncStackTraceId:a,asyncCallStackTraceId:o}){this._debuggerModel._pausedScript(e,t,s,i||[],r,a,o)}resumed(){this._debuggerModel._resumedScript()}scriptParsed({scriptId:e,url:t,startLine:s,startColumn:i,endLine:r,endColumn:a,executionContextId:o,hash:n,executionContextAuxData:c,isLiveEdit:l,sourceMapURL:u,hasSourceURL:d,isModule:p,length:g,stackTrace:h,codeOffset:m,scriptLanguage:_,debugSymbols:b,embedderName:S}){this._debuggerModel._parsedScriptSource(e,t,s,i,r,a,o,n,c,!!l,u,!!d,!1,g||0,h||null,m||null,_||null,b||null,S||null)}scriptFailedToParse({scriptId:e,url:t,startLine:s,startColumn:i,endLine:r,endColumn:a,executionContextId:o,hash:n,executionContextAuxData:c,sourceMapURL:l,hasSourceURL:u,isModule:d,length:p,stackTrace:g,codeOffset:h,scriptLanguage:m,embedderName:_}){this._debuggerModel._parsedScriptSource(e,t,s,i,r,a,o,n,c,!1,l,!!u,!0,p||0,g||null,h||null,m||null,null,_||null)}breakpointResolved({breakpointId:e,location:t}){this._debuggerModel._breakpointResolved(e,t)}}export class Location{constructor(e,t,s,i){this.debuggerModel=e,this.scriptId=t,this.lineNumber=s,this.columnNumber=i||0}static fromPayload(e,t){return new Location(e,t.scriptId,t.lineNumber,t.columnNumber)}payload(){return{scriptId:this.scriptId,lineNumber:this.lineNumber,columnNumber:this.columnNumber}}script(){return this.debuggerModel.scriptForId(this.scriptId)}continueToLocation(e){e&&(this.debuggerModel._continueToLocationCallback=this._paused.bind(this,e)),this.debuggerModel._agent.invoke_continueToLocation({location:this.payload(),targetCallFrames:Protocol.Debugger.ContinueToLocationRequestTargetCallFrames.Current})}_paused(e,t){const s=t.callFrames[0].location();return s.scriptId===this.scriptId&&s.lineNumber===this.lineNumber&&s.columnNumber===this.columnNumber&&(e(),!0)}id(){return this.debuggerModel.target().id()+":"+this.scriptId+":"+this.lineNumber+":"+this.columnNumber}}export class BreakLocation extends Location{constructor(e,t,s,i,r){super(e,t,s,i),r&&(this.type=r)}static fromPayload(e,t){return new BreakLocation(e,t.scriptId,t.lineNumber,t.columnNumber,t.type)}}export class CallFrame{constructor(e,t,s){this.debuggerModel=e,this.sourceScopeChain=null,this._script=t,this._payload=s,this._location=Location.fromPayload(e,s.location),this._scopeChain=[],this._localScope=null;for(let e=0;e<s.scopeChain.length;++e){const t=new Scope(this,e);this._scopeChain.push(t),t.type()===Protocol.Debugger.ScopeType.Local&&(this._localScope=t)}s.functionLocation&&(this._functionLocation=Location.fromPayload(e,s.functionLocation)),this._returnValue=s.returnValue?this.debuggerModel._runtimeModel.createRemoteObject(s.returnValue):null}static fromPayloadArray(e,t){const s=[];for(let i=0;i<t.length;++i){const r=t[i],a=e.scriptForId(r.location.scriptId);a&&s.push(new CallFrame(e,a,r))}return s}get script(){return this._script}get id(){return this._payload.callFrameId}scopeChain(){return this._scopeChain}localScope(){return this._localScope}thisObject(){return this._payload.this?this.debuggerModel._runtimeModel.createRemoteObject(this._payload.this):null}returnValue(){return this._returnValue}async setReturnValue(e){if(!this._returnValue)return null;const t=await this.debuggerModel._agent.invoke_evaluateOnCallFrame({callFrameId:this.id,expression:e,silent:!0,objectGroup:"backtrace"});if(t.getError()||t.exceptionDetails)return null;return(await this.debuggerModel._agent.invoke_setReturnValue({newValue:t.result})).getError()?null:(this._returnValue=this.debuggerModel._runtimeModel.createRemoteObject(t.result),this._returnValue)}get functionName(){return this._payload.functionName}location(){return this._location}functionLocation(){return this._functionLocation||null}async evaluate(e){const t=this.debuggerModel.runtimeModel();if((!!e.throwOnSideEffect||void 0!==e.timeout)&&(!1===t.hasSideEffectSupport()||null===t.hasSideEffectSupport()&&!await t.checkSideEffectSupport()))return{error:"Side-effect checks not supported by backend."};const s=await this.debuggerModel._agent.invoke_evaluateOnCallFrame({callFrameId:this.id,expression:e.expression,objectGroup:e.objectGroup,includeCommandLineAPI:e.includeCommandLineAPI,silent:e.silent,returnByValue:e.returnByValue,generatePreview:e.generatePreview,throwOnSideEffect:e.throwOnSideEffect,timeout:e.timeout}),i=s.getError();return i?(console.error(i),{error:i}):{object:t.createRemoteObject(s.result),exceptionDetails:s.exceptionDetails}}async restart(){(await this.debuggerModel._agent.invoke_restartFrame({callFrameId:this._payload.callFrameId})).getError()||this.debuggerModel.stepInto()}}export class Scope{constructor(e,t){this._callFrame=e,this._payload=e._payload.scopeChain[t],this._type=this._payload.type,this._name=this._payload.name,this._ordinal=t,this._startLocation=this._payload.startLocation?Location.fromPayload(e.debuggerModel,this._payload.startLocation):null,this._endLocation=this._payload.endLocation?Location.fromPayload(e.debuggerModel,this._payload.endLocation):null,this._object=null}callFrame(){return this._callFrame}type(){return this._type}typeName(){switch(this._type){case Protocol.Debugger.ScopeType.Local:return Common.UIString.UIString("Local");case Protocol.Debugger.ScopeType.Closure:return Common.UIString.UIString("Closure");case Protocol.Debugger.ScopeType.Catch:return Common.UIString.UIString("Catch");case Protocol.Debugger.ScopeType.Block:return Common.UIString.UIString("Block");case Protocol.Debugger.ScopeType.Script:return Common.UIString.UIString("Script");case Protocol.Debugger.ScopeType.With:return Common.UIString.UIString("With Block");case Protocol.Debugger.ScopeType.Global:return Common.UIString.UIString("Global");case Protocol.Debugger.ScopeType.Module:return Common.UIString.UIString("Module");case Protocol.Debugger.ScopeType.WasmExpressionStack:return Common.UIString.UIString("Stack")}return""}name(){return this._name}startLocation(){return this._startLocation}endLocation(){return this._endLocation}object(){if(this._object)return this._object;const e=this._callFrame.debuggerModel._runtimeModel,t=this._type!==Protocol.Debugger.ScopeType.With&&this._type!==Protocol.Debugger.ScopeType.Global;return this._object=t?e.createScopeRemoteObject(this._payload.object,new ScopeRef(this._ordinal,this._callFrame.id)):e.createRemoteObject(this._payload.object),this._object}description(){return this._type!==Protocol.Debugger.ScopeType.With&&this._type!==Protocol.Debugger.ScopeType.Global?"":this._payload.object.description||""}}export class DebuggerPausedDetails{constructor(e,t,s,i,r,a,o){this.debuggerModel=e,this.callFrames=CallFrame.fromPayloadArray(e,t),this.reason=s,this.auxData=i,this.breakpointIds=r,a&&(this.asyncStackTrace=this._cleanRedundantFrames(a)),this.asyncStackTraceId=o}exception(){return this.reason!==BreakReason.Exception&&this.reason!==BreakReason.PromiseRejection?null:this.debuggerModel._runtimeModel.createRemoteObject(this.auxData)}_cleanRedundantFrames(e){let t=e,s=null;for(;t;)"async function"===t.description&&t.callFrames.length&&t.callFrames.shift(),s&&!t.callFrames.length?s.parent=t.parent:s=t,t=t.parent;return e}}SDKModel.register(DebuggerModel,Capability.JS,!0);export let FunctionDetails;export let SetBreakpointResult;