import*as Common from"../common/common.js";import{Attributes,Cookie}from"./Cookie.js";import{Resource}from"./Resource.js";import{ResourceTreeModel}from"./ResourceTreeModel.js";import{Capability,SDKModel,Target}from"./SDKModel.js";export class CookieModel extends SDKModel{constructor(e){super(e),this._blockedCookies=new Map,this._cookieToBlockedReasons=new Map}addBlockedCookie(e,o){const t=e.key(),s=this._blockedCookies.get(t);this._blockedCookies.set(t,e),this._cookieToBlockedReasons.set(e,o),s&&this._cookieToBlockedReasons.delete(t)}getCookieToBlockedReasonsMap(){return this._cookieToBlockedReasons}async getCookies(e){const o=await this.target().networkAgent().invoke_getCookies({urls:e});if(o.getError())return[];return o.cookies.map(Cookie.fromProtocolCookie).concat(Array.from(this._blockedCookies.values()))}async deleteCookie(e){await this._deleteAll([e])}async clear(e){const o=await this.getCookiesForDomain(e||null);await this._deleteAll(o)}async saveCookie(e){let o=e.domain();o.startsWith(".")||(o="");let t=void 0;e.expires()&&(t=Math.floor(Date.parse(""+e.expires())/1e3));const s={name:e.name(),value:e.value(),url:e.url()||void 0,domain:o,path:e.path(),secure:e.secure(),httpOnly:e.httpOnly(),sameSite:e.sameSite(),expires:t,priority:e.priority()},i=await this.target().networkAgent().invoke_setCookie(s);return!i.getError()&&i.success}getCookiesForDomain(e){const o=[];const t=this.target().model(ResourceTreeModel);return t&&(t.mainFrame.unreachableUrl()&&o.push(t.mainFrame.unreachableUrl()),t.forAllResources((function(t){const s=Common.ParsedURL.ParsedURL.fromString(t.documentURL);!s||e&&s.securityOrigin()!==e||o.push(t.url)}))),this.getCookies(o)}async _deleteAll(e){const o=this.target().networkAgent();this._blockedCookies.clear(),this._cookieToBlockedReasons.clear(),await Promise.all(e.map(e=>o.invoke_deleteCookies({name:e.name(),url:void 0,domain:e.domain(),path:e.path()})))}}SDKModel.register(CookieModel,Capability.Network,!1);export let BlockedReason;