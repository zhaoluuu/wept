import*as Common from"../common/common.js";import{DebuggerModel,Events as DebuggerModelEvents}from"./DebuggerModel.js";import{DeferredDOMNode,DOMModel,DOMNode,Events as DOMModelEvents}from"./DOMModel.js";import{RemoteObject}from"./RemoteObject.js";import{Capability,SDKModel,Target,TargetManager}from"./SDKModel.js";export let HighlightColor;export let HighlightRect;export let Hinge;export class OverlayModel extends SDKModel{constructor(e){super(e),this._domModel=e.model(DOMModel),e.registerOverlayDispatcher(this),this._overlayAgent=e.overlayAgent(),this._debuggerModel=e.model(DebuggerModel),this._debuggerModel&&(Common.Settings.Settings.instance().moduleSetting("disablePausedStateOverlay").addChangeListener(this._updatePausedInDebuggerMessage,this),this._debuggerModel.addEventListener(DebuggerModelEvents.DebuggerPaused,e=>{this._updatePausedInDebuggerMessage()},this),this._debuggerModel.addEventListener(DebuggerModelEvents.DebuggerResumed,e=>{this._updatePausedInDebuggerMessage()},this),this._debuggerModel.addEventListener(DebuggerModelEvents.GlobalObjectCleared,e=>{this._updatePausedInDebuggerMessage()},this)),this._inspectModeEnabled=!1,this._gridFeaturesExperimentEnabled=Root.Runtime.experiments.isEnabled("cssGridFeatures"),this._sourceOrderViewerExperimentEnabled=Root.Runtime.experiments.isEnabled("sourceOrderViewer"),this._hideHighlightTimeout=null,this._defaultHighlighter=new DefaultHighlighter(this),this._highlighter=this._defaultHighlighter,this._showPaintRectsSetting=Common.Settings.Settings.instance().moduleSetting("showPaintRects"),this._showLayoutShiftRegionsSetting=Common.Settings.Settings.instance().moduleSetting("showLayoutShiftRegions"),this._showAdHighlightsSetting=Common.Settings.Settings.instance().moduleSetting("showAdHighlights"),this._showDebugBordersSetting=Common.Settings.Settings.instance().moduleSetting("showDebugBorders"),this._showFPSCounterSetting=Common.Settings.Settings.instance().moduleSetting("showFPSCounter"),this._showScrollBottleneckRectsSetting=Common.Settings.Settings.instance().moduleSetting("showScrollBottleneckRects"),this._showHitTestBordersSetting=Common.Settings.Settings.instance().moduleSetting("showHitTestBorders"),this._registeredListeners=[],this._showViewportSizeOnResize=!0,e.suspended()||(this._overlayAgent.enable(),this._wireAgentToSettings()),this._isPersistentGridModeOn=!1,this._gridFeaturesExperimentEnabled&&(this._persistentGridHighlighter=new DefaultPersistentGridHighlighter(this),this._domModel.addEventListener(DOMModelEvents.NodeRemoved,()=>{this._persistentGridHighlighter.refreshHighlights()}),this._domModel.addEventListener(DOMModelEvents.DocumentUpdated,()=>{this._persistentGridHighlighter.hideAllInOverlay()})),this._sourceOrderViewerExperimentEnabled&&(this._sourceOrderHighlighter=new SourceOrderHighlighter(this),this._sourceOrderModeActive=!1)}static highlightObjectAsDOMNode(e){const t=e.runtimeModel().target().model(DOMModel);t&&t.overlayModel().highlightInOverlay({object:e})}static hideDOMNodeHighlight(){for(const e of TargetManager.instance().models(OverlayModel))e._delayedHideHighlight(0)}static async muteHighlight(){return Promise.all(TargetManager.instance().models(OverlayModel).map(e=>e.suspendModel()))}static async unmuteHighlight(){return Promise.all(TargetManager.instance().models(OverlayModel).map(e=>e.resumeModel()))}static highlightRect(e){for(const t of TargetManager.instance().models(OverlayModel))t.highlightRect(e)}static clearHighlight(){for(const e of TargetManager.instance().models(OverlayModel))e.clearHighlight()}getDOMModel(){return this._domModel}highlightRect({x:e,y:t,width:i,height:o,color:s,outlineColor:r}){const h=s||{r:255,g:0,b:255,a:.3},g=r||{r:255,g:0,b:255,a:.5};return this._overlayAgent.invoke_highlightRect({x:e,y:t,width:i,height:o,color:h,outlineColor:g})}clearHighlight(){return this._overlayAgent.invoke_hideHighlight({})}_wireAgentToSettings(){return this._registeredListeners=[this._showPaintRectsSetting.addChangeListener(()=>this._overlayAgent.setShowPaintRects(this._showPaintRectsSetting.get())),this._showLayoutShiftRegionsSetting.addChangeListener(()=>this._overlayAgent.setShowLayoutShiftRegions(this._showLayoutShiftRegionsSetting.get())),this._showAdHighlightsSetting.addChangeListener(()=>this._overlayAgent.setShowAdHighlights(this._showAdHighlightsSetting.get())),this._showDebugBordersSetting.addChangeListener(()=>this._overlayAgent.setShowDebugBorders(this._showDebugBordersSetting.get())),this._showFPSCounterSetting.addChangeListener(()=>this._overlayAgent.setShowFPSCounter(this._showFPSCounterSetting.get())),this._showScrollBottleneckRectsSetting.addChangeListener(()=>this._overlayAgent.setShowScrollBottleneckRects(this._showScrollBottleneckRectsSetting.get())),this._showHitTestBordersSetting.addChangeListener(()=>this._overlayAgent.setShowHitTestBorders(this._showHitTestBordersSetting.get()))],this._showPaintRectsSetting.get()&&this._overlayAgent.setShowPaintRects(!0),this._showLayoutShiftRegionsSetting.get()&&this._overlayAgent.setShowLayoutShiftRegions(!0),this._showAdHighlightsSetting.get()&&this._overlayAgent.setShowAdHighlights(!0),this._showDebugBordersSetting.get()&&this._overlayAgent.setShowDebugBorders(!0),this._showFPSCounterSetting.get()&&this._overlayAgent.setShowFPSCounter(!0),this._showScrollBottleneckRectsSetting.get()&&this._overlayAgent.setShowScrollBottleneckRects(!0),this._showHitTestBordersSetting.get()&&this._overlayAgent.setShowHitTestBorders(!0),this._debuggerModel.isPaused()&&this._updatePausedInDebuggerMessage(),this._overlayAgent.setShowViewportSizeOnResize(this._showViewportSizeOnResize)}suspendModel(){return Common.EventTarget.EventTarget.removeEventListeners(this._registeredListeners),this._overlayAgent.disable()}resumeModel(){return this._overlayAgent.enable(),this._wireAgentToSettings()}setShowViewportSizeOnResize(e){this._showViewportSizeOnResize!==e&&(this._showViewportSizeOnResize=e,this.target().suspended()||this._overlayAgent.setShowViewportSizeOnResize(e))}setPersistentGridMode(e){this._isPersistentGridModeOn=e}_updatePausedInDebuggerMessage(){if(this.target().suspended())return;const e=this._debuggerModel.isPaused()&&!Common.Settings.Settings.instance().moduleSetting("disablePausedStateOverlay").get()?Common.UIString.UIString("Paused in debugger"):void 0;this._overlayAgent.setPausedInDebuggerMessage(e)}setHighlighter(e){this._highlighter=e||this._defaultHighlighter}async setInspectMode(e,t=!0){await this._domModel.requestDocument(),this._inspectModeEnabled=e!==Protocol.Overlay.InspectMode.None,this.dispatchEventToListeners(Events.InspectModeWillBeToggled,this),this._highlighter.setInspectMode(e,this._buildHighlightConfig("all",t)),this._inspectModeEnabled&&this._gridFeaturesExperimentEnabled&&(this._persistentGridHighlighter.hideAllInOverlay(),this.dispatchEventToListeners(Events.PersistentGridOverlayCleared))}inspectModeEnabled(){return this._inspectModeEnabled}highlightInOverlay(e,t,i){if(this._isPersistentGridModeOn)return;if(this._sourceOrderModeActive)return;this._hideHighlightTimeout&&(clearTimeout(this._hideHighlightTimeout),this._hideHighlightTimeout=null);const o=this._buildHighlightConfig(t);void 0!==i&&(o.showInfo=i),this._highlighter.highlightInOverlay(e,o)}highlightInOverlayForTwoSeconds(e){this.highlightInOverlay(e),this._delayedHideHighlight(2e3)}highlightGridInPersistentOverlay(e){this._persistentGridHighlighter.highlightInOverlay(e),this.dispatchEventToListeners(Events.PersistentGridOverlayStateChanged,{nodeId:e,enabled:!0})}isHighlightedGridInPersistentOverlay(e){return this._persistentGridHighlighter.isHighlighted(e)}hideGridInPersistentOverlay(e){this._persistentGridHighlighter.hideInOverlay(e),this.dispatchEventToListeners(Events.PersistentGridOverlayStateChanged,{nodeId:e,enabled:!1})}highlightSourceOrderInOverlay(e){const t={parentOutlineColor:Common.Color.SourceOrderHighlight.ParentOutline.toProtocolRGBA(),childOutlineColor:Common.Color.SourceOrderHighlight.ChildOutline.toProtocolRGBA()};this._sourceOrderHighlighter.highlightSourceOrderInOverlay(e,t)}hideSourceOrderInOverlay(){this._sourceOrderHighlighter.hideSourceOrderHighlight()}setSourceOrderActive(e){this._sourceOrderModeActive=e}sourceOrderModeActive(){return this._sourceOrderModeActive}_delayedHideHighlight(e){null===this._hideHighlightTimeout&&(this._hideHighlightTimeout=setTimeout(()=>this.highlightInOverlay({}),e))}highlightFrame(e){this._hideHighlightTimeout&&(clearTimeout(this._hideHighlightTimeout),this._hideHighlightTimeout=null),this._highlighter.highlightFrame(e)}showHingeForDualScreen(e,t=null){if(e){const{x:e,y:i,width:o,height:s,contentColor:r,outlineColor:h}=t;this._overlayAgent.setShowHinge({rect:{x:e,y:i,width:o,height:s},contentColor:r,outlineColor:h})}else this._overlayAgent.setShowHinge()}_buildHighlightConfig(e="all",t=!1){const i=Common.Settings.Settings.instance().moduleSetting("showMetricsRulers").get(),o=Common.Settings.Settings.instance().moduleSetting("colorFormat").get(),s={showInfo:"all"===e,showRulers:i,showStyles:t,showAccessibilityInfo:t,showExtensionLines:i,gridHighlightConfig:{}};"all"!==e&&"content"!==e||(s.contentColor=Common.Color.PageHighlight.Content.toProtocolRGBA()),"all"!==e&&"padding"!==e||(s.paddingColor=Common.Color.PageHighlight.Padding.toProtocolRGBA()),"all"!==e&&"border"!==e||(s.borderColor=Common.Color.PageHighlight.Border.toProtocolRGBA()),"all"!==e&&"margin"!==e||(s.marginColor=Common.Color.PageHighlight.Margin.toProtocolRGBA()),"all"===e&&(s.eventTargetColor=Common.Color.PageHighlight.EventTarget.toProtocolRGBA(),s.shapeColor=Common.Color.PageHighlight.Shape.toProtocolRGBA(),s.shapeMarginColor=Common.Color.PageHighlight.ShapeMargin.toProtocolRGBA(),s.gridHighlightConfig={rowGapColor:Common.Color.PageHighlight.GridRowGapBackground.toProtocolRGBA(),rowHatchColor:Common.Color.PageHighlight.GridRowGapHatch.toProtocolRGBA(),columnGapColor:Common.Color.PageHighlight.GridColumnGapBackground.toProtocolRGBA(),columnHatchColor:Common.Color.PageHighlight.GridColumnGapHatch.toProtocolRGBA(),rowLineColor:Common.Color.PageHighlight.GridRowLine.toProtocolRGBA(),columnLineColor:Common.Color.PageHighlight.GridColumnLine.toProtocolRGBA(),rowLineDash:!0,columnLineDash:!0}),e.endsWith("gap")&&this._gridFeaturesExperimentEnabled&&(s.gridHighlightConfig={gridBorderColor:Common.Color.PageHighlight.GridBorder.toProtocolRGBA(),gridBorderDash:!0},"gap"!==e&&"row-gap"!==e||(s.gridHighlightConfig.rowGapColor=Common.Color.PageHighlight.GridRowGapBackground.toProtocolRGBA(),s.gridHighlightConfig.rowHatchColor=Common.Color.PageHighlight.GridRowGapHatch.toProtocolRGBA()),"gap"!==e&&"column-gap"!==e||(s.gridHighlightConfig.columnGapColor=Common.Color.PageHighlight.GridColumnGapBackground.toProtocolRGBA(),s.gridHighlightConfig.columnHatchColor=Common.Color.PageHighlight.GridColumnGapHatch.toProtocolRGBA())),"grid-areas"===e&&this._gridFeaturesExperimentEnabled&&(s.gridHighlightConfig={rowLineColor:Common.Color.PageHighlight.GridRowLine.toProtocolRGBA(),columnLineColor:Common.Color.PageHighlight.GridColumnLine.toProtocolRGBA(),rowLineDash:!0,columnLineDash:!0,showAreaNames:!0,areaBorderColor:Common.Color.PageHighlight.GridAreaBorder.toProtocolRGBA()}),"grid-template-columns"===e&&this._gridFeaturesExperimentEnabled&&(s.contentColor=Common.Color.PageHighlight.Content.toProtocolRGBA(),s.gridHighlightConfig={columnLineColor:Common.Color.PageHighlight.GridColumnLine.toProtocolRGBA(),columnLineDash:!0}),"grid-template-rows"===e&&this._gridFeaturesExperimentEnabled&&(s.contentColor=Common.Color.PageHighlight.Content.toProtocolRGBA(),s.gridHighlightConfig={rowLineColor:Common.Color.PageHighlight.GridRowLine.toProtocolRGBA(),rowLineDash:!0});return new Set(["rgb","hsl","hex"]).has(o)&&(s.colorFormat=o),s}nodeHighlightRequested(e){const t=this._domModel.nodeForId(e);t&&this.dispatchEventToListeners(Events.HighlightNodeRequested,t)}static setInspectNodeHandler(e){OverlayModel._inspectNodeHandler=e}inspectNodeRequested(e){const t=new DeferredDOMNode(this.target(),e);OverlayModel._inspectNodeHandler?t.resolvePromise().then(e=>{e&&OverlayModel._inspectNodeHandler(e)}):Common.Revealer.reveal(t),this.dispatchEventToListeners(Events.ExitedInspectMode)}screenshotRequested(e){this.dispatchEventToListeners(Events.ScreenshotRequested,e),this.dispatchEventToListeners(Events.ExitedInspectMode)}inspectModeCanceled(){this.dispatchEventToListeners(Events.ExitedInspectMode)}}export const Events={InspectModeWillBeToggled:Symbol("InspectModeWillBeToggled"),ExitedInspectMode:Symbol("InspectModeExited"),HighlightNodeRequested:Symbol("HighlightNodeRequested"),ScreenshotRequested:Symbol("ScreenshotRequested"),PersistentGridOverlayCleared:Symbol("PersistentGridOverlayCleared"),PersistentGridOverlayStateChanged:Symbol("PersistentGridOverlayStateChanged")};export class Highlighter{highlightInOverlay(e,t){}setInspectMode(e,t){}highlightFrame(e){}}class DefaultHighlighter{constructor(e){this._model=e}highlightInOverlay(e,t){const{node:i,deferredNode:o,object:s,selectorList:r}=e,h=i?i.id:void 0,g=o?o.backendNodeId():void 0,n=s?s.objectId:void 0;h||g||n?this._model.target().overlayAgent().highlightNode(t,h,g,n,r):this._model.target().overlayAgent().hideHighlight()}setInspectMode(e,t){return this._model.target().overlayAgent().setInspectMode(e,t)}highlightFrame(e){this._model.target().overlayAgent().highlightFrame(e,Common.Color.PageHighlight.Content.toProtocolRGBA(),Common.Color.PageHighlight.ContentOutline.toProtocolRGBA())}}export class PersistentGridHighlighter{highlightInOverlay(e,t){}hideInOverlay(e){}hideAllInOverlay(){}refreshHighlights(){}isHighlighted(e){return!1}}class DefaultPersistentGridHighlighter{constructor(e){this._model=e,this._gridHighlights=new Map,this._showGridBorderSetting=Common.Settings.Settings.instance().moduleSetting("showGridBorder"),this._showGridBorderSetting.addChangeListener(this._onSettingChange,this),this._showGridLinesSetting=Common.Settings.Settings.instance().moduleSetting("showGridLines"),this._showGridLinesSetting.addChangeListener(this._onSettingChange,this),this._showGridLineNumbersSetting=Common.Settings.Settings.instance().moduleSetting("showGridLineNumbers"),this._showGridLineNumbersSetting.addChangeListener(this._onSettingChange,this),this._showGridGapsSetting=Common.Settings.Settings.instance().moduleSetting("showGridGaps"),this._showGridGapsSetting.addChangeListener(this._onSettingChange,this),this._showGridAreasSetting=Common.Settings.Settings.instance().moduleSetting("showGridAreas"),this._showGridAreasSetting.addChangeListener(this._onSettingChange,this),this._showGridTrackSizesSetting=Common.Settings.Settings.instance().moduleSetting("showGridTrackSizes"),this._showGridTrackSizesSetting.addChangeListener(this._onSettingChange,this),this._logCurrentGridSettings()}static getGridTelemetryLogged(){return DefaultPersistentGridHighlighter.gridTelemetryLogged}static setGridTelemetryLogged(e){DefaultPersistentGridHighlighter.gridTelemetryLogged=e}_onSettingChange(){this._resetOverlay()}_logCurrentGridSettings(){DefaultPersistentGridHighlighter.getGridTelemetryLogged()||(this._recordGridSetting(this._showGridBorderSetting),this._recordGridSetting(this._showGridLinesSetting),this._recordGridSetting(this._showGridLineNumbersSetting),this._recordGridSetting(this._showGridGapsSetting),this._recordGridSetting(this._showGridAreasSetting),this._recordGridSetting(this._showGridTrackSizesSetting),DefaultPersistentGridHighlighter.setGridTelemetryLogged(!0))}_recordGridSetting(e){e&&Host.userMetrics.cssGridSettings(`${e.name}.${e.get()}`)}_buildGridHighlightConfig(){let e=!1,t=!1;switch(this._showGridBorderSetting.get()){case"dashed":e=!0,t=!0;break;case"solid":e=!0}let i,o=!1,s=!1;switch(this._showGridLinesSetting.get()){case"dashed":o=!0,s=!0;break;case"solid":o=!0;break;case"extended-dashed":o=!0,s=!0,i=!0;break;case"extended-solid":o=!0,i=!0}let r=!1,h=!1,g=!1;switch(this._showGridLineNumbersSetting.get()){case"positive":r=!0;break;case"negative":h=!0;break;case"both":r=!0,h=!0;break;case"names":g=!0}let n=!1,l=!1;switch(this._showGridGapsSetting.get()){case"both":n=!0,l=!0;break;case"row-gaps":n=!0;break;case"column-gaps":l=!0}return{rowGapColor:n?Common.Color.PageHighlight.GridRowGapBackground.toProtocolRGBA():void 0,rowHatchColor:n?Common.Color.PageHighlight.GridRowGapHatch.toProtocolRGBA():void 0,columnGapColor:l?Common.Color.PageHighlight.GridColumnGapBackground.toProtocolRGBA():void 0,columnHatchColor:l?Common.Color.PageHighlight.GridColumnGapHatch.toProtocolRGBA():void 0,gridBorderColor:e?Common.Color.PageHighlight.GridBorder.toProtocolRGBA():void 0,gridBorderDash:t,rowLineColor:o?Common.Color.PageHighlight.GridRowLine.toProtocolRGBA():void 0,columnLineColor:o?Common.Color.PageHighlight.GridColumnLine.toProtocolRGBA():void 0,rowLineDash:s,columnLineDash:s,showGridExtensionLines:i,showPositiveLineNumbers:r,showNegativeLineNumbers:h,showLineNames:g,showAreaNames:this._showGridAreasSetting.get(),showTrackSizes:this._showGridTrackSizesSetting.get(),areaBorderColor:Common.Color.PageHighlight.GridAreaBorder.toProtocolRGBA()}}highlightInOverlay(e){this._gridHighlights.set(e,this._buildGridHighlightConfig()),this._updateHighlightsInOverlay()}isHighlighted(e){return this._gridHighlights.has(e)}hideInOverlay(e){this._gridHighlights.has(e)&&(this._gridHighlights.delete(e),this._updateHighlightsInOverlay())}hideAllInOverlay(){this._gridHighlights.clear(),this._updateHighlightsInOverlay()}refreshHighlights(){let e=!1;for(const t of this._gridHighlights.keys())null===this._model.getDOMModel().nodeForId(t)&&(this._gridHighlights.delete(t),e=!0);e&&this._updateHighlightsInOverlay()}_resetOverlay(){for(const e of this._gridHighlights.keys())this._gridHighlights.set(e,this._buildGridHighlightConfig());this._updateHighlightsInOverlay()}_updateHighlightsInOverlay(){const e=this._gridHighlights.size>0;this._model.setPersistentGridMode(e),this._model.setShowViewportSizeOnResize(!e);const t=this._model,i=[];for(const[e,t]of this._gridHighlights.entries())i.push({nodeId:e,gridHighlightConfig:t});t.target().overlayAgent().setShowGridOverlays(i)}}DefaultPersistentGridHighlighter.gridTelemetryLogged=!1;export class SourceOrderHighlighter{constructor(e){this._model=e}highlightSourceOrderInOverlay(e,t){this._model.setSourceOrderActive(!0),this._model.setShowViewportSizeOnResize(!1),this._model._overlayAgent.highlightSourceOrder(t,e.id)}hideSourceOrderHighlight(){this._model.setSourceOrderActive(!1),this._model.setShowViewportSizeOnResize(!0),this._model.clearHighlight()}}SDKModel.register(OverlayModel,Capability.DOM,!0);export let HighlightData;