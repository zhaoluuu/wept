import*as Bindings from"../bindings/bindings.js";import*as Common from"../common/common.js";import*as Host from"../host/host.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";import*as Workspace from"../workspace/workspace.js";export class CallStackSidebarPane extends UI.View.SimpleView{constructor(){super(Common.UIString.UIString("Call Stack"),!0),this.registerRequiredCSS("sources/callStackSidebarPane.css"),this._blackboxedMessageElement=this._createBlackboxedMessageElement(),this.contentElement.appendChild(this._blackboxedMessageElement),this._notPausedMessageElement=this.contentElement.createChild("div","gray-info-message"),this._notPausedMessageElement.textContent=Common.UIString.UIString("Not paused"),this._notPausedMessageElement.tabIndex=-1,this._items=new UI.ListModel.ListModel,this._list=new UI.ListControl.ListControl(this._items,this,UI.ListControl.ListMode.NonViewport),this.contentElement.appendChild(this._list.element),this._list.element.addEventListener("contextmenu",this._onContextMenu.bind(this),!1),self.onInvokeElement(this._list.element,e=>{const t=this._list.itemForNode(e.target);t&&(this._activateItem(t),e.consume(!0))}),this._showMoreMessageElement=this._createShowMoreMessageElement(),this._showMoreMessageElement.classList.add("hidden"),this.contentElement.appendChild(this._showMoreMessageElement),this._showBlackboxed=!1,this._locationPool=new Bindings.LiveLocation.LiveLocationPool,this._updateThrottler=new Common.Throttler.Throttler(100),this._maxAsyncStackChainDepth=defaultMaxAsyncStackChainDepth,this._update(),this._updateItemThrottler=new Common.Throttler.Throttler(100),this._scheduledForUpdateItems=new Set}flavorChanged(e){this._showBlackboxed=!1,this._maxAsyncStackChainDepth=defaultMaxAsyncStackChainDepth,this._update()}_update(){this._updateThrottler.schedule(()=>this._doUpdate())}async _doUpdate(){this._locationPool.disposeAll();const e=UI.Context.Context.instance().flavor(SDK.DebuggerModel.DebuggerPausedDetails);if(!e)return this.setDefaultFocusedElement(this._notPausedMessageElement),this._notPausedMessageElement.classList.remove("hidden"),this._blackboxedMessageElement.classList.add("hidden"),this._showMoreMessageElement.classList.add("hidden"),this._items.replaceAll([]),void UI.Context.Context.instance().setFlavor(SDK.DebuggerModel.CallFrame,null);let t=e.debuggerModel;this._notPausedMessageElement.classList.add("hidden");const s=[];for(const t of e.callFrames){const e=Item.createForDebuggerCallFrame(t,this._locationPool,this._refreshItem.bind(this)).then(e=>(e[debuggerCallFrameSymbol]=t,e));s.push(e)}const a=await Promise.all(s);let n=e.asyncStackTrace;!n&&e.asyncStackTraceId&&(e.asyncStackTraceId.debuggerId&&(t=SDK.DebuggerModel.DebuggerModel.modelForDebuggerId(e.asyncStackTraceId.debuggerId)),n=t?await t.fetchAsyncStackTrace(e.asyncStackTraceId):null);let i=e.callFrames,o=this._maxAsyncStackChainDepth;for(;n&&o>0;){let e="";if("async function"===n.description&&i.length&&n.callFrames.length){const t=i[i.length-1],s=UI.UIUtils.beautifyFunctionName(t.functionName);e=UI.UIUtils.asyncStackTraceLabel("await in "+s)}else e=UI.UIUtils.asyncStackTraceLabel(n.description);a.push(...await Item.createItemsForAsyncStack(e,t,n.callFrames,this._locationPool,this._refreshItem.bind(this))),--o,i=n.callFrames,n.parent?n=n.parent:n.parentId?(n.parentId.debuggerId&&(t=SDK.DebuggerModel.DebuggerModel.modelForDebuggerId(n.parentId.debuggerId)),n=t?await t.fetchAsyncStackTrace(n.parentId):null):n=null}if(this._showMoreMessageElement.classList.toggle("hidden",!n),this._items.replaceAll(a),this._maxAsyncStackChainDepth===defaultMaxAsyncStackChainDepth){this._list.selectNextItem(!0,!1);const e=this._list.selectedItem();e&&this._activateItem(e)}this._updatedForTest()}_updatedForTest(){}_refreshItem(e){this._scheduledForUpdateItems.add(e),this._updateItemThrottler.schedule(function(){const e=Array.from(this._scheduledForUpdateItems);if(this._scheduledForUpdateItems.clear(),this._muteActivateItem=!0,!this._showBlackboxed&&this._items.every(e=>e.isBlackboxed)){this._showBlackboxed=!0;for(let e=0;e<this._items.length;++e)this._list.refreshItemByIndex(e);this._blackboxedMessageElement.classList.toggle("hidden",!0)}else{const t=new Set(e);let s=!1;for(let e=0;e<this._items.length;++e){const a=this._items.at(e);t.has(a)&&this._list.refreshItemByIndex(e),s=s||a.isBlackboxed}this._blackboxedMessageElement.classList.toggle("hidden",this._showBlackboxed||!s)}return delete this._muteActivateItem,Promise.resolve()}.bind(this))}createElementForItem(e){const t=document.createElement("div");t.classList.add("call-frame-item");if(t.createChild("div","call-frame-item-title").createChild("div","call-frame-title-text").textContent=e.title,e.isAsyncHeader)t.classList.add("async-header");else{const s=t.createChild("div","call-frame-location");s.textContent=e.linkText.trimMiddle(30),s.title=e.linkText,t.classList.toggle("blackboxed-call-frame",e.isBlackboxed),e.isBlackboxed&&UI.ARIAUtils.setDescription(t,ls`blackboxed`),e[debuggerCallFrameSymbol]||UI.ARIAUtils.setDisabled(t,!0)}const s=e[debuggerCallFrameSymbol]===UI.Context.Context.instance().flavor(SDK.DebuggerModel.CallFrame);return t.classList.toggle("selected",s),UI.ARIAUtils.setSelected(t,s),t.classList.toggle("hidden",!this._showBlackboxed&&e.isBlackboxed),t.appendChild(UI.Icon.Icon.create("smallicon-thick-right-arrow","selected-call-frame-icon")),t.tabIndex=e===this._list.selectedItem()?0:-1,t}heightForItem(e){return console.assert(!1),0}isItemSelectable(e){return!0}selectedItemChanged(e,t,s,a){s&&(s.tabIndex=-1),a&&(this.setDefaultFocusedElement(a),a.tabIndex=0,this.hasFocus()&&a.focus())}updateSelectedItemARIA(e,t){return!0}_createBlackboxedMessageElement(){const e=document.createElement("div");e.classList.add("blackboxed-message"),e.createChild("span");const t=e.createChild("span","link");t.textContent=Common.UIString.UIString("Show blackboxed frames"),UI.ARIAUtils.markAsLink(t),t.tabIndex=0;const s=()=>{this._showBlackboxed=!0;for(const e of this._items)this._refreshItem(e);this._blackboxedMessageElement.classList.toggle("hidden",!0)};return t.addEventListener("click",s),t.addEventListener("keydown",e=>isEnterKey(e)&&s()),e}_createShowMoreMessageElement(){const e=document.createElement("div");e.classList.add("show-more-message"),e.createChild("span");const t=e.createChild("span","link");return t.textContent=Common.UIString.UIString("Show more"),t.addEventListener("click",()=>{this._maxAsyncStackChainDepth+=defaultMaxAsyncStackChainDepth,this._update()},!1),e}_onContextMenu(e){const t=this._list.itemForNode(e.target);if(!t)return;const s=new UI.ContextMenu.ContextMenu(e),a=t[debuggerCallFrameSymbol];a&&s.defaultSection().appendItem(Common.UIString.UIString("Restart frame"),()=>a.restart()),s.defaultSection().appendItem(Common.UIString.UIString("Copy stack trace"),this._copyStackTrace.bind(this)),t.uiLocation&&this.appendBlackboxURLContextMenuItems(s,t.uiLocation.uiSourceCode),s.show()}_onClick(e){const t=this._list.itemForNode(e.target);t&&this._activateItem(t)}_activateItem(e){const t=e.uiLocation;if(this._muteActivateItem||!t)return;this._list.selectItem(e);const s=e[debuggerCallFrameSymbol],a=this.activeCallFrameItem();s&&a!==e?(s.debuggerModel.setSelectedCallFrame(s),UI.Context.Context.instance().setFlavor(SDK.DebuggerModel.CallFrame,s),a&&this._refreshItem(a),this._refreshItem(e)):Common.Revealer.reveal(t)}activeCallFrameItem(){const e=UI.Context.Context.instance().flavor(SDK.DebuggerModel.CallFrame);return e&&this._items.find(t=>t[debuggerCallFrameSymbol]===e)||null}appendBlackboxURLContextMenuItems(e,t){const s=self.Persistence.persistence.binding(t);if(s&&(t=s.network),t.project().type()===Workspace.Workspace.projectTypes.FileSystem)return;const a=Bindings.BlackboxManager.BlackboxManager.instance().canBlackboxUISourceCode(t),n=Bindings.BlackboxManager.BlackboxManager.instance().isBlackboxedUISourceCode(t),i=t.project().type()===Workspace.Workspace.projectTypes.ContentScripts,o=Bindings.BlackboxManager.BlackboxManager.instance();a&&(n?e.defaultSection().appendItem(Common.UIString.UIString("Stop blackboxing"),o.unblackboxUISourceCode.bind(o,t)):e.defaultSection().appendItem(Common.UIString.UIString("Blackbox script"),o.blackboxUISourceCode.bind(o,t))),i&&(n?e.defaultSection().appendItem(Common.UIString.UIString("Stop blackboxing all content scripts"),o.blackboxContentScripts.bind(o)):e.defaultSection().appendItem(Common.UIString.UIString("Blackbox all content scripts"),o.unblackboxContentScripts.bind(o)))}_selectNextCallFrameOnStack(){const e=this.activeCallFrameItem();for(let t=e?this._items.indexOf(e)+1:0;t<this._items.length;t++){const e=this._items.at(t);if(e[debuggerCallFrameSymbol]){this._activateItem(e);break}}}_selectPreviousCallFrameOnStack(){const e=this.activeCallFrameItem();for(let t=e?this._items.indexOf(e)-1:this._items.length-1;t>=0;t--){const e=this._items.at(t);if(e[debuggerCallFrameSymbol]){this._activateItem(e);break}}}_copyStackTrace(){const e=[];for(const t of this._items){let s=t.title;t.uiLocation&&(s+=" ("+t.uiLocation.linkText(!0)+")"),e.push(s)}Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText(e.join("\n"))}}export const debuggerCallFrameSymbol=Symbol("debuggerCallFrame");export const elementSymbol=Symbol("element");export const defaultMaxAsyncStackChainDepth=32;export class ActionDelegate{handleAction(e,t){const s=self.runtime.sharedInstance(CallStackSidebarPane);switch(t){case"debugger.next-call-frame":return s._selectNextCallFrameOnStack(),!0;case"debugger.previous-call-frame":return s._selectPreviousCallFrameOnStack(),!0}return!1}}export class Item{static async createForDebuggerCallFrame(e,t,s){const a=new Item(UI.UIUtils.beautifyFunctionName(e.functionName),s);return await Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().createCallFrameLiveLocation(e.location(),a._update.bind(a),t),a}static async createItemsForAsyncStack(e,t,s,a,n){const i=Symbol("whiteboxedItems"),o=new Item(e,n);o[i]=new Set,o.isAsyncHeader=!0;const l=[],c=[];for(const e of s){const s=new Item(UI.UIUtils.beautifyFunctionName(e.functionName),r),n=t?t.createRawLocationByScriptId(e.scriptId,e.lineNumber,e.columnNumber):null;n?c.push(Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().createCallFrameLiveLocation(n,s._update.bind(s),a)):(s.linkText=(e.url||"<unknown>")+":"+(e.lineNumber+1),s.updateDelegate(s)),l.push(s)}return await Promise.all(c),n(o),[o,...l];function r(e){n(e);let t=!1;const s=o[i];e.isBlackboxed?(s.delete(e),t=0===s.size):(t=0===s.size,s.add(e)),o.isBlackboxed=0===o[i].size,t&&n(o)}}constructor(e,t){this.isBlackboxed=!1,this.title=e,this.linkText="",this.uiLocation=null,this.isAsyncHeader=!1,this.updateDelegate=t}async _update(e){const t=await e.uiLocation();this.isBlackboxed=await e.isBlackboxed(),this.linkText=t?t.linkText():"",this.uiLocation=t,this.updateDelegate(this)}}