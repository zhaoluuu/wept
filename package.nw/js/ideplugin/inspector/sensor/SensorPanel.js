import*as UI from"../ui/ui.js";import*as Common from"../common/common.js";import*as SDK from"../sdk/sdk.js";import{SensorMessenger}from"./SensorMessenger.js";import{accelerometer}from"./accelerometer.js";export class SensorPanel extends UI.Widget.VBox{constructor(){super("sensor"),this._initMessenger(),this.registerRequiredCSS("emulation/sensors.css"),this.contentElement.classList.add("sensors-view"),this._createLocationSection(),this.contentElement.createChild("div").classList.add("panel-section-separator"),this._deviceOrientation=new SDK.EmulationModel.DeviceOrientation(0,90,0),this._isAccelerometerEnabled=!1,this._createDeviceOrientationSection(),this._sensorMessenger.send("GET_SENSOR_STATUS")}_initMessenger(){this._sensorMessenger=new SensorMessenger,this._sensorMessenger.on("SET_SENSOR_STATUS",({accelerometer:t,geo:e})=>{this._enableOrientationFields(!t),this._isAccelerometerEnabled=t,e.enabled&&(this._enableLabel.checkboxElement.checked=e.enabled,this._fieldsetElement.disabled=!1),this._latitudeSetter(e.latitude||0),this._longitudeSetter(e.longitude||0),this._speedSetter(e.speed||-1),this._accuracySetter(e.accuracy||65),this._altitudeSetter(e.altitude||0),this._verticalAccuracySetter(e.verticalAccuracy||65),this._horizontalAccuracySetter(e.horizontalAccuracy||65)})}_createLocationSection(){const t=this.contentElement.createChild("section","sensors-group"),e=UI.UIUtils.createLabel(ls`Geolocation`,"sensors-group-title");t.appendChild(e);const i=t.createChild("div","geo-fields");this._enableLabel=UI.UIUtils.CheckboxLabel.create("Enable"),this._enableLabel.style.height="24px";this._enableLabel.checkboxElement.addEventListener("click",this._enableClicked.bind(this),!1),i.appendChild(this._enableLabel),this._fieldsetElement=i.createChild("fieldset"),this._fieldsetElement.disabled=!0,this._fieldsetElement.id="location-override-section";const n=this._fieldsetElement.createChild("div","latlong-group"),a=this._fieldsetElement.createChild("div","latlong-group"),s=this._fieldsetElement.createChild("div","latlong-group"),l=this._fieldsetElement.createChild("div","latlong-group"),r=this._fieldsetElement.createChild("div","latlong-group"),o=this._fieldsetElement.createChild("div","latlong-group"),c=this._fieldsetElement.createChild("div","latlong-group"),d=this._applyLocation.bind(this);this._latitudeInput=UI.UIUtils.createInput("","number"),n.appendChild(this._latitudeInput),this._latitudeInput.setAttribute("step","any"),this._latitudeInput.value=0,this._latitudeSetter=UI.UIUtils.bindInput(this._latitudeInput,d,SDK.EmulationModel.Location.latitudeValidator,!0,.1),n.appendChild(UI.UIUtils.createLabel(ls`Latitude`,"latlong-title",this._latitudeInput)),this._longitudeInput=UI.UIUtils.createInput("","number"),a.appendChild(this._longitudeInput),this._longitudeInput.setAttribute("step","any"),this._longitudeInput.value=0,this._longitudeSetter=UI.UIUtils.bindInput(this._longitudeInput,d,SDK.EmulationModel.Location.longitudeValidator,!0,.1),a.appendChild(UI.UIUtils.createLabel(ls`Longitude`,"latlong-title",this._longitudeInput)),this._speedInput=UI.UIUtils.createInput("","number"),s.appendChild(this._speedInput),this._speedInput.setAttribute("step","any"),this._speedInput.value=-1,this._speedSetter=UI.UIUtils.bindInput(this._speedInput,d,(function(t){return{valid:t>=-1}}),!0),s.appendChild(UI.UIUtils.createLabel(ls`Speed`,this._speedInput)),this._accuracyInput=UI.UIUtils.createInput("","number"),l.appendChild(this._accuracyInput),this._accuracyInput.setAttribute("step","any"),this._accuracyInput.value=65,this._accuracySetter=UI.UIUtils.bindInput(this._accuracyInput,d,(function(t){return{valid:t>=0&&t<=100}}),!0),l.appendChild(UI.UIUtils.createLabel(ls`Accuracy`,this._accuracyInput)),this._altitudeInput=UI.UIUtils.createInput("","number"),r.appendChild(this._altitudeInput),this._altitudeInput.setAttribute("step","any"),this._altitudeInput.value=0,this._altitudeSetter=UI.UIUtils.bindInput(this._altitudeInput,d,()=>({valid:!0}),!0),r.appendChild(UI.UIUtils.createLabel(ls`Altitude`,this._altitudeInput)),this._verticalAccuracyInput=UI.UIUtils.createInput("","number"),o.appendChild(this._verticalAccuracyInput),this._verticalAccuracyInput.setAttribute("step","any"),this._verticalAccuracyInput.value=65,this._verticalAccuracySetter=UI.UIUtils.bindInput(this._verticalAccuracyInput,d,(function(t){return{valid:t>=0}}),!0),o.appendChild(UI.UIUtils.createLabel(ls`Vertical Accuracy`,this._verticalAccuracyInput)),this._horizontalAccuracyInput=UI.UIUtils.createInput("","number"),c.appendChild(this._horizontalAccuracyInput),this._horizontalAccuracyInput.setAttribute("step","any"),this._horizontalAccuracyInput.value=65,this._horizontalAccuracySetter=UI.UIUtils.bindInput(this._horizontalAccuracyInput,d,(function(t){return{valid:t>=0}}),!0),c.appendChild(UI.UIUtils.createLabel(ls`Horizontal Accuracy`,this._horizontalAccuracyInput))}_enableClicked(t){this._fieldsetElement.disabled=!t.target.checked,this._applyLocation()}_applyLocation(){this._sensorMessenger.send("SET_GEO_SETTING",{enabled:this._enableLabel.checkboxElement.checked,longitude:this._longitudeInput.value,latitude:this._latitudeInput.value,speed:this._speedInput.value,accuracy:this._accuracyInput.value,altitude:this._altitudeInput.value,verticalAccuracy:this._verticalAccuracyInput.value,horizontalAccuracy:this._horizontalAccuracyInput.value})}_createDeviceOrientationSection(){const t=this.contentElement.createChild("section","sensors-group"),e=UI.UIUtils.createLabel(ls`Orientation`,"sensors-group-title");t.appendChild(e);const i=t.createChild("div","orientation-content"),n=i.createChild("div","orientation-fields");this._deviceOrientationFieldset=this._createDeviceOrientationOverrideElement(),this._stageElement=i.createChild("div","orientation-stage"),this._orientationLayer=this._stageElement.createChild("div","orientation-layer"),this._boxElement=this._orientationLayer.createChild("section","orientation-box orientation-element"),this._boxElement.createChild("section","orientation-front orientation-element"),this._boxElement.createChild("section","orientation-top orientation-element"),this._boxElement.createChild("section","orientation-back orientation-element"),this._boxElement.createChild("section","orientation-left orientation-element"),this._boxElement.createChild("section","orientation-right orientation-element"),this._boxElement.createChild("section","orientation-bottom orientation-element"),UI.UIUtils.installDragHandle(this._stageElement,this._onBoxDragStart.bind(this),t=>{this._onBoxDrag(t)},null,"-webkit-grabbing","-webkit-grab"),n.appendChild(this._deviceOrientationFieldset),this._enableOrientationFields(!0),this._setBoxOrientation(this._deviceOrientation)}_enableOrientationFields(t){t?(this._deviceOrientationFieldset.disabled=!0,this._stageElement.classList.add("disabled"),this._stageElement.title=ls`Enable orientation to rotate`):(this._deviceOrientationFieldset.disabled=!1,this._stageElement.classList.remove("disabled"),this._stageElement.title=ls`Shift+drag horizontally to rotate around the y-axis`)}_applyDeviceOrientation(){const{alpha:t,beta:e,gamma:i}=JSON.parse(this._deviceOrientation.toSetting());accelerometer.setEulerAngles({alpha:t,beta:e,gamma:i});let{accelX:n,accelY:a,accelZ:s}=accelerometer;if(n=parseFloat(n.toFixed(5)),a=parseFloat(a.toFixed(5)),s=parseFloat(s.toFixed(5)),this._xElement.value=n,this._yElement.value=a,this._zElement.value=s,this._isAccelerometerEnabled){const t=SDK.SDKModel.TargetManager.instance().mainTarget().model(SDK.RuntimeModel.RuntimeModel).executionContexts();let e;for(const i of t)if(isTopContext(i)){e=i;break}e.evaluate({expression:`window.DeviceOrientation(${n}, ${a}, ${s})`,objectGroup:"console",includeCommandLineAPI:!1,silent:!0,returnByValue:!1,generatePreview:!1},!1,!1)}}_createDeviceOrientationOverrideElement(){const t=createElement("fieldset");t.classList.add("device-orientation-override-section");const e=t.createChild("td","orientation-inputs-cell");this._xElement=UI.UIUtils.createInput(),this._xElement.value=0,this._xElement.disabled=!0,this._xElement.setAttribute("step","any"),this._xSetter=this._createAxisInput(e,this._xElement,Common.UIString.UIString("X")),this._yElement=UI.UIUtils.createInput(),this._yElement.value=-1,this._yElement.disabled=!0,this._yElement.setAttribute("step","any"),this._ySetter=this._createAxisInput(e,this._yElement,Common.UIString.UIString("Y")),this._zElement=UI.UIUtils.createInput(),this._zElement.value=0,this._zElement.disabled=!0,this._zElement.setAttribute("step","any"),this._zSetter=this._createAxisInput(e,this._zElement,Common.UIString.UIString("Z"));const i=UI.UIUtils.createTextButton(Common.UIString.UIString("Reset"),this._resetDeviceOrientation.bind(this),"orientation-reset-button");return i.setAttribute("type","reset"),e.appendChild(i),t}_resetDeviceOrientation(){this._setDeviceOrientation(new SDK.EmulationModel.DeviceOrientation(0,90,0))}_setDeviceOrientation(t){t&&(this._setBoxOrientation(t),this._deviceOrientation=t,this._applyDeviceOrientation())}_createAxisInput(t,e,i){const n=t.createChild("div","orientation-axis-input-container");return n.appendChild(e),n.appendChild(UI.UIUtils.createLabel(i,"",e)),e.type="number",e}_setBoxOrientation(t){this._stageElement.classList.remove("is-animating");const e=new WebKitCSSMatrix;this._boxMatrix=e.rotate(-t.beta,t.gamma,-t.alpha);const i=new UI.Geometry.EulerAngles(t.alpha,t.beta,t.gamma);this._orientationLayer.style.transform=i.toRotate3DString()}_onBoxDrag(t){const e=this._calculateRadiusVector(t.x,t.y);if(!e)return!0;let i,n;t.consume(!0),t.shiftKey?(i=new UI.Geometry.Vector(0,0,-1),n=(this._mouseDownVector.x-e.x)*ShiftDragOrientationSpeed):(i=UI.Geometry.crossProduct(this._mouseDownVector,e),n=UI.Geometry.calculateAngle(this._mouseDownVector,e));let a=new WebKitCSSMatrix;a=a.rotate(-90,0,0).rotateAxisAngle(i.x,i.y,i.z,n).rotate(90,0,0).multiply(this._originalBoxMatrix);const s=UI.Geometry.EulerAngles.fromRotationMatrix(a),l=new SDK.EmulationModel.DeviceOrientation(-s.alpha,-s.beta,s.gamma);return this._setDeviceOrientation(l),!1}_onBoxDragStart(t){return!!this._isAccelerometerEnabled&&(this._mouseDownVector=this._calculateRadiusVector(t.x,t.y),this._originalBoxMatrix=this._boxMatrix,!!this._mouseDownVector&&(t.consume(!0),!0))}_calculateRadiusVector(t,e){const i=this._stageElement.getBoundingClientRect(),n=Math.max(i.width,i.height)/2,a=(t-i.left-i.width/2)/n,s=(e-i.top-i.height/2)/n,l=a*a+s*s;return l>.5?new UI.Geometry.Vector(a,s,.5/Math.sqrt(l)):new UI.Geometry.Vector(a,s,Math.sqrt(1-l))}}export const ShiftDragOrientationSpeed=16;function isTopContext(t){if(!t||!t.isDefault)return!1;const e=t.target().model(SDK.ResourceTreeModel.ResourceTreeModel),i=t.frameId&&e&&e.frameForId(t.frameId);return!!i&&i.isTopFrame()}