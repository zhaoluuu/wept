import*as Common from"../common/common.js";import*as Platform from"../platform/platform.js";import*as UI from"../ui/ui.js";import{CSSLength,CSSShadowModel}from"./CSSShadowModel.js";const maxRange=20,defaultUnit="px",sliderThumbRadius=6,canvasSize=88;export class CSSShadowEditor extends UI.Widget.VBox{constructor(){super(!0),this.registerRequiredCSS("inline_editor/cssShadowEditor.css"),this.contentElement.tabIndex=0,this.setDefaultFocusedElement(this.contentElement),this._typeField=this.contentElement.createChild("div","shadow-editor-field shadow-editor-flex-field"),this._typeField.createChild("label","shadow-editor-label").textContent=Common.UIString.UIString("Type"),this._outsetButton=this._typeField.createChild("button","shadow-editor-button-left"),this._outsetButton.textContent=Common.UIString.UIString("Outset"),this._outsetButton.addEventListener("click",this._onButtonClick.bind(this),!1),this._insetButton=this._typeField.createChild("button","shadow-editor-button-right"),this._insetButton.textContent=Common.UIString.UIString("Inset"),this._insetButton.addEventListener("click",this._onButtonClick.bind(this),!1);const t=this.contentElement.createChild("div","shadow-editor-field");this._xInput=this._createTextInput(t,Common.UIString.UIString("X offset"));const e=this.contentElement.createChild("div","shadow-editor-field");this._yInput=this._createTextInput(e,Common.UIString.UIString("Y offset")),this._xySlider=t.createChild("canvas","shadow-editor-2D-slider"),this._xySlider.width=88,this._xySlider.height=88,this._xySlider.tabIndex=-1,this._halfCanvasSize=44,this._innerCanvasSize=this._halfCanvasSize-6,UI.UIUtils.installDragHandle(this._xySlider,this._dragStart.bind(this),this._dragMove.bind(this),null,"default"),this._xySlider.addEventListener("keydown",this._onCanvasArrowKey.bind(this),!1),this._xySlider.addEventListener("blur",this._onCanvasBlur.bind(this),!1);const i=this.contentElement.createChild("div","shadow-editor-field shadow-editor-flex-field shadow-editor-blur-field");this._blurInput=this._createTextInput(i,Common.UIString.UIString("Blur")),this._blurSlider=this._createSlider(i),this._spreadField=this.contentElement.createChild("div","shadow-editor-field shadow-editor-flex-field"),this._spreadInput=this._createTextInput(this._spreadField,Common.UIString.UIString("Spread")),this._spreadSlider=this._createSlider(this._spreadField)}_createTextInput(t,e){const i=t.createChild("label","shadow-editor-label");i.textContent=e,i.setAttribute("for",e);const s=UI.UIUtils.createInput("shadow-editor-text-input","text");return t.appendChild(s),s.id=e,s.addEventListener("keydown",this._handleValueModification.bind(this),!1),s.addEventListener("mousewheel",this._handleValueModification.bind(this),!1),s.addEventListener("input",this._onTextInput.bind(this),!1),s.addEventListener("blur",this._onTextBlur.bind(this),!1),s}_createSlider(t){const e=UI.UIUtils.createSlider(0,20,-1);return e.addEventListener("input",this._onSliderInput.bind(this),!1),t.appendChild(e),e}wasShown(){this._updateUI()}setModel(t){this._model=t,this._typeField.classList.toggle("hidden",!t.isBoxShadow()),this._spreadField.classList.toggle("hidden",!t.isBoxShadow()),this._updateUI()}_updateUI(){this._updateButtons(),this._xInput.value=this._model.offsetX().asCSSText(),this._yInput.value=this._model.offsetY().asCSSText(),this._blurInput.value=this._model.blurRadius().asCSSText(),this._spreadInput.value=this._model.spreadRadius().asCSSText(),this._blurSlider.value=this._model.blurRadius().amount,this._spreadSlider.value=this._model.spreadRadius().amount,this._updateCanvas(!1)}_updateButtons(){this._insetButton.classList.toggle("enabled",this._model.inset()),this._outsetButton.classList.toggle("enabled",!this._model.inset())}_updateCanvas(t){const e=this._xySlider.getContext("2d");e.clearRect(0,0,this._xySlider.width,this._xySlider.height),e.save(),e.setLineDash([1,1]),e.strokeStyle="rgba(210, 210, 210, 0.8)",e.beginPath(),e.moveTo(this._halfCanvasSize,0),e.lineTo(this._halfCanvasSize,88),e.moveTo(0,this._halfCanvasSize),e.lineTo(88,this._halfCanvasSize),e.stroke(),e.restore();const i=this._sliderThumbPosition();e.save(),e.translate(this._halfCanvasSize,this._halfCanvasSize),e.lineWidth=2,e.strokeStyle="rgba(130, 130, 130, 0.75)",e.beginPath(),e.moveTo(0,0),e.lineTo(i.x,i.y),e.stroke(),t&&(e.beginPath(),e.fillStyle="rgba(66, 133, 244, 0.4)",e.arc(i.x,i.y,8,0,2*Math.PI),e.fill()),e.beginPath(),e.fillStyle="#4285F4",e.arc(i.x,i.y,6,0,2*Math.PI),e.fill(),e.restore()}_onButtonClick(t){const e=t.currentTarget===this._insetButton;e&&this._model.inset()||!e&&!this._model.inset()||(this._model.setInset(e),this._updateButtons(),this.dispatchEventToListeners(Events.ShadowChanged,this._model))}_handleValueModification(t){const e=UI.UIUtils.createReplacementString(t.currentTarget.value,t,(function(t,e,i){i.length||(i="px");return t+e+i}));if(!e)return;const i=CSSLength.parse(e);i&&(t.currentTarget===this._blurInput&&i.amount<0&&(i.amount=0),t.currentTarget.value=i.asCSSText(),t.currentTarget.selectionStart=0,t.currentTarget.selectionEnd=t.currentTarget.value.length,this._onTextInput(t),t.consume(!0))}_onTextInput(t){this._changedElement=t.currentTarget,this._changedElement.classList.remove("invalid");const e=CSSLength.parse(t.currentTarget.value);!e||t.currentTarget===this._blurInput&&e.amount<0||(t.currentTarget===this._xInput?(this._model.setOffsetX(e),this._updateCanvas(!1)):t.currentTarget===this._yInput?(this._model.setOffsetY(e),this._updateCanvas(!1)):t.currentTarget===this._blurInput?(this._model.setBlurRadius(e),this._blurSlider.value=e.amount):t.currentTarget===this._spreadInput&&(this._model.setSpreadRadius(e),this._spreadSlider.value=e.amount),this.dispatchEventToListeners(Events.ShadowChanged,this._model))}_onTextBlur(){if(!this._changedElement)return;let t=this._changedElement.value.trim()?CSSLength.parse(this._changedElement.value):CSSLength.zero();if(t||(t=CSSLength.parse(this._changedElement.value+"px")),!t)return this._changedElement.classList.add("invalid"),void(this._changedElement=null);this._changedElement===this._xInput?(this._model.setOffsetX(t),this._xInput.value=t.asCSSText(),this._updateCanvas(!1)):this._changedElement===this._yInput?(this._model.setOffsetY(t),this._yInput.value=t.asCSSText(),this._updateCanvas(!1)):this._changedElement===this._blurInput?(t.amount<0&&(t=CSSLength.zero()),this._model.setBlurRadius(t),this._blurInput.value=t.asCSSText(),this._blurSlider.value=t.amount):this._changedElement===this._spreadInput&&(this._model.setSpreadRadius(t),this._spreadInput.value=t.asCSSText(),this._spreadSlider.value=t.amount),this._changedElement=null,this.dispatchEventToListeners(Events.ShadowChanged,this._model)}_onSliderInput(t){t.currentTarget===this._blurSlider?(this._model.setBlurRadius(new CSSLength(this._blurSlider.value,this._model.blurRadius().unit||"px")),this._blurInput.value=this._model.blurRadius().asCSSText(),this._blurInput.classList.remove("invalid")):t.currentTarget===this._spreadSlider&&(this._model.setSpreadRadius(new CSSLength(this._spreadSlider.value,this._model.spreadRadius().unit||"px")),this._spreadInput.value=this._model.spreadRadius().asCSSText(),this._spreadInput.classList.remove("invalid")),this.dispatchEventToListeners(Events.ShadowChanged,this._model)}_dragStart(t){this._xySlider.focus(),this._updateCanvas(!0),this._canvasOrigin=new UI.Geometry.Point(this._xySlider.totalOffsetLeft()+this._halfCanvasSize,this._xySlider.totalOffsetTop()+this._halfCanvasSize);const e=new UI.Geometry.Point(t.x-this._canvasOrigin.x,t.y-this._canvasOrigin.y),i=this._sliderThumbPosition();return e.distanceTo(i)>=6&&this._dragMove(t),!0}_dragMove(t){let e=new UI.Geometry.Point(t.x-this._canvasOrigin.x,t.y-this._canvasOrigin.y);t.shiftKey&&(e=this._snapToClosestDirection(e));const i=this._constrainPoint(e,this._innerCanvasSize),s=Math.round(i.x/this._innerCanvasSize*20),n=Math.round(i.y/this._innerCanvasSize*20);t.shiftKey?(this._model.setOffsetX(new CSSLength(s,this._model.offsetX().unit||"px")),this._model.setOffsetY(new CSSLength(n,this._model.offsetY().unit||"px"))):(t.altKey||this._model.setOffsetX(new CSSLength(s,this._model.offsetX().unit||"px")),UI.KeyboardShortcut.KeyboardShortcut.eventHasCtrlOrMeta(t)||this._model.setOffsetY(new CSSLength(n,this._model.offsetY().unit||"px"))),this._xInput.value=this._model.offsetX().asCSSText(),this._yInput.value=this._model.offsetY().asCSSText(),this._xInput.classList.remove("invalid"),this._yInput.classList.remove("invalid"),this._updateCanvas(!0),this.dispatchEventToListeners(Events.ShadowChanged,this._model)}_onCanvasBlur(){this._updateCanvas(!1)}_onCanvasArrowKey(t){let e=0,i=0;if("ArrowRight"===t.key?e=1:"ArrowLeft"===t.key?e=-1:"ArrowUp"===t.key?i=-1:"ArrowDown"===t.key&&(i=1),e||i){if(t.consume(!0),e){const t=this._model.offsetX(),i=Platform.NumberUtilities.clamp(t.amount+e,-20,20);if(i===t.amount)return;this._model.setOffsetX(new CSSLength(i,t.unit||"px")),this._xInput.value=this._model.offsetX().asCSSText(),this._xInput.classList.remove("invalid")}if(i){const t=this._model.offsetY(),e=Platform.NumberUtilities.clamp(t.amount+i,-20,20);if(e===t.amount)return;this._model.setOffsetY(new CSSLength(e,t.unit||"px")),this._yInput.value=this._model.offsetY().asCSSText(),this._yInput.classList.remove("invalid")}this._updateCanvas(!0),this.dispatchEventToListeners(Events.ShadowChanged,this._model)}}_constrainPoint(t,e){return Math.abs(t.x)<=e&&Math.abs(t.y)<=e?new UI.Geometry.Point(t.x,t.y):t.scale(e/Math.max(Math.abs(t.x),Math.abs(t.y)))}_snapToClosestDirection(t){let e=Number.MAX_VALUE,i=t;const s=[new UI.Geometry.Point(0,-1),new UI.Geometry.Point(1,-1),new UI.Geometry.Point(1,0),new UI.Geometry.Point(1,1)];for(const n of s){const s=t.projectOn(n),a=t.distanceTo(s);a<e&&(e=a,i=s)}return i}_sliderThumbPosition(){const t=this._model.offsetX().amount/20*this._innerCanvasSize,e=this._model.offsetY().amount/20*this._innerCanvasSize;return this._constrainPoint(new UI.Geometry.Point(t,e),this._innerCanvasSize)}}export const Events={ShadowChanged:Symbol("ShadowChanged")};