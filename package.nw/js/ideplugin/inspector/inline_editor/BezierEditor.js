import*as Common from"../common/common.js";import*as Platform from"../platform/platform.js";import*as UI from"../ui/ui.js";import{BezierUI}from"./BezierUI.js";export class BezierEditor extends UI.Widget.VBox{constructor(){super(!0),this.registerRequiredCSS("inline_editor/bezierEditor.css"),this.contentElement.tabIndex=0,this.setDefaultFocusedElement(this.contentElement),this._previewElement=this.contentElement.createChild("div","bezier-preview-container"),this._previewElement.createChild("div","bezier-preview-animation"),this._previewElement.addEventListener("click",this._startPreviewAnimation.bind(this)),this._previewOnion=this.contentElement.createChild("div","bezier-preview-onion"),this._previewOnion.addEventListener("click",this._startPreviewAnimation.bind(this)),this._outerContainer=this.contentElement.createChild("div","bezier-container"),this._presetsContainer=this._outerContainer.createChild("div","bezier-presets"),this._presetUI=new BezierUI(40,40,0,2,!1),this._presetCategories=[];for(let e=0;e<Presets.length;e++)this._presetCategories[e]=this._createCategory(Presets[e]),this._presetsContainer.appendChild(this._presetCategories[e].icon);this._curveUI=new BezierUI(150,250,50,7,!0),this._curve=this._outerContainer.createSVGChild("svg","bezier-curve"),UI.UIUtils.installDragHandle(this._curve,this._dragStart.bind(this),this._dragMove.bind(this),this._dragEnd.bind(this),"default"),this._header=this.contentElement.createChild("div","bezier-header");const e=this._createPresetModifyIcon(this._header,"bezier-preset-minus","M 12 6 L 8 10 L 12 14"),t=this._createPresetModifyIcon(this._header,"bezier-preset-plus","M 8 6 L 12 10 L 8 14");e.addEventListener("click",this._presetModifyClicked.bind(this,!1)),t.addEventListener("click",this._presetModifyClicked.bind(this,!0)),this._label=this._header.createChild("span","source-code bezier-display-value")}setBezier(e){e&&(this._bezier=e,this._updateUI())}bezier(){return this._bezier}wasShown(){this._unselectPresets();for(const e of this._presetCategories)for(let t=0;t<e.presets.length;t++)this._bezier.asCSSText()===e.presets[t].value&&(e.presetIndex=t,this._presetCategorySelected(e));this._updateUI(),this._startPreviewAnimation()}_onchange(){this._updateUI(),this.dispatchEventToListeners(Events.BezierChanged,this._bezier.asCSSText())}_updateUI(){const e=this._selectedCategory?this._selectedCategory.presets[this._selectedCategory.presetIndex].name:this._bezier.asCSSText().replace(/\s(-\d\.\d)/g,"$1");this._label.textContent=Common.UIString.UIString(e),this._curveUI.drawCurve(this._bezier,this._curve),this._previewOnion.removeChildren()}_dragStart(e){this._mouseDownPosition=new UI.Geometry.Point(e.x,e.y);const t=this._curveUI;this._controlPosition=new UI.Geometry.Point(Platform.NumberUtilities.clamp((e.offsetX-t.radius)/t.curveWidth(),0,1),(t.curveHeight()+t.marginTop+t.radius-e.offsetY)/t.curveHeight());const i=this._controlPosition.distanceTo(this._bezier.controlPoints[0])<this._controlPosition.distanceTo(this._bezier.controlPoints[1]);return this._selectedPoint=i?0:1,this._bezier.controlPoints[this._selectedPoint]=this._controlPosition,this._unselectPresets(),this._onchange(),e.consume(!0),!0}_updateControlPosition(e,t){const i=(e-this._mouseDownPosition.x)/this._curveUI.curveWidth(),s=(t-this._mouseDownPosition.y)/this._curveUI.curveHeight(),r=new UI.Geometry.Point(Platform.NumberUtilities.clamp(this._controlPosition.x+i,0,1),this._controlPosition.y-s);this._bezier.controlPoints[this._selectedPoint]=r}_dragMove(e){this._updateControlPosition(e.x,e.y),this._onchange()}_dragEnd(e){this._updateControlPosition(e.x,e.y),this._onchange(),this._startPreviewAnimation()}_createCategory(e){const t=document.createElement("div");t.classList.add("bezier-preset-category");const i=t.createSVGChild("svg","bezier-preset monospace"),s={presets:e,presetIndex:0,icon:t};return this._presetUI.drawCurve(UI.Geometry.CubicBezier.parse(s.presets[0].value),i),i.addEventListener("click",this._presetCategorySelected.bind(this,s)),s}_createPresetModifyIcon(e,t,i){const s=e.createSVGChild("svg","bezier-preset-modify "+t);s.setAttribute("width",20),s.setAttribute("height",20);return s.createSVGChild("path").setAttribute("d",i),s}_unselectPresets(){for(const e of this._presetCategories)e.icon.classList.remove("bezier-preset-selected");delete this._selectedCategory,this._header.classList.remove("bezier-header-active")}_presetCategorySelected(e,t){this._selectedCategory!==e&&(this._unselectPresets(),this._header.classList.add("bezier-header-active"),this._selectedCategory=e,this._selectedCategory.icon.classList.add("bezier-preset-selected"),this.setBezier(UI.Geometry.CubicBezier.parse(e.presets[e.presetIndex].value)),this._onchange(),this._startPreviewAnimation(),t&&t.consume(!0))}_presetModifyClicked(e,t){if(!this._selectedCategory)return;const i=this._selectedCategory.presets.length;this._selectedCategory.presetIndex=(this._selectedCategory.presetIndex+(e?1:-1)+i)%i,this.setBezier(UI.Geometry.CubicBezier.parse(this._selectedCategory.presets[this._selectedCategory.presetIndex].value)),this._onchange(),this._startPreviewAnimation()}_startPreviewAnimation(){this._previewAnimation&&this._previewAnimation.cancel();const e=[{offset:0,transform:"translateX(0px)",easing:this._bezier.asCSSText(),opacity:1},{offset:.9,transform:"translateX(218px)",opacity:1},{offset:1,transform:"translateX(218px)",opacity:0}];this._previewAnimation=this._previewElement.animate(e,1600),this._previewOnion.removeChildren();for(let e=0;e<=20;e++){const t=this._previewOnion.createChild("div","bezier-preview-animation").animate([{transform:"translateX(0px)",easing:this._bezier.asCSSText()},{transform:"translateX(218px)"}],{duration:1600,fill:"forwards"});t.pause(),t.currentTime=1600*e/20}}}export const Events={BezierChanged:Symbol("BezierChanged")};export const Presets=[[{name:"ease-in-out",value:"ease-in-out"},{name:"In Out · Sine",value:"cubic-bezier(0.45, 0.05, 0.55, 0.95)"},{name:"In Out · Quadratic",value:"cubic-bezier(0.46, 0.03, 0.52, 0.96)"},{name:"In Out · Cubic",value:"cubic-bezier(0.65, 0.05, 0.36, 1)"},{name:"Fast Out, Slow In",value:"cubic-bezier(0.4, 0, 0.2, 1)"},{name:"In Out · Back",value:"cubic-bezier(0.68, -0.55, 0.27, 1.55)"}],[{name:"Fast Out, Linear In",value:"cubic-bezier(0.4, 0, 1, 1)"},{name:"ease-in",value:"ease-in"},{name:"In · Sine",value:"cubic-bezier(0.47, 0, 0.75, 0.72)"},{name:"In · Quadratic",value:"cubic-bezier(0.55, 0.09, 0.68, 0.53)"},{name:"In · Cubic",value:"cubic-bezier(0.55, 0.06, 0.68, 0.19)"},{name:"In · Back",value:"cubic-bezier(0.6, -0.28, 0.74, 0.05)"}],[{name:"ease-out",value:"ease-out"},{name:"Out · Sine",value:"cubic-bezier(0.39, 0.58, 0.57, 1)"},{name:"Out · Quadratic",value:"cubic-bezier(0.25, 0.46, 0.45, 0.94)"},{name:"Out · Cubic",value:"cubic-bezier(0.22, 0.61, 0.36, 1)"},{name:"Linear Out, Slow In",value:"cubic-bezier(0, 0, 0.2, 1)"},{name:"Out · Back",value:"cubic-bezier(0.18, 0.89, 0.32, 1.28)"}]];export let PresetCategory;