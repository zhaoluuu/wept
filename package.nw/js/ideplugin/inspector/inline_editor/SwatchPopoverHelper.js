import*as Common from"../common/common.js";import*as UI from"../ui/ui.js";export class SwatchPopoverHelper extends Common.ObjectWrapper.ObjectWrapper{constructor(){super(),this._popover=new UI.GlassPane.GlassPane,this._popover.registerRequiredCSS("inline_editor/swatchPopover.css"),this._popover.setSizeBehavior(UI.GlassPane.SizeBehavior.MeasureContent),this._popover.setMarginBehavior(UI.GlassPane.MarginBehavior.Arrow),this._popover.element.addEventListener("mousedown",e=>e.consume(),!1),this._hideProxy=this.hide.bind(this,!0),this._boundOnKeyDown=this._onKeyDown.bind(this),this._boundFocusOut=this._onFocusOut.bind(this),this._isHidden=!0}_onFocusOut(e){this._isHidden||!e.relatedTarget||e.relatedTarget.isSelfOrDescendant(this._view.contentElement)||this._hideProxy()}isShowing(){return this._popover.isShowing()}show(e,t,i){if(this._popover.isShowing()){if(this._anchorElement===t)return;this.hide(!0)}delete this._isHidden,this._anchorElement=t,this._view=e,this._hiddenCallback=i,this.reposition(),e.focus();const o=this._popover.element.ownerDocument;o.addEventListener("mousedown",this._hideProxy,!1),o.defaultView.addEventListener("resize",this._hideProxy,!1),this._view.contentElement.addEventListener("keydown",this._boundOnKeyDown,!1)}reposition(){this._isHidden||(this._view.contentElement.removeEventListener("focusout",this._boundFocusOut,!1),this._view.show(this._popover.contentElement),this._popover.setContentAnchorBox(this._anchorElement.boxInWindow()),this._popover.show(this._anchorElement.ownerDocument),this._view.contentElement.addEventListener("focusout",this._boundFocusOut,!1),this._focusRestorer||(this._focusRestorer=new UI.Widget.WidgetFocusRestorer(this._view)))}hide(e){if(this._isHidden)return;const t=this._popover.element.ownerDocument;this._isHidden=!0,this._popover.hide(),t.removeEventListener("mousedown",this._hideProxy,!1),t.defaultView.removeEventListener("resize",this._hideProxy,!1),this._hiddenCallback&&this._hiddenCallback.call(null,!!e),this._focusRestorer.restore(),delete this._anchorElement,this._view&&(this._view.detach(),this._view.contentElement.removeEventListener("keydown",this._boundOnKeyDown,!1),this._view.contentElement.removeEventListener("focusout",this._boundFocusOut,!1),delete this._view)}_onKeyDown(e){if("Enter"===e.key)return this.hide(!0),void e.consume(!0);"Escape"===e.key&&(this.hide(!1),e.consume(!0))}}