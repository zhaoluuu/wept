import*as Platform from"../platform/platform.js";import{DataGridImpl,DataGridNode,Parameters}from"./DataGrid.js";export class ViewportDataGrid extends DataGridImpl{constructor(t){super(t),this._onScrollBound=this._onScroll.bind(this),this.scrollContainer.addEventListener("scroll",this._onScrollBound,!0),this._visibleNodes=[],this._inline=!1,this._stickToBottom=!1,this._updateIsFromUser=!1,this._lastScrollTop=0,this._firstVisibleIsStriped=!1,this._isStriped=!1,this.setRootNode(new ViewportDataGridNode)}setStriped(t){this._isStriped=t;let e=!0;if(this._visibleNodes.length){e=!!this.rootNode().flatChildren().indexOf(this._visibleNodes[0])}this._updateStripesClass(e)}_updateStripesClass(t){this.element.classList.toggle("striped-data-grid",!t&&this._isStriped),this.element.classList.toggle("striped-data-grid-starts-with-odd",t&&this._isStriped)}setScrollContainer(t){this.scrollContainer.removeEventListener("scroll",this._onScrollBound,!0),this._scrollContainer=t,this.scrollContainer.addEventListener("scroll",this._onScrollBound,!0)}onResize(){this._stickToBottom&&(this.scrollContainer.scrollTop=this.scrollContainer.scrollHeight-this.scrollContainer.clientHeight),this.scheduleUpdate(),super.onResize()}setStickToBottom(t){this._stickToBottom=t}_onScroll(t){this._stickToBottom=this.scrollContainer.isScrolledToBottom(),this._lastScrollTop!==this.scrollContainer.scrollTop&&this.scheduleUpdate(!0)}scheduleUpdateStructure(){this.scheduleUpdate()}scheduleUpdate(t){this._stickToBottom&&t&&(this._stickToBottom=this.scrollContainer.isScrolledToBottom()),this._updateIsFromUser=this._updateIsFromUser||t,this._updateAnimationFrameId||(this._updateAnimationFrameId=this.element.window().requestAnimationFrame(this._update.bind(this)))}updateInstantly(){this._update()}renderInline(){this._inline=!0,super.renderInline(),this._update()}_calculateVisibleNodes(t,e){const i=this.rootNode().flatChildren();if(this._inline)return{topPadding:0,bottomPadding:0,contentHeight:0,visibleNodes:i,offset:0};const s=i.length;let l=0,o=0;for(;l<s&&o+i[l].nodeSelfHeight()<e;++l)o+=i[l].nodeSelfHeight();const r=l,n=o;for(;l<s&&o<e+t;++l)o+=i[l].nodeSelfHeight();const d=l;let a=0;for(;l<s;++l)a+=i[l].nodeSelfHeight();return{topPadding:n,bottomPadding:a,contentHeight:o-n,visibleNodes:i.slice(r,d),offset:r}}_contentHeight(){const t=this.rootNode().flatChildren();let e=0;for(let i=0,s=t.length;i<s;++i)e+=t[i].nodeSelfHeight();return e}_update(){this._updateAnimationFrameId&&(this.element.window().cancelAnimationFrame(this._updateAnimationFrameId),delete this._updateAnimationFrameId);const t=this.scrollContainer.clientHeight;let e=this.scrollContainer.scrollTop;const i=e,s=Math.max(0,this._contentHeight()-t);!this._updateIsFromUser&&this._stickToBottom&&(e=s),this._updateIsFromUser=!1,e=Math.min(s,e);const l=this._calculateVisibleNodes(t,e),o=l.visibleNodes,r=new Set(o);for(let t=0;t<this._visibleNodes.length;++t){const e=this._visibleNodes[t];if(!r.has(e)&&e.attached()){e.existingElement().remove()}}let n=this.topFillerRowElement();const d=this.dataTableBody;let a=l.offset;if(o.length){const t=this.rootNode().flatChildren().indexOf(o[0]);this._updateStripesClass(!!(t%2)),this._stickToBottom&&-1!==t&&!!(t%2)!==this._firstVisibleIsStriped&&(a+=1)}this._firstVisibleIsStriped=!!(a%2);for(let t=0;t<o.length;++t){const e=o[t],i=e.element();e.setStriped((a+t)%2==0),i!==n.nextSibling&&d.insertBefore(i,n.nextSibling),e.revealed=!0,n=i}this.setVerticalPadding(l.topPadding,l.bottomPadding),this._lastScrollTop=e,e!==i&&(this.scrollContainer.scrollTop=e);const h=l.contentHeight<=t&&l.topPadding+l.bottomPadding===0;h!==this.element.classList.contains("data-grid-fits-viewport")&&(this.element.classList.toggle("data-grid-fits-viewport",h),this.updateWidths()),this._visibleNodes=o,this.dispatchEventToListeners(Events.ViewportCalculated)}_revealViewportNode(t){const e=this.rootNode().flatChildren(),i=e.indexOf(t);if(-1===i)return;let s=0;for(let t=0;t<i;++t)s+=e[t].nodeSelfHeight();const l=s+t.nodeSelfHeight();let o=this.scrollContainer.scrollTop;o>s?(o=s,this._stickToBottom=!1):o+this.scrollContainer.offsetHeight<l&&(o=l-this.scrollContainer.offsetHeight),this.scrollContainer.scrollTop=o}}export const Events={ViewportCalculated:Symbol("ViewportCalculated")};export class ViewportDataGridNode extends DataGridNode{constructor(t,e){super(t,e),this._stale=!1,this._flatNodes=null,this._isStriped=!1}element(){const t=this.existingElement(),e=t||this.createElement();return t&&!this._stale||(this.createCells(e),this._stale=!1),e}setStriped(t){this._isStriped=t,this.element().classList.toggle("odd",t)}isStriped(){return this._isStriped}clearFlatNodes(){this._flatNodes=null;const t=this.parent;t&&t.clearFlatNodes()}flatChildren(){if(this._flatNodes)return this._flatNodes;const t=[],e=[this.children],i=[0];let s=0;for(;s>=0;){if(e[s].length<=i[s]){s--;continue}const l=e[s][i[s]++];t.push(l),l.expanded&&l.children.length&&(s++,e[s]=l.children,i[s]=0)}return this._flatNodes=t,t}insertChild(t,e){if(this.clearFlatNodes(),t.parent===this){const i=this.children.indexOf(t);if(i<0&&console.assert(!1,"Inconsistent DataGrid state"),i===e)return;i<e&&--e}t.remove(),t.parent=this,t.dataGrid=this.dataGrid,this.children.length||this.setHasChildren(!0),this.children.splice(e,0,t),t.recalculateSiblings(e),this.expanded&&this.dataGrid.scheduleUpdateStructure()}removeChild(t){if(this.clearFlatNodes(),this.dataGrid&&this.dataGrid.updateSelectionBeforeRemoval(t,!1),t.previousSibling&&(t.previousSibling.nextSibling=t.nextSibling),t.nextSibling&&(t.nextSibling.previousSibling=t.previousSibling),t.parent!==this)throw"removeChild: Node is not a child of this node.";Platform.ArrayUtilities.removeElement(this.children,t,!0),t._unlink(),this.children.length||this.setHasChildren(!1),this.expanded&&this.dataGrid.scheduleUpdateStructure()}removeChildren(){this.clearFlatNodes(),this.dataGrid&&this.dataGrid.updateSelectionBeforeRemoval(this,!0);for(let t=0;t<this.children.length;++t)this.children[t]._unlink();this.children=[],this.expanded&&this.dataGrid.scheduleUpdateStructure()}_unlink(){this.attached()&&this.existingElement().remove(),this.resetNode()}collapse(){this.expanded&&(this.clearFlatNodes(),this._expanded=!1,this.existingElement()&&this.existingElement().classList.remove("expanded"),this.selected&&this.dataGrid.updateGridAccessibleName(ls`collapsed`),this.dataGrid.scheduleUpdateStructure())}expand(){this.expanded||(this.dataGrid._stickToBottom=!1,this.clearFlatNodes(),super.expand(),this.dataGrid.scheduleUpdateStructure())}attached(){return!!(this.dataGrid&&this.existingElement()&&this.existingElement().parentElement)}refresh(){this.attached()?(this._stale=!0,this.dataGrid.scheduleUpdate()):this.resetElement()}reveal(){this.dataGrid._revealViewportNode(this)}recalculateSiblings(t){this.clearFlatNodes(),super.recalculateSiblings(t)}}