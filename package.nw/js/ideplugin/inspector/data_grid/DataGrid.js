import*as Common from"../common/common.js";import*as Platform from"../platform/platform.js";import*as UI from"../ui/ui.js";export class DataGridImpl extends Common.ObjectWrapper.ObjectWrapper{constructor(e){super();const{displayName:t,columns:i,editCallback:s,deleteCallback:l,refreshCallback:n}=e;this.element=document.createElement("div"),this.element.classList.add("data-grid"),UI.Utils.appendStyle(this.element,"data_grid/dataGrid.css"),this.element.tabIndex=0,this.element.addEventListener("keydown",this._keyDown.bind(this),!1),this.element.addEventListener("contextmenu",this._contextMenu.bind(this),!0),this.element.addEventListener("focusin",e=>{this.updateGridAccessibleNameOnFocus(),e.consume(!0)}),this.element.addEventListener("focusout",e=>{this.updateGridAccessibleName(""),e.consume(!0)}),UI.ARIAUtils.markAsApplication(this.element),this._displayName=t,this._editCallback=s,this._deleteCallback=l,this._refreshCallback=n;const d=this.element.createChild("div","header-container");this._headerTable=d.createChild("table","header"),UI.ARIAUtils.markAsHidden(this._headerTable),this._headerTableHeaders={},this._scrollContainer=this.element.createChild("div","data-container"),this._dataTable=this._scrollContainer.createChild("table","data"),this._ariaLiveLabel=this.element.createChild("div","aria-live-label"),UI.ARIAUtils.markAsPoliteLiveRegion(this._ariaLiveLabel,!1),s&&this._dataTable.addEventListener("dblclick",this._ondblclick.bind(this),!1),this._dataTable.addEventListener("mousedown",this._mouseDownInDataTable.bind(this)),this._dataTable.addEventListener("click",this._clickInDataTable.bind(this),!0),this._inline=!1,this._columnsArray=[],this._columns={},this.visibleColumnsArray=i,i.forEach(e=>this._innerAddColumn(e)),this._cellClass=null,this._headerTableColumnGroup=this._headerTable.createChild("colgroup"),this._headerTableBody=this._headerTable.createChild("tbody"),this._headerRow=this._headerTableBody.createChild("tr"),this._dataTableColumnGroup=this._dataTable.createChild("colgroup"),this.dataTableBody=this._dataTable.createChild("tbody"),this._topFillerRow=this.dataTableBody.createChild("tr","data-grid-filler-row revealed"),this._bottomFillerRow=this.dataTableBody.createChild("tr","data-grid-filler-row revealed"),this.setVerticalPadding(0,0),this._refreshHeader(),this._editing=!1,this.selectedNode=null,this.expandNodesWhenArrowing=!1,this.setRootNode(new DataGridNode),this.setHasSelection(!1),this.indentWidth=15,this._resizers=[],this._columnWidthsInitialized=!1,this._cornerWidth=CornerWidth,this._resizeMethod=ResizeMethod.Nearest,this._headerContextMenuCallback=null,this._rowContextMenuCallback=null}_firstSelectableNode(){let e=this._rootNode;for(;e&&!e.selectable;)e=e.traverseNextNode(!0);return e}_lastSelectableNode(){let e=this._rootNode,t=this._rootNode;for(;t;)t.selectable&&(e=t),t=t.traverseNextNode(!0);return e}setElementContent(e,t){const i=this.columnIdFromNode(e);if(!i)return;const s=this._columns[i];s.dataType===DataGrid.DataGrid.DataType.Boolean?DataGridImpl.setElementBoolean(e,!!t):null!==t&&DataGridImpl.setElementText(e,t,!!s.longText)}static setElementText(e,t,i){i&&t.length>1e3?(e.textContent=t.trimEndWithMaxLength(1e3),e.title=t,e[DataGrid._longTextSymbol]=t):(e.textContent=t,e.title="",e[DataGrid._longTextSymbol]=void 0)}static setElementBoolean(e,t){e.textContent=t?"âœ“":"",e.title=""}setStriped(e){this.element.classList.toggle("striped-data-grid",e)}setFocusable(e){this.element.tabIndex=e?0:-1,!1===e&&UI.ARIAUtils.removeRole(this.element)}setHasSelection(e){this.element.classList.toggle("no-selection",!e)}updateGridAccessibleName(e){const t=this.selectedNode&&this.selectedNode.existingElement()?this.selectedNode.nodeAccessibleText:"";this._ariaLiveLabel.textContent=e||t}updateGridAccessibleNameOnFocus(){let e;if(this.selectedNode&&this.selectedNode.existingElement()){let t="";this.selectedNode.hasChildren()&&(t=this.selectedNode.expanded?ls`expanded`:ls`collapsed`);e=`${ls`${this._displayName} Row ${t}`} ${this.selectedNode.nodeAccessibleText}`}else{const t=this._enumerateChildren(this._rootNode,[],1),i=ls`Rows: ${t.length}`;e=ls`${this._displayName} ${i}, use the up and down arrow keys to navigate and interact with the rows of the table; Use browse mode to read cell by cell.`}this._ariaLiveLabel.textContent=e}headerTableBody(){return this._headerTableBody}_innerAddColumn(e,t){e.defaultWeight=e.weight;const i=e.id;i in this._columns&&this._innerRemoveColumn(i),void 0===t&&(t=this._columnsArray.length),this._columnsArray.splice(t,0,e),this._columns[i]=e,e.disclosure&&(this.disclosureColumnId=i);const s=createElement("th");s.className=i+"-column",s[DataGrid._columnIdSymbol]=i,this._headerTableHeaders[i]=s;const l=createElement("div");if(e.titleDOMFragment?l.appendChild(e.titleDOMFragment):l.textContent=e.title,s.appendChild(l),e.sort&&(s.classList.add(e.sort),this._sortColumnCell=s),e.sortable){s.addEventListener("click",this._clickInHeaderCell.bind(this),!1),s.classList.add("sortable");const e=UI.Icon.Icon.create("","sort-order-icon");s.createChild("div","sort-order-icon-container").appendChild(e),s[DataGrid._sortIconSymbol]=e}}addColumn(e,t){this._innerAddColumn(e,t)}_innerRemoveColumn(e){if(!this._columns[e])return;delete this._columns[e];const t=this._columnsArray.findIndex(t=>t.id===e);this._columnsArray.splice(t,1);const i=this._headerTableHeaders[e];i.parentElement&&i.parentElement.removeChild(i),delete this._headerTableHeaders[e]}removeColumn(e){this._innerRemoveColumn(e)}setCellClass(e){this._cellClass=e}_refreshHeader(){this._headerTableColumnGroup.removeChildren(),this._dataTableColumnGroup.removeChildren(),this._headerRow.removeChildren(),this._topFillerRow.removeChildren(),this._bottomFillerRow.removeChildren();for(let e=0;e<this.visibleColumnsArray.length;++e){const t=this.visibleColumnsArray[e],i=t.id,s=this._headerTableColumnGroup.createChild("col"),l=this._dataTableColumnGroup.createChild("col");t.width&&(s.style.width=t.width,l.style.width=t.width),this._headerRow.appendChild(this._headerTableHeaders[i]);const n=this._topFillerRow.createChild("th","top-filler-td");n.textContent=t.title,n.scope="col",this._bottomFillerRow.createChild("td","bottom-filler-td")[DataGrid._columnIdSymbol]=i}this._headerRow.createChild("th","corner");const e=this._topFillerRow.createChild("th","corner");e.classList.add("top-filler-td"),e.scope="col",this._bottomFillerRow.createChild("td","corner").classList.add("bottom-filler-td"),this._headerTableColumnGroup.createChild("col","corner"),this._dataTableColumnGroup.createChild("col","corner")}setVerticalPadding(e,t){const i=e+"px",s=e||t?t+"px":"auto";this._topFillerRow.style.height===i&&this._bottomFillerRow.style.height===s||(this._topFillerRow.style.height=i,this._bottomFillerRow.style.height=s,this.dispatchEventToListeners(Events.PaddingChanged))}setRootNode(e){this._rootNode&&(this._rootNode.removeChildren(),this._rootNode.dataGrid=null,this._rootNode._isRoot=!1),this._rootNode=e,e._isRoot=!0,e.setHasChildren(!1),e._expanded=!0,e._revealed=!0,e.selectable=!1,e.dataGrid=this}rootNode(){return this._rootNode}_ondblclick(e){if(this._editing||this._editingNode)return;const t=this.columnIdFromNode(e.target);t&&this._columns[t].editable&&this._startEditing(e.target)}_startEditingColumnOfDataGridNode(e,t){this._editing=!0,this._editingNode=e,this._editingNode.select();const i=this._editingNode._element.children[t];i[DataGrid._longTextSymbol]&&(i.textContent=i[DataGrid._longTextSymbol]);const s=this.visibleColumnsArray[t];if(s.dataType===DataGrid.DataGrid.DataType.Boolean){const t=UI.UIUtils.CheckboxLabel.create(void 0,e.data[s.id]);UI.ARIAUtils.setAccessibleName(t,s.title||"");let l=!1;t.style.height="100%";const n=t.checkboxElement;n.classList.add("inside-datagrid");const d=n.checked;n.addEventListener("change",()=>{l=!0,this._editingCommitted(i,n.checked,d,void 0,"forward")},!1),n.addEventListener("keydown",e=>{if("Tab"===e.key)return e.consume(!0),l=!0,this._editingCommitted(i,n.checked,d,void 0,e.shiftKey?"backward":"forward");" "===e.key?(e.consume(!0),n.checked=!n.checked):"Enter"===e.key&&(e.consume(!0),l=!0,this._editingCommitted(i,n.checked,d,void 0,"forward"))},!1),n.addEventListener("blur",()=>{l||this._editingCommitted(i,n.checked,n.checked,void 0,"next")},!1),i.innerHTML="",i.appendChild(t),n.focus()}else UI.InplaceEditor.InplaceEditor.startEditing(i,this._startEditingConfig(i)),i.getComponentSelection().selectAllChildren(i)}startEditingNextEditableColumnOfDataGridNode(e,t){const i=this._columns[t],s=this.visibleColumnsArray.indexOf(i),l=this._nextEditableColumn(s);-1!==l&&this._startEditingColumnOfDataGridNode(e,l)}_startEditing(e){if(!e.enclosingNodeOrSelfWithNodeName("td"))return;if(this._editingNode=this.dataGridNodeFromNode(e),!this._editingNode){if(!this.creationNode)return;this._editingNode=this.creationNode}if(this._editingNode.isCreationNode)return void this._startEditingColumnOfDataGridNode(this._editingNode,this._nextEditableColumn(-1));const t=this.columnIdFromNode(e);if(!t)return;const i=this._columns[t],s=this.visibleColumnsArray.indexOf(i);this._startEditingColumnOfDataGridNode(this._editingNode,s)}renderInline(){this.element.classList.add("inline"),this._cornerWidth=0,this._inline=!0,this.updateWidths()}_startEditingConfig(e){return new UI.InplaceEditor.Config(this._editingCommitted.bind(this),this._editingCancelled.bind(this))}_editingCommitted(e,t,i,s,l){const n=this.columnIdFromNode(e);if(!n)return void this._editingCancelled(e);const d=this._columns[n],r=this.visibleColumnsArray.indexOf(d),o=null===this._editingNode.data[n]?"":this._editingNode.data[n],a=this._editingNode;function h(e){if(l){if("forward"===l){const t=this._nextEditableColumn(-1);if(a.isCreationNode&&r===t&&!e)return;const i=this._nextEditableColumn(r);if(-1!==i)return void this._startEditingColumnOfDataGridNode(a,i);const s=a.traverseNextNode(!0,null,!0);return s?void this._startEditingColumnOfDataGridNode(s,t):a.isCreationNode&&e?(this.addCreationNode(!1),void this._startEditingColumnOfDataGridNode(this.creationNode,t)):void 0}if("backward"!==l);else{const e=this._nextEditableColumn(r,!0);if(-1!==e)return void this._startEditingColumnOfDataGridNode(a,e);const t=this._nextEditableColumn(this.visibleColumnsArray.length,!0),i=a.traversePreviousNode(!0,!0);i&&this._startEditingColumnOfDataGridNode(i,t)}}}if(this.setElementContent(e,t),o===t)return this._editingCancelled(e),void h.call(this,!1);this._editingNode.data[n]=t,this._editCallback(this._editingNode,n,o,t),this._editingNode.isCreationNode&&this.addCreationNode(!1),this._editingCancelled(e),h.call(this,!0)}_editingCancelled(e){this._editing=!1,this._editingNode=null}_nextEditableColumn(e,t){const i=t?-1:1,s=this.visibleColumnsArray;for(let t=e+i;t>=0&&t<s.length;t+=i)if(s[t].editable)return t;return-1}sortColumnId(){return this._sortColumnCell?this._sortColumnCell[DataGrid._columnIdSymbol]:null}sortOrder(){return!this._sortColumnCell||this._sortColumnCell.classList.contains(Order.Ascending)?Order.Ascending:this._sortColumnCell.classList.contains(Order.Descending)?Order.Descending:null}isSortOrderAscending(){return!this._sortColumnCell||this._sortColumnCell.classList.contains(Order.Ascending)}_autoSizeWidths(e,t,i){t&&(t=Math.min(t,Math.floor(100/e.length)));let s=0;for(let t=0;t<e.length;++t)s+=e[t];let l=0;for(let n=0;n<e.length;++n){let d=Math.round(100*e[n]/s);t&&d<t?d=t:i&&d>i&&(d=i),l+=d,e[n]=d}let n=l-100;for(;t&&n>0;)for(let i=0;i<e.length&&(!(e[i]>t)||(--e[i],--n,n));++i);for(;i&&n<0;)for(let t=0;t<e.length&&(!(e[t]<i)||(++e[t],++n,n));++t);return e}autoSizeColumns(e,t,i){let s=[];for(let e=0;e<this._columnsArray.length;++e)s.push((this._columnsArray[e].title||"").length);i=i||0;const l=this._enumerateChildren(this._rootNode,[],i+1);for(let e=0;e<l.length;++e){const t=l[e];for(let e=0;e<this._columnsArray.length;++e){const i=String(t.data[this._columnsArray[e].id]);i.length>s[e]&&(s[e]=i.length)}}s=this._autoSizeWidths(s,e,t);for(let e=0;e<this._columnsArray.length;++e)this._columnsArray[e].weight=s[e];this._columnWidthsInitialized=!1,this.updateWidths()}_enumerateChildren(e,t,i){if(e._isRoot||t.push(e),!i)return[];for(let s=0;s<e.children.length;++s)this._enumerateChildren(e.children[s],t,i-1);return t}onResize(){this.updateWidths()}updateWidths(){if(!this._columnWidthsInitialized&&this.element.offsetWidth){const e=this.element.offsetWidth-this._cornerWidth,t=this._headerTableBody.rows[0].cells,i=t.length-1;for(let s=0;s<i;s++){const i=this.visibleColumnsArray[s];i.weight||(i.weight=100*t[s].offsetWidth/e||10)}this._columnWidthsInitialized=!0}this._applyColumnWeights()}indexOfVisibleColumn(e){return this.visibleColumnsArray.findIndex(t=>t.id===e)}setName(e){this._columnWeightsSetting=Common.Settings.Settings.instance().createSetting("dataGrid-"+e+"-columnWeights",{}),this._loadColumnWeights()}_resetColumnWeights(){for(const e of this._columnsArray)e.defaultWeight&&(e.weight=e.defaultWeight);this._applyColumnWeights(),this._saveColumnWeights()}_loadColumnWeights(){if(!this._columnWeightsSetting)return;const e=this._columnWeightsSetting.get();for(let t=0;t<this._columnsArray.length;++t){const i=this._columnsArray[t],s=e[i.id];s&&(i.weight=s)}this._applyColumnWeights()}_saveColumnWeights(){if(!this._columnWeightsSetting)return;const e={};for(let t=0;t<this._columnsArray.length;++t){const i=this._columnsArray[t];e[i.id]=i.weight}this._columnWeightsSetting.set(e)}wasShown(){this._loadColumnWeights()}willHide(){}_applyColumnWeights(){let e=this.element.offsetWidth-this._cornerWidth;if(e<=0)return;let t=0;const i=[];for(let s=0;s<this.visibleColumnsArray.length;++s){if(this.visibleColumnsArray[s].fixedWidth){const t=this._headerTableColumnGroup.children[s][DataGrid._preferredWidthSymbol]||this._headerTableBody.rows[0].cells[s].offsetWidth;i[s]=t,e-=t}else t+=this.visibleColumnsArray[s].weight}let s=0,l=0;for(let n=0;n<this.visibleColumnsArray.length;++n){const d=this.visibleColumnsArray[n];let r;if(d.fixedWidth)r=i[n];else{s+=d.weight;const i=s*e/t|0;r=Math.max(i-l,14),l=i}this._setPreferredWidth(n,r)}this._positionResizers()}setColumnsVisiblity(e){this.visibleColumnsArray=[];for(let t=0;t<this._columnsArray.length;++t){const i=this._columnsArray[t];e[i.id]&&this.visibleColumnsArray.push(i)}this._refreshHeader(),this._applyColumnWeights();const t=this._enumerateChildren(this.rootNode(),[],-1);for(let e=0;e<t.length;++e)t[e].refresh()}get scrollContainer(){return this._scrollContainer}_positionResizers(){const e=this._headerTableColumnGroup.children.length-1,t=[],i=this._resizers;for(;i.length>e-1;)i.pop().remove();for(let i=0;i<e-1;i++)t[i]=(t[i-1]||0)+this._headerTableBody.rows[0].cells[i].offsetWidth;for(let s=0;s<e-1;s++){let e=i[s];e||(e=createElement("div"),e.__index=s,e.classList.add("data-grid-resizer"),UI.UIUtils.installDragHandle(e,this._startResizerDragging.bind(this),this._resizerDragging.bind(this),this._endResizerDragging.bind(this),"col-resize"),this.element.appendChild(e),i.push(e)),e.__position!==t[s]&&(e.__position=t[s],e.style.left=t[s]+"px")}}addCreationNode(e){this.creationNode&&this.creationNode.makeNormal();const t={};for(const e in this._columns)t[e]=null;this.creationNode=new CreationDataGridNode(t,e),this.rootNode().appendChild(this.creationNode)}_keyDown(e){if(e.shiftKey||e.metaKey||e.ctrlKey||this._editing||UI.UIUtils.isEditing())return;let t,i=!1;if(this.selectedNode)if("ArrowUp"!==e.key||e.altKey)if("ArrowDown"!==e.key||e.altKey)"ArrowLeft"===e.key?this.selectedNode.expanded?(e.altKey?this.selectedNode.collapseRecursively():this.selectedNode.collapse(),i=!0):this.selectedNode.parent&&!this.selectedNode.parent._isRoot&&(i=!0,this.selectedNode.parent.selectable?(t=this.selectedNode.parent,i=!!t):this.selectedNode.parent&&this.selectedNode.parent.collapse()):"ArrowRight"===e.key?this.selectedNode.revealed?this.selectedNode.hasChildren()&&(i=!0,this.selectedNode.expanded?(t=this.selectedNode.children[0],i=!!t):e.altKey?this.selectedNode.expandRecursively():this.selectedNode.expand()):(this.selectedNode.reveal(),i=!0):8===e.keyCode||46===e.keyCode?this._deleteCallback&&(i=!0,this._deleteCallback(this.selectedNode)):isEnterKey(e)&&(this._editCallback?(i=!0,this._startEditing(this.selectedNode._element.children[this._nextEditableColumn(-1)])):this.dispatchEventToListeners(Events.OpenedNode,this.selectedNode));else{for(t=this.selectedNode.traverseNextNode(!0);t&&!t.selectable;)t=t.traverseNextNode(!0);i=!!t}else{for(t=this.selectedNode.traversePreviousNode(!0);t&&!t.selectable;)t=t.traversePreviousNode(!0);i=!!t}else"ArrowUp"!==e.key||e.altKey?"ArrowDown"!==e.key||e.altKey||(t=this._firstSelectableNode()):t=this._lastSelectableNode(),i=!!t;t&&(t.reveal(),t.select()),"ArrowUp"!==e.key&&"ArrowDown"!==e.key&&"ArrowLeft"!==e.key&&"ArrowRight"!==e.key||document.activeElement===this.element||this.element.focus(),i&&e.consume(!0)}updateSelectionBeforeRemoval(e,t){let i,s=this.selectedNode;for(;s&&s!==e;)s=s.parent;if(s){for(s=e;s&&!s.nextSibling;s=s.parent);for(s&&(i=s.nextSibling);i&&!i.selectable;)i=i.traverseNextNode(!0);if(!i||i.isCreationNode)for(i=e.traversePreviousNode(!0);i&&!i.selectable;)i=i.traversePreviousNode(!0);i?(i.reveal(),i.select()):this.selectedNode.deselect()}}dataGridNodeFromNode(e){const t=e.enclosingNodeOrSelfWithNodeName("tr");return t&&t._dataGridNode}columnIdFromNode(e){const t=e.enclosingNodeOrSelfWithNodeName("td");return t&&t[DataGrid._columnIdSymbol]}_clickInHeaderCell(e){const t=e.target.enclosingNodeOrSelfWithNodeName("th");t&&this._sortByColumnHeaderCell(t)}_sortByColumnHeaderCell(e){if(void 0===e[DataGrid._columnIdSymbol]||!e.classList.contains("sortable"))return;let t=Order.Ascending;e===this._sortColumnCell&&this.isSortOrderAscending()&&(t=Order.Descending),this._sortColumnCell&&this._sortColumnCell.classList.remove(Order.Ascending,Order.Descending),this._sortColumnCell=e,e.classList.add(t);e[DataGrid._sortIconSymbol].setIconType(t===Order.Ascending?"smallicon-triangle-up":"smallicon-triangle-down"),this.dispatchEventToListeners(Events.SortingChanged)}markColumnAsSortedBy(e,t){this._sortColumnCell&&this._sortColumnCell.classList.remove(Order.Ascending,Order.Descending),this._sortColumnCell=this._headerTableHeaders[e],this._sortColumnCell.classList.add(t)}headerTableHeader(e){return this._headerTableHeaders[e]}_mouseDownInDataTable(e){const t=e.target,i=this.dataGridNodeFromNode(t);if(!i||!i.selectable||i.isEventWithinDisclosureTriangle(e))return;const s=this.columnIdFromNode(t);s&&this._columns[s].nonSelectable||(e.metaKey?i.selected?i.deselect():i.select():(i.select(),this.dispatchEventToListeners(Events.OpenedNode,i)))}setHeaderContextMenuCallback(e){this._headerContextMenuCallback=e}setRowContextMenuCallback(e){this._rowContextMenuCallback=e}_contextMenu(e){const t=new UI.ContextMenu.ContextMenu(e),i=e.target,s=this.visibleColumnsArray.filter(e=>e.sortable&&e.title),l=this._columnsArray.filter(e=>-1===s.indexOf(e)&&e.allowInSortByEvenWhenHidden),n=[...s,...l];if(n.length>0){const e=t.defaultSection().appendSubMenuItem(ls`Sort By`);for(const t of n){const i=this._headerTableHeaders[t.id];e.defaultSection().appendItem(t.title,this._sortByColumnHeaderCell.bind(this,i))}}if(i.isSelfOrDescendant(this._headerTableBody))return this._headerContextMenuCallback&&this._headerContextMenuCallback(t),t.defaultSection().appendItem(Common.UIString.UIString("Reset Columns"),this._resetColumnWeights.bind(this)),void t.show();const d=t.defaultSection().appendSubMenuItem(ls`Header Options`);this._headerContextMenuCallback&&this._headerContextMenuCallback(d),d.defaultSection().appendItem(Common.UIString.UIString("Reset Columns"),this._resetColumnWeights.bind(this));const r=0===e.button,o=r?this.selectedNode:this.dataGridNodeFromNode(i);if(r&&this.selectedNode){const e=this.selectedNode.existingElement().getBoundingClientRect();if(e){const i=(e.right+e.left)/2,s=(e.bottom+e.top)/2;t.setX(i),t.setY(s)}}if(!this._refreshCallback||o&&o===this.creationNode||t.defaultSection().appendItem(Common.UIString.UIString("Refresh"),this._refreshCallback.bind(this)),o&&o.selectable&&!o.isEventWithinDisclosureTriangle(e)){if(this._editCallback)if(o===this.creationNode)t.defaultSection().appendItem(Common.UIString.UIString("Add new"),this._startEditing.bind(this,i));else if(r){const e=this._nextEditableColumn(-1);if(e>-1){const i=this.visibleColumnsArray[e];i&&i.editable&&t.defaultSection().appendItem(ls`Edit "${i.title}"`,this._startEditingColumnOfDataGridNode.bind(this,o,e))}}else{const e=this.columnIdFromNode(i);e&&this._columns[e].editable&&t.defaultSection().appendItem(Common.UIString.UIString('Edit "%s"',this._columns[e].title),this._startEditing.bind(this,i))}this._deleteCallback&&o!==this.creationNode&&t.defaultSection().appendItem(Common.UIString.UIString("Delete"),this._deleteCallback.bind(this,o)),this._rowContextMenuCallback&&this._rowContextMenuCallback(t,o)}t.show()}_clickInDataTable(e){const t=this.dataGridNodeFromNode(e.target);t&&t.hasChildren()&&t.isEventWithinDisclosureTriangle(e)&&(t.expanded?e.altKey?t.collapseRecursively():t.collapse():e.altKey?t.expandRecursively():t.expand())}setResizeMethod(e){this._resizeMethod=e}_startResizerDragging(e){return this._currentResizer=e.target,!0}_endResizerDragging(){this._currentResizer=null,this._saveColumnWeights()}_resizerDragging(e){const t=this._currentResizer;if(!t)return;let i=e.clientX-this.element.totalOffsetLeft();const s=this._headerTableBody.rows[0].cells;let l=0,n=t.__index,d=n+1;for(let e=0;e<n;e++)l+=s[e].offsetWidth;this._resizeMethod===ResizeMethod.Last?d=this._resizers.length:this._resizeMethod===ResizeMethod.First&&(l+=s[n].offsetWidth-s[0].offsetWidth,n=0);const r=l+s[n].offsetWidth+s[d].offsetWidth,o=l+ColumnResizePadding,a=r-ColumnResizePadding;if(o>a)return;i=Platform.NumberUtilities.clamp(i,o,a);const h=i-CenterResizerOverBorderAdjustment;t.__position=h,t.style.left=h+"px",this._setPreferredWidth(n,i-l),this._setPreferredWidth(d,r-i);const c=this.visibleColumnsArray[n],_=this.visibleColumnsArray[d];if(c.weight||_.weight){const e=c.weight+_.weight,t=r-l;c.weight=(i-l)*e/t,_.weight=(r-i)*e/t}this._positionResizers(),e.preventDefault()}_setPreferredWidth(e,t){const i=t+"px";this._headerTableColumnGroup.children[e][DataGrid._preferredWidthSymbol]=t,this._headerTableColumnGroup.children[e].style.width=i,this._dataTableColumnGroup.children[e].style.width=i}columnOffset(e){if(!this.element.offsetWidth)return 0;for(let t=1;t<this.visibleColumnsArray.length;++t)if(e===this.visibleColumnsArray[t].id&&this._resizers[t-1])return this._resizers[t-1].__position;return 0}asWidget(){return this._dataGridWidget||(this._dataGridWidget=new DataGridWidget(this)),this._dataGridWidget}topFillerRowElement(){return this._topFillerRow}}export const CornerWidth=14;export const Events={SelectedNode:Symbol("SelectedNode"),DeselectedNode:Symbol("DeselectedNode"),OpenedNode:Symbol("OpenedNode"),SortingChanged:Symbol("SortingChanged"),PaddingChanged:Symbol("PaddingChanged")};export const Order={Ascending:"sort-ascending",Descending:"sort-descending"};export const Align={Center:"center",Right:"right"};export const DataType={String:Symbol("String"),Boolean:Symbol("Boolean")};export const ColumnResizePadding=24;export const CenterResizerOverBorderAdjustment=3;export const ResizeMethod={Nearest:"nearest",First:"first",Last:"last"};export class DataGridNode extends Common.ObjectWrapper.ObjectWrapper{constructor(e,t){super(),this._element=null,this._expanded=!1,this._selected=!1,this._dirty=!1,this._inactive=!1,this.key,this._depth,this._revealed,this._attached=!1,this._savedPosition=null,this._shouldRefreshChildren=!0,this._data=e||{},this._hasChildren=t||!1,this.children=[],this.dataGrid=null,this.parent=null,this.previousSibling=null,this.nextSibling=null,this.disclosureToggleWidth=10,this.selectable=!0,this._isRoot=!1,this.nodeAccessibleText="",this.cellAccessibleTextMap=new Map}element(){if(!this._element){const e=this.createElement();this.createCells(e)}return this._element}createElement(){return this._element=document.createElement("tr"),this._element.classList.add("data-grid-data-grid-node"),this._element._dataGridNode=this,this._hasChildren&&this._element.classList.add("parent"),this.expanded&&this._element.classList.add("expanded"),this.selected&&this._element.classList.add("selected"),this.revealed&&this._element.classList.add("revealed"),this.dirty&&this._element.classList.add("dirty"),this.inactive&&this._element.classList.add("inactive"),this._element}existingElement(){return this._element||null}resetElement(){this._element=null}createCells(e){e.removeChildren();const t=this.dataGrid.visibleColumnsArray,i=[];!this._hasChildren&&this.parent._isRoot||i.push(ls`level ${this.depth+1}`);for(let s=0;s<t.length;++s){const l=t[s],n=e.appendChild(this.createCell(l.id)),d=ls`${l.title}`;i.push(`${d}: ${this.cellAccessibleTextMap.get(l.id)||n.textContent}`)}this.nodeAccessibleText=i.join(", "),e.appendChild(this._createTDWithClass("corner"))}get data(){return this._data}set data(e){this._data=e||{},this.refresh()}get revealed(){if(void 0!==this._revealed)return this._revealed;let e=this.parent;for(;e&&!e._isRoot;){if(!e.expanded)return this._revealed=!1,!1;e=e.parent}return this.revealed=!0,!0}set revealed(e){if(this._revealed!==e){this._revealed=e,this._element&&this._element.classList.toggle("revealed",this._revealed);for(let t=0;t<this.children.length;++t)this.children[t].revealed=e&&this.expanded}}isDirty(){return this._dirty}setDirty(e){this._dirty!==e&&(this._dirty=e,this._element&&(e?this._element.classList.add("dirty"):this._element.classList.remove("dirty")))}isInactive(){return this._inactive}setInactive(e){this._inactive!==e&&(this._inactive=e,this._element&&(e?this._element.classList.add("inactive"):this._element.classList.remove("inactive")))}hasChildren(){return this._hasChildren}setHasChildren(e){this._hasChildren!==e&&(this._hasChildren=e,this._element&&(this._element.classList.toggle("parent",this._hasChildren),this._element.classList.toggle("expanded",this._hasChildren&&this.expanded)))}get depth(){return void 0!==this._depth||(this.parent&&!this.parent._isRoot?this._depth=this.parent.depth+1:this._depth=0),this._depth}get leftPadding(){return this.depth*this.dataGrid.indentWidth}get shouldRefreshChildren(){return this._shouldRefreshChildren}set shouldRefreshChildren(e){this._shouldRefreshChildren=e,e&&this.expanded&&this.expand()}get selected(){return this._selected}set selected(e){e?this.select():this.deselect()}get expanded(){return this._expanded}set expanded(e){e?this.expand():this.collapse()}refresh(){this.dataGrid||(this._element=null),this._element&&this.createCells(this._element)}_createTDWithClass(e){const t=document.createElement("td");e&&(t.className=e);const i=this.dataGrid._cellClass;return i&&t.classList.add(i),t}createTD(e){const t=this._createTDWithClass(e+"-column");t[DataGrid._columnIdSymbol]=e;const i=this.dataGrid._columns[e].align;return i&&t.classList.add(i),e===this.dataGrid.disclosureColumnId&&(t.classList.add("disclosure"),this.leftPadding&&t.style.setProperty("padding-left",this.leftPadding+"px")),t}createCell(e){const t=this.createTD(e),i=this.data[e];return i instanceof Node?t.appendChild(i):null!==i&&this.dataGrid.setElementContent(t,i),t}setCellAccessibleName(e,t,i){this.cellAccessibleTextMap.set(i,e);for(let e=0;e<t.children.length;e++)UI.ARIAUtils.markAsHidden(t.children[e]);UI.ARIAUtils.setAccessibleName(t,e)}nodeSelfHeight(){return 20}appendChild(e){this.insertChild(e,this.children.length)}resetNode(e){delete this._depth,delete this._revealed,e||(this.previousSibling&&(this.previousSibling.nextSibling=this.nextSibling),this.nextSibling&&(this.nextSibling.previousSibling=this.previousSibling),this.dataGrid=null,this.parent=null,this.nextSibling=null,this.previousSibling=null,this._attached=!1)}insertChild(e,t){if(!e)throw"insertChild: Node can't be undefined or null.";if(e.parent===this){const i=this.children.indexOf(e);if(i<0&&console.assert(!1,"Inconsistent DataGrid state"),i===t)return;i<t&&--t}e.remove(),this.children.splice(t,0,e),this.setHasChildren(!0),e.parent=this,e.dataGrid=this.dataGrid,e.recalculateSiblings(t),e._shouldRefreshChildren=!0;let i=e.children[0];for(;i;)i.resetNode(!0),i.dataGrid=this.dataGrid,i._attached=!1,i._shouldRefreshChildren=!0,i=i.traverseNextNode(!1,e,!0);this.expanded&&e._attach(),this.revealed||(e.revealed=!1)}remove(){this.parent&&this.parent.removeChild(this)}removeChild(e){if(!e)throw"removeChild: Node can't be undefined or null.";if(e.parent!==this)throw"removeChild: Node is not a child of this node.";this.dataGrid&&this.dataGrid.updateSelectionBeforeRemoval(e,!1),e._detach(),e.resetNode(),Platform.ArrayUtilities.removeElement(this.children,e,!0),this.children.length<=0&&this.setHasChildren(!1)}removeChildren(){this.dataGrid&&this.dataGrid.updateSelectionBeforeRemoval(this,!0);for(let e=0;e<this.children.length;++e){const t=this.children[e];t._detach(),t.resetNode()}this.children=[],this.setHasChildren(!1)}recalculateSiblings(e){if(!this.parent)return;const t=this.parent.children[e-1]||null;t&&(t.nextSibling=this),this.previousSibling=t;const i=this.parent.children[e+1]||null;i&&(i.previousSibling=this),this.nextSibling=i}collapse(){if(!this._isRoot){this._element&&this._element.classList.remove("expanded"),this._expanded=!1,this.selected&&this.dataGrid.updateGridAccessibleName(ls`collapsed`);for(let e=0;e<this.children.length;++e)this.children[e].revealed=!1}}collapseRecursively(){let e=this;for(;e;)e.expanded&&e.collapse(),e=e.traverseNextNode(!1,this,!0)}populate(){}expand(){if(this._hasChildren&&!this.expanded&&!this._isRoot){if(this.revealed&&!this._shouldRefreshChildren)for(let e=0;e<this.children.length;++e)this.children[e].revealed=!0;if(this._shouldRefreshChildren){for(let e=0;e<this.children.length;++e)this.children[e]._detach();if(this.populate(),this._attached)for(let e=0;e<this.children.length;++e){const t=this.children[e];this.revealed&&(t.revealed=!0),t._attach()}this._shouldRefreshChildren=!1}this._element&&this._element.classList.add("expanded"),this.selected&&this.dataGrid.updateGridAccessibleName(ls`expanded`),this._expanded=!0}}expandRecursively(){let e=this;for(;e;)e.expand(),e=e.traverseNextNode(!1,this)}reveal(){if(this._isRoot)return;let e=this.parent;for(;e&&!e._isRoot;)e.expanded||e.expand(),e=e.parent;this.element().scrollIntoViewIfNeeded(!1)}select(e){this.dataGrid&&this.selectable&&!this.selected&&(this.dataGrid.selectedNode&&this.dataGrid.selectedNode.deselect(),this._selected=!0,this.dataGrid.selectedNode=this,this._element&&(this._element.classList.add("selected"),this.dataGrid.setHasSelection(!0),this.dataGrid.updateGridAccessibleName()),e||this.dataGrid.dispatchEventToListeners(Events.SelectedNode,this))}revealAndSelect(){this._isRoot||(this.reveal(),this.select())}deselect(e){this.dataGrid&&this.dataGrid.selectedNode===this&&this.selected&&(this._selected=!1,this.dataGrid.selectedNode=null,this._element&&(this._element.classList.remove("selected"),this.dataGrid.setHasSelection(!1),this.dataGrid.updateGridAccessibleName("")),e||this.dataGrid.dispatchEventToListeners(Events.DeselectedNode))}traverseNextNode(e,t,i,s){!i&&this._hasChildren&&this.populate(),s&&(s.depthChange=0);let l=!e||this.revealed?this.children[0]:null;if(l&&(!e||this.expanded))return s&&(s.depthChange=1),l;if(this===t)return null;if(l=!e||this.revealed?this.nextSibling:null,l)return l;for(l=this;l&&!l._isRoot&&(e&&!l.revealed||!l.nextSibling)&&l.parent!==t;)s&&(s.depthChange-=1),l=l.parent;return l&&(!e||l.revealed)?l.nextSibling:null}traversePreviousNode(e,t){let i=!e||this.revealed?this.previousSibling:null;for(!t&&i&&i._hasChildren&&i.populate();i&&(!e||i.revealed&&i.expanded)&&i.children[i.children.length-1];)!t&&i._hasChildren&&i.populate(),i=!e||i.revealed&&i.expanded?i.children[i.children.length-1]:null;return i||(!this.parent||this.parent._isRoot?null:this.parent)}isEventWithinDisclosureTriangle(e){if(!this._hasChildren)return!1;const t=e.target.enclosingNodeOrSelfWithNodeName("td");if(!t||!t.classList.contains("disclosure"))return!1;const i=t.totalOffsetLeft()+this.leftPadding;return e.pageX>=i&&e.pageX<=i+this.disclosureToggleWidth}_attach(){if(!this.dataGrid||this._attached)return;this._attached=!0;const e=this.traversePreviousNode(!0,!0),t=e?e.element():this.dataGrid._topFillerRow;if(this.dataGrid.dataTableBody.insertBefore(this.element(),t.nextSibling),this.expanded)for(let e=0;e<this.children.length;++e)this.children[e]._attach()}_detach(){if(this._attached){this._attached=!1,this._element&&this._element.remove();for(let e=0;e<this.children.length;++e)this.children[e]._detach()}}savePosition(){if(!this._savedPosition){if(!this.parent)throw"savePosition: Node must have a parent.";this._savedPosition={parent:this.parent,index:this.parent.children.indexOf(this)}}}restorePosition(){this._savedPosition&&(this.parent!==this._savedPosition.parent&&this._savedPosition.parent.insertChild(this,this._savedPosition.index),this._savedPosition=null)}}export class CreationDataGridNode extends DataGridNode{constructor(e,t){super(e,t),this.isCreationNode=!0}makeNormal(){this.isCreationNode=!1}}export class DataGridWidget extends UI.Widget.VBox{constructor(e){super(),this._dataGrid=e,this.element.appendChild(e.element),this.setDefaultFocusedElement(e.element)}wasShown(){this._dataGrid.wasShown()}willHide(){this._dataGrid.willHide()}onResize(){this._dataGrid.onResize()}elementsToRestoreScrollPositionsFor(){return[this._dataGrid._scrollContainer]}detachChildWidgets(){super.detachChildWidgets();for(const e of this._dataGrids)this.element.removeChild(e.element);this._dataGrids=[]}}export let Parameters;export let ColumnDescriptor;