import*as Bindings from"../bindings/bindings.js";import*as Common from"../common/common.js";import*as SDK from"../sdk/sdk.js";import*as TextUtils from"../text_utils/text_utils.js";import*as Workspace from"../workspace/workspace.js";import{FormatterInterface,FormatterSourceMapping}from"./ScriptFormatter.js";export class SourceFormatData{constructor(o,e,t){this.originalSourceCode=o,this.formattedSourceCode=e,this.mapping=t}originalPath(){return this.originalSourceCode.project().id()+":"+this.originalSourceCode.url()}static _for(o){return o[SourceFormatData._formatDataSymbol]}}SourceFormatData._formatDataSymbol=Symbol("formatData");export class SourceFormatter{constructor(){this._projectId="formatter:",this._project=new Bindings.ContentProviderBasedProject.ContentProviderBasedProject(Workspace.Workspace.WorkspaceImpl.instance(),this._projectId,Workspace.Workspace.projectTypes.Formatter,"formatter",!0),this._formattedSourceCodes=new Map,this._scriptMapping=new ScriptMapping,this._styleMapping=new StyleMapping,Workspace.Workspace.WorkspaceImpl.instance().addEventListener(Workspace.Workspace.Events.UISourceCodeRemoved,o=>{this._onUISourceCodeRemoved(o)},this)}async _onUISourceCodeRemoved(o){const e=o.data,t=this._formattedSourceCodes.get(e);t&&t.formatData&&await this._discardFormatData(t.formatData),this._formattedSourceCodes.delete(e)}async discardFormattedUISourceCode(o){const e=SourceFormatData._for(o);return e?(await this._discardFormatData(e),this._formattedSourceCodes.delete(e.originalSourceCode),e.originalSourceCode):null}async _discardFormatData(o){delete o.formattedSourceCode[SourceFormatData._formatDataSymbol],await this._scriptMapping._setSourceMappingEnabled(o,!1),this._styleMapping._setSourceMappingEnabled(o,!1),this._project.removeFile(o.formattedSourceCode.url())}hasFormatted(o){return this._formattedSourceCodes.has(o)}getOriginalUISourceCode(o){const e=o[SourceFormatData._formatDataSymbol];return e?e.originalSourceCode:o}async format(o){const e=this._formattedSourceCodes.get(o);if(e)return e.promise;let t;const r=new Promise(o=>{t=o});this._formattedSourceCodes.set(o,{promise:r,formatData:null});const{content:a}=await o.requestContent();return FormatterInterface.format(o.contentType(),o.mimeType(),a||"",async function(e,a){const i=this._formattedSourceCodes.get(o);if(!i||i.promise!==r)return;let n,c=0,s="";do{n=`${o.url()}:formatted${s}`,s=":"+c++}while(this._project.uiSourceCodeForURL(n));const d=TextUtils.StaticContentProvider.StaticContentProvider.fromString(n,o.contentType(),e),u=this._project.addContentProvider(n,d,o.mimeType()),m=new SourceFormatData(o,u,a);u[SourceFormatData._formatDataSymbol]=m,await this._scriptMapping._setSourceMappingEnabled(m,!0),await this._styleMapping._setSourceMappingEnabled(m,!0),i.formatData=m;for(const e of o.allDecorations()){const o=e.range(),t=a.originalToFormatted(o.startLine,o.startColumn),r=a.originalToFormatted(o.endLine,o.endColumn);u.addDecoration(new TextUtils.TextRange.TextRange(t[0],t[1],r[0],r[1]),e.type(),e.data())}t(m)}.bind(this)),r}}class ScriptMapping{constructor(){Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().addSourceMapping(this)}rawLocationToUILocation(o){const e=o.script(),t=e&&SourceFormatData._for(e);if(!t)return null;if(e.isInlineScriptWithSourceURL()){const[r,a]=e.toRelativeLocation(o),[i,n]=t.mapping.originalToFormatted(r,a);return t.formattedSourceCode.uiLocation(i,n)}const[r,a]=t.mapping.originalToFormatted(o.lineNumber,o.columnNumber||0);return t.formattedSourceCode.uiLocation(r,a)}uiLocationToRawLocations(o,e,t){const r=SourceFormatData._for(o);if(!r)return[];const[a,i]=r.mapping.formattedToOriginal(e,t);if(r.originalSourceCode.contentType().isScript()){const o=Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().uiLocationToRawLocationsForUnformattedJavaScript(r.originalSourceCode,a,i);return console.assert(o.every(o=>o&&!!o.script())),o}if(r.originalSourceCode.contentType()===Common.ResourceType.resourceTypes.Document){const o=Bindings.NetworkProject.NetworkProject.targetForUISourceCode(r.originalSourceCode),e=o&&o.model(SDK.DebuggerModel.DebuggerModel);if(e){const o=e.scriptsForSourceURL(r.originalSourceCode.url()).filter(o=>o.isInlineScript()&&!o.hasSourceURL).map(o=>o.rawLocation(a,i)).filter(o=>!!o);return console.assert(o.every(o=>o&&!!o.script())),o}}return[]}async _setSourceMappingEnabled(o,e){const t=this._scriptsForUISourceCode(o.originalSourceCode);if(!t.length)return;if(e)for(const e of t)e[SourceFormatData._formatDataSymbol]=o;else for(const o of t)delete o[SourceFormatData._formatDataSymbol];const r=t.map(o=>Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().updateLocations(o));await Promise.all(r)}_scriptsForUISourceCode(o){if(o.contentType()===Common.ResourceType.resourceTypes.Document){const e=Bindings.NetworkProject.NetworkProject.targetForUISourceCode(o),t=e&&e.model(SDK.DebuggerModel.DebuggerModel);if(t){return t.scriptsForSourceURL(o.url()).filter(o=>o.isInlineScript()&&!o.hasSourceURL)}}if(o.contentType().isScript()){console.assert(!o[SourceFormatData._formatDataSymbol]||o[SourceFormatData._formatDataSymbol]===o);return Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().uiLocationToRawLocationsForUnformattedJavaScript(o,0,0).map(o=>o.script()).filter(o=>!!o)}return[]}}class StyleMapping{constructor(){Bindings.CSSWorkspaceBinding.CSSWorkspaceBinding.instance().addSourceMapping(this),this._headersSymbol=Symbol("Formatter.SourceFormatter.StyleMapping._headersSymbol")}rawLocationToUILocation(o){const e=o.header(),t=e&&SourceFormatData._for(e);if(!t)return null;const r=t.mapping.originalToFormatted(o.lineNumber,o.columnNumber||0);return t.formattedSourceCode.uiLocation(r[0],r[1])}uiLocationToRawLocations(o){const e=SourceFormatData._for(o.uiSourceCode);if(!e)return[];const[t,r]=e.mapping.formattedToOriginal(o.lineNumber,o.columnNumber);return e.originalSourceCode[this._headersSymbol].filter(o=>o.containsLocation(t,r)).map(o=>new SDK.CSSModel.CSSLocation(o,t,r))}async _setSourceMappingEnabled(o,e){const t=o.originalSourceCode,r=this._headersForUISourceCode(t);e?(t[this._headersSymbol]=r,r.forEach(e=>{e[SourceFormatData._formatDataSymbol]=o})):(t[this._headersSymbol]=null,r.forEach(o=>delete o[SourceFormatData._formatDataSymbol]));const a=r.map(o=>Bindings.CSSWorkspaceBinding.CSSWorkspaceBinding.instance().updateLocations(o));await Promise.all(a)}_headersForUISourceCode(o){if(o.contentType()===Common.ResourceType.resourceTypes.Document){const e=Bindings.NetworkProject.NetworkProject.targetForUISourceCode(o),t=e&&e.model(SDK.CSSModel.CSSModel);if(t)return t.headersForSourceURL(o.url()).filter(o=>o.isInline&&!o.hasSourceURL)}else if(o.contentType().isStyleSheet()){return Bindings.CSSWorkspaceBinding.CSSWorkspaceBinding.instance().uiLocationToRawLocations(o.uiLocation(0,0)).map(o=>o.header()).filter(o=>!!o)}return[]}}