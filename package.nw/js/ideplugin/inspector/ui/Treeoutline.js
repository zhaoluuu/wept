import*as Common from"../common/common.js";import*as ARIAUtils from"./ARIAUtils.js";import{Icon}from"./Icon.js";import{Config,InplaceEditor}from"./InplaceEditor.js";import{Keys}from"./KeyboardShortcut.js";import{isEditing}from"./UIUtils.js";import{appendStyle}from"./utils/append-style.js";import{createShadowRootWithCoreStyles}from"./utils/create-shadow-root-with-core-styles.js";export class TreeOutline extends Common.ObjectWrapper.ObjectWrapper{constructor(){super(),this._createRootElement(),this.selectedTreeElement=null,this.expandTreeElementsWhenArrowing=!1,this._comparator=null,this.contentElement=this._rootElement._childrenListNode,this.contentElement.addEventListener("keydown",this._treeKeyDown.bind(this),!1),this._preventTabOrder=!1,this._showSelectionOnKeyboardFocus=!1,this.setFocusable(!0),this.element=this.contentElement,ARIAUtils.markAsTree(this.element)}setShowSelectionOnKeyboardFocus(e,t){this.contentElement.classList.toggle("hide-selection-when-blurred",e),this._preventTabOrder=!!t,this._focusable&&(this.contentElement.tabIndex=t?-1:0),this._showSelectionOnKeyboardFocus=e}_createRootElement(){this._rootElement=new TreeElement,this._rootElement.treeOutline=this,this._rootElement.root=!0,this._rootElement.selectable=!1,this._rootElement.expanded=!0,this._rootElement._childrenListNode.classList.remove("children")}rootElement(){return this._rootElement}firstChild(){return this._rootElement.firstChild()}_lastDescendent(){let e=this._rootElement.lastChild();for(;e.expanded&&e.childCount();)e=e.lastChild();return e}appendChild(e,t){this._rootElement.appendChild(e,t)}insertChild(e,t){this._rootElement.insertChild(e,t)}removeChild(e){this._rootElement.removeChild(e)}removeChildren(){this._rootElement.removeChildren()}treeElementFromPoint(e,t){const i=this.contentElement.ownerDocument.deepElementFromPoint(e,t);if(!i)return null;const s=i.enclosingNodeOrSelfWithNodeNameInArray(["ol","li"]);return s?s.parentTreeElement||s.treeElement:null}treeElementFromEvent(e){return e?this.treeElementFromPoint(e.pageX,e.pageY):null}setComparator(e){this._comparator=e}setFocusable(e){this._focusable=e,this.updateFocusable()}updateFocusable(){this._focusable?(this.contentElement.tabIndex=this._preventTabOrder||this.selectedTreeElement?-1:0,this.selectedTreeElement&&this.selectedTreeElement._setFocusable(!0)):(this.contentElement.removeAttribute("tabIndex"),this.selectedTreeElement&&this.selectedTreeElement._setFocusable(!1))}focus(){this.selectedTreeElement?this.selectedTreeElement.listItemElement.focus():this.contentElement.focus()}useLightSelectionColor(){this._useLightSelectionColor=!0}_bindTreeElement(e){e.treeOutline&&console.error("Binding element for the second time: "+(new Error).stack),e.treeOutline=this,e.onbind()}_unbindTreeElement(e){e.treeOutline||console.error("Unbinding element that was not bound: "+(new Error).stack),e.deselect(),e.onunbind(),e.treeOutline=null}selectPrevious(){let e=this.selectedTreeElement.traversePreviousTreeElement(!0);for(;e&&!e.selectable;)e=e.traversePreviousTreeElement(!this.expandTreeElementsWhenArrowing);return!!e&&(e.select(!1,!0),!0)}selectNext(){let e=this.selectedTreeElement.traverseNextTreeElement(!0);for(;e&&!e.selectable;)e=e.traverseNextTreeElement(!this.expandTreeElementsWhenArrowing);return!!e&&(e.select(!1,!0),!0)}forceSelect(e=!1,t=!0){this.selectedTreeElement&&this.selectedTreeElement.deselect(),this._selectFirst(e,t)}_selectFirst(e=!1,t=!0){let i=this.firstChild();for(;i&&!i.selectable;)i=i.traverseNextTreeElement(!0);return!!i&&(i.select(e,t),!0)}_selectLast(){let e=this._lastDescendent();for(;e&&!e.selectable;)e=e.traversePreviousTreeElement(!0);return!!e&&(e.select(!1,!0),!0)}_treeKeyDown(e){if(e.shiftKey||e.metaKey||e.ctrlKey||isEditing())return;let t=!1;this.selectedTreeElement?"ArrowUp"!==e.key||e.altKey?"ArrowDown"!==e.key||e.altKey?"ArrowLeft"===e.key?t=this.selectedTreeElement.collapseOrAscend(e.altKey):"ArrowRight"===e.key?this.selectedTreeElement.revealed()?t=this.selectedTreeElement.descendOrExpand(e.altKey):(this.selectedTreeElement.reveal(),t=!0):8===e.keyCode||46===e.keyCode?t=this.selectedTreeElement.ondelete():isEnterKey(e)?t=this.selectedTreeElement.onenter():e.keyCode===Keys.Space.code?t=this.selectedTreeElement.onspace():"Home"===e.key?t=this._selectFirst():"End"===e.key&&(t=this._selectLast()):t=this.selectNext():t=this.selectPrevious():"ArrowUp"!==e.key||e.altKey?"ArrowDown"!==e.key||e.altKey||(t=this._selectFirst()):t=this._selectLast(),t&&e.consume(!0)}_deferredScrollIntoView(e,t){this._treeElementToScrollIntoView||this.element.window().requestAnimationFrame(function(){const e=this._treeElementToScrollIntoView.listItemElement.getBoundingClientRect(),t=this.contentElement.getBoundingClientRect(),i=this.element.getBoundingClientRect(),s=i.left-t.left,n=i.top-t.top;let l=e.left-t.left;l>s&&l<s+i.width?l=s:this._centerUponScrollIntoView&&(l-=i.width/2);let r=e.top-t.top;r>n&&r<n+i.height?r=n:this._centerUponScrollIntoView&&(r-=i.height/2);this.element.scrollTo(l,r),delete this._treeElementToScrollIntoView,delete this._centerUponScrollIntoView}.bind(this)),this._treeElementToScrollIntoView=e,this._centerUponScrollIntoView=t}}export const Events={ElementAttached:Symbol("ElementAttached"),ElementsDetached:Symbol("ElementsDetached"),ElementExpanded:Symbol("ElementExpanded"),ElementCollapsed:Symbol("ElementCollapsed"),ElementSelected:Symbol("ElementSelected")};export class TreeOutlineInShadow extends TreeOutline{constructor(){super(),this.contentElement.classList.add("tree-outline"),this.element=createElement("div"),this._shadowRoot=createShadowRootWithCoreStyles(this.element,"ui/treeoutline.css"),this._disclosureElement=this._shadowRoot.createChild("div","tree-outline-disclosure"),this._disclosureElement.appendChild(this.contentElement),this._renderSelection=!0}registerRequiredCSS(e){appendStyle(this._shadowRoot,e)}hideOverflow(){this._disclosureElement.classList.add("tree-outline-disclosure-hide-overflow")}makeDense(){this.contentElement.classList.add("tree-outline-dense")}}export class TreeElement{constructor(e,t){this.treeOutline=null,this.parent=null,this.previousSibling=null,this.nextSibling=null,this._boundOnFocus=this._onFocus.bind(this),this._boundOnBlur=this._onBlur.bind(this),this._listItemNode=createElement("li"),this.titleElement=this._listItemNode.createChild("span","tree-element-title"),this._listItemNode.treeElement=this,e&&(this.title=e),this._listItemNode.addEventListener("mousedown",this._handleMouseDown.bind(this),!1),this._listItemNode.addEventListener("click",this._treeElementToggled.bind(this),!1),this._listItemNode.addEventListener("dblclick",this._handleDoubleClick.bind(this),!1),ARIAUtils.markAsTreeitem(this._listItemNode),this._childrenListNode=createElement("ol"),this._childrenListNode.parentTreeElement=this,this._childrenListNode.classList.add("children"),ARIAUtils.markAsGroup(this._childrenListNode),this._hidden=!1,this._selectable=!0,this.expanded=!1,this.selected=!1,this.setExpandable(t||!1),this._collapsible=!0}hasAncestor(e){if(!e)return!1;let t=this.parent;for(;t;){if(e===t)return!0;t=t.parent}return!1}hasAncestorOrSelf(e){return this===e||this.hasAncestor(e)}isHidden(){if(this.hidden)return!0;let e=this.parent;for(;e;){if(e.hidden)return!0;e=e.parent}return!1}children(){return this._children||[]}childCount(){return this._children?this._children.length:0}firstChild(){return this._children?this._children[0]:null}lastChild(){return this._children?this._children[this._children.length-1]:null}childAt(e){return this._children?this._children[e]:null}indexOfChild(e){return this._children?this._children.indexOf(e):-1}appendChild(e,t){let i;this._children||(this._children=[]),i=t?this._children.lowerBound(e,t):this.treeOutline&&this.treeOutline._comparator?this._children.lowerBound(e,this.treeOutline._comparator):this._children.length,this.insertChild(e,i)}insertChild(e,t){if(this._children||(this._children=[]),!e)throw"child can't be undefined or null";console.assert(!e.parent,"Attempting to insert a child that is already in the tree, reparenting is not supported.");const i=t>0?this._children[t-1]:null;i?(i.nextSibling=e,e.previousSibling=i):e.previousSibling=null;const s=this._children[t];s?(s.previousSibling=e,e.nextSibling=s):e.nextSibling=null,this._children.splice(t,0,e),this.setExpandable(!0),e.parent=this,this.treeOutline&&this.treeOutline._bindTreeElement(e);for(let t=e.firstChild();this.treeOutline&&t;t=t.traverseNextTreeElement(!1,e,!0))this.treeOutline._bindTreeElement(t);e.onattach(),e._ensureSelection(),this.treeOutline&&this.treeOutline.dispatchEventToListeners(Events.ElementAttached,e);const n=e.nextSibling?e.nextSibling._listItemNode:null;this._childrenListNode.insertBefore(e._listItemNode,n),this._childrenListNode.insertBefore(e._childrenListNode,n),e.selected&&e.select(),e.expanded&&e.expand()}removeChildAtIndex(e){if(e<0||e>=this._children.length)throw"childIndex out of range";const t=this._children[e];this._children.splice(e,1);const i=t.parent;this.treeOutline&&this.treeOutline.selectedTreeElement&&this.treeOutline.selectedTreeElement.hasAncestorOrSelf(t)&&(t.nextSibling?t.nextSibling.select(!0):t.previousSibling?t.previousSibling.select(!0):i&&i.select(!0)),t.previousSibling&&(t.previousSibling.nextSibling=t.nextSibling),t.nextSibling&&(t.nextSibling.previousSibling=t.previousSibling),t.parent=null,this.treeOutline&&this.treeOutline._unbindTreeElement(t);for(let e=t.firstChild();this.treeOutline&&e;e=e.traverseNextTreeElement(!1,t,!0))this.treeOutline._unbindTreeElement(e);t._detach(),this.treeOutline&&this.treeOutline.dispatchEventToListeners(Events.ElementsDetached)}removeChild(e){if(!e)throw"child can't be undefined or null";if(e.parent!==this)return;const t=this._children.indexOf(e);if(-1===t)throw"child not found in this node's children";this.removeChildAtIndex(t)}removeChildren(){!this.root&&this.treeOutline&&this.treeOutline.selectedTreeElement&&this.treeOutline.selectedTreeElement.hasAncestorOrSelf(this)&&this.select(!0);for(let e=0;this._children&&e<this._children.length;++e){const t=this._children[e];t.previousSibling=null,t.nextSibling=null,t.parent=null,this.treeOutline&&this.treeOutline._unbindTreeElement(t);for(let e=t.firstChild();this.treeOutline&&e;e=e.traverseNextTreeElement(!1,t,!0))this.treeOutline._unbindTreeElement(e);t._detach()}this._children=[],this.treeOutline&&this.treeOutline.dispatchEventToListeners(Events.ElementsDetached)}get selectable(){return!this.isHidden()&&this._selectable}set selectable(e){this._selectable=e}get listItemElement(){return this._listItemNode}get childrenListElement(){return this._childrenListNode}get title(){return this._title}set title(e){this._title!==e&&(this._title=e,"string"==typeof e?(this.titleElement.textContent=e,this.tooltip=e):(this.titleElement=e,this.tooltip=""),this._listItemNode.removeChildren(),this._leadingIconsElement&&this._listItemNode.appendChild(this._leadingIconsElement),this._listItemNode.appendChild(this.titleElement),this._trailingIconsElement&&this._listItemNode.appendChild(this._trailingIconsElement),this._ensureSelection())}titleAsText(){return this._title?"string"==typeof this._title?this._title:this._title.textContent:""}startEditingTitle(e){InplaceEditor.startEditing(this.titleElement,e),this.treeOutline._shadowRoot.getSelection().selectAllChildren(this.titleElement)}setLeadingIcons(e){if(this._leadingIconsElement||e.length){this._leadingIconsElement||(this._leadingIconsElement=document.createElement("div"),this._leadingIconsElement.classList.add("leading-icons"),this._leadingIconsElement.classList.add("icons-container"),this._listItemNode.insertBefore(this._leadingIconsElement,this.titleElement),this._ensureSelection()),this._leadingIconsElement.removeChildren();for(const t of e)this._leadingIconsElement.appendChild(t)}}setTrailingIcons(e){if(this._trailingIconsElement||e.length){this._trailingIconsElement||(this._trailingIconsElement=document.createElement("div"),this._trailingIconsElement.classList.add("trailing-icons"),this._trailingIconsElement.classList.add("icons-container"),this._listItemNode.appendChild(this._trailingIconsElement),this._ensureSelection()),this._trailingIconsElement.removeChildren();for(const t of e)this._trailingIconsElement.appendChild(t)}}get tooltip(){return this._tooltip||""}set tooltip(e){this._tooltip!==e&&(this._tooltip=e,this._listItemNode.title=e)}isExpandable(){return this._expandable}setExpandable(e){this._expandable!==e&&(this._expandable=e,this._listItemNode.classList.toggle("parent",e),e?ARIAUtils.setExpanded(this._listItemNode,!1):(this.collapse(),ARIAUtils.unsetExpandable(this._listItemNode)))}setCollapsible(e){this._collapsible!==e&&(this._collapsible=e,this._listItemNode.classList.toggle("always-parent",!e),e||this.expand())}get hidden(){return this._hidden}set hidden(e){if(this._hidden!==e&&(this._hidden=e,this._listItemNode.classList.toggle("hidden",e),this._childrenListNode.classList.toggle("hidden",e),e&&this.treeOutline&&this.treeOutline.selectedTreeElement&&this.treeOutline.selectedTreeElement.hasAncestorOrSelf(this))){const e=this.treeOutline.selectedTreeElement.listItemElement.hasFocus();this.treeOutline.forceSelect(!e,!1)}}invalidateChildren(){this._children&&(this.removeChildren(),this._children=null)}_ensureSelection(){this.treeOutline&&this.treeOutline._renderSelection&&(this._selectionElement||(this._selectionElement=document.createElement("div"),this._selectionElement.classList.add("selection"),this._selectionElement.classList.add("fill")),this._listItemNode.insertBefore(this._selectionElement,this.listItemElement.firstChild))}_treeElementToggled(e){const t=e.currentTarget;if(t.treeElement!==this||t.hasSelection())return;console.assert(!!this.treeOutline);const i=!!this.treeOutline&&this.treeOutline._showSelectionOnKeyboardFocus,s=this.toggleOnClick&&(i||!this.selectable),n=this.isEventWithinDisclosureTriangle(e);(s||n)&&(this.expanded?e.altKey?this.collapseRecursively():this.collapse():e.altKey?this.expandRecursively():this.expand(),e.consume())}_handleMouseDown(e){const t=e.currentTarget;t&&this.selectable&&t.treeElement===this&&(this.isEventWithinDisclosureTriangle(e)||this.selectOnMouseDown(e))}_handleDoubleClick(e){const t=e.currentTarget;if(!t||t.treeElement!==this)return;this.ondblclick(e)||this._expandable&&!this.expanded&&this.expand()}_detach(){this._listItemNode.remove(),this._childrenListNode.remove()}collapse(){if(!this.expanded||!this._collapsible)return;this._listItemNode.classList.remove("expanded"),this._childrenListNode.classList.remove("expanded"),ARIAUtils.setExpanded(this._listItemNode,!1),this.expanded=!1,this.oncollapse(),this.treeOutline&&this.treeOutline.dispatchEventToListeners(Events.ElementCollapsed,this);const e=this.treeOutline.selectedTreeElement;e&&e.hasAncestor(this)&&this.select(!0,!0)}collapseRecursively(){let e=this;for(;e;)e.expanded&&e.collapse(),e=e.traverseNextTreeElement(!1,this,!0)}collapseChildren(){if(this._children)for(const e of this._children)e.collapseRecursively()}expand(){!this._expandable||this.expanded&&this._children||(this.expanded=!0,this._populateIfNeeded(),this._listItemNode.classList.add("expanded"),this._childrenListNode.classList.add("expanded"),ARIAUtils.setExpanded(this._listItemNode,!0),this.treeOutline&&(this.onexpand(),this.treeOutline.dispatchEventToListeners(Events.ElementExpanded,this)))}async expandRecursively(e){let t=this;const i={};let s=0;for(isNaN(e)&&(e=3);t;)await t._populateIfNeeded(),s<e&&t.expand(),t=t.traverseNextTreeElement(!1,this,s>=e,i),s+=i.depthChange}collapseOrAscend(e){if(this.expanded&&this._collapsible)return e?this.collapseRecursively():this.collapse(),!0;if(!this.parent||this.parent.root)return!1;if(!this.parent.selectable)return this.parent.collapse(),!0;let t=this.parent;for(;t&&!t.selectable;)t=t.parent;return!!t&&(t.select(!1,!0),!0)}descendOrExpand(e){if(!this._expandable)return!1;if(!this.expanded)return e?this.expandRecursively():this.expand(),!0;let t=this.firstChild();for(;t&&!t.selectable;)t=t.nextSibling;return!!t&&(t.select(!1,!0),!0)}reveal(e){let t=this.parent;for(;t&&!t.root;)t.expanded||t.expand(),t=t.parent;this.treeOutline._deferredScrollIntoView(this,!!e)}revealed(){let e=this.parent;for(;e&&!e.root;){if(!e.expanded)return!1;e=e.parent}return!0}selectOnMouseDown(e){if(this.select(!1,!0)&&e.consume(!0),this._listItemNode.draggable&&this._selectionElement){const e=this.treeOutline.element.getBoundingClientRect().left-this._listItemNode.getBoundingClientRect().left;this._selectionElement.style.setProperty("margin-left",e+"px")}}select(e,t){if(!this.treeOutline||!this.selectable||this.selected)return e||this.listItemElement.focus(),!1;const i=this.treeOutline.selectedTreeElement;return this.treeOutline.selectedTreeElement=null,this.treeOutline._rootElement===this?(i&&i.deselect(),e||this.listItemElement.focus(),!1):(this.selected=!0,this.treeOutline.selectedTreeElement=this,this.treeOutline.updateFocusable(),e&&!this.treeOutline.contentElement.hasFocus()||this.listItemElement.focus(),this._listItemNode.classList.add("selected"),ARIAUtils.setSelected(this._listItemNode,!0),this.treeOutline.dispatchEventToListeners(Events.ElementSelected,this),i&&i.deselect(),this.onselect(t))}_setFocusable(e){e?(this._listItemNode.setAttribute("tabIndex",this.treeOutline&&this.treeOutline._preventTabOrder?-1:0),this._listItemNode.addEventListener("focus",this._boundOnFocus,!1),this._listItemNode.addEventListener("blur",this._boundOnBlur,!1)):(this._listItemNode.removeAttribute("tabIndex"),this._listItemNode.removeEventListener("focus",this._boundOnFocus,!1),this._listItemNode.removeEventListener("blur",this._boundOnBlur,!1))}_onFocus(){this.treeOutline._useLightSelectionColor||this.treeOutline.contentElement.classList.contains("hide-selection-when-blurred")||this._listItemNode.classList.add("force-white-icons")}_onBlur(){this.treeOutline._useLightSelectionColor||this.treeOutline.contentElement.classList.contains("hide-selection-when-blurred")||this._listItemNode.classList.remove("force-white-icons")}revealAndSelect(e){this.reveal(!0),this.select(e)}deselect(){const e=this._listItemNode.hasFocus();this.selected=!1,this._listItemNode.classList.remove("selected"),ARIAUtils.clearSelected(this._listItemNode),this._setFocusable(!1),this.treeOutline&&this.treeOutline.selectedTreeElement===this&&(this.treeOutline.selectedTreeElement=null,this.treeOutline.updateFocusable(),e&&this.treeOutline.focus())}async _populateIfNeeded(){this.treeOutline&&this._expandable&&!this._children&&(this._children=[],await this.onpopulate())}async onpopulate(){}onenter(){return!1}ondelete(){return!1}onspace(){return!1}onbind(){}onunbind(){}onattach(){}onexpand(){}oncollapse(){}ondblclick(e){return!1}onselect(e){return!1}traverseNextTreeElement(e,t,i,s){i||this._populateIfNeeded(),s&&(s.depthChange=0);let n=e?this.revealed()?this.firstChild():null:this.firstChild();if(n&&(!e||e&&this.expanded))return s&&(s.depthChange=1),n;if(this===t)return null;if(n=e?this.revealed()?this.nextSibling:null:this.nextSibling,n)return n;for(n=this;n&&!n.root&&!(e?n.revealed()&&n.nextSibling:n.nextSibling)&&n.parent!==t;)s&&(s.depthChange-=1),n=n.parent;return!n||n.root?null:e?n.revealed()?n.nextSibling:null:n.nextSibling}traversePreviousTreeElement(e,t){let i=e?this.revealed()?this.previousSibling:null:this.previousSibling;for(!t&&i&&i._populateIfNeeded();i&&(e?i.revealed()&&i.expanded&&i.lastChild():i.lastChild());)t||i._populateIfNeeded(),i=e?i.revealed()&&i.expanded?i.lastChild():null:i.lastChild();return i||(!this.parent||this.parent.root?null:this.parent)}isEventWithinDisclosureTriangle(e){const t=window.getComputedStyle(this._listItemNode).paddingLeft;console.assert(t.endsWith("px"));const i=parseFloat(t),s=this._listItemNode.totalOffsetLeft()+i;return e.pageX>=s&&e.pageX<=s+TreeElement._ArrowToggleWidth&&this._expandable}}TreeElement._ArrowToggleWidth=10,function(){const e=new Image;e.src="Images/treeoutlineTriangles.svg",TreeElement._imagePreload=e}();