import*as Common from"../common/common.js";import*as Host from"../host/host.js";import{ActionDelegate as ActionDelegateInterface}from"./ActionDelegate.js";import{Context}from"./Context.js";import{ContextMenu}from"./ContextMenu.js";import{Dialog}from"./Dialog.js";import{DockController}from"./DockController.js";import{GlassPane}from"./GlassPane.js";import{Icon}from"./Icon.js";import{Infobar,Type as InfobarType}from"./Infobar.js";import{KeyboardShortcut}from"./KeyboardShortcut.js";import{Panel}from"./Panel.js";import{SplitWidget}from"./SplitWidget.js";import{Events as TabbedPaneEvents}from"./TabbedPane.js";import{TabbedPane,TabbedPaneTabDelegate}from"./TabbedPane.js";import{ToolbarButton}from"./Toolbar.js";import{View,ViewLocation,ViewLocationResolver}from"./View.js";import{ViewManager}from"./ViewManager.js";import{VBox,WidgetFocusRestorer}from"./Widget.js";export class InspectorView extends VBox{constructor(){super(),GlassPane.setContainer(this.element),this.setMinimumSize(240,72),this._drawerSplitWidget=new SplitWidget(!1,!0,"Inspector.drawerSplitViewState",200,200),this._drawerSplitWidget.hideSidebar(),this._drawerSplitWidget.enableShowModeSaving(),this._drawerSplitWidget.show(this.element),this._tabDelegate=new InspectorViewTabDelegate,this._drawerTabbedLocation=ViewManager.instance().createTabbedLocation(this._showDrawer.bind(this,!1),"drawer-view",!0,!0);this._drawerTabbedLocation.enableMoreTabsButton().setTitle(ls`More Tools`),this._drawerTabbedPane=this._drawerTabbedLocation.tabbedPane(),this._drawerTabbedPane.setMinimumSize(0,27),this._drawerTabbedPane.element.classList.add("drawer-tabbed-pane");const e=new ToolbarButton(Common.UIString.UIString("Close drawer"),"largeicon-delete");e.addEventListener(ToolbarButton.Events.Click,this._closeDrawer,this),this._drawerTabbedPane.addEventListener(TabbedPaneEvents.TabSelected,this._tabSelected,this),this._drawerTabbedPane.setTabDelegate(this._tabDelegate),this._drawerSplitWidget.installResizer(this._drawerTabbedPane.headerElement()),this._drawerSplitWidget.setSidebarWidget(this._drawerTabbedPane),this._drawerTabbedPane.rightToolbar().appendToolbarItem(e),this._infoBarDiv,this._tabbedLocation=ViewManager.instance().createTabbedLocation(Host.InspectorFrontendHost.InspectorFrontendHostInstance.bringToFront.bind(Host.InspectorFrontendHost.InspectorFrontendHostInstance),"panel",!0,!0,Root.Runtime.queryParam("panel")),this._tabbedPane=this._tabbedLocation.tabbedPane(),this._tabbedPane.element.classList.add("main-tabbed-pane"),this._tabbedPane.registerRequiredCSS("ui/inspectorViewTabbedPane.css"),this._tabbedPane.addEventListener(TabbedPaneEvents.TabSelected,this._tabSelected,this),this._tabbedPane.setAccessibleName(Common.UIString.UIString("Panels")),this._tabbedPane.setTabDelegate(this._tabDelegate),Host.userMetrics.setLaunchPanel(this._tabbedPane.selectedTabId),Host.InspectorFrontendHost.isUnderTest()&&this._tabbedPane.setAutoSelectFirstItemOnShow(!1),this._drawerSplitWidget.setMainWidget(this._tabbedPane),this._keyDownBound=this._keyDown.bind(this),Host.InspectorFrontendHost.InspectorFrontendHostInstance.events.addEventListener(Host.InspectorFrontendHostAPI.Events.ShowPanel,function(e){const t=e.data;this.showPanel(t)}.bind(this))}static instance(){return self.runtime.sharedInstance(InspectorView)}wasShown(){this.element.ownerDocument.addEventListener("keydown",this._keyDownBound,!1)}willHide(){this.element.ownerDocument.removeEventListener("keydown",this._keyDownBound,!1)}resolveLocation(e){return"drawer-view"===e?this._drawerTabbedLocation:"panel"===e?this._tabbedLocation:null}createToolbars(){this._tabbedPane.leftToolbar().appendItemsAtLocation("main-toolbar-left"),this._tabbedPane.rightToolbar().appendItemsAtLocation("main-toolbar-right")}addPanel(e){this._tabbedLocation.appendView(e)}hasPanel(e){return this._tabbedPane.hasTab(e)}panel(e){return ViewManager.instance().view(e).widget()}onSuspendStateChanged(e){this._currentPanelLocked=e,this._tabbedPane.setCurrentTabLocked(this._currentPanelLocked),this._tabbedPane.leftToolbar().setEnabled(!this._currentPanelLocked),this._tabbedPane.rightToolbar().setEnabled(!this._currentPanelLocked)}canSelectPanel(e){return!this._currentPanelLocked||this._tabbedPane.selectedTabId===e}showPanel(e){return ViewManager.instance().showView(e)}setPanelIcon(e,t){const a=this._getTabbedPaneForTabId(e);a&&a.setTabIcon(e,t)}_getTabbedPaneForTabId(e){return this._tabbedPane.hasTab(e)?this._tabbedPane:this._drawerTabbedPane.hasTab(e)?this._drawerTabbedPane:null}currentPanelDeprecated(){return ViewManager.instance().materializedWidget(this._tabbedPane.selectedTabId||"")}_showDrawer(e){this._drawerTabbedPane.isShowing()||(this._drawerSplitWidget.showBoth(),this._focusRestorer=e?new WidgetFocusRestorer(this._drawerTabbedPane):null)}drawerVisible(){return this._drawerTabbedPane.isShowing()}_closeDrawer(){this._drawerTabbedPane.isShowing()&&(this._focusRestorer&&this._focusRestorer.restore(),this._drawerSplitWidget.hideSidebar(!0))}setDrawerMinimized(e){this._drawerSplitWidget.setSidebarMinimized(e),this._drawerSplitWidget.setResizable(!e)}isDrawerMinimized(){return this._drawerSplitWidget.isSidebarMinimized()}closeDrawerTab(e,t){this._drawerTabbedPane.closeTab(e,t),Host.userMetrics.panelClosed(e)}_keyDown(e){const t=e;if(!KeyboardShortcut.eventHasCtrlOrMeta(t)||e.altKey||e.shiftKey)return;if(Common.Settings.moduleSetting("shortcutPanelSwitch").get()){let a=-1;if(e.keyCode>48&&e.keyCode<58?a=e.keyCode-49:e.keyCode>96&&e.keyCode<106&&t.location===KeyboardEvent.DOM_KEY_LOCATION_NUMPAD&&(a=e.keyCode-97),-1!==a){const t=this._tabbedPane.tabIds()[a];t&&(Dialog.hasInstance()||this._currentPanelLocked||this.showPanel(t),e.consume(!0))}}}onResize(){GlassPane.containerMoved(this.element)}topResizerElement(){return this._tabbedPane.headerElement()}toolbarItemResized(){this._tabbedPane.headerResized()}_tabSelected(e){const t=e.data.tabId;Host.userMetrics.panelShown(t)}setOwnerSplit(e){this._ownerSplitWidget=e}ownerSplit(){return this._ownerSplitWidget}minimize(){this._ownerSplitWidget&&this._ownerSplitWidget.setSidebarMinimized(!0)}restore(){this._ownerSplitWidget&&this._ownerSplitWidget.setSidebarMinimized(!1)}displayReloadRequiredWarning(e){if(!this._reloadRequiredInfobar){const t=new Infobar(InfobarType.Info,e,[{text:ls`Reload DevTools`,highlight:!0,delegate:()=>{self.UI.dockController.canDock()&&self.UI.dockController.dockSide()===DockController.State.Undocked&&Host.InspectorFrontendHost.InspectorFrontendHostInstance.setIsDocked(!0,(function(){})),Host.InspectorFrontendHost.InspectorFrontendHostInstance.reattach(()=>window.location.reload())},dismiss:!1}]);t.setParentView(this),this._attachReloadRequiredInfobar(t),this._reloadRequiredInfobar=t,t.setCloseCallback(()=>{delete this._reloadRequiredInfobar})}}_attachReloadRequiredInfobar(e){this._infoBarDiv||(this._infoBarDiv=document.createElement("div"),this._infoBarDiv.classList.add("flex-none"),this.contentElement.insertBefore(this._infoBarDiv,this.contentElement.firstChild)),this._infoBarDiv.appendChild(e.element)}}export class ActionDelegate{handleAction(e,t){switch(t){case"main.toggle-drawer":return self.UI.inspectorView.drawerVisible()?self.UI.inspectorView._closeDrawer():self.UI.inspectorView._showDrawer(!0),!0;case"main.next-tab":return self.UI.inspectorView._tabbedPane.selectNextTab(),self.UI.inspectorView._tabbedPane.focus(),!0;case"main.previous-tab":return self.UI.inspectorView._tabbedPane.selectPrevTab(),self.UI.inspectorView._tabbedPane.focus(),!0}return!1}}export class InspectorViewTabDelegate{closeTabs(e,t){e.closeTabs(t,!0),t.forEach(e=>{Host.userMetrics.panelClosed(e)})}moveToDrawer(e){Host.userMetrics.actionTaken(Host.UserMetrics.Action.TabMovedToDrawer),ViewManager.instance().moveView(e,"drawer-view")}moveToMainPanel(e){Host.userMetrics.actionTaken(Host.UserMetrics.Action.TabMovedToMainPanel),ViewManager.instance().moveView(e,"panel")}onContextMenu(e,t){if("console"===e||"console-view"===e)return;if(!Root.Runtime.experiments.isEnabled("movableTabs"))return;"drawer-view"===ViewManager.instance().locationNameForViewId(e)?t.defaultSection().appendItem(Common.UIString.UIString("Move to top"),this.moveToMainPanel.bind(this,e)):t.defaultSection().appendItem(Common.UIString.UIString("Move to bottom"),this.moveToDrawer.bind(this,e))}}