import*as Common from"../common/common.js";import*as Platform from"../platform/platform.js";import{Size}from"./Geometry.js";import{Icon}from"./Icon.js";import{measuredScrollbarWidth}from"./utils/measured-scrollbar-width.js";import{Widget}from"./Widget.js";export class GlassPane extends Common.ObjectWrapper.ObjectWrapper{constructor(){super(),this._widget=new Widget(!0),this._widget.markAsRoot(),this.element=this._widget.element,this.contentElement=this._widget.contentElement,this._arrowElement=Icon.create("","arrow hidden"),this.element.shadowRoot&&this.element.shadowRoot.appendChild(this._arrowElement),this.registerRequiredCSS("ui/glassPane.css"),this.setPointerEventsBehavior(PointerEventsBehavior.PierceGlassPane),this._onMouseDownBound=this._onMouseDown.bind(this),this._onClickOutsideCallback=null,this._maxSize=null,this._positionX=null,this._positionY=null,this._anchorBox=null,this._anchorBehavior=AnchorBehavior.PreferTop,this._sizeBehavior=SizeBehavior.SetExactSize,this._marginBehavior=MarginBehavior.DefaultMargin}isShowing(){return this._widget.isShowing()}registerRequiredCSS(e){this._widget.registerRequiredCSS(e)}setDefaultFocusedElement(e){this._widget.setDefaultFocusedElement(e)}setDimmed(e){this.element.classList.toggle("dimmed-pane",e)}setPointerEventsBehavior(e){this.element.classList.toggle("no-pointer-events",e!==PointerEventsBehavior.BlockedByGlassPane),this.contentElement.classList.toggle("no-pointer-events",e===PointerEventsBehavior.PierceContents)}setOutsideClickCallback(e){this._onClickOutsideCallback=e}setMaxContentSize(e){this._maxSize=e,this.positionContent()}setSizeBehavior(e){this._sizeBehavior=e,this.positionContent()}setContentPosition(e,t){this._positionX=e,this._positionY=t,this.positionContent()}setContentAnchorBox(e){this._anchorBox=e,this.positionContent()}setAnchorBehavior(e){this._anchorBehavior=e}setMarginBehavior(e){this._marginBehavior=e,this._arrowElement.classList.toggle("hidden",e!==MarginBehavior.Arrow)}show(e){this.isShowing()||(this.element.style.zIndex=""+(3e3+1e3*_panes.size),e.body.addEventListener("mousedown",this._onMouseDownBound,!0),this._widget.show(e.body),_panes.add(this),this.positionContent())}hide(){this.isShowing()&&(_panes.delete(this),this.element.ownerDocument.body.removeEventListener("mousedown",this._onMouseDownBound,!0),this._widget.detach())}_onMouseDown(e){if(!this._onClickOutsideCallback)return;const t=e.deepElementFromPoint();t&&!this.contentElement.isSelfOrAncestor(t)&&this._onClickOutsideCallback.call(null,e)}positionContent(){if(!this.isShowing())return;const e=this._marginBehavior===MarginBehavior.Arrow,t=e?8:this._marginBehavior===MarginBehavior.NoMargin?0:3,i=measuredScrollbarWidth(this.element.ownerDocument),o=_containers.get(this.element.ownerDocument);this._sizeBehavior===SizeBehavior.MeasureContent&&(this.contentElement.positionAt(0,0),this.contentElement.style.width="",this.contentElement.style.maxWidth="",this.contentElement.style.height="",this.contentElement.style.maxHeight="");const n=o.offsetWidth,s=o.offsetHeight;let r=n-2*t,a=s-2*t,h=t,l=t;if(this._maxSize&&(r=Math.min(r,this._maxSize.width),a=Math.min(a,this._maxSize.height)),this._sizeBehavior===SizeBehavior.MeasureContent){const e=this.contentElement.getBoundingClientRect(),t=a<e.height?i:0,o=r<e.width?i:0;r=Math.min(r,e.width+t),a=Math.min(a,e.height+o)}if(this._anchorBox){const i=this._anchorBox.relativeToElement(o);let m=this._anchorBehavior;if(this._arrowElement.classList.remove("arrow-none","arrow-top","arrow-bottom","arrow-left","arrow-right"),m===AnchorBehavior.PreferTop||m===AnchorBehavior.PreferBottom){const c=i.y-2*t,d=s-i.y-i.height-2*t;let w;m===AnchorBehavior.PreferTop&&c<a&&d>c&&(m=AnchorBehavior.PreferBottom),m===AnchorBehavior.PreferBottom&&d<a&&c>d&&(m=AnchorBehavior.PreferTop);let _=!0;if(m===AnchorBehavior.PreferTop){l=Math.max(t,i.y-a-t);const e=i.y-l-t;this._sizeBehavior===SizeBehavior.MeasureContent?a>e&&(this._arrowElement.classList.add("arrow-none"),_=!1):a=Math.min(a,e),this._arrowElement.setIconType("mediumicon-arrow-bottom"),this._arrowElement.classList.add("arrow-bottom"),w=i.y-t}else{l=i.y+i.height+t;const e=s-l-t;this._sizeBehavior===SizeBehavior.MeasureContent?a>e&&(this._arrowElement.classList.add("arrow-none"),l=s-t-a,_=!1):a=Math.min(a,e),this._arrowElement.setIconType("mediumicon-arrow-top"),this._arrowElement.classList.add("arrow-top"),w=i.y+i.height+t}if(h=Math.max(t,Math.min(i.x,n-r-t)),_?e&&h-10>=t&&(h-=10):h=Math.min(h+10,n-r-t),r=Math.min(r,n-h-t),20>=r)this._arrowElement.classList.add("arrow-none");else{let e=i.x+Math.min(50,Math.floor(i.width/2));e=Platform.NumberUtilities.clamp(e,h+10,h+r-10),this._arrowElement.positionAt(e,w,o)}}else{const c=i.x-2*t,d=n-i.x-i.width-2*t;let w;m===AnchorBehavior.PreferLeft&&c<r&&d>c&&(m=AnchorBehavior.PreferRight),m===AnchorBehavior.PreferRight&&d<r&&c>d&&(m=AnchorBehavior.PreferLeft);let _=!0;if(m===AnchorBehavior.PreferLeft){h=Math.max(t,i.x-r-t);const e=i.x-h-t;this._sizeBehavior===SizeBehavior.MeasureContent?r>e&&(this._arrowElement.classList.add("arrow-none"),_=!1):r=Math.min(r,e),this._arrowElement.setIconType("mediumicon-arrow-right"),this._arrowElement.classList.add("arrow-right"),w=i.x-t}else{h=i.x+i.width+t;const e=n-h-t;this._sizeBehavior===SizeBehavior.MeasureContent?r>e&&(this._arrowElement.classList.add("arrow-none"),h=n-t-r,_=!1):r=Math.min(r,e),this._arrowElement.setIconType("mediumicon-arrow-left"),this._arrowElement.classList.add("arrow-left"),w=i.x+i.width+t}if(l=Math.max(t,Math.min(i.y,s-a-t)),_?e&&l-10>=t&&(l-=10):l=Math.min(l+10,s-a-t),a=Math.min(a,s-l-t),20>=a)this._arrowElement.classList.add("arrow-none");else{let e=i.y+Math.min(50,Math.floor(i.height/2));e=Platform.NumberUtilities.clamp(e,l+10,l+a-10),this._arrowElement.positionAt(w,e,o)}}}else h=null!==this._positionX?this._positionX:(n-r)/2,l=null!==this._positionY?this._positionY:(s-a)/2,r=Math.min(r,n-h-t),a=Math.min(a,s-l-t),this._arrowElement.classList.add("arrow-none");this.contentElement.style.width=r+"px",this._sizeBehavior===SizeBehavior.SetExactWidthMaxHeight?this.contentElement.style.maxHeight=a+"px":this.contentElement.style.height=a+"px",this.contentElement.positionAt(h,l,o),this._widget.doResize()}widget(){return this._widget}static setContainer(e){_containers.set(e.ownerDocument,e),GlassPane.containerMoved(e)}static container(e){return _containers.get(e)}static containerMoved(e){for(const t of _panes)t.isShowing()&&t.element.ownerDocument===e.ownerDocument&&t.positionContent()}}export const PointerEventsBehavior={BlockedByGlassPane:Symbol("BlockedByGlassPane"),PierceGlassPane:Symbol("PierceGlassPane"),PierceContents:Symbol("PierceContents")};export const AnchorBehavior={PreferTop:Symbol("PreferTop"),PreferBottom:Symbol("PreferBottom"),PreferLeft:Symbol("PreferLeft"),PreferRight:Symbol("PreferRight")};export const SizeBehavior={SetExactSize:Symbol("SetExactSize"),SetExactWidthMaxHeight:Symbol("SetExactWidthMaxHeight"),MeasureContent:Symbol("MeasureContent")};export const MarginBehavior={Arrow:Symbol("Arrow"),DefaultMargin:Symbol("DefaultMargin"),NoMargin:Symbol("NoMargin")};const _containers=new Map,_panes=new Set;export const GlassPanePanes=_panes;