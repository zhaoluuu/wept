import*as Common from"../common/common.js";import*as SDK from"../sdk/sdk.js";import*as TextUtils from"../text_utils/text_utils.js";import*as Workspace from"../workspace/workspace.js";import{ContentProviderBasedProject}from"./ContentProviderBasedProject.js";import{CSSWorkspaceBinding}from"./CSSWorkspaceBinding.js";import{DebuggerWorkspaceBinding}from"./DebuggerWorkspaceBinding.js";import{NetworkProject}from"./NetworkProject.js";import{resourceMetadata}from"./ResourceUtils.js";let resourceMappingInstance;export class ResourceMapping{constructor(e,t){this._workspace=t,this._modelToInfo=new Map,e.observeModels(SDK.ResourceTreeModel.ResourceTreeModel,this)}static instance(e={forceNew:null,targetManager:null,workspace:null}){const{forceNew:t,targetManager:o,workspace:r}=e;if(!resourceMappingInstance||t){if(!o||!r)throw new Error("Unable to create settings: targetManager and workspace must be provided: "+(new Error).stack);resourceMappingInstance=new ResourceMapping(o,r)}return resourceMappingInstance}modelAdded(e){const t=new ModelInfo(this._workspace,e);this._modelToInfo.set(e,t)}modelRemoved(e){this._modelToInfo.get(e).dispose(),this._modelToInfo.delete(e)}_infoForTarget(e){const t=e.model(SDK.ResourceTreeModel.ResourceTreeModel);return t?this._modelToInfo.get(t):null}cssLocationToUILocation(e){const t=e.header();if(!t)return null;const o=this._infoForTarget(e.cssModel().target());if(!o)return null;const r=o._project.uiSourceCodeForURL(e.url);if(!r)return null;const s=t[offsetSymbol]||TextUtils.TextRange.TextRange.createFromLocation(t.startLine,t.startColumn),n=e.lineNumber+s.startLine-t.startLine;let i=e.columnNumber;return e.lineNumber===t.startLine&&(i+=s.startColumn-t.startColumn),r.uiLocation(n,i)}jsLocationToUILocation(e){const t=e.script();if(!t)return null;const o=this._infoForTarget(e.debuggerModel.target());if(!o)return null;const r=o._project.uiSourceCodeForURL(t.sourceURL);if(!r)return null;const s=t[offsetSymbol]||TextUtils.TextRange.TextRange.createFromLocation(t.lineOffset,t.columnOffset),n=e.lineNumber+s.startLine-t.lineOffset;let i=e.columnNumber;return e.lineNumber===t.lineOffset&&(i+=s.startColumn-t.columnOffset),r.uiLocation(n,i)}uiLocationToJSLocations(e,t,o){if(!e[symbol])return[];const r=NetworkProject.targetForUISourceCode(e);if(!r)return[];const s=r.model(SDK.DebuggerModel.DebuggerModel);if(!s)return[];const n=s.createRawLocationByURL(e.url(),t,o);return n&&n.script().containsLocation(t,o)?[n]:[]}uiLocationToCSSLocations(e){if(!e.uiSourceCode[symbol])return[];const t=NetworkProject.targetForUISourceCode(e.uiSourceCode);if(!t)return[];const o=t.model(SDK.CSSModel.CSSModel);return o?o.createRawLocationsByURL(e.uiSourceCode.url(),e.lineNumber,e.columnNumber):[]}_resetForTest(e){const t=e.model(SDK.ResourceTreeModel.ResourceTreeModel),o=t?this._modelToInfo.get(t):null;o&&o._resetForTest()}}class ModelInfo{constructor(e,t){const o=t.target();this._project=new ContentProviderBasedProject(e,"resources:"+o.id(),Workspace.Workspace.projectTypes.Network,"",!1),NetworkProject.setTargetForProject(this._project,o),this._bindings=new Map;const r=o.model(SDK.CSSModel.CSSModel);this._cssModel=r,this._eventListeners=[t.addEventListener(SDK.ResourceTreeModel.Events.ResourceAdded,this._resourceAdded,this),t.addEventListener(SDK.ResourceTreeModel.Events.FrameWillNavigate,this._frameWillNavigate,this),t.addEventListener(SDK.ResourceTreeModel.Events.FrameDetached,this._frameDetached,this),r.addEventListener(SDK.CSSModel.Events.StyleSheetChanged,e=>{this._styleSheetChanged(e)},this)]}async _styleSheetChanged(e){const t=this._cssModel.styleSheetHeaderForId(e.data.styleSheetId);if(!t||!t.isInline||t.isInline&&t.isMutable)return;const o=this._bindings.get(t.resourceURL());o&&await o._styleSheetChanged(t,e.data.edit)}_acceptsResource(e){const t=e.resourceType();return(t===Common.ResourceType.resourceTypes.Image||t===Common.ResourceType.resourceTypes.Font||t===Common.ResourceType.resourceTypes.Document||t===Common.ResourceType.resourceTypes.Manifest)&&(!(t===Common.ResourceType.resourceTypes.Image&&e.mimeType&&!e.mimeType.startsWith("image"))&&(!(t===Common.ResourceType.resourceTypes.Font&&e.mimeType&&!e.mimeType.includes("font"))&&(t!==Common.ResourceType.resourceTypes.Image&&t!==Common.ResourceType.resourceTypes.Font||!e.contentURL().startsWith("data:"))))}_resourceAdded(e){const t=e.data;if(!this._acceptsResource(t))return;let o=this._bindings.get(t.url);o?o.addResource(t):(o=new Binding(this._project,t),this._bindings.set(t.url,o))}_removeFrameResources(e){for(const t of e.resources()){if(!this._acceptsResource(t))continue;const e=this._bindings.get(t.url);e&&(1===e._resources.size?(e.dispose(),this._bindings.delete(t.url)):e.removeResource(t))}}_frameWillNavigate(e){const t=e.data;this._removeFrameResources(t)}_frameDetached(e){const t=e.data;this._removeFrameResources(t)}_resetForTest(){for(const e of this._bindings.values())e.dispose();this._bindings.clear()}dispose(){Common.EventTarget.EventTarget.removeEventListeners(this._eventListeners);for(const e of this._bindings.values())e.dispose();this._bindings.clear(),this._project.removeProject()}}class Binding{constructor(e,t){this._resources=new Set([t]),this._project=e,this._uiSourceCode=this._project.createUISourceCode(t.url,t.contentType()),this._uiSourceCode[symbol]=!0,NetworkProject.setInitialFrameAttribution(this._uiSourceCode,t.frameId),this._project.addUISourceCodeWithProvider(this._uiSourceCode,this,resourceMetadata(t),t.mimeType),this._edits=[]}_inlineStyles(){const e=NetworkProject.targetForUISourceCode(this._uiSourceCode).model(SDK.CSSModel.CSSModel),t=[];if(e)for(const o of e.styleSheetIdsForURL(this._uiSourceCode.url())){const r=e.styleSheetHeaderForId(o);r&&t.push(r)}return t}_inlineScripts(){const e=NetworkProject.targetForUISourceCode(this._uiSourceCode).model(SDK.DebuggerModel.DebuggerModel);return e?e.scriptsForSourceURL(this._uiSourceCode.url()):[]}async _styleSheetChanged(e,t){if(this._edits.push({stylesheet:e,edit:t}),this._edits.length>1)return;const{content:o}=await this._uiSourceCode.requestContent();null!==o&&await this._innerStyleSheetChanged(o),this._edits=[]}async _innerStyleSheetChanged(e){const t=this._inlineScripts(),o=this._inlineStyles();let r=new TextUtils.Text.Text(e);for(const e of this._edits){const s=e.edit;if(!s)continue;const n=e.stylesheet,i=n[offsetSymbol]||TextUtils.TextRange.TextRange.createFromLocation(n.startLine,n.startColumn),c=s.oldRange.relativeFrom(i.startLine,i.startColumn),a=s.newRange.relativeFrom(i.startLine,i.startColumn);r=new TextUtils.Text.Text(r.replaceRange(c,s.newText));const u=[];for(const e of t){const t=e[offsetSymbol]||TextUtils.TextRange.TextRange.createFromLocation(e.lineOffset,e.columnOffset);t.follows(c)&&(e[offsetSymbol]=t.rebaseAfterTextEdit(c,a),u.push(DebuggerWorkspaceBinding.instance().updateLocations(e)))}for(const e of o){const t=e[offsetSymbol]||TextUtils.TextRange.TextRange.createFromLocation(e.startLine,e.startColumn);t.follows(c)&&(e[offsetSymbol]=t.rebaseAfterTextEdit(c,a),u.push(CSSWorkspaceBinding.instance().updateLocations(e)))}await Promise.all(u)}this._uiSourceCode.addRevision(r.value())}addResource(e){this._resources.add(e),NetworkProject.addFrameAttribution(this._uiSourceCode,e.frameId)}removeResource(e){this._resources.delete(e),NetworkProject.removeFrameAttribution(this._uiSourceCode,e.frameId)}dispose(){this._project.removeFile(this._uiSourceCode.url())}contentURL(){return this._resources.firstValue().contentURL()}contentType(){return this._resources.firstValue().contentType()}contentEncoded(){return this._resources.firstValue().contentEncoded()}requestContent(){return this._resources.firstValue().requestContent()}searchInContent(e,t,o){return this._resources.firstValue().searchInContent(e,t,o)}}export const symbol=Symbol("Bindings.ResourceMapping._symbol");export const offsetSymbol=Symbol("Bindings.ResourceMapping._offsetSymbol");