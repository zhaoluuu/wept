import*as Common from"../common/common.js";import*as SDK from"../sdk/sdk.js";import*as TextUtils from"../text_utils/text_utils.js";import*as Workspace from"../workspace/workspace.js";import{BlackboxManager}from"./BlackboxManager.js";import{ContentProviderBasedProject}from"./ContentProviderBasedProject.js";import{DebuggerSourceMapping,DebuggerWorkspaceBinding}from"./DebuggerWorkspaceBinding.js";import{NetworkProject}from"./NetworkProject.js";export class CompilerScriptMapping{constructor(e,t,r){this._debuggerModel=e,this._sourceMapManager=this._debuggerModel.sourceMapManager(),this._workspace=t,this._debuggerWorkspaceBinding=r;const o=e.target();this._regularProject=new ContentProviderBasedProject(t,"jsSourceMaps::"+o.id(),Workspace.Workspace.projectTypes.Network,"",!1),this._contentScriptsProject=new ContentProviderBasedProject(t,"jsSourceMaps:extensions:"+o.id(),Workspace.Workspace.projectTypes.ContentScripts,"",!1),NetworkProject.setTargetForProject(this._regularProject,o),NetworkProject.setTargetForProject(this._contentScriptsProject,o),this._regularBindings=new Map,this._contentScriptsBindings=new Map,this._stubUISourceCodes=new Map,this._stubProject=new ContentProviderBasedProject(t,"jsSourceMaps:stub:"+o.id(),Workspace.Workspace.projectTypes.Service,"",!0),this._eventListeners=[this._sourceMapManager.addEventListener(SDK.SourceMapManager.Events.SourceMapWillAttach,e=>{this._sourceMapWillAttach(e)},this),this._sourceMapManager.addEventListener(SDK.SourceMapManager.Events.SourceMapFailedToAttach,e=>{this._sourceMapFailedToAttach(e)},this),this._sourceMapManager.addEventListener(SDK.SourceMapManager.Events.SourceMapAttached,e=>{this._sourceMapAttached(e)},this),this._sourceMapManager.addEventListener(SDK.SourceMapManager.Events.SourceMapDetached,e=>{this._sourceMapDetached(e)},this)]}_addStubUISourceCode(e){const t=this._stubProject.addContentProvider(e.sourceURL+":sourcemap",TextUtils.StaticContentProvider.StaticContentProvider.fromString(e.sourceURL,Common.ResourceType.resourceTypes.Script,"\n\n\n\n\n// Please wait a bit.\n// Compiled script is not shown while source map is being loaded!"),"text/javascript");this._stubUISourceCodes.set(e,t)}async _removeStubUISourceCode(e){const t=this._stubUISourceCodes.get(e);this._stubUISourceCodes.delete(e),t&&this._stubProject.removeFile(t.url()),await this._debuggerWorkspaceBinding.updateLocations(e)}static uiSourceCodeOrigin(e){const t=e[_sourceMapSymbol];return t?t.compiledURL():null}mapsToSourceCode(e){const t=e.script(),r=t?this._sourceMapManager.sourceMapForClient(t):null;if(!r)return!0;const o=r.findEntry(e.lineNumber,e.columnNumber);return!!o&&o.lineNumber===e.lineNumber&&o.columnNumber===e.columnNumber}uiSourceCodeForURL(e,t){return t?this._contentScriptsProject.uiSourceCodeForURL(e):this._regularProject.uiSourceCodeForURL(e)}rawLocationToUILocation(e){const t=e.script();if(!t)return null;const r=e.lineNumber-t.lineOffset;let o=e.columnNumber;r||(o-=t.columnOffset);const s=this._stubUISourceCodes.get(t);if(s)return new Workspace.UISourceCode.UILocation(s,r,o);const c=this._sourceMapManager.sourceMapForClient(t);if(!c)return null;const i=c.findEntry(r,o);if(!i||!i.sourceURL)return null;const n=t.isContentScript()?this._contentScriptsProject.uiSourceCodeForURL(i.sourceURL):this._regularProject.uiSourceCodeForURL(i.sourceURL);return n?n.uiLocation(i.sourceLineNumber,i.sourceColumnNumber):null}uiLocationToRawLocations(e,t,r){const o=e[_sourceMapSymbol];if(!o)return[];const s=this._sourceMapManager.clientsForSourceMap(o);if(!s.length)return[];const c=o.sourceLineMapping(e.url(),t,r);return c?s.map(e=>this._debuggerModel.createRawLocation(e,c.lineNumber+e.lineOffset,c.lineNumber?c.columnNumber:c.columnNumber+e.columnOffset)):[]}async _sourceMapWillAttach(e){const t=e.data;this._addStubUISourceCode(t),await this._debuggerWorkspaceBinding.updateLocations(t)}async _sourceMapFailedToAttach(e){const t=e.data;await this._removeStubUISourceCode(t)}async _sourceMapAttached(e){const t=e.data.client,r=e.data.sourceMap;await this._removeStubUISourceCode(t),BlackboxManager.instance().isBlackboxedURL(t.sourceURL,t.isContentScript())||await this._populateSourceMapSources(t,r),this._sourceMapAttachedForTest(r)}async _sourceMapDetached(e){const t=e.data.client,r=e.data.sourceMap,o=t.isContentScript()?this._contentScriptsBindings:this._regularBindings;for(const e of r.sourceURLs()){const s=o.get(e);s&&(s.removeSourceMap(r,t.frameId),s._uiSourceCode||o.delete(e))}await this._debuggerWorkspaceBinding.updateLocations(t)}sourceMapForScript(e){return this._sourceMapManager.sourceMapForClient(e)}_sourceMapAttachedForTest(e){}async _populateSourceMapSources(e,t){const r=e.isContentScript()?this._contentScriptsProject:this._regularProject,o=e.isContentScript()?this._contentScriptsBindings:this._regularBindings;for(const s of t.sourceURLs()){let c=o.get(s);c||(c=new Binding(r,s),o.set(s,c)),c.addSourceMap(t,e.frameId)}await this._debuggerWorkspaceBinding.updateLocations(e)}static uiLineHasMapping(e,t){const r=e[_sourceMapSymbol];return!r||!!r.sourceLineMapping(e.url(),t,0)}dispose(){Common.EventTarget.EventTarget.removeEventListeners(this._eventListeners),this._regularProject.dispose(),this._contentScriptsProject.dispose(),this._stubProject.dispose()}}const _sourceMapSymbol=Symbol("_sourceMapSymbol");class Binding{constructor(e,t){this._project=e,this._url=t,this._referringSourceMaps=[],this._activeSourceMap=null,this._uiSourceCode=null}_recreateUISourceCodeIfNeeded(e){const t=this._referringSourceMaps.peekLast();if(this._activeSourceMap===t)return;this._activeSourceMap=t;const r=this._project.createUISourceCode(this._url,Common.ResourceType.resourceTypes.SourceMapScript);r[_sourceMapSymbol]=t;const o=t.sourceContentProvider(this._url,Common.ResourceType.resourceTypes.SourceMapScript),s=Common.ResourceType.ResourceType.mimeFromURL(this._url)||"text/javascript",c=t.embeddedContentByURL(this._url),i="string"==typeof c?new Workspace.UISourceCode.UISourceCodeMetadata(null,c.length):null;this._uiSourceCode?(NetworkProject.cloneInitialFrameAttribution(this._uiSourceCode,r),this._project.removeFile(this._uiSourceCode.url())):NetworkProject.setInitialFrameAttribution(r,e),this._uiSourceCode=r,this._project.addUISourceCodeWithProvider(this._uiSourceCode,o,i,s)}addSourceMap(e,t){this._uiSourceCode&&NetworkProject.addFrameAttribution(this._uiSourceCode,t),this._referringSourceMaps.push(e),this._recreateUISourceCodeIfNeeded(t)}removeSourceMap(e,t){NetworkProject.removeFrameAttribution(this._uiSourceCode,t);const r=this._referringSourceMaps.lastIndexOf(e);-1!==r&&this._referringSourceMaps.splice(r,1),this._referringSourceMaps.length?this._recreateUISourceCodeIfNeeded(t):(this._project.removeFile(this._uiSourceCode.url()),this._uiSourceCode=null)}}