import*as Common from"../common/common.js";import*as ProtocolClient from"../protocol_client/protocol_client.js";import*as SDK from"../sdk/sdk.js";import*as Workspace from"../workspace/workspace.js";import{DebuggerWorkspaceBinding}from"./DebuggerWorkspaceBinding.js";class SourceVariable extends SDK.RemoteObject.RemoteObjectImpl{constructor(e,t,r,o){const n=t.type.replace(/[ ]/g,"_");super(e.debuggerModel.runtimeModel(),void 0,n,void 0,null,void 0,t.type),this._variable=t,this._variable_type=n,this._callFrame=e,this._plugin=r,this._location=o,this._hasChildren=!0,this._evaluator=null}get type(){return this._variable_type}_getEvaluator(){return this._evaluator||(this._evaluator=this._plugin.evaluateVariable(this._variable.name,this._location).catch(e=>Common.Console.Console.instance().warn(ls`Error in debugger language plugin: ${e.message} (${e.code})`))),this._evaluator}_reprString(e){return e.value}_reprNumber(e){return Number(e.value)}_reprCompound(e){const t={};for(const r of e.value)t[r.name]=this._repr(r);return t}_reprArray(e){return e.value.map(e=>this._repr(e))}_repr(e){return"array"===e.js_type?this._reprArray(e):"object"===e.js_type?this._reprCompound(e):"number"===e.js_type?this._reprNumber(e):("string"!==e.js_type&&Common.Console.Console.instance().warn(ls`Invalid JS type on the evaluation result: ${e.js_type}`),this._reprString(e))}_getRepresentation(e){return new SDK.RemoteObject.LocalJSONObject(this._repr(e))}async doGetProperties(e,t,r){if(t)return{properties:[],internalProperties:[]};const o=await(async(e,t,r)=>{const o=await e;if(!o||!o.code)return null;const n=await t.debuggerModel.executeWasmEvaluator(t.id,o.code);if(n[ProtocolClient.InspectorBackend.ProtocolError]||n.exceptionDetails)return console.error(n[ProtocolClient.InspectorBackend.ProtocolError]||n.exceptionDetails.exception.description),null;const s=JSON.parse(n.result.value);return this._getRepresentation(s)})(this._getEvaluator(),this._callFrame,this._plugin);return{properties:[new SDK.RemoteObject.RemoteObjectProperty("value",o,!1,!1,!0,!1)],internalProperties:[]}}}class NamespaceObject extends SDK.RemoteObject.LocalJSONObject{constructor(e){super(e)}get description(){return this.type}get type(){return"namespace"}}class SourceScopeRemoteObject extends SDK.RemoteObject.RemoteObjectImpl{constructor(e,t,r){super(e.debuggerModel.runtimeModel(),void 0,"object",void 0,null),this.variables=[],this._callFrame=e,this._plugin=t,this._location=r}async doGetProperties(e,t,r){if(t)return{properties:[],internalProperties:[]};const o=[],n={};function s(e,t){return new SDK.RemoteObject.RemoteObjectProperty(e,t,!1,!1,!0,!1)}for(const e of this.variables){const t=new SourceVariable(this._callFrame,e,this._plugin,this._location);if(e.nestedName&&e.nestedName.length>1){let r=n;for(let t=0;t<e.nestedName.length-1;t++)r[e.nestedName[t]]||(r[e.nestedName[t]]=new NamespaceObject({})),r=r[e.nestedName[t]].value;r[e.nestedName[e.nestedName.length-1]]=t}else o.push(s(e.name,t))}for(const e in n)o.push(s(e,n[e]));return{properties:o,internalProperties:[]}}}class SourceScope{constructor(e,t,r,o){this._callFrame=e,this._type=t,this._object=new SourceScopeRemoteObject(e,r,o),this._name=t,this._startLocation=null,this._endLocation=null}callFrame(){return this._callFrame}type(){return this._type}typeName(){return this.type()}name(){return this._name}startLocation(){return this._startLocation}endLocation(){return this._endLocation}object(){return this._object}description(){return this.type()}}export class DebuggerLanguagePluginManager{constructor(e,t,r){this._sourceMapManager=e.sourceMapManager(),this._debuggerModel=e,this._debuggerWorkspaceBinding=r,this._plugins=[];for(const e of self.Extensions.extensionServer.languageExtensionEndpoints)this._plugins.push(e);this._uiSourceCodes=new Map,this._pluginForScriptId=new Map,this._unhandledScripts=new Set;const o=this._debuggerModel.target();this._project=new Bindings.ContentProviderBasedProject(t,"language_plugins::"+o.id(),Workspace.Workspace.projectTypes.Network,"",!1),Bindings.NetworkProject.setTargetForProject(this._project,o),this._eventHandlers=[this._debuggerModel.addEventListener(SDK.DebuggerModel.Events.ParsedScriptSource,this._newScriptSourceListener,this),self.Extensions.extensionServer.addEventListener(Extensions.ExtensionServer.Events.LanguageExtensionEndpointAdded,this._languageExtensionPluginAdded,this)]}clearPlugins(){this._plugins=[]}addPlugin(e){this._plugins.push(e);const t=[];for(const r of this._unhandledScripts)e.handleScript(r)&&(t.push(r),this._unhandledScripts.delete(r));t.forEach(t=>this._pluginForScriptId.set(t.scriptId,this._loadScript(e,t)))}_languageExtensionPluginAdded(e){this.addPlugin(e.data)}hasPluginForScript(e){return this._pluginForScriptId.has(e.scriptId)}_getPluginForScript(e){return Promise.resolve(this._pluginForScriptId.get(e.scriptId))}async rawLocationToUILocation(e){const t=e.script();if(!t)return null;const r=await this._getPluginForScript(t);if(!r)return null;const o={rawModuleId:t.sourceURL,codeOffset:e.columnNumber-t.codeOffset()};let n;try{n=await r.rawLocationToSourceLocation(o)}catch(e){if(!(e instanceof DebuggerLanguagePluginError))throw e;return Common.Console.Console.instance().warn(ls`Error in debugger language plugin: ${e.message} (${e.code})`),null}if(!n||0===n.length)return null;const s=n[0],i=this._project.uiSourceCodeForURL(s.sourceFileURL);return i?i.uiLocation(s.lineNumber,s.columnNumber>=0?s.columnNumber:void 0):null}async uiLocationToRawLocationRanges(e,t,r){const o=this._uiSourceCodes.get(e);if(!o)return null;const n=[];for(const[e,t]of o){const r=await this._getPluginForScript(t);r&&n.push(s(this._debuggerModel,r,e,t))}if(0===n.length)return null;try{return(await Promise.all(n)).flat()}catch(e){if(!(e instanceof DebuggerLanguagePluginError))throw e;return Common.Console.Console.instance().warn(ls`Error in debugger language plugin: ${e.message} (${e.code})`),null}async function s(e,o,n,s){const i={rawModuleId:s.sourceURL,sourceFileURL:n,lineNumber:t,columnNumber:r},a=await o.sourceLocationToRawLocation(i);return a&&0!==a.length?a.map(t=>({start:new SDK.DebuggerModel.Location(e,s.scriptId,0,Number(t.startOffset)+s.codeOffset()),end:new SDK.DebuggerModel.Location(e,s.scriptId,0,Number(t.endOffset)+s.codeOffset())})):[]}}async uiLocationToRawLocations(e,t,r){const o=await this.uiLocationToRawLocationRanges(e,t,r);return o?o.map(({start:e})=>e):null}async _getRawModule(e){return e.sourceURL.startsWith("wasm://")?e.sourceMapURL===SDK.SourceMap.WasmSourceMap.FAKE_URL?{code:await e.getWasmBytecode(),url:e.sourceURL}:null:{url:e.sourceURL}}_getOrCreateUISourceCode(e,t){let r=this._project.uiSourceCodeForURL(e);if(r)return r;r=this._project.createUISourceCode(e,Common.ResourceType.resourceTypes.SourceMapScript),Bindings.NetworkProject.setInitialFrameAttribution(r,t.frameId);const o=new SDK.CompilerSourceMappingContentProvider.CompilerSourceMappingContentProvider(e,Common.ResourceType.resourceTypes.SourceMapScript,t.createPageResourceLoadInitiator());this._bindUISourceCode(r,t,e);const n=Common.ResourceType.ResourceType.mimeFromURL(e)||"text/javascript";return this._project.addUISourceCodeWithProvider(r,o,null,n),r}_bindUISourceCode(e,t,r){const o=this._uiSourceCodes.get(e);o?o.push([r,t]):this._uiSourceCodes.set(e,[[r,t]])}_unbindUISourceCode(e,t){const r=this._uiSourceCodes.get(e).filter(([e,r])=>r!==t);this._uiSourceCodes.set(e,r),0===r.length&&(this._project.removeFile(e.url()),this._uiSourceCodes.delete(e))}async _loadScript(e,t){const r=await this._getRawModule(t);if(!r)return null;const o=(t.debugSymbols?t.debugSymbols.externalURL:t.sourceMapURL)||"";try{const n=await e.addRawModule(t.sourceURL,o,r);for(const e of n)this._getOrCreateUISourceCode(e,t);return this._debuggerWorkspaceBinding.updateLocations(t),e}catch(e){if(!(e instanceof DebuggerLanguagePluginError))throw e;return Common.Console.Console.instance().warn(ls`Error in debugger language plugin: ${e.message} (${e.code})`),null}}_newScriptSourceListener(e){const t=e.data;if(t.isWasm()&&t.sourceURL){for(const e of this._plugins)if(e.handleScript(t))return void this._pluginForScriptId.set(t.scriptId,this._loadScript(e,t));this._unhandledScripts.add(t)}}dispose(){this._project.dispose();for(const e of this._plugins)e.dispose&&e.dispose();this._pluginForScriptId.clear(),this._uiSourceCodes.clear()}async resolveScopeChain(e){if(!e)return null;const t=e.script,r=await this._getPluginForScript(t);if(!r)return null;const o=new Map,n={rawModuleId:t.sourceURL,codeOffset:e.location().columnNumber-t.codeOffset()};try{const t=await r.listVariablesInScope(n);for(const s of t||[])o.has(s.scope)||o.set(s.scope,new SourceScope(e,s.scope,r,n)),o.get(s.scope).object().variables.push(s);return Array.from(o.values())}catch(e){if(!(e instanceof DebuggerLanguagePluginError))throw e;return Common.Console.Console.instance().warn(ls`Error in debugger language plugin: ${e.message} (${e.code})`),null}}async removeScript(e){const t=this._pluginForScriptId.get(e.scriptId);if(!t)return;this._pluginForScriptId.delete(e.scriptId);const r=await t;if(r){try{await r.removeRawModule(e.sourceURL)}catch(e){if(!(e instanceof DebuggerLanguagePluginError))throw e;Common.Console.Console.instance().warn(ls`Error in debugger language plugin: ${e.message} (${e.code})`)}for(const t of this._uiSourceCodes.keys())this._unbindUISourceCode(t,e)}}}export class DebuggerLanguagePluginError extends Error{constructor(e,t){super(t),this.code=e,this.name="DebuggerLanguagePluginError"}}export let RawModule;export let RawLocationRange;export let RawLocation;export let SourceLocation;export let Variable;export let VariableValue;export class DebuggerLanguagePlugin{handleScript(e){}dispose(){}async addRawModule(e,t,r){}async sourceLocationToRawLocation(e){}async rawLocationToSourceLocation(e){}async listVariablesInScope(e){}async evaluateVariable(e,t){}}