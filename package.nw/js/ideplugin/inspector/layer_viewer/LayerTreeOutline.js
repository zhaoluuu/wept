import*as Common from"../common/common.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";import{LayerSelection,LayerView,LayerViewHost,Selection}from"./LayerViewHost.js";export const layerSymbol=Symbol("layer");export class LayerTreeOutline extends Common.ObjectWrapper.ObjectWrapper{constructor(e){super(),this._layerViewHost=e,this._layerViewHost.registerView(this),this._treeOutline=new UI.TreeOutline.TreeOutlineInShadow,this._treeOutline.element.classList.add("layer-tree","overflow-auto"),this._treeOutline.element.addEventListener("mousemove",this._onMouseMove.bind(this),!1),this._treeOutline.element.addEventListener("mouseout",this._onMouseMove.bind(this),!1),this._treeOutline.element.addEventListener("contextmenu",this._onContextMenu.bind(this),!0),UI.ARIAUtils.setAccessibleName(this._treeOutline.contentElement,ls`Layers Tree Pane`),this._lastHoveredNode=null,this.element=this._treeOutline.element,this._layerViewHost.showInternalLayersSetting().addChangeListener(this._update,this)}focus(){this._treeOutline.focus()}selectObject(e){this.hoverObject(null);const t=e&&e.layer(),s=t&&t[layerSymbol];s?s.revealAndSelect(!0):this._treeOutline.selectedTreeElement&&this._treeOutline.selectedTreeElement.deselect()}hoverObject(e){const t=e&&e.layer(),s=t&&t[layerSymbol];s!==this._lastHoveredNode&&(this._lastHoveredNode&&this._lastHoveredNode.setHovered(!1),s&&s.setHovered(!0),this._lastHoveredNode=s)}setLayerTree(e){this._layerTree=e,this._update()}_update(){const e=this._layerViewHost.showInternalLayersSetting().get(),t=new Map;let s=null;this._layerTree&&(e||(s=this._layerTree.contentRoot()),s||(s=this._layerTree.root())),s&&this._layerTree.forEachLayer(function(r){if(!r.drawsContent()&&!e)return;t.get(r)&&console.assert(!1,"Duplicate layer: "+r.id()),t.set(r,!0);let n=r[layerSymbol],i=r.parent();for(;i&&i!==s&&!i.drawsContent()&&!e;)i=i.parent();const o=r===s?this._treeOutline.rootElement():i[layerSymbol];if(o)if(n){if(n.parent!==o){const e=this._treeOutline.selectedTreeElement;n.parent&&n.parent.removeChild(n),o.appendChild(n),e!==this._treeOutline.selectedTreeElement&&e.select()}n._update()}else n=new LayerTreeElement(this,r),o.appendChild(n),r.drawsContent()||n.expand();else console.assert(!1,"Parent is not in the tree")}.bind(this),s);for(let e=this._treeOutline.rootElement().firstChild();e&&!e.root;)if(t.get(e._layer))e=e.traverseNextTreeElement(!1);else{const t=e.nextSibling||e.parent;e.parent.removeChild(e),e===this._lastHoveredNode&&(this._lastHoveredNode=null),e=t}if(!this._treeOutline.selectedTreeElement){const e=this._layerTree.contentRoot()||this._layerTree.root();e&&e[layerSymbol].revealAndSelect(!0)}}_onMouseMove(e){const t=this._treeOutline.treeElementFromEvent(e);t!==this._lastHoveredNode&&this._layerViewHost.hoverObject(this._selectionForNode(t))}_selectedNodeChanged(e){this._layerViewHost.selectObject(this._selectionForNode(e))}_onContextMenu(e){const t=this._selectionForNode(this._treeOutline.treeElementFromEvent(e)),s=new UI.ContextMenu.ContextMenu(e),r=t&&t.layer();r&&(this._layerSnapshotMap=this._layerViewHost.getLayerSnapshotMap(),this._layerSnapshotMap.has(r)&&s.defaultSection().appendItem(ls`Show Paint Profiler`,this.dispatchEventToListeners.bind(this,Events.PaintProfilerRequested,t),!1)),this._layerViewHost.showContextMenu(s,t)}_selectionForNode(e){return e&&e._layer?new LayerSelection(e._layer):null}}export const Events={PaintProfilerRequested:Symbol("PaintProfilerRequested")};export class LayerTreeElement extends UI.TreeOutline.TreeElement{constructor(e,t){super(),this._treeOutline=e,this._layer=t,this._layer[layerSymbol]=this,this._update()}_update(){const e=this._layer.nodeForSelfOrAncestor(),t=createDocumentFragment();t.createTextChild(e?e.simpleSelector():"#"+this._layer.id());t.createChild("span","dimmed").textContent=Common.UIString.UIString(" (%d Ã— %d)",this._layer.width(),this._layer.height()),this.title=t}onselect(){return this._treeOutline._selectedNodeChanged(this),!1}setHovered(e){this.listItemElement.classList.toggle("hovered",e)}}