import*as Common from"../common/common.js";import*as ProtocolClient from"../protocol_client/protocol_client.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";import{linkifyDeferredNodeReference}from"./DOMLinkifier.js";import{ElementsTreeElement,InitialChildrenLimit}from"./ElementsTreeElement.js";import{HrefSymbol,ImagePreviewPopover}from"./ImagePreviewPopover.js";export class ElementsTreeOutline extends UI.TreeOutline.TreeOutline{constructor(e,t,i){super(),this._treeElementSymbol=Symbol("treeElement");const n=createElement("div");this._shadowRoot=UI.Utils.createShadowRootWithCoreStyles(n,"elements/elementsTreeOutline.css");const d=this._shadowRoot.createChild("div","elements-disclosure");this._element=this.element,this._element.classList.add("elements-tree-outline","source-code"),i&&this._element.classList.add("elements-hide-gutter"),UI.ARIAUtils.setAccessibleName(this._element,Common.UIString.UIString("Page DOM")),this._element.addEventListener("focusout",this._onfocusout.bind(this),!1),this._element.addEventListener("mousedown",this._onmousedown.bind(this),!1),this._element.addEventListener("mousemove",this._onmousemove.bind(this),!1),this._element.addEventListener("mouseleave",this._onmouseleave.bind(this),!1),this._element.addEventListener("dragstart",this._ondragstart.bind(this),!1),this._element.addEventListener("dragover",this._ondragover.bind(this),!1),this._element.addEventListener("dragleave",this._ondragleave.bind(this),!1),this._element.addEventListener("drop",this._ondrop.bind(this),!1),this._element.addEventListener("dragend",this._ondragend.bind(this),!1),this._element.addEventListener("contextmenu",this._contextMenuEventFired.bind(this),!1),this._element.addEventListener("clipboard-beforecopy",this._onBeforeCopy.bind(this),!1),this._element.addEventListener("clipboard-copy",this._onCopyOrCut.bind(this,!1),!1),this._element.addEventListener("clipboard-cut",this._onCopyOrCut.bind(this,!0),!1),this._element.addEventListener("clipboard-paste",this._onPaste.bind(this),!1),this._element.addEventListener("keydown",this._onKeyDown.bind(this),!1),d.appendChild(this._element),this.element=n,this._includeRootDOMNode=!e,this._selectEnabled=t,this._rootDOMNode=null,this._selectedDOMNode=null,this._visible=!1,this._imagePreviewPopover=new ImagePreviewPopover(this.contentElement,e=>{let t=e.target;for(;t&&!t[HrefSymbol];)t=t.parentElementOrShadowHost();return t},e=>{const t=e.enclosingNodeOrSelfWithNodeName("li");return t?t.treeElement.node():null}),this._updateRecords=new Map,this._treeElementsBeingUpdated=new Set,this._showHTMLCommentsSetting=Common.Settings.Settings.instance().moduleSetting("showHTMLComments"),this._showHTMLCommentsSetting.addChangeListener(this._onShowHTMLCommentsChange.bind(this)),this.useLightSelectionColor()}static forDOMModel(e){return e[ElementsTreeOutline._treeOutlineSymbol]||null}_onShowHTMLCommentsChange(){const e=this.selectedDOMNode();e&&e.nodeType()===Node.COMMENT_NODE&&!this._showHTMLCommentsSetting.get()&&this.selectDOMNode(e.parentNode),this.update()}treeElementSymbol(){return this._treeElementSymbol}setWordWrap(e){this._element.classList.toggle("elements-tree-nowrap",!e)}setMultilineEditing(e){this._multilineEditing=e}visibleWidth(){return this._visibleWidth}setVisibleWidth(e){this._visibleWidth=e,this._multilineEditing&&this._multilineEditing.resize()}_setClipboardData(e){if(this._clipboardNodeData){const e=this.findTreeElement(this._clipboardNodeData.node);e&&e.setInClipboard(!1),delete this._clipboardNodeData}if(e){const t=this.findTreeElement(e.node);t&&t.setInClipboard(!0),this._clipboardNodeData=e}}resetClipboardIfNeeded(e){this._clipboardNodeData&&this._clipboardNodeData.node===e&&this._setClipboardData(null)}_onBeforeCopy(e){e.handled=!0}_onCopyOrCut(e,t){this._setClipboardData(null);const i=t.original;if(i.target.hasSelection())return;if(UI.UIUtils.isEditing())return;const n=this.selectedDOMNode();n&&(i.clipboardData.clearData(),t.handled=!0,this.performCopyOrCut(e,n))}performCopyOrCut(e,t){e&&(t.isShadowRoot()||t.ancestorUserAgentShadowRoot())||(t.copyNode(),this._setClipboardData({node:t,isCut:e}))}canPaste(e){if(e.isShadowRoot()||e.ancestorUserAgentShadowRoot())return!1;if(!this._clipboardNodeData)return!1;const t=this._clipboardNodeData.node;return(!this._clipboardNodeData.isCut||t!==e&&!t.isAncestor(e))&&e.domModel()===t.domModel()}pasteNode(e){this.canPaste(e)&&this._performPaste(e)}_onPaste(e){if(UI.UIUtils.isEditing())return;const t=this.selectedDOMNode();t&&this.canPaste(t)&&(e.handled=!0,this._performPaste(t))}_performPaste(e){function t(t,i){if(t)return;const n=e.domModel().nodeForId(i);n&&this.selectDOMNode(n)}this._clipboardNodeData.isCut?(this._clipboardNodeData.node.moveTo(e,null,t.bind(this)),this._setClipboardData(null)):this._clipboardNodeData.node.copyTo(e,null,t.bind(this))}setVisible(e){if(e!==this._visible){if(this._visible=e,!this._visible)return this._imagePreviewPopover.hide(),void(this._multilineEditing&&this._multilineEditing.cancel());this.runPendingUpdates(),this._selectedDOMNode&&this._revealAndSelectNode(this._selectedDOMNode,!1)}}get rootDOMNode(){return this._rootDOMNode}set rootDOMNode(e){this._rootDOMNode!==e&&(this._rootDOMNode=e,this._isXMLMimeType=e&&e.isXMLNode(),this.update())}get isXMLMimeType(){return this._isXMLMimeType}selectedDOMNode(){return this._selectedDOMNode}selectDOMNode(e,t){this._selectedDOMNode!==e?(this._selectedDOMNode=e,this._revealAndSelectNode(e,!t),this._selectedDOMNode===e&&this._selectedNodeChanged(!!t)):this._revealAndSelectNode(e,!t)}editing(){const e=this.selectedDOMNode();if(!e)return!1;const t=this.findTreeElement(e);return t&&t.isEditing()||!1}update(){const e=this.selectedDOMNode();if(this.removeChildren(),this.rootDOMNode){if(this._includeRootDOMNode){const e=this._createElementTreeElement(this.rootDOMNode);this.appendChild(e)}else{const e=this._visibleChildren(this.rootDOMNode);for(const t of e){const e=this._createElementTreeElement(t);this.appendChild(e)}}e&&this._revealAndSelectNode(e,!0)}}_selectedNodeChanged(e){this.dispatchEventToListeners(ElementsTreeOutline.Events.SelectedNodeChanged,{node:this._selectedDOMNode,focus:e})}_fireElementsTreeUpdated(e){this.dispatchEventToListeners(ElementsTreeOutline.Events.ElementsTreeUpdated,e)}findTreeElement(e){let t=this._lookUpTreeElement(e);return t||e.nodeType()!==Node.TEXT_NODE||(t=this._lookUpTreeElement(e.parentNode)),t}_lookUpTreeElement(e){if(!e)return null;const t=e[this._treeElementSymbol];if(t)return t;const i=[];let n;for(n=e.parentNode;n&&(i.push(n),!n[this._treeElementSymbol]);n=n.parentNode);if(!n)return null;for(let t=i.length-1;t>=0;--t){const n=i[t-1]||e,d=i[t][this._treeElementSymbol];d&&(d.onpopulate(),n.index>=d.expandedChildrenLimit()&&this.setExpandedChildrenLimit(d,n.index+1))}return e[this._treeElementSymbol]}createTreeElementFor(e){let t=this.findTreeElement(e);return t||(e.parentNode?(t=this.createTreeElementFor(e.parentNode),t?this._showChild(t,e):null):null)}set suppressRevealAndSelect(e){this._suppressRevealAndSelect!==e&&(this._suppressRevealAndSelect=e)}_revealAndSelectNode(e,t){if(this._suppressRevealAndSelect)return;if(!this._includeRootDOMNode&&e===this.rootDOMNode&&this.rootDOMNode&&(e=this.rootDOMNode.firstChild),!e)return;const i=this.createTreeElementFor(e);i&&i.revealAndSelect(t)}_treeElementFromEvent(e){const t=this.element.parentElement,i=t.totalOffsetLeft()+t.offsetWidth-36,n=e.pageY,d=this.treeElementFromPoint(i,n);let o;return o=d===this.treeElementFromPoint(i,n-2)?d:this.treeElementFromPoint(i,n+2),o}_onfocusout(e){SDK.OverlayModel.OverlayModel.hideDOMNodeHighlight()}_onmousedown(e){const t=this._treeElementFromEvent(e);t&&!t.isEventWithinDisclosureTriangle(e)&&t.select()}setHoverEffect(e){this._previousHoveredElement!==e&&(this._previousHoveredElement&&(this._previousHoveredElement.hovered=!1,delete this._previousHoveredElement),e&&(e.hovered=!0,this._previousHoveredElement=e))}_onmousemove(e){const t=this._treeElementFromEvent(e);t&&this._previousHoveredElement===t||(this.setHoverEffect(t),this._highlightTreeElement(t,!UI.KeyboardShortcut.KeyboardShortcut.eventHasCtrlOrMeta(e)))}_highlightTreeElement(e,t){e instanceof ElementsTreeElement?e.node().domModel().overlayModel().highlightInOverlay({node:e.node()},"all",t):e instanceof ShortcutTreeElement&&e.domModel().overlayModel().highlightInOverlay({deferredNode:e.deferredNode()},"all",t)}_onmouseleave(e){this.setHoverEffect(null),SDK.OverlayModel.OverlayModel.hideDOMNodeHighlight()}_ondragstart(e){if(e.target.hasSelection())return!1;if("A"===e.target.nodeName)return!1;const t=this._validDragSourceOrTarget(this._treeElementFromEvent(e));return!!t&&("BODY"!==t.node().nodeName()&&"HEAD"!==t.node().nodeName()&&(e.dataTransfer.setData("text/plain",t.listItemElement.textContent.replace(/\u200b/g,"")),e.dataTransfer.effectAllowed="copyMove",this._treeElementBeingDragged=t,SDK.OverlayModel.OverlayModel.hideDOMNodeHighlight(),!0))}_ondragover(e){if(!this._treeElementBeingDragged)return!1;const t=this._validDragSourceOrTarget(this._treeElementFromEvent(e));if(!t)return!1;let i=t.node();for(;i;){if(i===this._treeElementBeingDragged._node)return!1;i=i.parentNode}return t.listItemElement.classList.add("elements-drag-over"),this._dragOverTreeElement=t,e.preventDefault(),e.dataTransfer.dropEffect="move",!1}_ondragleave(e){return this._clearDragOverTreeElementMarker(),e.preventDefault(),!1}_validDragSourceOrTarget(e){if(!e)return null;if(!(e instanceof ElementsTreeElement))return null;const t=e,i=t.node();return i.parentNode&&i.parentNode.nodeType()===Node.ELEMENT_NODE?t:null}_ondrop(e){e.preventDefault();const t=this._treeElementFromEvent(e);t instanceof ElementsTreeElement&&this._doMove(t)}_doMove(e){if(!this._treeElementBeingDragged)return;let t,i;if(e.isClosingTag())t=e.node();else{const n=e.node();t=n.parentNode,i=n}const n=this._treeElementBeingDragged.expanded;this._treeElementBeingDragged._node.moveTo(t,i,this.selectNodeAfterEdit.bind(this,n)),delete this._treeElementBeingDragged}_ondragend(e){e.preventDefault(),this._clearDragOverTreeElementMarker(),delete this._treeElementBeingDragged}_clearDragOverTreeElementMarker(){this._dragOverTreeElement&&(this._dragOverTreeElement.listItemElement.classList.remove("elements-drag-over"),delete this._dragOverTreeElement)}_contextMenuEventFired(e){const t=this._treeElementFromEvent(e);t instanceof ElementsTreeElement&&this.showContextMenu(t,e)}showContextMenu(e,t){if(UI.UIUtils.isEditing())return;const i=new UI.ContextMenu.ContextMenu(t),n=!!e.node().pseudoType(),d=e.node().nodeType()===Node.ELEMENT_NODE&&!n;let o=t.target.enclosingNodeOrSelfWithClass("webkit-html-text-node");o&&o.classList.contains("bogus")&&(o=null);const s=t.target.enclosingNodeOrSelfWithClass("webkit-html-comment");i.saveSection().appendItem(ls`Store as global variable`,this._saveNodeToTempVariable.bind(this,e.node())),o?e.populateTextContextMenu(i,o):d?e.populateTagContextMenu(i,t):s?e.populateNodeContextMenu(i):n&&e.populateScrollIntoView(i),i.appendApplicableItems(e.node()),i.show()}async _saveNodeToTempVariable(e){const t=await e.resolveToObject();await SDK.ConsoleModel.ConsoleModel.instance().saveToTempVariable(UI.Context.Context.instance().flavor(SDK.RuntimeModel.ExecutionContext),t)}runPendingUpdates(){this._updateModifiedNodes()}_onKeyDown(e){const t=e;if(UI.UIUtils.isEditing())return;const i=this.selectedDOMNode();if(!i)return;const n=i[this._treeElementSymbol];if(n&&UI.KeyboardShortcut.KeyboardShortcut.eventHasCtrlOrMeta(t)&&i.parentNode){if("ArrowUp"===t.key&&i.previousSibling)return i.moveTo(i.parentNode,i.previousSibling,this.selectNodeAfterEdit.bind(this,n.expanded)),void t.consume(!0);if("ArrowDown"===t.key&&i.nextSibling)return i.moveTo(i.parentNode,i.nextSibling.nextSibling,this.selectNodeAfterEdit.bind(this,n.expanded)),void t.consume(!0)}}toggleEditAsHTML(e,t,i){const n=e[this._treeElementSymbol];if(!n||!n.hasEditableNode())return;if(e.pseudoType())return;const d=e.parentNode,o=e.index,s=n.expanded;n.toggleEditAsHTML(function(e){i&&i();if(!e)return;this.runPendingUpdates();const t=d?d.children()[o]||d:null;if(!t)return;if(this.selectDOMNode(t,!0),s){const e=this.findTreeElement(t);e&&e.expand()}}.bind(this),t)}selectNodeAfterEdit(e,t,i){if(t)return null;if(this.runPendingUpdates(),!i)return null;this.selectDOMNode(i,!0);const n=this.findTreeElement(i);return e&&n&&n.expand(),n}async toggleHideElement(e){const t=e.pseudoType(),i=t?e.parentNode:e;if(!i)return;const n=e.marker("hidden-marker"),d=await i.resolveToObject("");d&&(await d.callFunction((function(e,t){const i="__web-inspector-hide-shortcut-style__",n=[];n.push(".__web-inspector-hide-shortcut__"),n.push(".__web-inspector-hide-shortcut__ *"),n.push(".__web-inspector-hidebefore-shortcut__::before"),n.push(".__web-inspector-hideafter-shortcut__::after");const d=n.join(", "),o="\n"+d+"\n{\n    visibility: hidden !important;\n}\n",s="__web-inspector-hide"+(e||"")+"-shortcut__";this.classList.toggle(s,t);let r=this;for(;r.parentNode;)r=r.parentNode;r.nodeType===Node.DOCUMENT_NODE&&(r=document.head);let l=r.querySelector("style#"+i);if(l)return;l=document.createElement("style"),l.id=i,l.textContent=o,r.appendChild(l)}),[{value:t},{value:!n}]),d.release(),e.setMarker("hidden-marker",!n||null))}isToggledToHidden(e){return!!e.marker("hidden-marker")}_reset(){this.rootDOMNode=null,this.selectDOMNode(null,!1),this._imagePreviewPopover.hide(),delete this._clipboardNodeData,SDK.OverlayModel.OverlayModel.hideDOMNodeHighlight(),this._updateRecords.clear()}wireToDOMModel(e){e[ElementsTreeOutline._treeOutlineSymbol]=this,e.addEventListener(SDK.DOMModel.Events.MarkersChanged,this._markersChanged,this),e.addEventListener(SDK.DOMModel.Events.NodeInserted,this._nodeInserted,this),e.addEventListener(SDK.DOMModel.Events.NodeRemoved,this._nodeRemoved,this),e.addEventListener(SDK.DOMModel.Events.AttrModified,this._attributeModified,this),e.addEventListener(SDK.DOMModel.Events.AttrRemoved,this._attributeRemoved,this),e.addEventListener(SDK.DOMModel.Events.CharacterDataModified,this._characterDataModified,this),e.addEventListener(SDK.DOMModel.Events.DocumentUpdated,this._documentUpdated,this),e.addEventListener(SDK.DOMModel.Events.ChildNodeCountUpdated,this._childNodeCountUpdated,this),e.addEventListener(SDK.DOMModel.Events.DistributedNodesChanged,this._distributedNodesChanged,this)}unwireFromDOMModel(e){e.removeEventListener(SDK.DOMModel.Events.MarkersChanged,this._markersChanged,this),e.removeEventListener(SDK.DOMModel.Events.NodeInserted,this._nodeInserted,this),e.removeEventListener(SDK.DOMModel.Events.NodeRemoved,this._nodeRemoved,this),e.removeEventListener(SDK.DOMModel.Events.AttrModified,this._attributeModified,this),e.removeEventListener(SDK.DOMModel.Events.AttrRemoved,this._attributeRemoved,this),e.removeEventListener(SDK.DOMModel.Events.CharacterDataModified,this._characterDataModified,this),e.removeEventListener(SDK.DOMModel.Events.DocumentUpdated,this._documentUpdated,this),e.removeEventListener(SDK.DOMModel.Events.ChildNodeCountUpdated,this._childNodeCountUpdated,this),e.removeEventListener(SDK.DOMModel.Events.DistributedNodesChanged,this._distributedNodesChanged,this),delete e[ElementsTreeOutline._treeOutlineSymbol]}_addUpdateRecord(e){let t=this._updateRecords.get(e);return t||(t=new UpdateRecord,this._updateRecords.set(e,t)),t}_updateRecordForHighlight(e){return this._visible&&this._updateRecords.get(e)||null}_documentUpdated(e){const t=e.data;this._reset(),t.existingDocument()&&(this.rootDOMNode=t.existingDocument())}_attributeModified(e){const t=e.data.node;this._addUpdateRecord(t).attributeModified(e.data.name),this._updateModifiedNodesSoon()}_attributeRemoved(e){const t=e.data.node;this._addUpdateRecord(t).attributeRemoved(e.data.name),this._updateModifiedNodesSoon()}_characterDataModified(e){const t=e.data;this._addUpdateRecord(t).charDataModified(),t.parentNode&&t.parentNode.firstChild===t.parentNode.lastChild&&this._addUpdateRecord(t.parentNode).childrenModified(),this._updateModifiedNodesSoon()}_nodeInserted(e){const t=e.data;this._addUpdateRecord(t.parentNode).nodeInserted(t),this._updateModifiedNodesSoon()}_nodeRemoved(e){const t=e.data.node,i=e.data.parent;this.resetClipboardIfNeeded(t),this._addUpdateRecord(i).nodeRemoved(t),this._updateModifiedNodesSoon()}_childNodeCountUpdated(e){const t=e.data;this._addUpdateRecord(t).childrenModified(),this._updateModifiedNodesSoon()}_distributedNodesChanged(e){const t=e.data;this._addUpdateRecord(t).childrenModified(),this._updateModifiedNodesSoon()}_updateModifiedNodesSoon(){this._updateRecords.size&&(this._updateModifiedNodesTimeout||(this._updateModifiedNodesTimeout=setTimeout(this._updateModifiedNodes.bind(this),50)))}_updateModifiedNodes(){this._updateModifiedNodesTimeout&&(clearTimeout(this._updateModifiedNodesTimeout),delete this._updateModifiedNodesTimeout);const e=[...this._updateRecords.keys()],t=e.length>10;let i,n;if(t&&(i=this.element.parentNode,n=i?i.scrollTop:0,this._element.classList.add("hidden")),this._rootDOMNode&&this._updateRecords.get(this._rootDOMNode)&&this._updateRecords.get(this._rootDOMNode).hasChangedChildren())this.update();else for(const e of this._updateRecords.keys())this._updateRecords.get(e).hasChangedChildren()?this._updateModifiedParentNode(e):this._updateModifiedNode(e);t&&(this._element.classList.remove("hidden"),n&&(i.scrollTop=n)),this._updateRecords.clear(),this._fireElementsTreeUpdated(e)}_updateModifiedNode(e){const t=this.findTreeElement(e);t&&t.updateTitle(this._updateRecordForHighlight(e))}_updateModifiedParentNode(e){const t=this.findTreeElement(e);t&&(t.setExpandable(this._hasVisibleChildren(e)),t.updateTitle(this._updateRecordForHighlight(e)),t.populated&&this._updateChildren(t))}populateTreeElement(e){return e.childCount()||!e.isExpandable()?Promise.resolve():new Promise(t=>{e.node().getChildNodes(()=>{e.populated=!0,this._updateModifiedParentNode(e.node()),t()})})}_createElementTreeElement(e,t){const i=new ElementsTreeElement(e,t);return i.setExpandable(!t&&this._hasVisibleChildren(e)),e.nodeType()===Node.ELEMENT_NODE&&e.parentNode&&e.parentNode.nodeType()===Node.DOCUMENT_NODE&&!e.parentNode.parentNode&&i.setCollapsible(!1),i.selectable=this._selectEnabled,i}_showChild(e,t){if(e.isClosingTag())return null;const i=this._visibleChildren(e.node()).indexOf(t);return-1===i?null:(i>=e.expandedChildrenLimit()&&this.setExpandedChildrenLimit(e,i+1),e.childAt(i))}_visibleChildren(e){let t=ElementsTreeElement.visibleShadowRoots(e);const i=e.contentDocument();i&&t.push(i);const n=e.importedDocument();n&&t.push(n);const d=e.templateContent();d&&t.push(d);const o=e.markerPseudoElement();o&&t.push(o);const s=e.beforePseudoElement();if(s&&t.push(s),e.childNodeCount()){let i=e.children()||[];this._showHTMLCommentsSetting.get()||(i=i.filter(e=>e.nodeType()!==Node.COMMENT_NODE)),t=t.concat(i)}const r=e.afterPseudoElement();return r&&t.push(r),t}_hasVisibleChildren(e){return!!e.isIframe()||(!!e.isPortal()||(!!e.contentDocument()||(!!e.importedDocument()||(!!e.templateContent()||(!!ElementsTreeElement.visibleShadowRoots(e).length||(!!e.hasPseudoElements()||(!!e.isInsertionPoint()||!!e.childNodeCount()&&!ElementsTreeElement.canShowInlineText(e))))))))}_createExpandAllButtonTreeElement(e){const t=UI.UIUtils.createTextButton("",function(t){const i=this._visibleChildren(e.node()).length;this.setExpandedChildrenLimit(e,Math.max(i,e.expandedChildrenLimit()+InitialChildrenLimit)),t.consume()}.bind(this));t.value="";const i=new UI.TreeOutline.TreeElement(t);return i.selectable=!1,i.expandAllButton=!0,i.button=t,i}setExpandedChildrenLimit(e,t){e.expandedChildrenLimit()!==t&&(e.setExpandedChildrenLimit(t),e.treeOutline&&!this._treeElementsBeingUpdated.has(e)&&this._updateModifiedParentNode(e.node()))}_updateChildren(e){if(!e.isExpandable()){const t=e.treeOutline.selectedTreeElement;return t&&t.hasAncestor(e)&&e.select(!0),void e.removeChildren()}console.assert(!e.isClosingTag()),this._innerUpdateChildren(e)}insertChildElement(e,t,i,n){const d=this._createElementTreeElement(t,n);return e.insertChild(d,i),d}_moveChild(e,t,i){if(e.indexOfChild(t)===i)return;const n=t.selected;t.parent&&t.parent.removeChild(t),e.insertChild(t,i),n&&t.select()}_innerUpdateChildren(e){if(this._treeElementsBeingUpdated.has(e))return;this._treeElementsBeingUpdated.add(e);const t=e.node(),i=this._visibleChildren(t),n=new Set(i),d=new Map;for(let t=e.childCount()-1;t>=0;--t){const i=e.childAt(t);if(!(i instanceof ElementsTreeElement)){e.removeChildAtIndex(t);continue}const o=i.node();n.has(o)?d.set(o,i):e.removeChildAtIndex(t)}for(let n=0;n<i.length&&n<e.expandedChildrenLimit();++n){const o=i[n],s=d.get(o)||this.findTreeElement(o);if(s&&s!==e)this._moveChild(e,s,n);else{const i=this.insertChildElement(e,o,n);this._updateRecordForHighlight(t)&&e.expanded&&ElementsTreeElement.animateOnDOMUpdate(i),e.childCount()>e.expandedChildrenLimit()&&this.setExpandedChildrenLimit(e,e.expandedChildrenLimit()+1)}}const o=e.childCount();if(i.length>o){const t=o;e.expandAllButtonElement||(e.expandAllButtonElement=this._createExpandAllButtonTreeElement(e)),e.insertChild(e.expandAllButtonElement,t),e.expandAllButtonElement.button.textContent=Common.UIString.UIString("Show All Nodes (%d More)",i.length-o)}else e.expandAllButtonElement&&delete e.expandAllButtonElement;if(t.isInsertionPoint())for(const i of t.distributedNodes())e.appendChild(new ShortcutTreeElement(i));t.nodeType()===Node.ELEMENT_NODE&&!t.pseudoType()&&e.isExpandable()&&this.insertChildElement(e,t,e.childCount(),!0),this._treeElementsBeingUpdated.delete(e)}_markersChanged(e){const t=e.data[this._treeElementSymbol];t&&t.updateDecorations()}}ElementsTreeOutline._treeOutlineSymbol=Symbol("treeOutline"),ElementsTreeOutline.Events={SelectedNodeChanged:Symbol("SelectedNodeChanged"),ElementsTreeUpdated:Symbol("ElementsTreeUpdated")};export const MappedCharToEntity={" ":"nbsp","":"#147","­":"shy"," ":"ensp"," ":"emsp"," ":"thinsp"," ":"#8202","​":"#8203","‌":"zwnj","‍":"zwj","‎":"lrm","‏":"rlm","‪":"#8234","‫":"#8235","‬":"#8236","‭":"#8237","‮":"#8238","\ufeff":"#65279"};export class UpdateRecord{attributeModified(e){this._removedAttributes&&this._removedAttributes.has(e)&&this._removedAttributes.delete(e),this._modifiedAttributes||(this._modifiedAttributes=new Set),this._modifiedAttributes.add(e)}attributeRemoved(e){this._modifiedAttributes&&this._modifiedAttributes.has(e)&&this._modifiedAttributes.delete(e),this._removedAttributes||(this._removedAttributes=new Set),this._removedAttributes.add(e)}nodeInserted(e){this._hasChangedChildren=!0}nodeRemoved(e){this._hasChangedChildren=!0,this._hasRemovedChildren=!0}charDataModified(){this._charDataModified=!0}childrenModified(){this._hasChangedChildren=!0}isAttributeModified(e){return this._modifiedAttributes&&this._modifiedAttributes.has(e)}hasRemovedAttributes(){return!!this._removedAttributes&&!!this._removedAttributes.size}isCharDataModified(){return!!this._charDataModified}hasChangedChildren(){return!!this._hasChangedChildren}hasRemovedChildren(){return!!this._hasRemovedChildren}}export class Renderer{async render(e){let t;if(e instanceof SDK.DOMModel.DOMNode?t=e:e instanceof SDK.DOMModel.DeferredDOMNode&&(t=await e.resolvePromise()),!t)return null;const i=new ElementsTreeOutline(!1,!0,!0);return i.rootDOMNode=t,i.firstChild().isExpandable()||i._element.classList.add("single-node"),i.setVisible(!0),i.element.treeElementForTest=i.firstChild(),i.setShowSelectionOnKeyboardFocus(!0,!0),{node:i.element,tree:i}}}export class ShortcutTreeElement extends UI.TreeOutline.TreeElement{constructor(e){super(""),this.listItemElement.createChild("div","selection fill");const t=this.listItemElement.createChild("span","elements-tree-shortcut-title");let i=e.nodeName.toLowerCase();e.nodeType===Node.ELEMENT_NODE&&(i="<"+i+">"),t.textContent="↪ "+i;const n=linkifyDeferredNodeReference(e.deferredNode);this.listItemElement.createTextChild(" "),n.classList.add("elements-tree-shortcut-link"),n.textContent=Common.UIString.UIString("reveal"),this.listItemElement.appendChild(n),this._nodeShortcut=e}get hovered(){return this._hovered}set hovered(e){this._hovered!==e&&(this._hovered=e,this.listItemElement.classList.toggle("hovered",e))}deferredNode(){return this._nodeShortcut.deferredNode}domModel(){return this._nodeShortcut.deferredNode.domModel()}onselect(e){if(!e)return!0;return this._nodeShortcut.deferredNode.highlight(),this._nodeShortcut.deferredNode.resolve(function(e){e&&(this.treeOutline._selectedDOMNode=e,this.treeOutline._selectedNodeChanged())}.bind(this)),!0}}export let MultilineEditorController;export let ClipboardData;