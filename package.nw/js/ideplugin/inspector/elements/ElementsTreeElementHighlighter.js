import*as Common from"../common/common.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";import{ElementsTreeOutline}from"./ElementsTreeOutline.js";export class ElementsTreeElementHighlighter{constructor(e){this._throttler=new Common.Throttler.Throttler(100),this._treeOutline=e,this._treeOutline.addEventListener(UI.TreeOutline.Events.ElementExpanded,this._clearState,this),this._treeOutline.addEventListener(UI.TreeOutline.Events.ElementCollapsed,this._clearState,this),this._treeOutline.addEventListener(ElementsTreeOutline.Events.SelectedNodeChanged,this._clearState,this),SDK.SDKModel.TargetManager.instance().addModelListener(SDK.OverlayModel.OverlayModel,SDK.OverlayModel.Events.HighlightNodeRequested,this._highlightNode,this),SDK.SDKModel.TargetManager.instance().addModelListener(SDK.OverlayModel.OverlayModel,SDK.OverlayModel.Events.InspectModeWillBeToggled,this._clearState,this)}_highlightNode(e){if(!Common.Settings.Settings.instance().moduleSetting("highlightNodeOnHoverInOverlay").get())return;const t=e.data;this._throttler.schedule(function(){return this._highlightNodeInternal(this._pendingHighlightNode),delete this._pendingHighlightNode,Promise.resolve()}.bind(this)),this._pendingHighlightNode=this._treeOutline===ElementsTreeOutline.forDOMModel(t.domModel())?t:null}_highlightNodeInternal(e){this._isModifyingTreeOutline=!0;let t=null;if(this._currentHighlightedElement){let e=this._currentHighlightedElement;for(;e!==this._alreadyExpandedParentElement;)e.expanded&&e.collapse(),e=e.parent}if(delete this._currentHighlightedElement,delete this._alreadyExpandedParentElement,e){let i=e;const l=this._treeOutline.treeElementSymbol();for(;i&&(!i[l]||!i[l].expanded);)i=i.parentNode;this._alreadyExpandedParentElement=i?i[l]:this._treeOutline.rootElement(),t=this._treeOutline.createTreeElementFor(e)}this._currentHighlightedElement=t,this._treeOutline.setHoverEffect(t),t&&t.reveal(!0),this._isModifyingTreeOutline=!1}_clearState(){this._isModifyingTreeOutline||(delete this._currentHighlightedElement,delete this._alreadyExpandedParentElement,delete this._pendingHighlightNode)}}