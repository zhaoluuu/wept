import*as Common from"../common/common.js";import*as Host from"../host/host.js";import*as ObjectUI from"../object_ui/object_ui.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";export class PropertiesWidget extends UI.ThrottledWidget.ThrottledWidget{constructor(){super(!0),this.registerRequiredCSS("elements/propertiesWidget.css"),SDK.SDKModel.TargetManager.instance().addModelListener(SDK.DOMModel.DOMModel,SDK.DOMModel.Events.AttrModified,this._onNodeChange,this),SDK.SDKModel.TargetManager.instance().addModelListener(SDK.DOMModel.DOMModel,SDK.DOMModel.Events.AttrRemoved,this._onNodeChange,this),SDK.SDKModel.TargetManager.instance().addModelListener(SDK.DOMModel.DOMModel,SDK.DOMModel.Events.CharacterDataModified,this._onNodeChange,this),SDK.SDKModel.TargetManager.instance().addModelListener(SDK.DOMModel.DOMModel,SDK.DOMModel.Events.ChildNodeCountUpdated,this._onNodeChange,this),self.UI.context.addFlavorChangeListener(SDK.DOMModel.DOMNode,this._setNode,this),this._node=self.UI.context.flavor(SDK.DOMModel.DOMNode),this._treeOutline=new ObjectUI.ObjectPropertiesSection.ObjectPropertiesSectionsTreeOutline({readOnly:!0}),this._treeOutline.setShowSelectionOnKeyboardFocus(!0,!1),this._expandController=new ObjectUI.ObjectPropertiesSection.ObjectPropertiesSectionsTreeExpandController(this._treeOutline),this.contentElement.appendChild(this._treeOutline.element),this._treeOutline.addEventListener(UI.TreeOutline.Events.ElementExpanded,()=>{Host.userMetrics.actionTaken(Host.UserMetrics.Action.DOMPropertiesExpanded)}),this.update()}_setNode(e){this._node=e.data,this.update()}async doUpdate(){if(this._lastRequestedNode&&(this._lastRequestedNode.domModel().runtimeModel().releaseObjectGroup(_objectGroupName),delete this._lastRequestedNode),!this._node)return void this._treeOutline.removeChildren();this._lastRequestedNode=this._node;const e=await this._node.resolveToObject(_objectGroupName);if(!e)return;const t=await e.callFunction((function(){let e=this;const t={__proto__:null};let o=1;for(;e;)t[o++]=e,e=e.__proto__;return t}));if(e.release(),!t.object||t.wasThrown)return;const o=await t.object.getOwnProperties(!1);if(t.object.release(),!o||!o.properties)return;const n=o.properties;this._treeOutline.removeChildren();let s=!1;for(let e=0;e<n.length;++e){if(!parseInt(n[e].name,10))continue;const t=n[e].value;let o=t.description;o=o.replace(/Prototype$/,"");const r=this._createSectionTreeElement(t,o);this._treeOutline.appendChild(r),s||(r.select(!0,!1),s=!0)}}_createSectionTreeElement(e,t){const o=document.createElement("span");o.classList.add("tree-element-title"),o.textContent=t;const n=new ObjectUI.ObjectPropertiesSection.RootElement(e);return n.title=o,this._expandController.watchSection(t,n),n}_onNodeChange(e){if(!this._node)return;const t=e.data,o=t instanceof SDK.DOMModel.DOMNode?t:t.node;this._node===o&&this.update()}}export const _objectGroupName="properties-sidebar-pane";