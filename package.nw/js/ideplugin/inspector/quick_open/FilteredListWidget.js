import*as Common from"../common/common.js";import*as Diff from"../diff/diff.js";import*as Platform from"../platform/platform.js";import*as TextUtils from"../text_utils/text_utils.js";import*as UI from"../ui/ui.js";export class FilteredListWidget extends UI.Widget.VBox{constructor(t,e,i){super(!0),this._promptHistory=e||[],this.contentElement.classList.add("filtered-list-widget"),this.contentElement.addEventListener("keydown",this._onKeyDown.bind(this),!0),UI.ARIAUtils.markAsCombobox(this.contentElement),this.registerRequiredCSS("quick_open/filteredListWidget.css"),this._promptElement=this.contentElement.createChild("div","filtered-list-widget-input"),UI.ARIAUtils.setAccessibleName(this._promptElement,ls`Quick open prompt`),this._promptElement.setAttribute("spellcheck","false"),this._promptElement.setAttribute("contenteditable","plaintext-only"),this._prompt=new UI.TextPrompt.TextPrompt,this._prompt.initialize(()=>Promise.resolve([]));const s=this._prompt.attach(this._promptElement);s.addEventListener("input",this._onInput.bind(this),!1),s.classList.add("filtered-list-widget-prompt-element"),this._bottomElementsContainer=this.contentElement.createChild("div","vbox"),this._progressElement=this._bottomElementsContainer.createChild("div","filtered-list-widget-progress"),this._progressBarElement=this._progressElement.createChild("div","filtered-list-widget-progress-bar"),this._items=new UI.ListModel.ListModel,this._list=new UI.ListControl.ListControl(this._items,this,UI.ListControl.ListMode.EqualHeightItems),this._itemElementsContainer=this._list.element,this._itemElementsContainer.classList.add("container"),this._bottomElementsContainer.appendChild(this._itemElementsContainer),this._itemElementsContainer.addEventListener("click",this._onClick.bind(this),!1),UI.ARIAUtils.markAsListBox(this._itemElementsContainer),UI.ARIAUtils.setControls(this._promptElement,this._itemElementsContainer),UI.ARIAUtils.setAutocomplete(this._promptElement,UI.ARIAUtils.AutocompleteInteractionModel.list),this._notFoundElement=this._bottomElementsContainer.createChild("div","not-found-text"),this._notFoundElement.classList.add("hidden"),this.setDefaultFocusedElement(this._promptElement),this._prefix="",this._provider=t,this._queryChangedCallback=i}static highlightRanges(t,e,i){if(!e)return!1;function s(t,e){const i=Diff.Diff.DiffWrapper.charDiff(e,t);let s=0;const r=[];for(let t=0;t<i.length;++t){const e=i[t];if(e[0]===Diff.Diff.Operation.Equal)r.push(new TextUtils.TextRange.SourceRange(s,e[1].length));else if(e[0]!==Diff.Diff.Operation.Insert)return null;s+=e[1].length}return r}const r=t.textContent;let o=s(r,e);return o&&!i||(o=s(r.toUpperCase(),e.toUpperCase())),!!o&&(UI.UIUtils.highlightRangesWithStyleClass(t,o,"highlight"),!0)}setPlaceholder(t,e){this._prompt.setPlaceholder(t,e)}setPromptTitle(t){UI.ARIAUtils.setAccessibleName(this._promptElement,t)}showAsDialog(t=ls`Quick open`){this._dialog=new UI.Dialog.Dialog,UI.ARIAUtils.setAccessibleName(this._dialog.contentElement,t),this._dialog.setMaxContentSize(new UI.Geometry.Size(504,340)),this._dialog.setSizeBehavior(UI.GlassPane.SizeBehavior.SetExactWidthMaxHeight),this._dialog.setContentPosition(null,22),this.show(this._dialog.contentElement),UI.ARIAUtils.setExpanded(this.contentElement,!0),this._dialog.once("hidden").then(()=>{this.dispatchEventToListeners("hidden")}),this._dialog.show()}setPrefix(t){this._prefix=t}setProvider(t){t!==this._provider&&(this._provider&&this._provider.detach(),this._clearTimers(),this._provider=t,this.isShowing()&&this._attachProvider())}setQuerySelectedRange(t,e){this._prompt.setSelectedRange(t,e)}_attachProvider(){this._items.replaceAll([]),this._list.invalidateItemHeight(),this._provider&&(this._provider.setRefreshCallback(this._itemsLoaded.bind(this,this._provider)),this._provider.attach()),this._itemsLoaded(this._provider)}_value(){return this._prompt.text().trim()}_cleanValue(){return this._value().substring(this._prefix.length)}wasShown(){this._attachProvider()}willHide(){this._provider&&this._provider.detach(),this._clearTimers(),UI.ARIAUtils.setExpanded(this.contentElement,!1)}_clearTimers(){clearTimeout(this._filterTimer),clearTimeout(this._scoringTimer),clearTimeout(this._loadTimeout),delete this._filterTimer,delete this._scoringTimer,delete this._loadTimeout,delete this._refreshListWithCurrentResult}_onEnter(t){if(!this._provider)return;const e=this._provider.itemCount()?this._list.selectedItem():null;this._selectItem(e),this._dialog&&this._dialog.hide()}_itemsLoaded(t){this._loadTimeout||t!==this._provider||(this._loadTimeout=setTimeout(this._updateAfterItemsLoaded.bind(this),0))}_updateAfterItemsLoaded(){delete this._loadTimeout,this._filterItems()}createElementForItem(t){const e=createElement("div");e.className="filtered-list-widget-item "+(this._provider.renderAsTwoRows()?"two-rows":"one-row");const i=e.createChild("div","filtered-list-widget-title"),s=e.createChild("div","filtered-list-widget-subtitle");return s.textContent="â€‹",this._provider.renderItem(t,this._cleanValue(),i,s),UI.ARIAUtils.markAsOption(e),e}heightForItem(t){return 0}isItemSelectable(t){return!0}selectedItemChanged(t,e,i,s){i&&i.classList.remove("selected"),s&&s.classList.add("selected"),UI.ARIAUtils.setActiveDescendant(this._promptElement,s)}_onClick(t){const e=this._list.itemForNode(t.target);null!==e&&(t.consume(!0),this._selectItem(e),this._dialog&&this._dialog.hide())}setQuery(t){this._prompt.focus(),this._prompt.setText(t),this._queryChanged(),this._prompt.autoCompleteSoon(!0),this._scheduleFilter()}_tabKeyPressed(){const t=this._prompt.text();let e;for(let i=this._promptHistory.length-1;i>=0;i--)if(this._promptHistory[i]!==t&&this._promptHistory[i].startsWith(t)){e=this._promptHistory[i];break}return!!e&&(this._prompt.focus(),this._prompt.setText(e),this._prompt.setDOMSelection(t.length,e.length),this._scheduleFilter(),!0)}_itemsFilteredForTest(){}_filterItems(){if(delete this._filterTimer,this._scoringTimer&&(clearTimeout(this._scoringTimer),delete this._scoringTimer,this._refreshListWithCurrentResult&&this._refreshListWithCurrentResult()),!this._provider)return this._bottomElementsContainer.classList.toggle("hidden",!0),void this._itemsFilteredForTest();this._bottomElementsContainer.classList.toggle("hidden",!1),this._progressBarElement.style.transform="scaleX(0)",this._progressBarElement.classList.remove("filtered-widget-progress-fade"),this._progressBarElement.classList.remove("hidden");const t=this._provider.rewriteQuery(this._cleanValue());this._query=t;const e=t?String.filterRegex(t):null,i=[],s=[],r=[];let o=0;const l=[],n=window.performance.now(),h=Platform.NumberUtilities.clamp(10,500,this._provider.itemCount()/10|0);function a(t,e){return e-t}(function d(m){delete this._scoringTimer;let _,c=0;for(_=m;_<this._provider.itemCount()&&c<h;++_){if(e&&!e.test(this._provider.itemKeyAt(_)))continue;const n=this._provider.itemScoreAt(_,t);if(t&&c++,n>o||s.length<100){const t=s.upperBound(n,a);s.splice(t,0,n),r.splice(t,0,_),s.length>100&&(l.push(r.peekLast()),s.length=100,r.length=100),o=s.peekLast()}else i.push(_)}if(this._refreshListWithCurrentResult=this._refreshList.bind(this,r,l,i),_<this._provider.itemCount())return this._scoringTimer=setTimeout(d.bind(this,_),0),void(window.performance.now()-n>50&&(this._progressBarElement.style.transform="scaleX("+_/this._provider.itemCount()+")"));window.performance.now()-n>100?(this._progressBarElement.style.transform="scaleX(1)",this._progressBarElement.classList.add("filtered-widget-progress-fade")):this._progressBarElement.classList.add("hidden");this._refreshListWithCurrentResult()}).call(this,0)}_refreshList(t,e,i){delete this._refreshListWithCurrentResult,i=[].concat(t,e,i),this._updateNotFoundMessage(!!i.length);const s=this._list.element.offsetHeight;this._items.replaceAll(i),i.length&&this._list.selectItem(i[0]),this._list.element.offsetHeight!==s&&this._list.viewportResized(),this._itemsFilteredForTest()}_updateNotFoundMessage(t){this._list.element.classList.toggle("hidden",!t),this._notFoundElement.classList.toggle("hidden",t),t||(this._notFoundElement.textContent=this._provider.notFoundText(this._cleanValue()),UI.ARIAUtils.alert(this._notFoundElement.textContent,this._notFoundElement))}_onInput(){this._queryChanged(),this._scheduleFilter()}_queryChanged(){this._queryChangedCallback&&this._queryChangedCallback(this._value()),this._provider&&this._provider.queryChanged(this._cleanValue())}updateSelectedItemARIA(t,e){return!1}_onKeyDown(t){let e=!1;switch(t.key){case"Enter":return void this._onEnter(t);case"Tab":e=this._tabKeyPressed();break;case"ArrowUp":e=this._list.selectPreviousItem(!0,!1);break;case"ArrowDown":e=this._list.selectNextItem(!0,!1);break;case"PageUp":e=this._list.selectItemPreviousPage(!1);break;case"PageDown":e=this._list.selectItemNextPage(!1)}e&&t.consume(!0)}_scheduleFilter(){this._filterTimer||(this._filterTimer=setTimeout(this._filterItems.bind(this),0))}_selectItem(t){this._promptHistory.push(this._value()),this._promptHistory.length>100&&this._promptHistory.shift(),this._provider.selectItem(t,this._cleanValue())}}export class Provider{setRefreshCallback(t){this._refreshCallback=t}attach(){}itemCount(){return 0}itemKeyAt(t){return""}itemScoreAt(t,e){return 1}renderItem(t,e,i,s){}renderAsTwoRows(){return!1}selectItem(t,e){}refresh(){this._refreshCallback()}rewriteQuery(t){return t}queryChanged(t){}notFoundText(t){return Common.UIString.UIString("No results found")}detach(){}}