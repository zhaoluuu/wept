import*as Common from"../common/common.js";import*as ObjectUI from"../object_ui/object_ui.js";import*as SDK from"../sdk/sdk.js";import*as TextUtils from"../text_utils/text_utils.js";import*as UI from"../ui/ui.js";const _PinSymbol=Symbol("pinSymbol");export class ConsolePinPane extends UI.ThrottledWidget.ThrottledWidget{constructor(e){super(!0,250),this._liveExpressionButton=e,this.registerRequiredCSS("console/consolePinPane.css"),this.registerRequiredCSS("object_ui/objectValue.css"),this.contentElement.classList.add("console-pins","monospace"),this.contentElement.addEventListener("contextmenu",this._contextMenuEventFired.bind(this),!1),this._pins=new Set,this._pinsSetting=Common.Settings.Settings.instance().createLocalSetting("consolePins",[]);for(const e of this._pinsSetting.get())this.addPin(e)}willHide(){for(const e of this._pins)e.setHovered(!1)}_savePins(){const e=Array.from(this._pins).map(e=>e.expression());this._pinsSetting.set(e)}_contextMenuEventFired(e){const t=new UI.ContextMenu.ContextMenu(e),i=e.deepElementFromPoint();if(i){const e=i.enclosingNodeOrSelfWithClass("console-pin");if(e){const i=e[_PinSymbol];t.editSection().appendItem(ls`Edit expression`,i.focus.bind(i)),t.editSection().appendItem(ls`Remove expression`,this._removePin.bind(this,i)),i.appendToContextMenu(t)}}t.editSection().appendItem(ls`Remove all expressions`,this._removeAllPins.bind(this)),t.show()}_removeAllPins(){for(const e of this._pins)this._removePin(e)}_removePin(e){e.element().remove(),this._pins.delete(e),this._savePins(),this._liveExpressionButton.element.focus()}addPin(e,t){const i=new ConsolePin(e,this);this.contentElement.appendChild(i.element()),this._pins.add(i),this._savePins(),t&&i.focus(),this.update()}doUpdate(){if(!this._pins.size||!this.isShowing())return Promise.resolve();this.isShowing()&&this.update();const e=Array.from(this._pins,e=>e.updatePreview());return Promise.all(e).then(this._updatedForTest.bind(this))}_updatedForTest(){}}export class ConsolePin extends Common.ObjectWrapper.ObjectWrapper{constructor(e,t){super();const i=UI.Icon.Icon.create("smallicon-cross","console-delete-pin");self.onInvokeElement(i,e=>{t._removePin(this),e.consume(!0)}),i.tabIndex=0,UI.ARIAUtils.setAccessibleName(i,ls`Remove expression`),UI.ARIAUtils.markAsButton(i);const s=UI.Fragment.Fragment.build`
    <div class='console-pin'>
      ${i}
      <div class='console-pin-name' $='name'></div>
      <div class='console-pin-preview' $='preview'>${ls`not available`}</div>
    </div>`;this._pinElement=s.element(),this._pinPreview=s.$("preview");const o=s.$("name");o.title=e,this._pinElement[_PinSymbol]=this,this._lastResult=null,this._lastExecutionContext=null,this._editor=null,this._committedExpression=e,this._hovered=!1,this._lastNode=null,this._pinPreview.addEventListener("mouseenter",this.setHovered.bind(this,!0),!1),this._pinPreview.addEventListener("mouseleave",this.setHovered.bind(this,!1),!1),this._pinPreview.addEventListener("click",e=>{this._lastNode&&(Common.Revealer.reveal(this._lastNode),e.consume())},!1),this._editorPromise=self.runtime.extension(UI.TextEditor.TextEditorFactory).instance().then(i=>{this._editor=i.createEditor({devtoolsAccessibleName:ls`Live expression editor`,lineNumbers:!1,lineWrapping:!0,mimeType:"javascript",autoHeight:!0,placeholder:ls`Expression`}),this._editor.configureAutocomplete(ObjectUI.JavaScriptAutocomplete.JavaScriptAutocompleteConfig.createConfigForEditor(this._editor)),this._editor.widget().show(o),this._editor.widget().element.classList.add("console-pin-editor"),this._editor.widget().element.tabIndex=-1,this._editor.setText(e),this._editor.widget().element.addEventListener("keydown",e=>{"Tab"!==e.key||this._editor.text()?e.keyCode===UI.KeyboardShortcut.Keys.Esc.code&&this._editor.setText(this._committedExpression):e.consume()},!0),this._editor.widget().element.addEventListener("focusout",e=>{const i=this._editor.text(),s=i.trim();i.length!==s.length&&this._editor.setText(s),this._committedExpression=s,t._savePins(),this._editor.setSelection(TextUtils.TextRange.TextRange.createFromLocation(1/0,1/0))})})}setHovered(e){this._hovered!==e&&(this._hovered=e,!e&&this._lastNode&&SDK.OverlayModel.OverlayModel.hideDOMNodeHighlight())}expression(){return this._committedExpression}element(){return this._pinElement}async focus(){await this._editorPromise,this._editor.widget().focus(),this._editor.setSelection(TextUtils.TextRange.TextRange.createFromLocation(1/0,1/0))}appendToContextMenu(e){this._lastResult&&this._lastResult.object&&(e.appendApplicableItems(this._lastResult.object),this._lastResult=null)}async updatePreview(){if(!this._editor)return;const e=this._editor.textWithCurrentSuggestion().trim(),t=this._pinElement.hasFocus(),i=t&&e!==this._committedExpression,s=i?250:void 0,o=UI.Context.Context.instance().flavor(SDK.RuntimeModel.ExecutionContext),{preview:n,result:l}=await ObjectUI.JavaScriptREPL.JavaScriptREPL.evaluateAndBuildPreview(e,i,s,!t,"console");this._lastResult&&this._lastExecutionContext&&this._lastExecutionContext.runtimeModel.releaseEvaluationResult(this._lastResult),this._lastResult=l||null,this._lastExecutionContext=o||null;const r=n.deepTextContent();if(!r||r!==this._pinPreview.deepTextContent()){if(this._pinPreview.removeChildren(),l&&SDK.RuntimeModel.RuntimeModel.isSideEffectFailure(l)){const e=this._pinPreview.createChild("span","object-value-calculate-value-button");e.textContent="(â€¦)",e.title=ls`Evaluate, allowing side effects`}else r?this._pinPreview.appendChild(n):t||this._pinPreview.createTextChild(ls`not available`);this._pinPreview.title=r}let d=null;l&&l.object&&"object"===l.object.type&&"node"===l.object.subtype&&(d=l.object),this._hovered&&(d?SDK.OverlayModel.OverlayModel.highlightObjectAsDOMNode(d):this._lastNode&&SDK.OverlayModel.OverlayModel.hideDOMNodeHighlight()),this._lastNode=d||null;const a=l&&l.exceptionDetails&&!SDK.RuntimeModel.RuntimeModel.isSideEffectFailure(l);this._pinElement.classList.toggle("error-level",!!a)}}