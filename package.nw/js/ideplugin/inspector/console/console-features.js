import{ConsoleView}from"./ConsoleView.js";import{ConsoleFilter}from"./ConsoleFilter.js";import{ConsoleViewMessage}from"./ConsoleViewMessage.js";import{ConsoleContextSelector}from"./ConsoleContextSelector.js";import*as UI from"../ui/ui.js";import*as SDK from"../sdk/sdk.js";import{isRemoteDebugGame,isRemoteAppserviceMode}from"../wx_main/util.js";import*as Common from"../common/common.js";if(wxMain.isFeatureEnabled("setMaxLogLen")){const e=wxMain.getMessenger();let t=999999;e.registerCallback(e=>{"SET_MAX_CONSOLE_LOG_LENGTH"===e.command&&(t=e.data)}),e.send({command:"GET_MAX_CONSOLE_LOG_LENGTH"});const s=ConsoleView.prototype._addConsoleMessage;ConsoleView.prototype._addConsoleMessage=function(){const e=this._consoleMessages,o=e.length;o>t&&(this._consoleMessages=e.slice(o-t,o),this._updateMessageList()),s.apply(this,arguments)}}if(wxMain.isFeatureEnabled("consoleLink")){const e=ConsoleViewMessage.prototype._formatParameterAsValue;ConsoleViewMessage.prototype._formatParameterAsValue=function(t){if("symbol"===t.type){const e=wxMain.getFeatureOptions("consoleLink").links,s=t._description.match(/Symbol\(@linkable:(.*)\)/);if(s){const t=s[1],[o,n]=t.split("#");if(o&&e[o]){const t=e[o],s=document.createElement("a");return s.innerText=n,s.href=t,s.target="_blank",s.style.color="hsl(220deg 100% 65%)",s}}}return e.apply(this,[t])}}if(wxMain.isFeatureEnabled("disabledRemoteDebugContextSelector")&&"RemoteDebug"===wxMain.type&&!isRemoteDebugGame()&&isRemoteAppserviceMode()){const e=ConsoleContextSelector.prototype.isItemSelectable;ConsoleContextSelector.prototype.isItemSelectable=function(t){if(wxMain.getGlobal("appserviceDebug"))return e.apply(this,[t]);const s=t.debuggerModel.selectedCallFrame(),o=s&&s.script.executionContext();return o?t===o:"---"!==t.label()}}if(wxMain.isFeatureEnabled("disableContextSelector")){const e=ConsoleContextSelector.prototype.isItemSelectable;ConsoleContextSelector.prototype.isItemSelectable=function(t){if(wxMain.getGlobal("appserviceDebug"))return e.apply(this,[t]);const s=t.debuggerModel.selectedCallFrame(),o=s&&s.script.executionContext();return o?t===o:"---"!==t.label()},ConsoleContextSelector.prototype.itemSelected=function(e){const t="AppService"===wxMain.type;this._toolbarItem.element.classList.toggle("warning",!t&&!this._isTopContext(e)&&this._hasTopContext());const s=e?ls`JavaScript context: ${this.titleFor(e)}`:ls`JavaScript context: Not selected`;this._toolbarItem.setTitle(s),UI.Context.Context.instance().setFlavor(SDK.RuntimeModel.ExecutionContext,e)}}if(wxMain.isFeatureEnabled("hideSourceMapWarning")){const e="DevTools failed to load SourceMap",t=ConsoleFilter.prototype.shouldBeVisible;ConsoleFilter.prototype.shouldBeVisible=function(s){return!(s._message&&s._message.messageText&&s._message.messageText.startsWith(e))&&t.apply(this,[s])}}if(wxMain.isFeatureEnabled("errorOccursDisplayIDEInfo")){let e="";wxMain.getMessenger().send({command:"GET_IDE_INFO"});const t=ConsoleViewMessage.prototype._buildMessage;ConsoleViewMessage.prototype._buildMessage=function(){const s=t.apply(this,arguments),o=SDK.ConsoleModel&&SDK.ConsoleModel.MessageLevel;if(this._message&&e&&o&&this._message.level===o.Error){const t=document.createElementWithClass("div","console-message-text");t.innerHTML=e,s.appendChild(t)}return s},wxMain.getMessenger().registerCallback(async t=>{const{command:s,data:o}=t;"SET_IDE_INFO_TO_CONSOLE"===s&&(e=o)})}if(wxMain.isFeatureEnabled("handleConsoleStackTrace")){const e=wxMain.getFeatureOptions("handleConsoleStackTrace").regexList||[],t=t=>{if(!t)return!1;for(const s of e)if(s.test(t))return!0;return!1},s=e=>{const o=(e.callFrames||[]).filter(e=>!t(e.url)),n=e.parent;if(!n)return{...e,callFrames:o};const a=s(n);return a.callFrames&&a.callFrames.length>0?{...e,callFrames:o,parent:a}:{...e,callFrames:o,parent:void 0}},o=ConsoleViewMessage.prototype._buildMessageWithStackTrace;ConsoleViewMessage.prototype._buildMessageWithStackTrace=function(){const e=Common.Settings.Settings.instance().moduleSetting("hideIDEStackTrace").get();return!e||(this._message.stackTrace=s(this._message.stackTrace),this._message.stackTrace&&this._message.stackTrace.callFrames&&0!==this._message.stackTrace.callFrames.length)?o.apply(this,arguments):this._message.type===SDK.ConsoleModel.MessageType.Table?this._buildTableMessage():this._buildMessage()};const n=ConsoleViewMessage.prototype._buildMessageAnchor;ConsoleViewMessage.prototype._buildMessageAnchor=function(){const e=Common.Settings.Settings.instance().moduleSetting("hideIDEStackTrace").get();return e&&(t(this._message.scriptId)||t(this._message.url))?null:n.apply(this,arguments)}}