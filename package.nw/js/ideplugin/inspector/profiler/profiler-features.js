import{ProfileLauncherView}from"./ProfileLauncherView.js";import{JSProfilerPanel}from"./ProfilesPanel.js";import{HeapProfilerPanel}from"./HeapProfilerPanel.js";import{CPUProfileHeader,CPUProfileType}from"./CPUProfileView.js";import{HeapProfileHeader,HeapSnapshotProfileType}from"./HeapSnapshotView.js";import{instance as ProfileTypeRegistryInstance}from"./ProfileTypeRegistry.js";import{ProfileEvents}from"./ProfileHeader.js";import*as UI from"../ui/ui.js";import*as Common from"../common/common.js";import*as SDK from"../sdk/sdk.js";import*as Host from"../host/host.js";let wasProfilerShown=!1;if(wxMain.isFeatureEnabled("customProfiler")||wxMain.isFeatureEnabled("customGameProfiler")){JSProfilerPanel.instance=function(){return self.runtime.sharedInstance(JSProfilerPanel)},HeapProfilerPanel.instance=function(){return self.runtime.sharedInstance(HeapProfilerPanel)};const e=ProfileLauncherView.prototype._loadButtonClicked;ProfileLauncherView.prototype._loadButtonClicked=function(){this._isInstantProfile?e.call(this):wxMain.getMessenger().send({command:"JAVASCRIPT_PROFILER_CLICK_LOAD"})};const o=JSProfilerPanel.prototype.wasShown,r=HeapProfilerPanel.prototype.wasShown;JSProfilerPanel.prototype.wasShown=function(){return wasProfilerShown=!0,o.call(this)},HeapProfilerPanel.prototype.wasShown=function(){return wasProfilerShown=!0,r.call(this)},wxMain.getMessenger().registerCallback(async e=>{if(!wasProfilerShown)return;const{command:o,data:r}=e;if("PROFILER_SET_FILE_TO_LOAD"===o){const e=new File([r.file],r.name);if(r.isSafariProfile){JSProfilerPanel.instance()._createFileSelectorElement();const o=JSProfilerPanel.instance()._findProfileTypeByExtension(e.name.replace(/\.json$/,".cpuprofile"));if(!o)return void Common.Console.Console.instance().error(Common.UIString.UIString("Can't load file."));if(o.profileBeingRecorded())return void Common.Console.Console.instance().error(Common.UIString.UIString("Can't load profile while another profile is being recorded."));const r=o.fileExtension.bind(o);o.fileExtension=()=>".json";const i=await o.loadFromFile(e);o.fileExtension=r,i&&UI.UIUtils.MessageDialog.show(Common.UIString.UIString("Profile loading failed: %s.",i.message))}else JSProfilerPanel.instance()._loadFromFile(e);wxMain.getMessenger().send({command:"CLOSE_PROFILER_WINDOW"})}})}if(wxMain.isFeatureEnabled("customGameProfiler")){function printError(e){Common.Console.Console.instance().error(e)}const e=JSProfilerPanel.prototype.handleAction;JSProfilerPanel.prototype.handleAction=function(o,r){if(this._launcherView._isProfiling){if("simulator"===this._recordSource)return e.call(this,o,r);wxMain.getMessenger().send({command:"JAVASCRIPT_PROFILER_CLICK_STOP",data:this._recordSource})}else wxMain.getMessenger().send({command:"JAVASCRIPT_PROFILER_CLICK_START",data:"cpu"})},HeapProfilerPanel.prototype.handleAction=function(e,o){wxMain.getMessenger().send({command:"MEMORY_CLICK_TAKE_SNAPSHOT",data:"memory"})},ProfileLauncherView.prototype._controlButtonClicked=function(){const e=this._isProfiling;if(this._isInstantProfile){if(e)return;wxMain.getMessenger().send({command:"MEMORY_CLICK_TAKE_SNAPSHOT",data:"memory"})}else!0!==e?wxMain.getMessenger().send({command:"JAVASCRIPT_PROFILER_CLICK_START",data:"cpu"}):"simulator"===this._recordSource?this._panel.toggleRecord():wxMain.getMessenger().send({command:"JAVASCRIPT_PROFILER_CLICK_STOP",data:this._recordSource})},wxMain.getMessenger().registerCallback(async e=>{const{command:o,data:r}=e;if(!wasProfilerShown)return;const i=JSProfilerPanel.instance()._launcherView,t=HeapProfilerPanel.instance()._launcherView;let n,s;if(t._isShowing||"memory"===r.type?(s="memory",n=t):(i._isShowing||"cpu"===r.type)&&(s="cpu",n=i),"PROFILER_START_RECORD"===o){if(JSProfilerPanel.instance()._recordSource=r.source||"cpu",n._recordSource=r.source||"cpu",s!==r.type)return;if("memory"===s&&(n._panel._selectedProfileType.isClient=!1),"simulator"===r.source)n._panel.toggleRecord();else{n.profileStarted();const e=n._panel;e._selectedProfileType._startRecordingGameProfile(),e._updateToggleRecordAction(!0)}}else if("PROFILE_STOP_RECORD"===o){const e=n._panel,o=e._selectedProfileType;if(s!==r.type)return;if(r&&r.result)try{"memory"===s?o._stopRecordingGameProfile(r.result):o._stopRecordingGameProfile(JSON.parse(r.result))}catch(e){console.error(e);const r=o._profileBeingRecorded;o.removeProfile(r)}else{const e=o._profileBeingRecorded;o.removeProfile(e),printError(Common.UIString.UIString(`Mobile don't support ${s} recording function, please use WeChat Developer Edition and update wxapplib`))}e._updateToggleRecordAction(!1),n.profileFinished()}else if("LAN_DEBUG_TAKE_SNAPSHOT"===o)wxMain.getMessenger().send({command:"LAN_DEBUG_START_TAKE_SNAPSHOT",data:r.source});else if("HEAP_SNAPSHOT_UPDATE_STATUS"===o){const e=n._panel._selectedProfileType.profileHeader;e&&(r.isError?(printError(r.status),e.updateStatus("Build Failed!",!0)):e.updateStatus(r.status,!0))}}),CPUProfileType.prototype._startRecordingGameProfile=function(){const e=UI.Context.Context.instance().flavor(SDK.CPUProfilerModel.CPUProfilerModel);if(this.profileBeingRecorded()||!e)return;const o=new CPUProfileHeader(e,this);this.setProfileBeingRecorded(o),SDK.SDKModel.TargetManager.instance().suspendAllTargets(),this.addProfile(o),o.updateStatus(Common.UIString.UIString("Recording…")),this._recording=!0,Host.userMetrics.actionTaken(Host.UserMetrics.Action.ProfilesCPUProfileTaken)},CPUProfileType.prototype._stopRecordingGameProfile=async function(e){if(this._recording=!1,!this.profileBeingRecorded()||!this.profileBeingRecorded()._cpuProfilerModel)return;const o=this.profileBeingRecorded();o&&(console.assert(e),o.setProtocolProfile(e),o.updateStatus(""),this.setProfileBeingRecorded(null)),await SDK.SDKModel.TargetManager.instance().resumeAllTargets(),this.dispatchEventToListeners(ProfileEvents.ProfileComplete,o)},HeapSnapshotProfileType.prototype._startRecordingGameProfile=async function(){if(this.isClient=!0,this.profileBeingRecorded())return;const e=UI.Context.Context.instance().flavor(SDK.HeapProfilerModel.HeapProfilerModel);if(!e)return;this.profileHeader=null;const o=new HeapProfileHeader(e,this);this.profileHeader=o,o.ignoreUpdateStatus=!0,this.setProfileBeingRecorded(o),this.addProfile(o),o.updateStatus(Common.UIString.UIString("Snapshotting…")),this.takeHeapSnapshotPromise=await e.takeHeapSnapshot(!0)},HeapSnapshotProfileType.prototype._reportHeapSnapshotProgress=function(e){const o=this.profileBeingRecorded();if(!o)return;const r=e.data;!o.ignoreUpdateStatus&&o.updateStatus(Common.UIString.UIString("%.0f%%",r.done/r.total*100),!0),r.finished&&o._prepareToLoad()},HeapSnapshotProfileType.prototype._stopRecordingGameProfile=async function(e){await this.takeHeapSnapshotPromise;const o=this.profileBeingRecorded();o.transferChunk(e),o.title=Common.UIString.UIString("Snapshot %d",o.uid),o._finishLoad(),this.setProfileBeingRecorded(null),this.dispatchEventToListeners(ProfileEvents.ProfileComplete,o),o.ignoreUpdateStatus=!1,this.isClient=!1,this.profileHeader=null},HeapSnapshotProfileType.prototype._addHeapSnapshotChunk=function(e){if(!this.profileBeingRecorded())return;if(this.isClient)return;const o=e.data;this.profileBeingRecorded().transferChunk(o)},HeapProfileHeader.prototype._prepareToLoad=function(){console.assert(!this._receiver,"Already loading"),this._setupWorker(),!this.ignoreUpdateStatus&&this.updateStatus(Common.UIString.UIString("Loading…"),!0)},ProfileTypeRegistryInstance.heapSnapshotProfileType=new HeapSnapshotProfileType}