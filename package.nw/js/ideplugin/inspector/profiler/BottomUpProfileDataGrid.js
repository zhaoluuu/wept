import*as Platform from"../platform/platform.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";import{Formatter,ProfileDataGridNode,ProfileDataGridTree}from"./ProfileDataGrid.js";import{TopDownProfileDataGridTree}from"./TopDownProfileDataGrid.js";export class BottomUpProfileDataGridNode extends ProfileDataGridNode{constructor(e,t){super(e,t,!!e.parent&&!!e.parent.parent),this._remainingNodeInfos=[]}static _sharedPopulate(e){const t=e._remainingNodeInfos,r=t.length;for(let o=0;o<r;++o){const r=t[o],i=r.ancestor,s=r.focusNode;let a=e.findChild(i);if(a){const e=r.totalAccountedFor;a.self+=s.self,e||(a.total+=s.total)}else a=new BottomUpProfileDataGridNode(i,e.tree),i!==s&&(a.self=s.self,a.total=s.total),e.appendChild(a);const l=i.parent;l&&l.parent&&(r.ancestor=l,a._remainingNodeInfos.push(r))}delete e._remainingNodeInfos}_takePropertiesFromProfileDataGridNode(e){this.save(),this.self=e.self,this.total=e.total}_keepOnlyChild(e){this.save(),this.removeChildren(),this.appendChild(e)}_exclude(e){this._remainingNodeInfos&&this.populate(),this.save();const t=this.children;let r=this.children.length;for(;r--;)t[r]._exclude(e);const o=this.childrenByCallUID.get(e);o&&this.merge(o,!0)}restore(){super.restore(),this.children.length||this.setHasChildren(this._willHaveChildren(this.profileNode))}merge(e,t){this.self-=e.self,super.merge(e,t)}populateChildren(){BottomUpProfileDataGridNode._sharedPopulate(this)}_willHaveChildren(e){return!(!e.parent||!e.parent.parent)}}export class BottomUpProfileDataGridTree extends ProfileDataGridTree{constructor(e,t,r,o){super(e,t,o),this.deepSearch=!1;let i=0;const s=[[],[r]],a=new Map;this._remainingNodeInfos=[];for(let e=0;e<s.length;++e){const t=s[e],r=s[++e],o=r.length;for(let e=0;e<o;++e){const o=r[e];if(o.UID||(o.UID=++i),o.parent){let e=a.get(o.callUID),r=!1;if(e){const o=t.length;for(let i=0;i<o;++i)if(e.has(t[i].UID)){r=!0;break}}else e=new Set,a.set(o.callUID,e);e.add(o.UID),this._remainingNodeInfos.push({ancestor:o,focusNode:o,totalAccountedFor:r})}const l=o.children;l.length&&(s.push(t.concat([o])),s.push(l))}}return ProfileDataGridNode.populate(this),this}focus(e){if(!e)return;this.save();let t=e,r=e;for(;t.parent&&t instanceof ProfileDataGridNode;)t._takePropertiesFromProfileDataGridNode(e),r=t,t=t.parent,t instanceof ProfileDataGridNode&&t._keepOnlyChild(r);this.children=[r],this.total=e.total}exclude(e){if(!e)return;this.save();const t=e.callUID,r=this.childrenByCallUID.get(t);r&&Platform.ArrayUtilities.removeElement(this.children,r);const o=this.children,i=o.length;for(let e=0;e<i;++e)o[e]._exclude(t);this.lastComparator&&this.sort(this.lastComparator,!0)}populateChildren(){BottomUpProfileDataGridNode._sharedPopulate(this)}}