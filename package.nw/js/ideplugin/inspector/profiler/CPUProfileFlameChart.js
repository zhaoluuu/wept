import*as Common from"../common/common.js";import*as Host from"../host/host.js";import*as PerfUI from"../perf_ui/perf_ui.js";import*as UI from"../ui/ui.js";export class ProfileFlameChartDataProvider{constructor(){this._colorGenerator=ProfileFlameChartDataProvider.colorGenerator()}static colorGenerator(){if(!ProfileFlameChartDataProvider._colorGenerator){const e=new Common.Color.Generator({min:30,max:330},{min:50,max:80,count:5},{min:80,max:90,count:3});e.setColorForID("(idle)","hsl(0, 0%, 94%)"),e.setColorForID("(program)","hsl(0, 0%, 80%)"),e.setColorForID("(garbage collector)","hsl(0, 0%, 80%)"),ProfileFlameChartDataProvider._colorGenerator=e}return ProfileFlameChartDataProvider._colorGenerator}minimumBoundary(){return this._cpuProfile.profileStartTime}totalTime(){return this._cpuProfile.profileHead.total}formatValue(e,t){return Number.preciseMillisToString(e,t)}maxStackDepth(){return this._maxStackDepth}timelineData(){return this._timelineData||this._calculateTimelineData()}_calculateTimelineData(){throw"Not implemented."}prepareHighlightedEntryInfo(e){throw"Not implemented."}canJumpToEntry(e){return"0"!==this._entryNodes[e].scriptId}entryTitle(e){const t=this._entryNodes[e];return UI.UIUtils.beautifyFunctionName(t.functionName)}entryFont(e){this._font||(this._font="11px "+Host.Platform.fontFamily(),this._boldFont="bold "+this._font);return this._entryNodes[e].deoptReason?this._boldFont:this._font}entryColor(e){const t=this._entryNodes[e];return this._colorGenerator.colorForID(t.url||("0"!==t.scriptId?t.scriptId:t.functionName))}decorateEntry(e,t,i,r,a,s,n){return!1}forceDecoration(e){return!1}textColor(e){return"#333"}navStartTimes(){return new Map}}export class CPUProfileFlameChart extends UI.Widget.VBox{constructor(e,t){super(),this.element.id="cpu-flame-chart",this._searchableView=e,this._overviewPane=new OverviewPane(t),this._overviewPane.show(this.element),this._mainPane=new PerfUI.FlameChart.FlameChart(t,this._overviewPane),this._mainPane.setBarHeight(15),this._mainPane.setTextBaseline(4),this._mainPane.setTextPadding(2),this._mainPane.show(this.element),this._mainPane.addEventListener(PerfUI.FlameChart.Events.EntrySelected,this._onEntrySelected,this),this._mainPane.addEventListener(PerfUI.FlameChart.Events.EntryInvoked,this._onEntryInvoked,this),this._entrySelected=!1,this._mainPane.addEventListener(PerfUI.FlameChart.Events.CanvasFocused,this._onEntrySelected,this),this._overviewPane.addEventListener(PerfUI.OverviewGrid.Events.WindowChanged,this._onWindowChanged,this),this._dataProvider=t,this._searchResults=[]}focus(){this._mainPane.focus()}_onWindowChanged(e){const t=e.data.windowTimeLeft,i=e.data.windowTimeRight;this._mainPane.setWindowTimes(t,i,!0)}selectRange(e,t){this._overviewPane._selectRange(e,t)}_onEntrySelected(e){if(e.data){const t=Number(e.data);this._mainPane.setSelectedEntry(t),this._entrySelected=-1!==t}else this._entrySelected||(this._mainPane.setSelectedEntry(0),this._entrySelected=!0)}_onEntryInvoked(e){this._onEntrySelected(e),this.dispatchEventToListeners(PerfUI.FlameChart.Events.EntryInvoked,e.data)}update(){this._overviewPane.update(),this._mainPane.update()}performSearch(e,t,i){const r=createPlainTextSearchRegex(e.query,e.caseSensitive?"":"i"),a=-1!==this._searchResultIndex?this._searchResults[this._searchResultIndex]:-1;this._searchResults=[];const s=this._dataProvider._entryNodes.length;for(let e=0;e<s;++e)this._dataProvider.entryTitle(e).match(r)&&this._searchResults.push(e);this._searchResults.length?(this._searchResultIndex=this._searchResults.indexOf(a),-1===this._searchResultIndex&&(this._searchResultIndex=i?this._searchResults.length-1:0),this._mainPane.setSelectedEntry(this._searchResults[this._searchResultIndex])):this.searchCanceled(),this._searchableView.updateSearchMatchesCount(this._searchResults.length),this._searchableView.updateCurrentMatchIndex(this._searchResultIndex)}searchCanceled(){this._mainPane.setSelectedEntry(-1),this._searchResults=[],this._searchResultIndex=-1}jumpToNextSearchResult(){this._searchResultIndex=(this._searchResultIndex+1)%this._searchResults.length,this._mainPane.setSelectedEntry(this._searchResults[this._searchResultIndex]),this._searchableView.updateCurrentMatchIndex(this._searchResultIndex)}jumpToPreviousSearchResult(){this._searchResultIndex=(this._searchResultIndex-1+this._searchResults.length)%this._searchResults.length,this._mainPane.setSelectedEntry(this._searchResults[this._searchResultIndex]),this._searchableView.updateCurrentMatchIndex(this._searchResultIndex)}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!1}}export class OverviewCalculator{constructor(e){this._dataProvider=e}_updateBoundaries(e){this._minimumBoundaries=e._dataProvider.minimumBoundary();const t=e._dataProvider.totalTime();this._maximumBoundaries=this._minimumBoundaries+t,this._xScaleFactor=e._overviewContainer.clientWidth/t}computePosition(e){return(e-this._minimumBoundaries)*this._xScaleFactor}formatValue(e,t){return this._dataProvider.formatValue(e-this._minimumBoundaries,t)}maximumBoundary(){return this._maximumBoundaries}minimumBoundary(){return this._minimumBoundaries}zeroTime(){return this._minimumBoundaries}boundarySpan(){return this._maximumBoundaries-this._minimumBoundaries}}export class OverviewPane extends UI.Widget.VBox{constructor(e){super(),this.element.classList.add("cpu-profile-flame-chart-overview-pane"),this._overviewContainer=this.element.createChild("div","cpu-profile-flame-chart-overview-container"),this._overviewCalculator=new OverviewCalculator(e),this._overviewGrid=new PerfUI.OverviewGrid.OverviewGrid("cpu-profile-flame-chart",this._overviewCalculator),this._overviewGrid.element.classList.add("fill"),this._overviewCanvas=this._overviewContainer.createChild("canvas","cpu-profile-flame-chart-overview-canvas"),this._overviewContainer.appendChild(this._overviewGrid.element),this._dataProvider=e,this._overviewGrid.addEventListener(PerfUI.OverviewGrid.Events.WindowChanged,this._onWindowChanged,this)}windowChanged(e,t){this._selectRange(e,t)}updateRangeSelection(e,t){}updateSelectedGroup(e,t){}_selectRange(e,t){const i=this._dataProvider.minimumBoundary(),r=this._dataProvider.totalTime();this._overviewGrid.setWindow((e-i)/r,(t-i)/r)}_onWindowChanged(e){const t={windowTimeLeft:e.data.rawStartValue,windowTimeRight:e.data.rawEndValue};this._windowTimeLeft=t.windowTimeLeft,this._windowTimeRight=t.windowTimeRight,this.dispatchEventToListeners(PerfUI.OverviewGrid.Events.WindowChanged,t)}_timelineData(){return this._dataProvider.timelineData()}onResize(){this._scheduleUpdate()}_scheduleUpdate(){this._updateTimerId||(this._updateTimerId=this.element.window().requestAnimationFrame(this.update.bind(this)))}update(){this._updateTimerId=0;this._timelineData()&&(this._resetCanvas(this._overviewContainer.clientWidth,this._overviewContainer.clientHeight-PerfUI.FlameChart.HeaderHeight),this._overviewCalculator._updateBoundaries(this),this._overviewGrid.updateDividers(this._overviewCalculator),this._drawOverviewCanvas())}_drawOverviewCanvas(){const e=this._overviewCanvas.width,t=this._overviewCanvas.height,i=this._calculateDrawData(e),r=this._overviewCanvas.getContext("2d"),a=window.devicePixelRatio,s=t/(1.1*this._dataProvider.maxStackDepth());let n;r.lineWidth=1,r.translate(.5,.5),r.strokeStyle="rgba(20,0,0,0.4)",r.fillStyle="rgba(214,225,254,0.8)",r.moveTo(-1,t+1),r.lineTo(-1,Math.round(t-i[0]*s-a));for(let o=0;o<e;++o)n=Math.round(t-i[o]*s-a),r.lineTo(o,n);r.lineTo(e+1,n),r.lineTo(e+1,t+1),r.fill(),r.stroke(),r.closePath()}_calculateDrawData(e){const t=this._dataProvider,i=this._timelineData(),r=i.entryStartTimes,a=i.entryTotalTimes,s=i.entryLevels,n=r.length,o=this._dataProvider.minimumBoundary(),h=new Uint8Array(e),d=e/t.totalTime();for(let e=0;e<n;++e){const t=Math.floor((r[e]-o)*d),i=Math.floor((r[e]-o+a[e])*d);for(let r=t;r<=i;++r)h[r]=Math.max(h[r],s[e]+1)}return h}_resetCanvas(e,t){const i=window.devicePixelRatio;this._overviewCanvas.width=e*i,this._overviewCanvas.height=t*i,this._overviewCanvas.style.width=e+"px",this._overviewCanvas.style.height=t+"px"}}