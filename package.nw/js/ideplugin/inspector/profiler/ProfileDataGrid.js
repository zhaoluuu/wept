import*as Common from"../common/common.js";import*as DataGrid from"../data_grid/data_grid.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";export class ProfileDataGridNode extends DataGrid.DataGrid.DataGridNode{constructor(e,t,s){super(null,s),this._searchMatchedSelfColumn=!1,this._searchMatchedTotalColumn=!1,this._searchMatchedFunctionColumn=!1,this.profileNode=e,this.tree=t,this.childrenByCallUID=new Map,this.lastComparator=null,this.callUID=e.callUID,this.self=e.self,this.total=e.total,this.functionName=UI.UIUtils.beautifyFunctionName(e.functionName),this._deoptReason=e.deoptReason||"",this.url=e.url,this.linkElement=null}static sort(e,t,s){for(let l=0;l<e.length;++l){const r=e[l],a=r.length;for(let l=0;l<a;++l){const a=r[l];if(!(s||a.expanded&&a.lastComparator!==t)){a.children.length&&(a.shouldRefreshChildren=!0);continue}a.lastComparator=t;const h=a.children,i=h.length;if(i){h.sort(t);for(let e=0;e<i;++e)h[e].recalculateSiblings(e);e.push(h)}}}}static merge(e,t,s){e.self+=t.self,s||(e.total+=t.total);let l=e.children.slice();e.removeChildren();let r=l.length;for(let a=0;a<r;++a)s&&l[a]===t||e.appendChild(l[a]);l=t.children.slice(),r=l.length;for(let t=0;t<r;++t){const s=l[t],r=e.childrenByCallUID.get(s.callUID);r?r.merge(s,!1):e.appendChild(s)}}static populate(e){if(e._populated)return;e._populated=!0,e.populateChildren();const t=e.tree.lastComparator;t&&e.sort(t,!0)}createCell(e){switch(e){case"self":{const t=this._createValueCell(this.self,this.selfPercent,e);return t.classList.toggle("highlight",this._searchMatchedSelfColumn),t}case"total":{const t=this._createValueCell(this.total,this.totalPercent,e);return t.classList.toggle("highlight",this._searchMatchedTotalColumn),t}case"function":{const t=this.createTD(e);if(t.classList.toggle("highlight",this._searchMatchedFunctionColumn),this._deoptReason){t.classList.add("not-optimized");const e=UI.Icon.Icon.create("smallicon-warning","profile-warn-marker");e.title=Common.UIString.UIString("Not optimized: %s",this._deoptReason),t.appendChild(e)}if(t.createTextChild(this.functionName),"0"===this.profileNode.scriptId)return t;const s=this.tree._formatter.linkifyNode(this);return s?(s.style.maxWidth="75%",t.appendChild(s),this.linkElement=s,t):t}}return super.createCell(e)}_createValueCell(e,t,s){const l=document.createElement("td");l.classList.add("numeric-column");const r=l.createChild("div","profile-multiple-values"),a=r.createChild("span"),h=this.tree._formatter.formatValue(e,this);a.textContent=h;const i=r.createChild("span","percent-column"),n=this.tree._formatter.formatPercent(t,this);i.textContent=n;const o=this.tree._formatter.formatValueAccessibleText(e,this);return this.setCellAccessibleName(ls`${o}, ${n}`,l,s),l}sort(e,t){return ProfileDataGridNode.sort([[this]],e,t)}insertChild(e,t){super.insertChild(e,t),this.childrenByCallUID.set(e.callUID,e)}removeChild(e){super.removeChild(e),this.childrenByCallUID.delete(e.callUID)}removeChildren(){super.removeChildren(),this.childrenByCallUID.clear()}findChild(e){return e?this.childrenByCallUID.get(e.callUID):null}get selfPercent(){return this.self/this.tree.total*100}get totalPercent(){return this.total/this.tree.total*100}populate(){ProfileDataGridNode.populate(this)}populateChildren(){}save(){this._savedChildren||(this._savedSelf=this.self,this._savedTotal=this.total,this._savedChildren=this.children.slice())}restore(){if(!this._savedChildren)return;this.self=this._savedSelf,this.total=this._savedTotal,this.removeChildren();const e=this._savedChildren,t=e.length;for(let s=0;s<t;++s)e[s].restore(),this.appendChild(e[s])}merge(e,t){ProfileDataGridNode.merge(this,e,t)}}export class ProfileDataGridTree{constructor(e,t,s){this.tree=this,this.children=[],this._formatter=e,this._searchableView=t,this.total=s,this.lastComparator=null,this.childrenByCallUID=new Map,this.deepSearch=!0}static propertyComparator(e,t){let s=ProfileDataGridTree.propertyComparators[t?1:0][e];return s||(s=t?function(t,s){return t[e]<s[e]?-1:t[e]>s[e]?1:0}:function(t,s){return t[e]>s[e]?-1:t[e]<s[e]?1:0},ProfileDataGridTree.propertyComparators[t?1:0][e]=s),s}get expanded(){return!0}appendChild(e){this.insertChild(e,this.children.length)}insertChild(e,t){this.children.splice(t,0,e),this.childrenByCallUID.set(e.callUID,e)}removeChildren(){this.children=[],this.childrenByCallUID.clear()}populateChildren(){}findChild(e){return e?this.childrenByCallUID.get(e.callUID):null}sort(e,t){return ProfileDataGridNode.sort([[this]],e,t)}save(){this._savedChildren||(this._savedTotal=this.total,this._savedChildren=this.children.slice())}restore(){if(!this._savedChildren)return;this.children=this._savedChildren,this.total=this._savedTotal;const e=this.children,t=e.length;for(let s=0;s<t;++s)e[s].restore();this._savedChildren=null}_matchFunction(e){const t=e.query.trim();if(!t.length)return null;const s=t.startsWith(">"),l=t.startsWith("<");let r=t.startsWith("=")||(s||l)&&1===t.indexOf("=");const a=t.endsWith("%"),h=t.length>2&&t.endsWith("ms"),i=!h&&t.endsWith("s");let n=parseFloat(t);(s||l||r)&&(n=r&&(s||l)?parseFloat(t.substring(2)):parseFloat(t.substring(1)));const o=i?1e3*n:n;isNaN(n)||s||l||(r=!0);const c=createPlainTextSearchRegex(t,"i");return function(e){return e._searchMatchedSelfColumn=!1,e._searchMatchedTotalColumn=!1,e._searchMatchedFunctionColumn=!1,a?(l?(e.selfPercent<n&&(e._searchMatchedSelfColumn=!0),e.totalPercent<n&&(e._searchMatchedTotalColumn=!0)):s&&(e.selfPercent>n&&(e._searchMatchedSelfColumn=!0),e.totalPercent>n&&(e._searchMatchedTotalColumn=!0)),r&&(e.selfPercent===n&&(e._searchMatchedSelfColumn=!0),e.totalPercent===n&&(e._searchMatchedTotalColumn=!0))):(h||i)&&(l?(e.self<o&&(e._searchMatchedSelfColumn=!0),e.total<o&&(e._searchMatchedTotalColumn=!0)):s&&(e.self>o&&(e._searchMatchedSelfColumn=!0),e.total>o&&(e._searchMatchedTotalColumn=!0)),r&&(e.self===o&&(e._searchMatchedSelfColumn=!0),e.total===o&&(e._searchMatchedTotalColumn=!0))),(e.functionName.match(c)||e.url&&e.url.match(c))&&(e._searchMatchedFunctionColumn=!0),!!(e._searchMatchedSelfColumn||e._searchMatchedTotalColumn||e._searchMatchedFunctionColumn)&&(e.refresh(),!0)}}performSearch(e,t,s){this.searchCanceled();const l=this._matchFunction(e);if(!l)return;this._searchResults=[];const r=this.deepSearch;for(let e=this.children[0];e;e=e.traverseNextNode(!r,null,!r))l(e)&&this._searchResults.push({profileNode:e});this._searchResultIndex=s?0:this._searchResults.length-1,this._searchableView.updateSearchMatchesCount(this._searchResults.length),this._searchableView.updateCurrentMatchIndex(this._searchResultIndex)}searchCanceled(){if(this._searchResults)for(let e=0;e<this._searchResults.length;++e){const t=this._searchResults[e].profileNode;t._searchMatchedSelfColumn=!1,t._searchMatchedTotalColumn=!1,t._searchMatchedFunctionColumn=!1,t.refresh()}this._searchResults=[],this._searchResultIndex=-1}jumpToNextSearchResult(){this._searchResults&&this._searchResults.length&&(this._searchResultIndex=(this._searchResultIndex+1)%this._searchResults.length,this._jumpToSearchResult(this._searchResultIndex))}jumpToPreviousSearchResult(){this._searchResults&&this._searchResults.length&&(this._searchResultIndex=(this._searchResultIndex-1+this._searchResults.length)%this._searchResults.length,this._jumpToSearchResult(this._searchResultIndex))}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!1}_jumpToSearchResult(e){const t=this._searchResults[e];if(!t)return;t.profileNode.revealAndSelect(),this._searchableView.updateCurrentMatchIndex(e)}}ProfileDataGridTree.propertyComparators=[{},{}];export class Formatter{formatValue(e,t){}formatValueAccessibleText(e){}formatPercent(e,t){}linkifyNode(e){}}