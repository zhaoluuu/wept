(()=>{"use strict";(()=>{const t=window.__WeixinJSContext||{};window.__WeixinJSContext=t;const e=window.__global;e.__contextSupport=window.__contextSupport,e._private_doGetNewWeixinJSContext=function(t,e,o,n,i,r,l,a){const s=n.__contextSupport,d=o.__devtoolsConfig,c=o.__wxConfig,u=n.XMLHttpRequest||e.XMLHttpRequest,p=e.document,h=(null==p?void 0:p.head)||(null==p?void 0:p.body)||(null==p?void 0:p.documentElement);n.WeixinJSBridgeMap=n.WeixinJSBridgeMap||{};let v=2;function _(t){return t=t.replace(/\\/g,"/").replace(/(\/){2,}/g,"/").replace(/^\/+/,"")}const x=()=>null==i?void 0:i.delegate,f="object"==typeof s?String(s.pathScope||"game"):"game",y=function(...t){("object"==typeof s?Boolean(s.isDev):"object"==typeof d&&Boolean((d.appConfig||{}).isDev))&&console.log(...t)};function C(t){"function"==typeof t&&("object"==typeof s?Boolean(s.isIsolateContext):"object"==typeof c&&Boolean(("object"==typeof c?c:{}).isIsolateContext))&&t.call(null)}const w=console.warn.bind(console);n.contextFrameMaps=n.contextFrameMaps||new Map;const m=n.contextFrameMaps;e.__subcontext_ready__=t=>{const e=m.get(String(t));if(e){for(const t in e.globalObject)e.iframe.contentWindow[t]=e.globalObject[t];e.setPrepared()}else w("[Context] unknown context ready",t)},e.__subcontext_ready_to_evaluate__=t=>{const e=m.get(String(t));e?e.setReady():w("[Context] unknown context eval ready",t)};const b=t=>a?`${a}_${t}`:t;class S{constructor(e,i,l,a){this.id=e,this.name=i,this.empty=l,this.creationBarrier=a,this._destroyed=!1,this._ready=!1,this._prepared=!1,this._delayedTasks=[],this._evalCounter=1,this.fullId=b(String(e)),this.iframe=n.document.createElement("iframe"),this.iframe.style.pointerEvents="none",this.iframe.dataset.contextFrameId=this.fullId,this.iframe.dataset.contextFrameName=String(i);const s=b(`subcontext_${e}`);let d=r;r||(d=n.getNewWeixinJSBridge(s),n.WeixinJSBridgeMap[s]=r),this.globalObject={WeixinJSContext:t,__wxConfig:o.__wxConfig}}install(t){if(!this.creationBarrier)return this.doInstall(t);this.creationBarrier.wait().then((()=>{this._destroyed||this.doInstall(t)}))}doInstall(t){this.iframe.src=`/${f}/${this.name}Context?id=${this.fullId}${this.empty?"&empty=true":""}${l||""}`;n.document.getElementsByTagName("body")[0].appendChild(this.iframe),null==t||t()}uninstall(){this.iframe.src="about:blank",this.iframe.remove()}throwIfDestroyed(){if(this._destroyed)throw new Error("[Context] context frame already destroyed.")}destroy(){y("[Context] destroy",this.fullId),this.creationBarrier=void 0,this._destroyed=!0,this._delayedTasks.splice(0,this._delayedTasks.length),this.uninstall(),m.delete(this.fullId)}onDidReady(t){this.throwIfDestroyed(),this._ready?t.call(null):this._delayedTasks.push(t)}setPrepared(){var t,e;this.throwIfDestroyed(),this._prepared&&w("[Context] context frame already prepared",this.fullId,this.name),this._prepared=!0,null===(e=null===(t=x())||void 0===t?void 0:t.onDidContextFramePrepared)||void 0===e||e.call(t,this)}setReady(){var t,e,o,n;this.throwIfDestroyed(),this._ready&&w("[Context] context frame already ready",this.fullId,this.name),null===(e=null===(t=x())||void 0===t?void 0:t.onWillContextFrameReady)||void 0===e||e.call(t,this),this._ready=!0;const i=[...this._delayedTasks];this._delayedTasks=[],i.forEach((t=>t.call(null))),null===(n=null===(o=x())||void 0===o?void 0:o.onDidContextFrameReady)||void 0===n||n.call(o,this)}loadScriptContent(t){const e=new n.XMLHttpRequest;if(e.open("GET",t,!1),e.send(null),200===e.status)return e.responseText;throw new Error(`[Context] get script error ${t}`)}evalScript(t,e="script",o){if(t=_(t),this.throwIfDestroyed(),!this._ready)throw new Error(`[Context] context frame not ready before eval scripts ${this.fullId}`);const i=!o,r=n.document.createElement("script");r.async=!1,r.dataset.evalScriptPath=t,r.dataset.evalCounter=String(this._evalCounter++);let l=`/${f}/${"script"===e?"__context__":"__dev__"}/${t}`;if("lib"===e&&(l+=`?v=${s.libVersion}`),i){r.type="text/javascript";let o=this.loadScriptContent(l);o="script"===e?`${o}\n//# sourceURL=weapp:///${t}`:`${o}\n//# sourceURL=wxlibfile:///${t}`,r.text=o}else{r.src=l;const e=()=>{!this._destroyed&&o&&o.call(null),r.onload=null,r.onerror=null};r.onload=()=>{const o=this.window.__$scriptOnLoadBarriers||{};o[t]?(o[t].onDidOpen(e),delete o[t]):e()},r.onerror=t=>{this._destroyed||console.error("[Context] eval script error",this.fullId,this.name,t),r.onload=null,r.onerror=null}}this.head.appendChild(r)}evalScriptSync(t,e){if(t=_(t),this.throwIfDestroyed(),!this._ready)throw new Error(`[Context] context frame not ready before eval scripts ${this.fullId}`);const o=n.document.createElement("script");o.dataset.evalScriptPath=t,o.dataset.evalCounter=String(this._evalCounter++),o.dataset.evalSync="yes";let i=`/${f}/${"script"===e?"__context__":"__dev__"}/${t}`;return y(`[Context] evalScriptSync ${t} type: ${e}, libVersion: ${s.libVersion}`),"lib"===e&&(i+=`?v=${s.libVersion}`),$(i,o,this.head)}get window(){return this._preservedWindow||(this._preservedWindow=this.iframe.contentWindow,this._preservedWindow.__$scriptOnLoadBarriers=Object.create(null),this._preservedWindow.__$ownerHead=this._preservedWindow.document.head),this._preservedWindow}get head(){return this._preservedHeadElement||(this._preservedHeadElement=this.window.document.head),this._preservedHeadElement}}const g=function(t,e,n,i){var r,l,a,s,d;y("[Context] create",t,e,n?"has_callback":"(no callback)",Date.now(),null===(r=null==o?void 0:o.location)||void 0===r?void 0:r.href);const c=null===(a=null===(l=x())||void 0===l?void 0:l.barrierForContextFrameCreation)||void 0===a?void 0:a.call(l,t,e);null===(d=null===(s=x())||void 0===s?void 0:s.onWillCreateContextFrame)||void 0===d||d.call(s,t,e,c);const u=v++,p=new S(u,e=e||`untitledContext${u}`,i,c),h=b(String(u));return m.set(h,p),p.install((()=>{var o,n;null===(n=null===(o=x())||void 0===o?void 0:o.onDidCreateContextFrame)||void 0===n||n.call(o,t,e,p)})),t?p.onDidReady((()=>{p.evalScript(t,"script",(()=>{y("[Context] create callback of context id",h,"invoked"),C(n)}))})):n&&p.onDidReady((()=>{y("[Context] create callback of context id",h,"invoked"),C(n)})),u},$=function(t,e,o){const n=new u;if(n.open("GET",t,!1),n.send(),200!==n.status)throw new Error(`[Context] helper evalScriptSync error xhr ${n.status} ${n.statusText}`);return e.async=!1,e.setAttribute("charset","utf-8"),e.type="application/javascript",e.text=n.responseText,o.appendChild(e),1};let F=1;const k=function(t,e){const o=p.createElement("script"),n=_(e);o.dataset.evalScriptPath=n,o.dataset.evalCounter=String(F++),o.dataset.evalInMainContext="yes",o.dataset.evalSync="yes";let i=`/${f}/${"script"===t?"__context__":"__dev__"}/${n}`;return"lib"===t&&(i+=`?v=${s.libVersion}`),$(i,o,h)},I=function(t,e,o){var n,i,r,l;if(y("[Context] evaluateScriptFile",t,e,o?"has_callback":"(no callback)"),1===t){const t=k("script",e);return"function"==typeof o&&o(),t}const a=b(String(t)),s=m.get(a);return s?(null===(i=null===(n=x())||void 0===n?void 0:n.onWillContextFrameEvaluateScriptFile)||void 0===i||i.call(n,s,e),o?s.onDidReady((()=>{s.evalScript(e,"script",(()=>{var t,n;y("[Context] evaluateScriptFile callback of context id",s.fullId,"invoked"),null===(n=null===(t=x())||void 0===t?void 0:t.onDidContextFrameEvaluateScriptFile)||void 0===n||n.call(t,s,e),C(o)}))})):(s.evalScript(e,"script"),null===(l=null===(r=x())||void 0===r?void 0:r.onDidContextFrameEvaluateScriptFile)||void 0===l||l.call(r,s,e)),1):(w(`[Context] context frame not found for id ${t} (${a})`),0)},E=function(t,e){var o,n,i,r;if(y("[Context] evaluateLibFile",t,e),1===t)return k("lib",e);const l=b(String(t)),a=m.get(l);if(!a)return w(`[Context] context frame not found for id ${t} (${l})`),0;null===(n=null===(o=x())||void 0===o?void 0:o.onWillContextFrameEvaluateScriptFile)||void 0===n||n.call(o,a,e);const s=a.evalScriptSync(e,"lib");return null===(r=null===(i=x())||void 0===i?void 0:i.onDidContextFrameEvaluateScriptFile)||void 0===r||r.call(i,a,e),s};t.mainContextId=1,t.alloc=function(t,e){return y("[Context] alloc",t,e?"has_callback":"(no callback)"),g(void 0,t,e)},t.allocEmpty=function(t,e){return y("[Context] allocEmpty",t,e?"has_callback":"(no callback)"),g(void 0,t,e,!0)},t.create=g,t.evaluateScriptFile=I,t.loadJsFiles=function(t,e,o){const n=JSON.parse(e);if(y("[Context] loadJsFiles",t,n,o?"has_callback":"(no callback)"),o){let e=0,i=!1;const r=()=>{e++,e!==n.length||i||null==o||o()};for(const e of n){let o;if(o=1===t?k("script",e):I(t,e,r),0===o)return i=!0,o}return 1===t&&"function"==typeof o&&o(),1}for(const e of n)I(t,e);return 1},t.loadLibFiles=function(t,e){const o=JSON.parse(e);y("[Context] loadLibFiles (sync)",t,o);for(const e of o)E(t,e);return 1},t.destroy=function(t,e){var o,n;const i=b(String(t));y("[Context] destroy",i,e?"has_callback":"(no callback)");const r=m.get(i);r&&(null===(n=null===(o=x())||void 0===o?void 0:o.onWillContextFrameDestroy)||void 0===n||n.call(o,r),m.delete(i),r.destroy(),y("[Context] destroy callback of context id",r.fullId,"invoked"),C(e))}},e._private_doGetNewWeixinJSContext(t,window,window,e,e.__contextSupport,void 0,"",""),e.__getNewWeixinJSContext=function(t){const o=t||{},n=o.obj||{};return e._private_doGetNewWeixinJSContext(n,window,o.window||window,e,o.scopedContextSupport||e.__contextSupport,o.bridge,o.locationHash,o.parentId),o.obj||new Proxy(n,{get:(t,e)=>t[e],set:(t,e,o)=>t[e]=o,getPrototypeOf:()=>o.ObjectPrototype||Object.prototype})}})()})();
//# sourceURL=ide:///extensions/context/index.js