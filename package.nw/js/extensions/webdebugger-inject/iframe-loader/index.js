(()=>{"use strict";var e={5673:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const s=n(8422),a=navigator.userAgent.match(/webview\/([\w]*)/),o=a?a[1]:"",i=`${Date.now()}${Math.floor(1e4*Math.random())}`;let r;const c=()=>{if(r)return r;return r=new s(`WEBDEBUGGER_${i}`),r.send({command:"WEBDEBUGGER_MESSAGER_READY",webviewID:o,runtimeID:i}),r};t.default={send(e){e.webviewID=o,e.runtimeID=i;c().send(e)},registerCallback(e){c().registerCallback(e)}}},8422:e=>{const t=window.navigator||window.__global.navigator,n=window.WebSocket||window.__global.WebSocket,s=window.prompt||window.__global.prompt,a=t.userAgent.match(/port\/(\d*)/),o=a?parseInt(a[1]):9974,i=`ws://127.0.0.1:${o}`;window.__maxConnectTryTime=10;e.exports=class{constructor(e,t=!0){this._protocol=e,this._needToken=t,this._ws=null,this._msgQueue=[],this._callback=new Set,this._parseJson=null,this.tryTime=0,"complete"===document.readyState?setTimeout((()=>{this.connect()})):window.addEventListener("load",(()=>{this.connect()}))}connect(){if(!o)return;if(this.tryTime++,this.tryTime>=window.__maxConnectTryTime)return void console.error("当前应用通道断开且重连次数已满，请重新编译应用");let e=this._protocol;if(this._needToken){e=`${e}#${s("GET_MESSAGE_TOKEN")}#`}this._ws=new n(i,e),this._ws.onopen=()=>{const e=[].concat(this._msgQueue);this._msgQueue=[],e.forEach((e=>{this.send(e)}))},this._ws.onclose=()=>{this._ws=null,setTimeout((()=>{this.connect()}),150)},this._ws.onmessage=e=>{try{const t=this._parseJson?this._parseJson(e.data):JSON.parse(e.data);this._callback.forEach((e=>{try{e.call(this,t)}catch(e){console.error("onmessage",e)}}))}catch(e){console.error("onmessage",e)}}}send(e){this._ws&&this._ws.readyState===n.OPEN?this._ws.send(JSON.stringify(e)):this._msgQueue.push(e)}registerCallback(e){"function"==typeof e&&this._callback.add(e)}removeCallback(e){this._callback.delete(e)}}},8253:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const s=n(8422),a=navigator.userAgent.match(/webview\/([\w]*)/),o=a?a[1]:"",i=`${Date.now()}${Math.floor(1e4*Math.random())}`;let r;const c=()=>{if(r)return r;return r=new s(`JSCOREWEBVIEW_${i}`),r};t.default={send(e){e.webviewID=o,e.runtimeID=i;c().send(e)},registerCallback(e){c().registerCallback(e)}}},6405:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createIframeElement=void 0,t.createIframeElement=async function(e,t="about:blank"){const n=document.createElement("iframe");return n.style.borderWidth="0px",n.style.width="100%",n.style.height="100%",n.id=e,n.src=function(e,t){if(t.includes(`#id_${e}`))return t;return`${t}#id_${e}`}(e,t),document.body?(document.body.appendChild(n),n):new Promise((e=>{document.addEventListener("DOMContentLoaded",(()=>{document.body.appendChild(n),e(n)}))}))}}},t={};function n(s){var a=t[s];if(void 0!==a)return a.exports;var o=t[s]={exports:{}};return e[s](o,o.exports,n),o.exports}(()=>{const e=n(6405),t=n(8253),s=n(5673);class a{constructor(){this.jsCoreMap=new Map,this.onMessage=e=>{const{command:t,data:n}=e;switch(t){case"JSCORE_INVOKE_RES":return this.handleInvoke(n.id,n.result);case"CREATE_JSCORE_IFRAME":return this.createIframe(n.comptName,n.configOptions);case"IFRAME_TO_JSCORE_MSG":return this.handleOnMessage(n.comptName,n.message);case"JSCORE_LAUNCH":return this.handleLaunch(n.id,n.launchData);case"JSCORE_ONBIND":return this.handleOnBind(n.id,n.tagId,n.matrix)}},t.default.registerCallback(this.onMessage)}async createIframe(t,n){const s=this.jsCoreMap.get(t);(null==s?void 0:s.iframe)&&this.disposeFrame(t);const a=await e.createIframeElement(t,this.generateIframeSrc(t));this.jsCoreMap.set(t,{iframe:a,config:n})}generateIframeSrc(e){return`http://${location.host}/__webdebugger__/webdebugger-jscoreiframe.html#id_${e}`}handleInvoke(e,t){const{callbackID:n,res:s}=t,a=this.jsCoreMap.get(e);a&&a.iframe.contentWindow.WeixinWebCompt._callback(n,s)}handleConfig(e,t){const n=this.jsCoreMap.get(t);(null==n?void 0:n.config)&&e.addEventListener("load",(()=>{e.WeixinWebCompt.config(n.config),this.handleInjectAppScript(t),this.getLaunchInfo(t)}))}handleOnBind(e,n,s){const a=this.jsCoreMap.get(e);if(null==a?void 0:a.iframe){const o=a.iframe.contentWindow;if(!o)return console.error("JSCore is not created");"complete"===o.document.readyState?(o.WeixinWebCompt.onBind(...s),t.default.send({command:"JSCORE_ONBIND_RES",data:{id:e,tagId:n}})):o.addEventListener("load",(()=>{o.WeixinWebCompt.onBind(o.WeixinWebCompt,s),t.default.send({command:"JSCORE_ONBIND_RES",data:{id:e,tagId:n}})}))}}handleOnMessage(e,t){const n=this.jsCoreMap.get(e);n&&n.iframe.contentWindow.WeixinWebCompt.onMessage(JSON.parse(t))}getLaunchInfo(e){s.default.send({command:"JSCORE_GET_LAUNCH_INFO",data:{id:e}})}handleLaunch(e,t){const n=this.jsCoreMap.get(e);n&&n.iframe.contentWindow.WeixinWebCompt.launch(t)}handleInjectAppScript(e){const t=this.jsCoreMap.get(e);t&&t.iframe.contentWindow.eval("var __exp_inject_script__ = document.createElement('script'); __exp_inject_script__.src = './wxopen.js'; document.body.appendChild(__exp_inject_script__)")}disposeFrame(e){const t=this.jsCoreMap.get(e);t&&t.iframe.parentElement.removeChild(t.iframe),this.jsCoreMap.delete(e)}disposeAllFrame(){Object.values(this.jsCoreMap).forEach((e=>{e.iframe.parentElement.removeChild(e.iframe)})),this.jsCoreMap.clear()}destroy(){this.disposeAllFrame()}}const o=new a;window.__global.iframeLoader=o})()})();
//# sourceURL=ide:///extensions/webdebugger-inject/iframe-loader/index.js