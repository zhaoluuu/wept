!function(require, directRequire){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getPageJSONVariableDecalearProperty=exports.checkComponentPath=exports.getUseExtendLib=exports.checkFilePathIsInIndependentSubpackage=exports.checkPagePathIsInIndependentSubpackage=exports.checkPagePathIsInSubPackage=exports.checkJSONFormat=void 0;const tslib_1=require("tslib"),path_1=tslib_1.__importDefault(require("path")),lodash_1=require("lodash"),tools_1=require("../../../../utils/tools"),locales_1=tslib_1.__importDefault(require("../../../../utils/locales/locales")),common_1=require("../../../../utils/common"),config_1=require("../../../../config/config"),appJSON_1=require("./app/appJSON");function checkJSONFormat(e,t){let o={};e||(0,common_1.throwError)({filePath:t,msg:"Empty file is NOT a valid json file",code:config_1.JSON_PARSE_ERR});try{o=JSON.parse(e)}catch(o){const n=(0,tools_1.formatJSONParseErr)({filePath:t,data:e,error:o});(0,common_1.throwError)({filePath:t,msg:n,code:config_1.JSON_PARSE_ERR})}return o}function checkPagePathIsInSubPackage(e,t){const{subPackages:o,subpackages:n}=e;if(o||n)for(const e of o||n)if(t.startsWith(e.root))return e}function checkPagePathIsInIndependentSubpackage(e,t){const o=checkPagePathIsInSubPackage(e,t);if(o&&!0===o.independent)return o}function checkFilePathIsInIndependentSubpackage(e,t){const{subPackages:o}=e;if(o)for(const e of o)if(!0===e.independent){const o=e.root.replace(/^\//,"");if(t.startsWith(o))return o}}function checkNodeModulesFile2(e,t,o){var n,a;for(const i of o){const o=i+".json",r=i+".wxml";if((null===(n=e.stat(t,o))||void 0===n?void 0:n.isFile)&&(null===(a=e.stat(t,r))||void 0===a?void 0:a.isFile))return i}return""}function resolveComponentPath2(e,t,o,n){n=(0,tools_1.normalizePath)(n);const a=[path_1.default.posix.join(o,n),path_1.default.posix.join(o,n,"index")];let i=o.split(path_1.default.posix.sep);for(i=i.filter(e=>!!e);i.length;){const e=[path_1.default.posix.join(i.join(path_1.default.posix.sep),"miniprogram_npm",n),path_1.default.posix.join(i.join(path_1.default.posix.sep),"miniprogram_npm",n,"index")];a.push(...e),i.pop()}const r=[path_1.default.posix.join("miniprogram_npm",n),path_1.default.posix.join("miniprogram_npm",n,"index")];a.push(...r);const s=checkNodeModulesFile2(e,t,a);return s?{searchedPaths:a,requirePath:path_1.default.posix.relative(o,s)}:{searchedPaths:a,requirePath:""}}exports.checkJSONFormat=checkJSONFormat,exports.checkPagePathIsInSubPackage=checkPagePathIsInSubPackage,exports.checkPagePathIsInIndependentSubpackage=checkPagePathIsInIndependentSubpackage,exports.checkFilePathIsInIndependentSubpackage=checkFilePathIsInIndependentSubpackage;const innerCheckComponentPath=e=>{const{value:t,tips:o,project:n,root:a,relativePath:i}=e,r=`${o}: "${t}"`,s=path_1.default.posix.join(a,i);if(t.startsWith("plugin://")||t.startsWith("plugin-private://"))return t;const c=e=>n.stat(a,e+".json")&&n.stat(a,e+".wxml"),p=(0,exports.getUseExtendLib)(n,i);if(t.startsWith("/")){if(p.length){const e=p.map(e=>"/miniprogram_npm/"+e);let o=!1;for(const n of e)if(t.startsWith(n)){o=!0;break}if(o)return t}if(c(t))return t;if(c(t+"/index"))return t+"/index";(0,common_1.throwError)({msg:locales_1.default.config.COMPONENT_NOT_FOUND.format(r,path_1.default.posix.join(n.projectPath,a,t)),filePath:s})}if(t.startsWith(".")){if(t.startsWith("../")){const e=t.replace(/^(\.\.\/)+/,"");if(c("/"+e))return t;if(c(`/${e}/index`))return t+"/index"}if(c(path_1.default.posix.join(path_1.default.posix.dirname(i),""+t)))return t;if(c(path_1.default.posix.join(path_1.default.posix.dirname(i),t+"/index")))return t+"/index";(0,common_1.throwError)({msg:locales_1.default.config.COMPONENT_NOT_FOUND.format(r,path_1.default.posix.join(n.projectPath,a,path_1.default.posix.dirname(i),t)),filePath:s})}for(const e of p)if(t.startsWith(e))return"miniprogram-element"===e?`/miniprogram_npm/${e}/index`:t.replace(e,"/miniprogram_npm/"+e);const l=resolveComponentPath2(n,a,path_1.default.posix.dirname(i),t);l.requirePath||(0,common_1.throwError)({msg:locales_1.default.config.COMPONENT_NOT_FOUND.format(r,l.searchedPaths.map(e=>path_1.default.posix.join(n.projectPath,a,e)).join("\n")),filePath:s});const h=l.requirePath||"";return h.startsWith(".")?h:"./"+h},getUseExtendLib=(e,t)=>{var o;const n=(0,appJSON_1.getRawAppJSON)(e);let a=[];if("[object Object]"===Object.prototype.toString.call(n.useExtendedLib)){const e=Object.keys(config_1.extendedLibMap),t=Object.keys(n.useExtendedLib).filter(t=>!e.includes(t));t.length&&(0,common_1.throwError)({msg:t.join(", ")+' is not allowed in ["useExtendedLib"]',filePath:"app.json"}),a=Object.keys(n.useExtendedLib||{}).filter(e=>n.useExtendedLib[e]).map(e=>config_1.extendedLibMap[e].packages),a=(0,lodash_1.flattenDeep)(a)}const i=checkPagePathIsInSubPackage(n,t);if((null==i?void 0:i.useExtendedLib)&&"[object Object]"===Object.prototype.toString.call(i.useExtendedLib)){const e=Object.keys(config_1.extendedLibMap),t=Object.keys(i.useExtendedLib).filter(t=>!e.includes(t));t.length&&(0,common_1.throwError)({msg:`${t.join(", ")} is not allowed in subPackages[${null===(o=n.subPackages)||void 0===o?void 0:o.indexOf(i)}]["useExtendedLib"]`,filePath:"app.json"});const r=Object.keys(i.useExtendedLib||{}).filter(e=>i.useExtendedLib[e]).map(e=>config_1.extendedLibMap[e].packages);a=(0,lodash_1.uniq)(a.concat((0,lodash_1.flattenDeep)(r)))}return a};exports.getUseExtendLib=getUseExtendLib;const checkComponentPath=e=>{const{project:t,root:o,relativePath:n,inputJSON:a}=e,{usingComponents:i,componentGenerics:r}=a;if(i)for(const e in i){const a=i[e]||"";i[e]=innerCheckComponentPath({tips:`["usingComponents"]["${e}"]`,value:a,project:t,root:o,relativePath:n})}if(r)for(const e in r){const a="object"==typeof r[e],i=a?r[e].default:r[e];if(!i||"string"!=typeof i)continue;const s=innerCheckComponentPath({tips:`["componentGenerics"]["${e}"]`,value:i,project:t,root:o,relativePath:n});a?r[e].default=s:r[e]=s}};function getPageJSONVariableDecalearProperty(e){const{windowPropertWhiteList:t}=config_1.jsonVariablePropertyWhiteList;let o=[];return"[object Object]"===Object.prototype.toString.call(e)&&(o=o.concat(Object.keys(e).filter(e=>t.includes(e)).map(t=>({property:`["${t}"]`,value:e[t]})).filter(e=>e.value.startsWith("@")))),o}exports.checkComponentPath=checkComponentPath,exports.getPageJSONVariableDecalearProperty=getPageJSONVariableDecalearProperty;
}(require("licia/lazyImport")(require), require)