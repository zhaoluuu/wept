!function(require, directRequire){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CIProject=exports.getProjectAttr=void 0;const tslib_1=require("tslib"),path_1=tslib_1.__importDefault(require("path")),fs_1=tslib_1.__importDefault(require("fs")),glob_1=tslib_1.__importDefault(require("glob")),config_1=require("../config/config"),locales_1=tslib_1.__importDefault(require("../utils/locales/locales")),error_1=require("../utils/error"),request_1=require("../utils/request"),sign_1=require("../utils/sign"),log=tslib_1.__importStar(require("../utils/log")),url_config_1=require("../config/url.config"),jsonParse_1=require("../utils/jsonParse"),tools_1=require("../utils/tools"),baseProject_1=require("./baseProject"),testCache={};async function getProjectAttr(t,e){try{if(global.useAttrCache&&testCache[e])return testCache[e];const r=await(0,sign_1.getSignature)(t,e),{body:i}=await(0,request_1.request)({url:url_config_1.GET_ATTR_URL,method:"post",body:JSON.stringify({appid:e,signature:r}),headers:{"content-type":"application/json"}}),o=(0,jsonParse_1.jsonRespParse)(i,url_config_1.GET_ATTR_URL);if(0===o.errCode)return global.useAttrCache&&(testCache[e]=o.data),o.data;log.error(`get ${e} project attr fail errCode: ${o.errCode}, errMsg: ${o.errMsg}`)}catch(t){log.error(`get ${e} project attr fail ${t}`)}return config_1.DefaultProjectAttr}exports.getProjectAttr=getProjectAttr;class CIProject extends baseProject_1.BaseProject{constructor(t){super();const{appid:e,type:r,projectPath:i,ignores:o,privateKey:s="",privateKeyPath:a=""}=t;if(!e)throw new error_1.CodeError(locales_1.default.config.SHOULD_NOT_BE_EMPTY.format("appid"),config_1.PARAM_ERROR);if(!i)throw new error_1.CodeError(locales_1.default.config.SHOULD_NOT_BE_EMPTY.format("projectPath"),config_1.PARAM_ERROR);if(s)this._privateKey=s;else{if(!a)throw new error_1.CodeError(locales_1.default.config.SHOULD_NOT_BE_EMPTY.format("privateKeyPath"),config_1.PARAM_ERROR);try{this._privateKey=fs_1.default.readFileSync(a).toString("utf8")}catch(t){throw new error_1.CodeError(t.toString(),config_1.PARAM_ERROR)}}this._projectPath=path_1.default.isAbsolute(i)?(0,tools_1.normalizePath)(i):(0,tools_1.normalizePath)(path_1.default.join(process.cwd(),i));const _=this.getProjectConfig();this._projectArchitecture=_.projectArchitecture||"miniProgram",this._miniprogramRoot=_.miniprogramRoot,this._pluginRoot=_.pluginRoot,this._appid=e,this._type=r||"miniProgram",this.ignores=o||[],this.setting=_.setting,this._project=t,this.init()}get project(){return this._project}async init(){(0,request_1.initGlobalProxy)(),this.updateFileAndDirs()}updateFileAndDirs(){const t=glob_1.default.sync("**",{nodir:!1,ignore:[...(0,config_1.getDefaultIgnores)(this),...this.ignores],nosort:!0,strict:!1,silent:!0,cwd:this.projectPath,absolute:!1,mark:!0,dot:!0});for(const e of t){const t=e.replace(/\\/g,path_1.default.posix.sep),r=fs_1.default.statSync(path_1.default.posix.join(this.projectPath,e));r.isDirectory()&&this.cacheDirName(this._dirSet,t.replace(/\/$/,"")),r.isFile()&&(this._fileSet.add(t),this.cacheDirName(this._dirSet,path_1.default.posix.dirname(t)))}}async attr(){return"function"==typeof this._project.attr?await this._project.attr():(this._attr||(this._attr=await getProjectAttr(this._privateKey,this._appid)),this._attr)}async getExtAppid(){if(this._extAppid)return this._extAppid;if(null!==this._extAppid)try{const t=await this.getProjectConfig(),{miniprogramRoot:e=""}=t,r=this.getFile(e,"ext.json"),i=JSON.parse(r.toString("utf-8"));return i.extEnable&&i.extAppid?this._extAppid=i.extAppid:this._extAppid=null,this._extAppid}catch(t){this._extAppid=null}}}exports.CIProject=CIProject;
}(require("licia/lazyImport")(require), require)