!function(require, directRequire){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SubProcessProxy=void 0;const tslib_1=require("tslib"),child_process_1=require("child_process"),path_1=tslib_1.__importDefault(require("path")),customError_1=require("../../utils/customError"),singletontask_1=require("../../utils/singletontask");function performanceMark(s,e){}function shouldInspectCompiler(){return!!(null===localStorage||void 0===localStorage?void 0:localStorage.getItem("inspectCompiler"))}const PROCESS_READY_TIMEOUT=2e4;class SubProcessProxy{constructor(s,e,t,o,r=8891){this.project=s,this.entryPath=e,this.passData=t,this.initOptions=o,this.inspectPort=r,this.taskMap=new Map,this.taskId=0,this.init=async()=>{performanceMark("process init"),this.process=await this.forkProcess(),performanceMark("process init",!0)}}async ready(){var s;return this._checkReadyTask||(this._checkReadyTask=new singletontask_1.SingletonTask(this.init)),await(null===(s=this._checkReadyTask)||void 0===s?void 0:s.getResult(!0))}async sendProcessMessage(s){await this.ready(),this.process.send(s)}destroy(){var s;null===(s=this.process)||void 0===s||s.kill("SIGTERM"),this.process=void 0,this._checkReadyTask=void 0}async forkProcess(){const s=this.entryPath,e={stdio:["pipe","pipe","pipe","ipc"],cwd:this.project.projectPath,env:Object.assign(Object.assign({},process.env),{cpprocessEnv:"childprocess",nativeProcess:"1",timeout:global.TEST_COMPILER_PROCESS_TIMEOUT})};shouldInspectCompiler()&&(e.execArgv=["--inspect="+this.inspectPort]);const t=process.__nwjs&&"wechatwebdevtools"===nw.App.manifest.appname;if(e.env.isDevtools=t,t){let s=path_1.default.join(path_1.default.dirname(process.execPath),"node");"darwin"!==process.platform&&(s+=".exe"),e.execPath=s}performanceMark("fork process");const o=await this.project.serialize();return new Promise((r,i)=>{const a=(0,child_process_1.fork)(s,["--expose-gc"],e),n=setTimeout(()=>{this.destroy(),i(new Error("fork process timeout"))},2e4);a.stdout.setEncoding("utf8"),a.stdout.on("data",s=>{console.log("child process stdout: "+s)}),a.stderr.on("data",s=>{console.error("child process stderr: "+s)}),a.on("exit",(s,e)=>{this.process=void 0,this._checkReadyTask=void 0,t&&console.error(`child process exit: code(${s}), signal(${e})`),0!==s&&i(new Error(`native child process exit: code(${s}), signal(${e})`))}),a.on("message",s=>{if("ready"===s.type&&(clearTimeout(n),performanceMark("process ready"),r(a)),"noReady"===s.type&&(performanceMark("process not ready"),i(new Error(s.error.message))),"progress"===s.type){const e=this.taskMap.get(s.taskId);(null==e?void 0:e.progressUpdate)&&e.progressUpdate(s.id,s.status,s.message)}if("response"===s.type){const{id:e,data:t,error:o}=s;o?this.onResponse(e,void 0,o):this.onResponse(e,t,void 0)}}),a.unref(),this.taskId+=1;const c={type:"init",data:{passData:this.passData,projectInfo:o,options:this.initOptions}};return a.send(c),a})}onResponse(s,e,t){const o=this.taskMap.get(s);this.taskMap.delete(s),o?t?(t=new customError_1.CustomError(t),o.reject(t)):o.resolve(e):console.error(`child process task: ${s} not found`)}async sendEvent(s,e){this.sendProcessMessage({type:"event",name:s,data:e})}async runTask(s,e,t){return new Promise((o,r)=>{const i={name:s,data:e,resolve:o,reject:r,progressUpdate:t};this.taskId+=1,this.taskMap.set(this.taskId,i),this.sendProcessMessage({type:"request",id:this.taskId,name:s,data:e})})}}exports.SubProcessProxy=SubProcessProxy;
}(require("licia/lazyImport")(require), require)