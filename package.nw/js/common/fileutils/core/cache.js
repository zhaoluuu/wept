"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Cache=void 0;const fs=require("fs"),path=require("path"),utils_1=require("../utils"),taskmanager_1=require("./taskmanager");class Cache{constructor(e,t={},i){this.enableCaseSensitive=!1,this.updateFileContentMD5Async=e=>new Promise((t=>{const i=path.posix.join(this.dirPath,e);((null===global||void 0===global?void 0:global.requestIdleCallback)||setTimeout)((()=>{fs.readFile(i,((i,s)=>{i?t(""):(this._fileContentMD5[e]=utils_1.generateMD5(s),t(this._fileContentMD5[e]))}))}))})),this._dirPath=e,this._fileList=[],this._completeFileList=[],this._fileInfo={},this._fileData={},this._fileTransform={},this._fileContentMD5={},this.logger=i,this.enableCaseSensitive=!!t.enableCaseSensitive}clean(){this._fileList=[],this._completeFileList=[],this._fileInfo={},this._fileData={}}get dirPath(){return this._dirPath}get fileList(){return this._fileList}set fileList(e){this._fileList=e}get completeFileList(){return this._completeFileList}set completeFileList(e){this._completeFileList=e}get fileInfo(){return this._fileInfo}set fileInfo(e){this._fileInfo=e}get fileData(){return this._fileData}get fileTransform(){return this._fileTransform}initAllFile(e){this._completeFileList=e.completeFileList,this._fileList=e.fileList;for(let e=0;e<this._fileList.length;e++){const t=this._fileList[e],i=fs.lstatSync(path.join(this.dirPath,t));i.isFile()&&(this.fileInfo[t]=i)}}isFileExist(e){return!!this._fileInfo[e]}isDirExist(e){const t=e.endsWith("/")?"":"/",i=`${e}${t}`;return this._completeFileList.indexOf(i)>=0&&!this.isFileExist(e)}addFile(e){utils_1.pushNoRepeat(this._fileList,e),utils_1.pushNoRepeat(this._completeFileList,e)}addDir(e){utils_1.pushNoRepeat(this._completeFileList,e)}deleteFile(e,t){let i=this.fileList.indexOf(e);-1!==i&&this.fileList.splice(i,1),i=this.completeFileList.indexOf(e),-1!==i&&this.completeFileList.splice(i,1),delete this.fileInfo[e],t&&delete this.fileData[t],this.clearFileContentMD5(e)}deleteDir(e,t){const i=e.endsWith("/")?"":"/",s=`${e}${i}`,l=t=>!!t&&(t===e||0===t.indexOf(s));this._completeFileList=this._deleteCache(this._completeFileList,l),this._fileList=this._deleteCache(this._fileList,l);for(const t in this.fileInfo)0===t.indexOf(e)&&delete this._fileInfo[t];if(t)for(const e in this._fileData)0===e.indexOf(t)&&delete this._fileData[e]}deleteFileData(e){var t;(null===(t=this._fileData)||void 0===t?void 0:t[e])&&delete this._fileData[e]}deleteAllFileData(){this._fileData={}}_deleteCache(e,t){for(let i=e.length-1;i>=0;i--)t(e[i])&&e.splice(i,1);return e}getCacheRealPath(e){var t;if(!e)return e;let i=e;return this.enableCaseSensitive||(i=e.toLocaleLowerCase()),(null===(t=this.fileTransform[i])||void 0===t?void 0:t.realPath)?this.fileTransform[i].realPath:e}initFileTransform(e=!1){if(!(!e&&this.fileTransform&&Object.keys(this.fileTransform).length>0))for(let e=0;e<this.completeFileList.length;e++){const t=this.completeFileList[e];this.updateFileTransFormCache(t)}}updateFileTransFormCache(e){if(!e)return;let t=e;this.enableCaseSensitive||(t=e.toLocaleLowerCase()),this._fileTransform=this._fileTransform||{},this._fileTransform[t]={realPath:e}}clearFileTransFormCache(e,t=!0){if(!e)return;let i=e;this.enableCaseSensitive||(i=e.toLocaleLowerCase());const s=this._fileTransform;if(t)delete s[i];else for(const e in s)s[e]&&0===e.indexOf(i)&&delete s[e]}initAllFileContentMD5(e){const t=e||this._fileList,i=new taskmanager_1.TaskManager({poolLimit:10,breakWhenError:!1});for(let e=0;e<t.length;e++){const s=t[e];i.addTask(this.updateFileContentMD5Async,s)}i.runAllAsync()}updateFileContentMD5(e){try{const t=path.posix.join(this.dirPath,e),i=fs.readFileSync(t);return this._fileContentMD5[e]=utils_1.generateMD5(i),this._fileContentMD5[e]}catch(e){return""}}clearFileContentMD5(e){delete this._fileContentMD5[e]}isFileMtimeChange(e,t){const i=this._fileInfo[e],s=null==t?void 0:t.mtimeMs;return!i||i.mtimeMs<s}isFileContentChange(e,t){const i=this._fileContentMD5[e],s=this.updateFileContentMD5(e);return!i||s!==i}}exports.Cache=Cache;